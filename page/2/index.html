<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="工作中技术总结">
<meta property="og:type" content="website">
<meta property="og:title" content="Hikari的Java之路">
<meta property="og:url" content="https://yuanyayuan.github.io/page/2/index.html">
<meta property="og:site_name" content="Hikari的Java之路">
<meta property="og:description" content="工作中技术总结">
<meta property="og:locale">
<meta property="article:author" content="LiYuan">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yuanyayuan.github.io/page/2/"/>





  <title>Hikari的Java之路</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hikari的Java之路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Hello,world</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/22/%E5%88%86%E6%AD%A5%E5%BC%8F-%E9%99%90%E6%B5%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/22/%E5%88%86%E6%AD%A5%E5%BC%8F-%E9%99%90%E6%B5%81/" itemprop="url">分步式-限流</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-22T20:45:58+08:00">
                2021-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E6%AD%A5%E5%BC%8F-%E9%99%90%E6%B5%81/" itemprop="url" rel="index">
                    <span itemprop="name">分步式 - 限流</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h1><p>流量模型：网关层—–&gt;服务—&gt;缓存—-&gt;数据库<br>限流：在某个时间窗口对资源访问做限制</p>
<h1 id="限流分类"><a href="#限流分类" class="headerlink" title="限流分类"></a>限流分类</h1><ol>
<li><strong>合法性验证限流</strong>：比如验证码、IP 黑名单等，这些手段可以有效的防止恶意攻击和爬虫采集；</li>
<li><strong>容器限流</strong>：比如 Tomcat、Nginx 等限流手段，其中 Tomcat 可以设置最大线程数（maxThreads），当并发超过最大线程数会排队等待执行；而 Nginx 提供了两种限流手段：一是控制速率，二是控制并发连接数；</li>
<li><strong>服务端限流</strong>：比如我们在服务器端通过限流算法实现限流</li>
</ol>
<h2 id="分布式限流的几种维度"><a href="#分布式限流的几种维度" class="headerlink" title="分布式限流的几种维度"></a>分布式限流的几种维度</h2><p>1、连接数</p>
<p>2、访问频率（QPS）</p>
<p>3、黑白名单</p>
<p>4、传输速率</p>
<h2 id="目前比较主流的限流方案"><a href="#目前比较主流的限流方案" class="headerlink" title="目前比较主流的限流方案"></a>目前比较主流的限流方案</h2><p>1、网管层限流 将限流规则应用在所有流量的入口处</p>
<p>2、中间件限流 将限流信息存储在分布式环境中某个中间件里（如Redis缓存），每个组件都可以从这里获取到当前时刻的流量统计，从而决定是拒绝服务还是放行流量</p>
<h2 id="常见限流算法"><a href="#常见限流算法" class="headerlink" title="常见限流算法"></a>常见限流算法</h2><ol>
<li><strong>令牌桶算法</strong><br>a、令牌 获取到令牌的Request才会被处理，其他Request要么排队，要么被丢弃<br>b、桶 用来装令牌的地方，所有Request都从这个桶里获取令牌</li>
</ol>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95.png"></p>
<p>​    <strong>令牌生成</strong></p>
<p>​    根据一个预定的速率相同中添加令牌（<strong>发放的速率是匀速</strong>，并非是每个时间窗口刚开始就一次性发放，而是会    在这个时间窗口内匀速发放）令牌桶的容量是有限的，如果当前已经放满了额定容量的令牌，那么信赖的令牌    就会被丢弃掉</p>
<p>​    <strong>令牌获取</strong></p>
<p>​    每个请求到来后，必须拿到令牌才能执行后面的逻辑。假如遇到令牌少而请求多的情况，可以设置一个”缓冲队    列”来暂存这些多余的令牌（“缓冲队列”是一个可选方案）</p>
<p>​    实际应用中也可以对缓存队列添加一些特性，比如队列中请求存活时间，或者将队列改造为<code>PriorityQueue</code>，    根据某种优先级排序</p>
<blockquote>
<p><em>为什么需要匀速限流</em> ?</p>
<p>假如我们设置限流策略设置了10r/s,也就是说10个令牌平均到1秒钟的时间窗口中生成，每0.1秒产生一个令牌。如果在这一秒来了10个请求，这些请求会在一秒钟内匀速消化掉</p>
<ol>
<li><p>令牌利用率低</p>
<p>每秒初就把令牌全部发放会出现下面情况，比如：</p>
<p>上一秒还有还剩9个令牌，在这一秒初就直接投放10个令牌，这时桶明显放不下，只能放一个，剩下的九个全部浪费了。这时又正好有15个请求过来，因为这一秒的令牌已经全部发放，所以只能处理10个请求，剩下5个要等下一秒</p>
</li>
<li><p>容易引发服务雪崩</p>
<p>假如上一秒的10个令牌没有消耗，攻击者在上一秒末发起10的请求消耗掉这10个令牌，这一秒初10个令牌发放时紧跟着又发起10个请求消耗掉这10个令牌，所以可以瞬间发起20个瞬间流量，假如策略是1wr/s,那瞬间就是2w的请求。</p>
</li>
</ol>
</blockquote>
<ol start="2">
<li><p><strong>漏桶算法</strong></p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95.png" style="zoom: 67%;" />

<p>将请求的数据包放在桶里，如果桶满了九江后面来的数据包丢弃。漏桶算法只会以一个恒定的速率将数据包从桶内流出。</p>
<p><strong>楼桶算法</strong>vs<strong>令牌桶算法</strong></p>
<ul>
<li><p><strong>令牌桶算法</strong>操作的对象是令牌</p>
</li>
<li><p><strong>漏桶算法</strong>操作的对象是请求</p>
</li>
<li><p>两种算法都有一个<strong>恒定</strong>的速率：<strong>令牌桶算法</strong>——恒定的创建令牌速率；<strong>漏桶算法</strong>——恒定的处理请求速率</p>
</li>
<li><p>两种算法都有一个<strong>不定</strong>的速率：<strong>令牌桶算法</strong>——不定的访问请求获取令牌速率；<strong>漏桶算法</strong>——不定的请求流入漏铜速率</p>
</li>
</ul>
<ul>
<li><strong>漏桶算法</strong>的特性节点他不会发生突发流量。服务器访问速率永远恒定，<strong>令牌桶算法</strong>可通过”预存一些”令牌产生突发流量现象</li>
</ul>
<ol start="3">
<li><strong>滑动窗口</strong><br>限定一个时间窗口中，访问流量。时间窗口越长，限流效果越平滑。<br><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3.png"><br>比如：第一秒有5个用户，第5秒有10个用户，那么在0-5秒这个时间窗口内访问量就是15。        接口设置了时间窗口内访问上限是20，那么当时间到第六秒的时候，因为1秒的格子已经退                 出了时间窗口，因此在第六秒内可以接收的访问量就是“20-10=10”个。</li>
</ol>
</li>
</ol>
<h2 id="容器限流"><a href="#容器限流" class="headerlink" title="容器限流"></a>容器限流</h2><h2 id="Tomcat-限流"><a href="#Tomcat-限流" class="headerlink" title="Tomcat 限流"></a>Tomcat 限流</h2><p>Tomcat 8.5 版本的最大线程数在 conf/server.xml 配置中，如下所示：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">          connectionTimeout=&quot;20000&quot;</span><br><span class="line">          maxThreads=&quot;150&quot;</span><br><span class="line">          redirectPort=&quot;8443&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>其中 maxThreads 就是 Tomcat 的最大线程数，当请求的并发大于此值（maxThreads）时，请求就会排队执行，这样就完成了限流的目的。</p>
<blockquote>
<p>小贴士：maxThreads 的值可以适当的调大一些，此值默认为 150（Tomcat 版本  8.5.42），但这个值也不是越大越好，要看具体的硬件配置，需要注意的是每开启一个线程需要耗用 1MB 的 JVM  内存空间用于作为线程栈之用，并且线程越多 GC 的负担也越重。最后需要注意一下，操作系统对于进程中的线程数有一定的限制，Windows  每个进程中的线程数不允许超过 2000，Linux 每个进程中的线程数不允许超过 1000。</p>
</blockquote>
<h2 id="基于Nginx的分布式限流"><a href="#基于Nginx的分布式限流" class="headerlink" title="基于Nginx的分布式限流"></a>基于Nginx的分布式限流</h2><p>1、基于IP地址和基于服务器访问请求限流</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据IP地址限制速度</span></span><br><span class="line"><span class="comment"># 1） 第一个参数 $binary_remote_addr</span></span><br><span class="line"><span class="comment">#    binary_目的是缩写内存占用，remote_addr表示通过IP地址来限流</span></span><br><span class="line"><span class="comment"># 2） 第二个参数 zone=iplimit:20m</span></span><br><span class="line"><span class="comment">#    iplimit是一块内存区域（记录访问频率信息），20m是指这块内存区域的大小</span></span><br><span class="line"><span class="comment"># 3） 第三个参数 rate=1r/s</span></span><br><span class="line"><span class="comment">#    比如100r/m，标识访问的限流频率</span></span><br><span class="line"><span class="attr">limit_req_zone</span> <span class="string">$binary_remote_addr zone=iplimit:20m rate=1r/s;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">server_name</span> <span class="string">www.imooc-training.com;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">/access-limit/ &#123;</span></span><br><span class="line">            <span class="attr">proxy_pass</span> <span class="string">http://127.0.0.1:10086/;</span></span><br><span class="line">            </span><br><span class="line"><span class="comment">            # 基于IP地址的限制</span></span><br><span class="line"><span class="comment">            # 1） 第一个参数zone=iplimit =&gt; 引用limit_req_zone中的zone变量</span></span><br><span class="line"><span class="comment">            # 2） 第二个参数burst=2，设置一个大小为2的缓冲区域，当大量请求到来。</span></span><br><span class="line"><span class="comment">            #     请求数量超过限流频率时，将其放入缓冲区域</span></span><br><span class="line"><span class="comment">            # 3) 第三个参数nodelay=&gt; 缓冲区满了以后，直接返回503异常</span></span><br><span class="line">            <span class="attr">limit_req</span> <span class="string">zone=iplimit burst=2 nodelay;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="meta">&#125;</span>        <span class="string"></span></span><br></pre></td></tr></table></figure>

<p>2、并发量（连接数）限流</p>
<p>利用 limit_conn_zone 和 limit_conn 两个指令即可控制并发数，示例配置如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于连接数的配置</span></span><br><span class="line"><span class="attr">limit_conn_zone</span> <span class="string">$binary_remote_addr zone=perip:20m;</span></span><br><span class="line"><span class="attr">limit_conn_zone</span> <span class="string">$server_name zone=perserver:20m;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">...</span></span><br><span class="line"><span class="comment">    # 每个server最多保持100个连接</span></span><br><span class="line">    <span class="attr">limit_conn</span> <span class="string">perserver 100;</span></span><br><span class="line"><span class="comment">    # 每个IP地址最多保持1个连接</span></span><br><span class="line">    <span class="attr">limit_conn</span> <span class="string">perip 5;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>其中 limit_conn perip 10 表示限制单个 IP 同时最多能持有 10 个连接；limit_conn perserver 100 表示 server 同时能处理并发连接的总数为 100 个。</p>
<blockquote>
<p>小贴士：只有当 request header 被后端处理后，这个连接才进行计数。</p>
</blockquote>
<p>3、基于服务器级别的限制</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">limit_req_zone</span> <span class="string">$server_name zone=serverlimit:10m rate=100r/s;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123; </span></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123; </span></span><br><span class="line"><span class="comment">        # 基于服务器级别的限制</span></span><br><span class="line"><span class="comment">        # 通常情况下，server级别的限流速率是最大的</span></span><br><span class="line">        <span class="attr">limit_req</span> <span class="string">zone=serverlimit burst=100 nodelay;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>以上配置表示，限制每个 IP 访问的速度为 2r/s，因为 Nginx 的限流统计是基于毫秒的，我们设置的速度是 2r/s，转换一下就是 500ms 内单个 IP 只允许通过 1 个请求，从 501ms 开始才允许通过第 2 个请求。</p>
<p><strong>速率限制升级版</strong></p>
<p>上面的速率控制虽然很精准但是应用于真实环境未免太苛刻了，真实情况下我们应该控制一个 IP 单位总时间内的总访问次数，而不是像上面那么精确但毫秒，我们可以使用 burst 关键字开启此设置，示例配置如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $binary_remote_addr zone=mylimit:10m rate=2r/s;</span><br><span class="line">server &#123; </span><br><span class="line">    location / &#123; </span><br><span class="line">        limit_req zone=mylimit burst=4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>burst=4 表示每个 IP 最多允许4个突发请求</p>
<h1 id="服务限流"><a href="#服务限流" class="headerlink" title="服务限流"></a>服务限流</h1><h2 id="Guava-RateLimiter客户端限流"><a href="#Guava-RateLimiter客户端限流" class="headerlink" title="Guava RateLimiter客户端限流"></a>Guava RateLimiter客户端限流</h2><h3 id="Guava-RateLimiter客户端限流（阻塞模式）"><a href="#Guava-RateLimiter客户端限流（阻塞模式）" class="headerlink" title="Guava RateLimiter客户端限流（阻塞模式）"></a>Guava RateLimiter客户端限流（阻塞模式）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RateLimiter limiter = RateLimiter.create(<span class="number">2.0</span>);</span><br><span class="line"><span class="comment">// 同步阻塞限流</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/acquire&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">acquire</span><span class="params">(Integer count)</span> </span>&#123;</span><br><span class="line">    limiter.acquire(count);</span><br><span class="line">    log.info(<span class="string">&quot;success, rate is &#123;&#125;&quot;</span>, limiter.getRate());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Guava-RateLimiter客户端限流（非阻塞模式）"><a href="#Guava-RateLimiter客户端限流（非阻塞模式）" class="headerlink" title="Guava RateLimiter客户端限流（非阻塞模式）"></a>Guava RateLimiter客户端限流（非阻塞模式）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RateLimiter limiter = RateLimiter.create(<span class="number">2.0</span>);</span><br><span class="line"><span class="comment">// 非阻塞限流</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/tryAcquire&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">tryAcquire</span><span class="params">(Integer count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (limiter.tryAcquire(count)) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;success, rate is &#123;&#125;&quot;</span>, limiter.getRate());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;fail, rate is &#123;&#125;&quot;</span>, limiter.getRate());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Guava-RateLimiter客户端限流（限定时间的非阻塞限流）"><a href="#Guava-RateLimiter客户端限流（限定时间的非阻塞限流）" class="headerlink" title="Guava RateLimiter客户端限流（限定时间的非阻塞限流）"></a>Guava RateLimiter客户端限流（限定时间的非阻塞限流）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RateLimiter limiter = RateLimiter.create(<span class="number">2.0</span>);</span><br><span class="line"><span class="comment">// 限定时间的非阻塞限流</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/tryAcquireWithTimeout&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">tryAcquireWithTimeout</span><span class="params">(Integer count, Integer timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (limiter.tryAcquire(count, timeout, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;success, rate is &#123;&#125;&quot;</span>, limiter.getRate());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;fail, rate is &#123;&#125;&quot;</span>, limiter.getRate());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="基于Redis-lua的分布式限流"><a href="#基于Redis-lua的分布式限流" class="headerlink" title="基于Redis+lua的分布式限流"></a>基于Redis+lua的分布式限流</h2><p><strong>首选Redis</strong>：</p>
<p>​    <strong>为什么用：</strong></p>
<ul>
<li>基于内存操作，性能优异</li>
<li>单线程承接网络请求，天然的线程安全，而且支持原子操作</li>
</ul>
<p>​    <strong>怎么用：</strong></p>
<ol>
<li><strong>限流请求</strong>：需要被限流的对象</li>
<li><strong>限流规则</strong>：定义一段程序或者脚本，当请求到来的时候执行</li>
<li><strong>存储介质</strong>:   用于存储限流信息的地方，比如令牌个数或者是访问请求的计数</li>
</ol>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81/%E5%9F%BA%E4%BA%8Eredis.png" style="zoom:50%;" />

<ul>
<li>利用redis过期时间特性，设置限流的时间跨度（如每秒10个请求）</li>
<li>利用redis脚本编程，将限流逻辑编写成一段脚本植入到Redis中，这样就将限流的重任从服务层完全剥离。</li>
<li>redis集群方便横向扩展</li>
</ul>
<h3 id="限流组件封装（Redis-Lua）"><a href="#限流组件封装（Redis-Lua）" class="headerlink" title="限流组件封装（Redis+Lua）"></a>限流组件封装（Redis+Lua）</h3><blockquote>
<p>使用自定义切面，若接口使用自定义切面，则开启限流</p>
</blockquote>
<ul>
<li>pom引用</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ratelimiter.lua</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取方法签名特征、</span></span><br><span class="line"><span class="comment">-- 用作限流的key</span></span><br><span class="line"><span class="keyword">local</span> methodKey = KEYS[<span class="number">1</span>]</span><br><span class="line">redis.<span class="built_in">log</span>(redis.LOG_DEBUG, <span class="string">&#x27;key is&#x27;</span>, methodKey)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用脚本传入的限流大小</span></span><br><span class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取当前流量大小</span></span><br><span class="line"><span class="keyword">local</span> count = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, methodKey) <span class="keyword">or</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 是否超出限流阈值</span></span><br><span class="line"><span class="keyword">if</span> count + <span class="number">1</span> &gt; limit <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 拒绝服务访问</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- 没有超过阈值</span></span><br><span class="line">    <span class="comment">-- 设置当前访问的数量+1</span></span><br><span class="line">    redis.call(<span class="string">&quot;INCRBY&quot;</span>, methodKey, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">-- 设置过期时间</span></span><br><span class="line">    redis.call(<span class="string">&quot;EXPIRE&quot;</span>, methodKey, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">-- 放行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>AccessLimiter.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AccessLimiter &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">limit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">methodKey</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>AccessLimiterAspect.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessLimiterAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisScript&lt;Boolean&gt; rateLimitLua;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.imooc.springcloud.annotation.AccessLimiter)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;cut&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;cut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 获得方法签名，作为method Key</span></span><br><span class="line">        MethodSignature signature = (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        Method method = signature.getMethod();</span><br><span class="line">		<span class="comment">//指定拿到的自定义注解</span></span><br><span class="line">        AccessLimiter annotation = method.getAnnotation(AccessLimiter.class);</span><br><span class="line">        String key = annotation.methodKey();</span><br><span class="line">        Integer limit = annotation.limit()；</span><br><span class="line">        <span class="comment">// 如果没设置methodkey, 从调用方法签名生成自动一个key</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(key)) &#123;</span><br><span class="line">            Class[] type = method.getParameterTypes();</span><br><span class="line">            key = method.getClass() + method.getName();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String paramTypes = Arrays.stream(type)</span><br><span class="line">                        .map(Class::getName)</span><br><span class="line">                        .collect(Collectors.joining(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">                log.info(<span class="string">&quot;param types: &quot;</span> + paramTypes);</span><br><span class="line">                key += <span class="string">&quot;#&quot;</span> + paramTypes;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 调用Redis</span></span><br><span class="line">        <span class="keyword">boolean</span> acquired = stringRedisTemplate.execute(</span><br><span class="line">                rateLimitLua, <span class="comment">// Lua script的真身</span></span><br><span class="line">                Lists.newArrayList(key), <span class="comment">// Lua脚本中的Key列表</span></span><br><span class="line">                limit.toString() <span class="comment">// Lua脚本Value列表</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!acquired) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;your access is blocked, key=&#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Your access is blocked&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Controller测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;test-annotation&quot;)</span></span><br><span class="line"><span class="meta">@AccessLimiter(limit = 1)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testAnnotation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/22/%E5%88%86%E6%AD%A5%E5%BC%8F-%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/22/%E5%88%86%E6%AD%A5%E5%BC%8F-%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7/" itemprop="url">分步式-接口幂等性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-22T20:45:48+08:00">
                2021-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" itemprop="url" rel="index">
                    <span itemprop="name">分步式 - 分库分表</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="接口设计与重试机制引发的问题"><a href="#接口设计与重试机制引发的问题" class="headerlink" title="接口设计与重试机制引发的问题"></a>接口设计与重试机制引发的问题</h1><h2 id="接口幂等性问题"><a href="#接口幂等性问题" class="headerlink" title="接口幂等性问题"></a>接口幂等性问题</h2><ul>
<li>提交订单按钮如何防止重复提价</li>
<li>表单录入也如何防止重复提交</li>
<li>微服务接口，客户端重试时，会对业务数据产生什么影响</li>
</ul>
<h2 id="什么是幂等性"><a href="#什么是幂等性" class="headerlink" title="什么是幂等性"></a>什么是幂等性</h2><p>f(f(x)) = f(x)</p>
<h2 id="什么情况下需要幂等性"><a href="#什么情况下需要幂等性" class="headerlink" title="什么情况下需要幂等性"></a>什么情况下需要幂等性</h2><ul>
<li>重复提交、接口重试、前端抖动</li>
<li>业务场景：<ul>
<li>用户多次点击提交订单，后台应只生成一个订单</li>
<li>支付时，由于网络问题重发，应该只扣一次钱</li>
</ul>
</li>
<li>并不是所有接口都要求幂等性，根据业务而定</li>
</ul>
<h2 id="幂等性核心思想"><a href="#幂等性核心思想" class="headerlink" title="幂等性核心思想"></a>幂等性核心思想</h2><p>通过<strong>唯一的业务单号</strong>保证幂等性</p>
<ul>
<li>非并发情况下：查询业务单号有没有操作过，没有则执行操作</li>
<li>并发情况下：整个操作过程加锁</li>
</ul>
<h2 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h2><p>Select操作：不会对业务数据有影响，天然幂等</p>
<p>delete操作：第一次已经删除，第二次也不会有影响</p>
<p>Update操作：更新操作传入数据版本号，通过乐观锁实现幂等性</p>
<p>Insert操作：没有唯一的业务单号，使用Token实现幂等</p>
<p>混合操作：找到操作的<strong>唯一业务单号</strong>，有责可使用分布式锁，没有可以通过使用token保证幂等</p>
<h3 id="delete操作"><a href="#delete操作" class="headerlink" title="delete操作"></a>delete操作</h3><ul>
<li>根据唯一的业务号去删除<ul>
<li>第一次删除是，已将数据删除</li>
<li>第二次在执行时，由于没有找到记录，所以返回的结果是0，对业务数据没有影响。可在删除前进行数据的查询</li>
</ul>
</li>
<li>删除操作没有唯一业务号，则要看具体的业务要求<ul>
<li>如删除所有审核未通过的商品</li>
<li>第一次执行，将所有未通过审核的商品删除</li>
<li>在第二次执行前，又有新的商品未审核通过</li>
<li>执行第二次删除操作，新的为审核的商品要不要删除？（根据业务需求而定）</li>
</ul>
</li>
</ul>
<h3 id="update操作的幂等性"><a href="#update操作的幂等性" class="headerlink" title="update操作的幂等性"></a>update操作的幂等性</h3><ul>
<li>根据<strong>唯一业务号</strong>去更新数据的情况</li>
<li>用户查询出的要修改的数据，系统将数据返回页面，将版本数据放入隐藏域</li>
<li>用户修改数据，点击提交，将版本号一同提交给后台</li>
<li>后台使用版本号作为更新条件</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update set version = version + 1,xxx=$&#123;xxx&#125; where id = xxx and version = $&#123;version&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用乐观锁与update行锁，保证幂等</p>
</li>
<li><p>更新操作没有唯一业务号的使用Token</p>
</li>
</ul>
<h3 id="insert操作幂等性"><a href="#insert操作幂等性" class="headerlink" title="insert操作幂等性"></a>insert操作幂等性</h3><ul>
<li>有唯一业务号的Insert操作，例如：秒杀，商品ID+用户ID可通过分布式锁，保证接口幂等</li>
<li>没有唯一业务唯一业务号的Insert操作，例如：用户注册，点击多次，使用Token机制保证幂等性</li>
<li>进入到注册页时，后台统一生成Token，返回前台隐藏域中，用户在页面点击提交时，将Token一同传入后台，使用Token获取分布式锁，完成Insert操作，执行成功后，不释放锁，等待过期自动释放</li>
</ul>
<h3 id="混合操作幂等性"><a href="#混合操作幂等性" class="headerlink" title="混合操作幂等性"></a>混合操作幂等性</h3><ul>
<li>混合操作，一个接口包含多种操作，同样使用Token机制</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/21/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/21/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" itemprop="url">分步式-分布式事务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-21T18:42:15+08:00">
                2021-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" itemprop="url" rel="index">
                    <span itemprop="name">分步式 - 分布式事务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>摘抄<a target="_blank" rel="noopener" href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/distributed-system/CAP%E7%90%86%E8%AE%BA">《CAP理论解读》</a></p>
<p>摘抄<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903936718012430">《神一样的CAP理论被应用在何方》</a></p>
<h1 id="分布式事务，是怎么从ACID解脱，投身CAP-BASE"><a href="#分布式事务，是怎么从ACID解脱，投身CAP-BASE" class="headerlink" title="分布式事务，是怎么从ACID解脱，投身CAP/BASE"></a>分布式事务，是怎么从ACID解脱，投身CAP/BASE</h1><p>如果说到事务，ACID(原子)是传统数据库常用的设计理念，追求强一致性模型，关系数据库的ACID模型拥有高一致性+可用性，所以很难进行分区，所以在微服务中ACID已经是无法支持。</p>
<p>我们还是回到CAP去寻求解决方案，不过根据上面的讨论，CAP定理中，要么只能CP，要么只能AP。</p>
<p>如果我们追求数据的一致性而忽略可用性这个在微服务中肯定是行不通的。</p>
<p>如果我们追求可用性而忽略一致性，那么在一些重要的数据（例如支付，金额）肯定出现漏洞百出，这个也是无法接受。</p>
<p>所以我们既要一致性，也要可用性。都要是无法实现的，但我们能不能在一致性上作出一些妥协，不追求强一致性，转而追求最终一致性，所以引入BASE理论，在分布式事务中，BASE最重要是为CAP提出了最终一致性的解决方案，BASE强调牺牲高一致性，从而获取肯用性，数据允许在一段时间内不一致，只要保证最终一致性就可以了。</p>
<h1 id="分布式一致性问题"><a href="#分布式一致性问题" class="headerlink" title="分布式一致性问题"></a>分布式一致性问题</h1><p>设计一个分布式系统必定会遇到一个问题—— <strong>因为分区容忍性（partition tolerance）的存在，就必定要求我们需要在系统可用性（availability）和数据一致性（consistency）中做出权衡</strong> 。这就是著名的 <code>CAP</code> 定理。</p>
<blockquote>
<p>理解起来其实很简单，比如说把一个班级作为整个系统，而学生是系统中的一个个独立的子系统。这个时候班里的小红小明偷偷谈恋爱被班里的大嘴巴小花发现了，小花欣喜若狂告诉了周围的人，然后小红小明谈恋爱的消息在班级里传播起来了。当在消息的传播（散布）过程中，你抓到一个同学问他们的情况，如果回答你不知道，那么说明整个班级系统出现了数据不一致的问题（因为小花已经知道这个消息了）。而如果他直接不回答你，因为整个班级有消息在进行传播（为了保证一致性，需要所有人都知道才可提供服务），这个时候就出现了系统的可用性问题。</p>
</blockquote>
<h1 id="一致性协议和算法"><a href="#一致性协议和算法" class="headerlink" title="一致性协议和算法"></a>一致性协议和算法</h1><p>而为了解决数据一致性问题，在科学家和程序员的不断探索中，就出现了很多的一致性协议和算法。比如 2PC（两阶段提交），3PC（三阶段提交），Paxos算法等等。</p>
<p>这时候请你思考一个问题，同学之间如果采用传纸条的方式去传播消息，那么就会出现一个问题——我咋知道我的小纸条有没有传到我想要传递的那个人手中呢？万一被哪个小家伙给劫持篡改了呢，对吧？</p>
<p>这个时候就引申出一个概念—— <strong>拜占庭将军问题</strong> 。它意指 <strong>在不可靠信道上试图通过消息传递的方式达到一致性是不可能的</strong>， 所以所有的一致性算法的 <strong>必要前提</strong> 就是<strong>安全可靠的消息通道。</strong></p>
<p>而为什么要去解决数据一致性的问题？你想想，如果一个秒杀系统将服务拆分成了下订单和加积分服务，这两个服务部署在不同的机器上了，万一在消息的传播过程中积分系统宕机了，总不能你这边下了订单却没加积分吧？你总得保证两边的数据需要一致吧？</p>
<h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><blockquote>
<p>拿秒杀系统的下订单和加积分两个系统来举例，下完订单会发个消息给积分系统告诉它下面该增加积分了。如果我们仅仅是发送一个消息也不收回复，那么我们的订单系统怎么能知道积分系统的收到消息的情况呢？如果我们增加一个收回复的过程，那么当积分系统收到消息后返回给订单系统一个 <code>Response</code> ，但在中间出现了网络波动，那个回复消息没有发送成功，订单系统是不是以为积分系统消息接收失败了？它是不是会回滚事务？但此时积分系统是成功收到消息的，它就会去处理消息然后给用户增加积分，这个时候就会出现积分加了但是订单没下成功。</p>
</blockquote>
<p>在分布式系统中，要实现分布式事务，无外乎几种解决方案。方案各有不同，不过其实都是遵循BASE理论，是最终一致性模型。</p>
<ul>
<li>两阶段提交（2PC）</li>
<li></li>
<li>补偿事务（TCC）</li>
<li>本地消息表</li>
<li>MQ事务消息</li>
</ul>
<h2 id="2PC（两阶段提交）-强一致"><a href="#2PC（两阶段提交）-强一致" class="headerlink" title="2PC（两阶段提交）[强一致]"></a>2PC（两阶段提交）[强一致]</h2><blockquote>
<p>PC:phase-commit 的缩写，即阶段提交。</p>
</blockquote>
<p><strong>二阶段提交是一种强一致性设计</strong></p>
<p>在两阶段提交中，主要涉及到两个角色，分别是协调者（事务管理器TM）和参与者（资源管理器Rm）。</p>
<p>**准备阶段(第一阶段)**协调者会给各参与者发送准备命令，</p>
<p>同步等待所有资源的响应之后就进入第二阶段即提交阶段（注意提交阶段不一定是提交事务，也可能是回滚事务）。假如在第一阶段所有参与者都返回准备成功，那么协调者则向所有参与者发送提交事务命令，然后等待所有事务都提交成功之后，返回事务执行成功。假如在第一阶段有一个参与者返回失败，那么协调者就会向所有参与者发送回滚事务的请求，即分布式事务执行失败。</p>
<p>2PC 是一个<strong>同步阻塞协议</strong>，像第一阶段协调者会等待所有参与者响应才会进行下一步操作，当然第一阶段的<strong>协调者有超时机制</strong>，假设因为网络原因没有收到某参与者的响应或某参与者挂了，那么超时后就会判断事务失败，向所有参与者发送回滚命令。</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4.png" alt="image"></p>
<p>**提交阶段(第二阶段)**提交失败的话有两种情况</p>
<ul>
<li><p>第一种是<strong>第二阶段执行的是回滚事务操作</strong>，那么答案是不断重试，直到所有参与者都回滚了，不然那些在第一阶段准备成功的参与者会一直阻塞着。</p>
</li>
<li><p>第二种是<strong>第二阶段执行的是提交事务操作</strong>，那么答案也是不断重试，因为有可能一些参与者的事务已经提交成功了，这个时候只有一条路，就是头铁往前冲，不断的重试，直到提交成功，到最后真的不行只能人工介入处理。</p>
</li>
</ul>
<p>第二阶段协调者的没法超时，所以只能不断重试！</p>
<p><strong>事实上2PC（两阶段提交）只解决了各个事务的原子性问题，随之也带来了很多的问题。</strong></p>
<ul>
<li><p><strong>单点故障问题</strong></p>
<ul>
<li>假设协调者在<strong>发送准备命令之前</strong>挂了，还行等于事务还没开始。</li>
<li>假设协调者在<strong>发送准备命令之后</strong>挂了，这就不太行了，有些参与者等于都执行了处于事务资源锁定的状态。不仅事务执行不下去，还会因为锁定了一些公共资源而阻塞系统其它操作。</li>
<li>假设协调者在<strong>发送回滚事务命令之前</strong>挂了，那么事务也是执行不下去，且在第一阶段那些准备成功参与者都阻塞着。</li>
<li>假设协调者在<strong>发送回滚事务命令之后</strong>挂了，这个还行，至少命令发出去了，很大的概率都会回滚成功，资源都会释放。但是如果出现网络分区问题，某些参与者将因为收不到命令而阻塞着。</li>
<li>假设协调者在<strong>发送提交事务命令之前</strong>挂了，这个不行，傻了！这下是所有资源都阻塞着。</li>
<li>假设协调者在<strong>发送提交事务命令之后</strong>挂了，这个还行，也是至少命令发出去了，很大概率都会提交成功，然后释放资源，但是如果出现网络分区问题某些参与者将因为收不到命令而阻塞着。</li>
</ul>
</li>
<li><p>协调者故障，通过选举得到新协调者</p>
<blockquote>
<p>因为协调者单点问题，因此我们可以通过选举等操作选出一个新协调者来顶替。</p>
</blockquote>
<p>如果处于第一阶段，其实影响不大都回滚好了，在第一阶段事务肯定还没提交。</p>
<p>如果处于第二阶段:</p>
<p>假设参与者都没挂，此时新协调者可以向所有参与者确认它们自身情况来推断下一步的操作。</p>
<p>假设有个别参与者挂了 ,比如协调者发送了回滚命令，此时第一个参与者收到了并执行，然后协调者和第一个参与者都挂了。此时其他参与者都没收到请求，然后新协调者来了，它询问其他参与者都说OK，但它不知道挂了的那个参与者的执行情况。问题其实就出在<strong>每个参与者自身的状态只有自己和协调者知道</strong>，因此新协调者无法通过在场的参与者的状态推断出挂了的参与者是什么情况。</p>
<p>不过在实现的时候我们可以灵活的让协调者将自己发过的请求在哪个地方记一下，也就是日志记录，这样新协调者来的时候不就知道此时该不该发了?(就算协调者知道自己该发提交请求，那么在参与者也一起挂了的情况下没用，因为你不知道参与者在挂之前有没有提交事务)</p>
<p>如果参与者在挂之前事务提交成功，新协调者确定存活着的参与者都没问题，那肯定得向其他参与者发送提交事务命令才能<strong>保证数据一致</strong>。</p>
<p>如果参与者在挂之前事务还未提交成功，参与者恢复了之后数据是回滚的，此时协调者必须是向其他参与者发送回滚事务命令才能保持<strong>事务的一致</strong>。</p>
</li>
</ul>
<h3 id="具体实现方式"><a href="#具体实现方式" class="headerlink" title="具体实现方式"></a>具体实现方式</h3><p> Java 中的 JTA：它是基于XA规范实现的事务接口，基于数据库的 XA 规范来实现的 2PC（Atomikos）</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>2PC 是一种<strong>尽量保证强一致性</strong>的分布式事务，因此它是<strong>同步阻塞</strong>的，而同步阻塞就导致长久的资源锁定问题，<strong>总体而言效率低</strong>，并且存在<strong>单点故障</strong>问题，在极端条件下存在<strong>数据不一致</strong>的风险。</p>
<p>2PC 适用于<strong>数据库层面的分布式事务场景</strong>，而我们业务需求有时候不仅仅关乎数据库，也有可能是上传一张图片或者发送一条短信。</p>
<h2 id="3PC（三阶段提交）-强一致"><a href="#3PC（三阶段提交）-强一致" class="headerlink" title="3PC（三阶段提交）[强一致]"></a>3PC（三阶段提交）[强一致]</h2><p>3PC 包含了三个阶段，分别是<strong>准备阶段、预提交阶段和提交阶段</strong>，对应的英文就是：<code>CanCommit、PreCommit 和 DoCommit</code>。</p>
<p>3PC 的准备阶段协调者只是询问参与者的自身状况，比如你现在还好吗？负载重不重？这类的。而预提交阶段就是和 2PC 的准备阶段一样，除了事务的提交该做的都做了。</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/3PC.png"></p>
<p>不管哪一个阶段有参与者返回失败都会宣布事务失败，这和 2PC 是一样的（当然到最后的提交阶段和 2PC 一样只要是提交请求就只能不断重试）。</p>
<p><strong>准备阶段的变更成不会直接执行事务</strong>，而是会先去询问此时的参与者是否有条件接这个事务，因此<strong>不会一来就干活直接锁资源</strong>，使得在某些资源不可用的情况下所有参与者都阻塞着。</p>
<p><strong>预提交阶段的引入起到了一个统一状态的作用</strong>，它像一道栅栏，表明在预提交阶段前所有参与者其实还未都回应，在预处理阶段表明所有参与者都已经回应了。</p>
<h3 id="相比2PC，3PC引入超时机制"><a href="#相比2PC，3PC引入超时机制" class="headerlink" title="相比2PC，3PC引入超时机制"></a>相比2PC，3PC引入超时机制</h3><blockquote>
<p>2PC 是同步阻塞的，协调者挂在提交请求还未发出去的时候是最伤的，所有参与者都已经锁定资源并且阻塞等待着。</p>
</blockquote>
<p><strong>如果是等待提交命令超时，那么参与者就会提交事务了</strong>，因为都到了这一阶段了大概率是提交的，</p>
<p><strong>如果是等待预提交命令超时，那该干啥就干啥了，反正本来啥也没干</strong>。</p>
<p>然而超时机制也会带来数据不一致的问题，比如在等待提交命令时候超时了，参与者默认执行的是提交事务操作，但是<strong>有可能执行的是回滚操作，这样一来数据就不一致了</strong>。当然 3PC 协调者超时还是在的。</p>
<h3 id="3PC-的引入目的"><a href="#3PC-的引入目的" class="headerlink" title="3PC 的引入目的"></a>3PC 的引入目的</h3><blockquote>
<p> 为了解决提交阶段 2PC 协调者和某参与者都挂了之后新选举的协调者不知道当前应该提交还是回滚的问题</p>
</blockquote>
<p>新协调者来的时候发现有一个参与者处于预提交或者提交阶段，那么表明已经经过了所有参与者的确认了，所以此时执行的就是提交命令。</p>
<p>所以说 3PC 就是通过引入预提交阶段来使得参与者之间的状态得到统一，也就是留了一个阶段让大家同步一下。</p>
<p>但是这也只能让协调者知道该如果做，但不能保证这样做一定对，这其实和上面 2PC 分析一致，因为挂了的参与者到底有没有执行事务无法断定。</p>
<p>所以说 3PC 通过预提交阶段可以减少故障恢复时候的复杂性，但是不能保证数据一致，除非挂了的那个参与者恢复。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>3PC 相对于 2PC 做了一定的改进：引入了参与者超时机制，并且增加了预提交阶段使得故障恢复之后协调者的决策复杂度降低，但整体的交互过程更长了，性能有所下降，并且还是会存在数据不一致问题。所以 2PC 和 3PC 都不能保证数据100%一致，因此一般都需要有定时扫描补偿机制。 3PC 没有找到具体的实现，所以认为 3PC 只是纯的理论上的东西，而且可以看到相比于 2PC 它是做了一些努力但是效果甚微，所以只做了解即可。</p>
<h2 id="补偿事务（TCC）-补偿性事务思想"><a href="#补偿事务（TCC）-补偿性事务思想" class="headerlink" title="补偿事务（TCC）[补偿性事务思想]"></a>补偿事务（TCC）[补偿性事务思想]</h2><blockquote>
<p>适用的范围更广，在业务层面实现，因此对业务的侵入性较大，每一个操作都需要实现对应的三个方法。</p>
</blockquote>
<p><strong>2PC 和 3PC 都是数据库层面的，而 TCC 是业务层面的分布式事务</strong>，就像前面说的分布式事务不仅仅包括数据库的操作，还包括发送短信等，这时候 TCC 就派上用场了！</p>
<p>TCC 指的是<code>Try - Confirm - Cancel</code>。</p>
<ul>
<li>Try 指的是预留，即资源的预留和锁定，<strong>注意是预留</strong>。</li>
<li>Confirm 指的是确认操作，这一步其实就是真正的执行了。</li>
<li>Cancel 指的是撤销操作，可以理解为把预留阶段的动作撤销了。</li>
</ul>
<p>其实从思想上看和 2PC 差不多，都是先试探性的执行，如果都可以那就真正的执行，如果不行就回滚。</p>
<p>比如说一个事务要执行A、B、C三个操作，那么先对三个操作执行预留动作。如果都预留成功了那么就执行确认操作，如果有一个预留失败那就都执行撤销动作。</p>
<p>我们来看下流程，TCC模型还有个事务管理者的角色，用来记录TCC全局事务状态并提交或者回滚事务。</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/TCC.png" alt="img" style="zoom:50%;" />

<p>可以看到流程还是很简单的，难点在于业务上的定义，对于每一个操作你都需要定义三个动作分别对应<code>Try - Confirm - Cancel</code>。</p>
<p>因此 <strong>TCC 对业务的侵入较大和业务紧耦合</strong>，需要根据特定的场景和业务逻辑来设计相应的操作。</p>
<p>还有一点要注意，撤销和确认操作的执行可能需要重试，因此还需要保证<strong>操作的幂等</strong>。</p>
<p>相对于 2PC、3PC ，TCC 适用的范围更大，但是开发量也更大，毕竟都在业务上实现，而且有时候你会发现这三个方法还真不好写。不过也因为是在业务上实现的，所以<strong>TCC可以跨数据库、跨不同的业务系统来实现事务</strong>。</p>
<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountAMapper accountAMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountBMapper accountBMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(transactionManager = &quot;tm131&quot;,rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transferAccount</span><span class="params">()</span></span>&#123;</span><br><span class="line">        AccountA accountA = accountAMapper.selectByPrimaryKey(<span class="number">1</span>);</span><br><span class="line">        accountA.setBalance(accountA.getBalance().subtract(<span class="keyword">new</span> BigDecimal(<span class="number">200</span>)));</span><br><span class="line">        accountAMapper.updateByPrimaryKey(accountA);</span><br><span class="line"></span><br><span class="line">        AccountB accountB = accountBMapper.selectByPrimaryKey(<span class="number">2</span>);</span><br><span class="line">        accountB.setBalance(accountB.getBalance().add(<span class="keyword">new</span> BigDecimal(<span class="number">200</span>)));</span><br><span class="line">        accountBMapper.updateByPrimaryKey(accountB);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                AccountB accountb = accountBMapper.selectByPrimaryKey(<span class="number">2</span>);</span><br><span class="line">                accountb.setBalance(accountb.getBalance().subtract(<span class="keyword">new</span> BigDecimal(<span class="number">200</span>)));</span><br><span class="line">                accountBMapper.updateByPrimaryKey(accountb);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="本地消息表-最终一致性"><a href="#本地消息表-最终一致性" class="headerlink" title="本地消息表[最终一致性]"></a>本地消息表[最终一致性]</h2><p>本地消息表其实就是利用了 <strong>各系统本地的事务</strong>来实现分布式事务。</p>
<p>本地消息表顾名思义就是会有一张存放本地消息的表，一般都是放在数据库中，然后在执行业务的时候 <strong>将业务的执行和将消息放入消息表中的操作放在同一个事务中</strong>，这样就能保证消息放入本地表中业务肯定是执行成功的。</p>
<p>然后再去调用下一个操作，如果下一个操作调用成功了好说，消息表的消息状态可以直接改成已成功。</p>
<p>如果调用失败也没事，会有 <strong>后台任务定时去读取本地消息表</strong>，筛选出还未成功的消息再调用对应的服务，服务更新成功了再变更消息的状态。</p>
<p>这时候有可能消息对应的操作不成功，因此也需要重试，重试就得保证对应服务的方法是幂等的，而且一般重试会有最大次数，超过最大次数可以记录下报警让人工处理。</p>
<p>可以看到本地消息表其实实现的是<strong>最终一致性</strong>，容忍了数据暂时不一致的情况。</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8.png"></p>
<ol>
<li><p>执行支付下单的操作，数据存入支付业务表（金额，账户，转账）</p>
</li>
<li><p>业务表记录成功后将该条操作录入消息表（订单信息，存储状态）</p>
</li>
<li><p>定时任务轮询消息表，找出外发送的消息，调用操作接口</p>
</li>
<li><p>操作接口根据消息表中的订单号，操作订单业务表中的对应数据</p>
</li>
<li><p>操作成功后通过操作接口反馈给支付业务（反馈内容success或ok），支付业务接收到反馈后更新消息表发送状态</p>
</li>
<li><p>操作接口反馈操作失败，消息表规定最大失败次数，定时任务找到发送失败的进行重试，如果从事次数大于最大失败次数，消息状态特殊标注，转为人工干预</p>
</li>
</ol>
<p><strong>优点</strong>：避免了分布式事务，实现最终一致性（不一致的时间是定时任务调用操作接口那段时间）适用于一些对时间不敏感的业务。</p>
<p><strong>缺点</strong>：要注意重试时的幂等性操作</p>
<h2 id="基于MQ的最终一致方案-最终一致性"><a href="#基于MQ的最终一致方案-最终一致性" class="headerlink" title="基于MQ的最终一致方案[最终一致性]"></a>基于MQ的最终一致方案[最终一致性]</h2><ul>
<li>原理、流程与本地消息表类似</li>
<li>不同点：本地消息表改为MQ，定时任务改为MQ的消费者</li>
</ul>
<p>RocketMQ中实现了分布式事务，实际上是对本地消息表的一个封装，将本地消息表移动到了MQ内部。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/6/16d0588ae2844970?imageView2/0/w/1280/h/960/ignore-error/1" alt="image"></p>
<ol>
<li>业务系统1操作数据，将数据保存到DB1，另外写一条消息存入消息队列</li>
<li>消费者从消息队列中取出消息，执行业务逻辑，将数据保存DB2</li>
</ol>
<p>事务消息作为一种异步确保型事务， 将两个事务分支通过 MQ 进行异步解耦，RocketMQ 事务消息的设计流程同样借鉴了两阶段提交理论，整体交互流程如下图所示：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/6/16d0588aeba679cf?imageView2/0/w/1280/h/960/ignore-error/1&ynotemdtimestamp=1619092644755" alt="image"></p>
<ol>
<li>先给 Broker 发送事务消息即半消息(<strong>半消息不是说一半消息，而是这个消息对消费者来说不可见</strong>)，并接受Broker的ack或nack</li>
<li>MQ发送者<strong>发送成功后发送方再执行本地事务</strong></li>
<li>MQ发送者根据<strong>本地事务的结果向 Broker 发送 Commit 或者 RollBack 命令</strong></li>
<li>并且MQ 的发送方会提供一个<strong>反查事务状态接口</strong>，如果一段时间内半消息没有收到任何操作请求，那么 Broker 会通过反查接口得知发送方事务是否执行成功，然后执行 Commit 或者 RollBack 命令。</li>
<li>如果是 Commit 那么订阅方就能收到这条消息，然后再做对应的操作，做完了之后再消费这条消息即可。</li>
<li>如果是 RollBack 那么订阅方收不到这条消息，等于事务就没执行过。</li>
</ol>
<p>MQ事务是对本地消息表的一层封装，将本地消息表移动到了MQ内部，所以也是基于BASE理论，是最终一致性模式，对强一致性要求不那么高的事务适用，同时MQ事务将整个流程异步化了，也非常适合在高并发情况下使用。</p>
<ul>
<li><p>优点：不依赖定时任务，基于MQ更高效 , 适用于一些对时间不敏感的业务。</p>
</li>
<li><p>适合于公司内部系统</p>
</li>
<li><p>不同公司之间无法基于MQ，本地消息表更合适</p>
</li>
</ul>
<h2 id="最大努力通知"><a href="#最大努力通知" class="headerlink" title="最大努力通知"></a><strong>最大努力通知</strong></h2><p>其实我觉得本地消息表也可以算最大努力，事务消息也可以算最大努力。</p>
<p>就本地消息表来说会有后台任务定时去查看未完成的消息，然后去调用对应的服务，当一个消息多次调用都失败的时候可以记录下然后引入人工，或者直接舍弃。这其实算是最大努力了。</p>
<p>事务消息也是一样，当半消息被commit了之后确实就是普通消息了，如果订阅者一直不消费或者消费不了则会一直重试，到最后进入死信队列。其实这也算最大努力。</p>
<p>所以<strong>最大努力通知其实只是表明了一种柔性事务的思想</strong>：我已经尽力我最大的努力想达成事务的最终一致了。</p>
<p>适用于对时间不敏感的业务，例如短信通知。</p>
<h2 id="Paxos-算法"><a href="#Paxos-算法" class="headerlink" title="Paxos 算法"></a><code>Paxos</code> 算法</h2><p><code>Paxos</code> 算法是基于<strong>消息传递且具有高度容错特性的一致性算法</strong>，是目前公认的解决分布式一致性问题最有效的算法之一，<strong>其解决的问题就是在分布式系统中如何就某个值（决议）达成一致</strong> 。</p>
<p>在 <code>Paxos</code> 中主要有三个角色，分别为 <code>Proposer提案者</code>、<code>Acceptor表决者</code>、<code>Learner学习者</code>。<code>Paxos</code> 算法和 <code>2PC</code> 一样，也有两个阶段，分别为 <code>Prepare</code> 和 <code>accept</code> 阶段。</p>
<h3 id="prepare-阶段"><a href="#prepare-阶段" class="headerlink" title="prepare 阶段"></a>prepare 阶段</h3><ul>
<li><code>Proposer提案者</code>：负责提出 <code>proposal</code>，每个提案者在提出提案时都会首先获取到一个 <strong>具有全局唯一性的、递增的提案编号N</strong>，即在整个集群中是唯一的编号 N，然后将该编号赋予其要提出的提案，在<strong>第一阶段是只将提案编号发送给所有的表决者</strong>。</li>
<li><code>Acceptor表决者</code>：每个表决者在 <code>accept</code> 某提案后，会将该提案编号N记录在本地，这样每个表决者中保存的已经被 accept 的提案中会存在一个<strong>编号最大的提案</strong>，其编号假设为 <code>maxN</code>。每个表决者仅会 <code>accept</code> 编号大于自己本地 <code>maxN</code> 的提案，在批准提案时表决者会将以前接受过的最大编号的提案作为响应反馈给 <code>Proposer</code> 。</li>
</ul>
<blockquote>
<p>下面是 <code>prepare</code> 阶段的流程图，你可以对照着参考一下。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/img_convert/22e8d512d954676bdf0cc92d200af8ef.png?ynotemdtimestamp=1618749953489" alt="paxos第一阶段"></p>
<h3 id="accept-阶段"><a href="#accept-阶段" class="headerlink" title="accept 阶段"></a>accept 阶段</h3><p>当一个提案被 <code>Proposer</code> 提出后，如果 <code>Proposer</code> 收到了超过半数的 <code>Acceptor</code> 的批准（<code>Proposer</code> 本身同意），那么此时 <code>Proposer</code> 会给所有的 <code>Acceptor</code> 发送真正的提案（你可以理解为第一阶段为试探），这个时候 <code>Proposer</code> 就会发送提案的内容和提案编号。</p>
<p>表决者收到提案请求后会再次比较本身已经批准过的最大提案编号和该提案编号，如果该提案编号 <strong>大于等于</strong> 已经批准过的最大提案编号，那么就 <code>accept</code> 该提案（此时执行提案内容但不提交），随后将情况返回给 <code>Proposer</code> 。如果不满足则不回应或者返回 NO 。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b82536f956f70a584c6a20c10113f225.png?ynotemdtimestamp=1618749953489" alt="paxos第二阶段1"></p>
<p>当 <code>Proposer</code> 收到超过半数的 <code>accept</code> ，那么它这个时候会向所有的 <code>acceptor</code> 发送提案的提交请求。需要注意的是，因为上述仅仅是超过半数的 <code>acceptor</code> 批准执行了该提案内容，其他没有批准的并没有执行该提案内容，所以这个时候需要<strong>向未批准的 <code>acceptor</code>发送提案内容和提案编号并让它无条件执行和提交</strong>，而对于前面已经批准过该提案的 <code>acceptor</code> 来说 <strong>仅仅需要发送该提案的编号</strong> ，让 <code>acceptor</code> 执行提交就行了。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/743889b97485fdfe2094e5ef0af6b141.png?ynotemdtimestamp=1618749953489" alt="paxos第二阶段2"></p>
<p>而如果 <code>Proposer</code> 如果没有收到超过半数的 <code>accept</code> 那么它将会将 <strong>递增</strong> 该 <code>Proposal</code> 的编号，然后 <strong>重新进入 <code>Prepare</code> 阶段</strong> 。</p>
<blockquote>
<p>对于 <code>Learner</code> 来说如何去学习 <code>Acceptor</code> 批准的提案内容，这有很多方式，读者可以自己去了解一下，这里不做过多解释。</p>
</blockquote>
<h3 id="paxos-算法的死循环问题"><a href="#paxos-算法的死循环问题" class="headerlink" title="paxos 算法的死循环问题"></a><code>paxos</code> 算法的死循环问题</h3><p>其实就有点类似于两个人吵架，小明说我是对的，小红说我才是对的，两个人据理力争的谁也不让谁🤬🤬。</p>
<p>比如说，此时提案者 P1 提出一个方案 M1，完成了 <code>Prepare</code> 阶段的工作，这个时候 <code>acceptor</code> 则批准了 M1，但是此时提案者 P2 同时也提出了一个方案 M2，它也完成了 <code>Prepare</code> 阶段的工作。然后 P1 的方案已经不能在第二阶段被批准了（因为 <code>acceptor</code> 已经批准了比 M1 更大的 M2），所以 P1 自增方案变为 M3 重新进入 <code>Prepare</code> 阶段，然后 <code>acceptor</code> ，又批准了新的 M3 方案，它又不能批准 M2 了，这个时候 M2 又自增进入 <code>Prepare</code> 阶段。。。</p>
<p>就这样无休无止的永远提案下去，这就是 <code>paxos</code> 算法的死循环问题。</p>
<p>那么如何解决呢？很简单，人多了容易吵架，我现在 <strong>就允许一个能提案</strong> 就行了。</p>
<h1 id="RocketMQ选择异步-同步刷盘，异步-同步复制，背后的CP和AP思考"><a href="#RocketMQ选择异步-同步刷盘，异步-同步复制，背后的CP和AP思考" class="headerlink" title="RocketMQ选择异步/同步刷盘，异步/同步复制，背后的CP和AP思考"></a>RocketMQ选择异步/同步刷盘，异步/同步复制，背后的CP和AP思考</h1><p>虽然同步刷盘/异步刷盘，同步/异步复制，并没有对cAP直接的应用，但在配置的过程中也一样涉及到可用性和一致性的考虑</p>
<h4 id="同步刷盘-异步刷盘"><a href="#同步刷盘-异步刷盘" class="headerlink" title="同步刷盘/异步刷盘"></a>同步刷盘/异步刷盘</h4><p>RocketMQ的消息是可以做到持久化的，数据会持久化到磁盘，RocketMQ为了提高性能，尽可能保证磁盘的顺序写入，消息在Producer写入RocketMq的时候，有两种写入磁盘方式：</p>
<ol>
<li>异步刷盘： 消息快速写入到内存的pagecache，就立马返回写成功状态，当内存的消息累计到一定程度的时候，会触发统一的写磁盘操作。这种方式可以保证大吞吐量，但也存在着消息可能未存入磁盘丢失的风险。</li>
<li>同步刷盘： 消息快速写入内存的pagecahe，立刻通知刷盘线程进行刷盘，等待刷盘完成之后，唤醒等待的线程，返回消息写成功的状态。</li>
</ol>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/RocketMQ.png?ynotemdtimestamp=1618994173556" alt="image"></p>
<h4 id="同步复制-异步复制"><a href="#同步复制-异步复制" class="headerlink" title="同步复制/异步复制"></a>同步复制/异步复制</h4><p>一个broker组有Master和Slave，消息需要从Master复制到Slave上，所以有同步和异步两种复制方式。</p>
<ol>
<li>同步复制： 是等Master和Slave均写成功后才反馈给客户端写成功状态。</li>
<li>异步复制： 是只要Master写成功即可反馈给客户端写成功状态。</li>
</ol>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/RocketMQ1.png?ynotemdtimestamp=1618994173556" alt="image"></p>
<p>异步复制的优点是可以提高响应速度，但牺牲了一致性 ，一般实现该类协议的算法需要增加额外的补偿机制。同步复制的优点是可以保证一致性(一般通过两阶段提交协议)，但是开销较大，可用性不好(参见CAP定理)，带来了更多的冲突和死锁等问题。值得一提的是Lazy+Primary/Copy的复制协议在实际生产环境中是非常实用的。</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E5%88%86%E5%B8%83%E5%BC%8F/RocketMQ2.png?ynotemdtimestamp=1618994173556" alt="image"></p>
<p>RocketMQ的设置要结合业务场景，合理设置刷盘方式和主从复制方式，尤其是SYNC_FLUSH方式，由于频繁的触发写磁盘动作，会明显降低性能。通常情况下，应该把Master和Slave设置成ASYNC_FLUSH的刷盘方式，主从之间配置成SYNC_MASTER的复制方式，这样即使有一台机器出故障，仍然可以保证数据不丢</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/21/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8FID/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/21/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8FID/" itemprop="url">分步式-分布式ID</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-21T17:15:57+08:00">
                2021-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8FID/" itemprop="url" rel="index">
                    <span itemprop="name">分步式 - 分布式ID</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h1><p>通用唯一标识码，保证每一条记录的id都是不同的</p>
<p>缺点：只是一个单纯的id，没有实际意义，长度32位，太长</p>
<p><strong>MyCat不支持UUID</strong>，<strong>Sharding-Jdbc</strong>支持UUID的方式</p>
<h1 id="MyCat全局Id（本地文件和数据库）"><a href="#MyCat全局Id（本地文件和数据库）" class="headerlink" title="MyCat全局Id（本地文件和数据库）"></a>MyCat全局Id（本地文件和数据库）</h1><ul>
<li><p>ID的值统一的从一个集中的ID序列生成器中获取</p>
<p><strong>MyCat支持ID序列生成器</strong>，<strong>Sharding-Jdbc不支持ID序列生成器</strong></p>
</li>
<li><p>MyCat中有两种方式：本地文件方式和数据库方式</p>
<p><strong>本地文件有弊端：当MyCat重启后会从新从本地文件中读取，因为MyCat启动时会将本地文件加载到内存,第数据库方式则可以解决</strong></p>
</li>
<li><p>本地文件用于测试，数据库方式用于生产</p>
</li>
</ul>
<p>缺点：并发量大时，ID生成器压力较大</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--0:本地文件|2:本地时间戳(雪花算法)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;property name=&quot;sequnceHandlerPattern&quot;&gt;(?:(\s*next\s+value\s+for\s*MYCATSEQ_(\w+))(,|\)|\s)*)+&lt;/property&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--必须带有MYCATSEQ_或者 mycatseq_进入序列匹配流程 注意MYCATSEQ_有空格的情况--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerPattern&quot;</span>&gt;</span>(?:(\s*next\s+value\s+for\s*MYCATSEQ_(\w+))(,|\)|\s)*)+<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>sequence_conf.properties——本地文件配置——sequnceHandlerType：0</li>
<li>sequence_db_conf.properties——数据库表配置——sequnceHandlerType：1</li>
<li>sequence_distributed_conf.properties——分布式配置（基于zookeeper）</li>
<li>sequence_time_conf.properties——本地时间戳配置(雪花算法)——sequnceHandlerType：2</li>
</ul>
<h2 id="本地文件配置"><a href="#本地文件配置" class="headerlink" title="本地文件配置"></a>本地文件配置</h2><ul>
<li>sequence_conf.properties<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#default global sequence</span></span><br><span class="line"><span class="meta">GLOBAL.HISIDS</span>=<span class="string"></span></span><br><span class="line"><span class="meta">GLOBAL.MINID</span>=<span class="string">10001</span></span><br><span class="line"><span class="meta">GLOBAL.MAXID</span>=<span class="string">20000</span></span><br><span class="line"><span class="meta">GLOBAL.CURID</span>=<span class="string">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># self define sequence</span></span><br><span class="line"><span class="comment"># MALL_ORDER一定要与数据库表明匹配上</span></span><br><span class="line"><span class="meta">MALL_ORDER.HISIDS</span>=<span class="string"></span></span><br><span class="line"><span class="comment">#最小</span></span><br><span class="line"><span class="meta">MALL_ORDER.MINID</span>=<span class="string">1001</span></span><br><span class="line"><span class="comment">#最大</span></span><br><span class="line"><span class="meta">MALL_ORDER.MAXID</span>=<span class="string">2000000</span></span><br><span class="line"><span class="meta">MALL_ORDER.CURID</span>=<span class="string">1000</span></span><br></pre></td></tr></table></figure></li>
<li>schema.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;mall_order&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">primayKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn129,dn130&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;order_item&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mall_order(id,total_amount,order_status)<span class="keyword">values</span>(<span class="number">88</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h2><ol>
<li>在一个节点(129)运行conf中的<code>dbseq.sql</code>生成<code>MYCAT_SEQUENCE</code></li>
</ol>
<table>
<thead>
<tr>
<th>name</th>
<th>current_value</th>
<th>increment</th>
</tr>
</thead>
<tbody><tr>
<td>GLOBAL</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>MALL_ORDER</td>
<td>10000</td>
<td>1</td>
</tr>
</tbody></table>
<p>name需要和自己的表名一致</p>
<ol start="2">
<li>sequence_db_conf.properties</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sequence stored in datanode</span></span><br><span class="line"><span class="attr">GLOBAL</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">COMPANY</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">CUSTOMER</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">MALL_ORDER</span>=<span class="string">dn129</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mall_order(id,total_amount,order_status)<span class="keyword">values</span>(<span class="number">88</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<h1 id="雪花算法"><a href="#雪花算法" class="headerlink" title="雪花算法"></a>雪花算法</h1><ul>
<li>一个64bit的long型的数字</li>
<li>引入时间戳，保持自增</li>
</ul>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p>0+41为时间戳+5位机房id+5位机器id+12位序列号</p>
<p>支持毫秒级的并发数位4096，但时间回调可能引起id重复，<strong>MyCat支持</strong>雪花算法，<strong>Sharding-Jdbc</strong>支持雪花算法的方式。<strong>Sharding-Jdbc</strong>可设置最大容忍回调时间</p>
<p><strong>使用时注意</strong>：</p>
<ol>
<li><code>&lt;property name=&quot;sequnceHandlerType&quot;&gt;2&lt;/property&gt;</code></li>
<li><strong>id的类型位long</strong></li>
<li><strong>分片规则，id的类型位long用合适的规则</strong></li>
</ol>
<ul>
<li><p>sequence_time_conf.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">  #sequence depend on TIME</span></span><br><span class="line"><span class="comment">  #mycat部署多台可以设置不同的值</span></span><br><span class="line"><span class="comment">  #机器</span></span><br><span class="line">  <span class="attr">WORKID</span>=<span class="string">01</span></span><br><span class="line"><span class="comment">  #机房</span></span><br><span class="line"><span class="attr">DATAACENTERID</span>=<span class="string">01</span></span><br></pre></td></tr></table></figure>

<p><strong>WORKID和DATAACENTERID不能超过32，因为5bit是2的5次方=32</strong></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/20/%E4%B8%AD%E9%97%B4%E4%BB%B6-RabbitMQ%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/20/%E4%B8%AD%E9%97%B4%E4%BB%B6-RabbitMQ%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE/" itemprop="url">中间件-RabbitMQ集群配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-20T23:02:25+08:00">
                2021-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rabbitmq-rabbitmq%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE/" itemprop="url" rel="index">
                    <span itemprop="name">rabbitmq - rabbitmq集群配置</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何保证高可用的"><a href="#如何保证高可用的" class="headerlink" title="如何保证高可用的"></a>如何保证高可用的</h1><p>RabbitMQ 有三种模式：单机模式、普通集群模式、镜像集群模式。</p>
<ul>
<li><p><strong>单机模式普通集群模式</strong>(不会去用的)</p>
<p>多台机器上启动多个 RabbitMQ 实例，每个机器启动一个。你创建的queue，只会放在<br>一个 RabbitMQ 实例上，但是每个实例都同步 queue 的元数据（元数据可以认为是queue 的一些配置<br>信息，通过元数据，可以找到 queue 所在实例）。你消费的时候，实际上如果连接到了另外一个实<br>例，那么那个实例会从 queue 所在实例上拉取数据过来</p>
<p>这方案主要是提高吞吐量的，就是说让集群中多个节点来服务某个 queue 的读写操作。</p>
</li>
<li><p><strong>镜像集群模式</strong></p>
<p>在镜像集群模式下，你创建的 queue，无论元数据还是 queue 里的消息都会存在于多个实例上，就是说，每<br>个 RabbitMQ 节点都有这个 queue 的一个完整镜像，包含 queue 的全部数据的意思。然后每次你写消息到 queue 的时候，都会自动把消息同步到多个实例的 queue 上。</p>
<p>好处：你任何一个机器宕机了不影响，其它机器（节点）还包含了这个 queue 的完整数据，别的 consumer 都可以到其它节点上去消费数据。</p>
<p>坏处在于，第一，这个性能开销也太大了，消息需要同步到所有机器上，导致网络带宽压力和消耗很重！</p>
</li>
</ul>
<h1 id="镜像模式"><a href="#镜像模式" class="headerlink" title="镜像模式"></a>镜像模式</h1><p>你创建的 queue，无论元数据还是 queue 里的消息都会存在于多个实例上，然后每次你写消息到,queue 的时候，都会自动把消息到多个实例的 queue 里进行消息同步。</p>
<p><strong>好处</strong>:</p>
<p>你任何一个机器宕机了，别的机器都可以用。</p>
<p><strong>坏处</strong>:</p>
<p>第一，这个性能开销也太大了，消息同步所有机器，导致网络带宽压力和消耗很重</p>
<p>第二，就没有扩展性可言了，如果某个 queue 负载很重，你加机器，新增的机器也包含了这个 queue 的所有数据，并没有办法线性扩展你的 queue</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E9%9B%86%E7%BE%A4.png"></p>
<table>
<thead>
<tr>
<th>服务器IP</th>
<th>hostname</th>
<th>节点说明</th>
<th>端口</th>
<th>管控台地址</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.159.128</td>
<td>ly128</td>
<td>rabbitmq  master</td>
<td>5672</td>
<td><a target="_blank" rel="noopener" href="http://192.168.159.128:15672/">http://192.168.159.128:15672</a></td>
</tr>
<tr>
<td>192.168.159.129</td>
<td>ly129</td>
<td>rabbitmq  slave</td>
<td>5672</td>
<td><a target="_blank" rel="noopener" href="http://192.168.159.129:15672/">http://192.168.159.129:15672</a></td>
</tr>
<tr>
<td>192.168.159.130</td>
<td>ly130</td>
<td>rabbitmq  slave</td>
<td>5672</td>
<td><a target="_blank" rel="noopener" href="http://192.168.159.130:15672/">http://192.168.159.130:15672</a></td>
</tr>
</tbody></table>
<h2 id="启动三台rabbitmq"><a href="#启动三台rabbitmq" class="headerlink" title="启动三台rabbitmq"></a>启动三台rabbitmq</h2><p>指令操作</p>
<h2 id="文件同步步骤"><a href="#文件同步步骤" class="headerlink" title="文件同步步骤"></a>文件同步步骤</h2><blockquote>
<p>选择128、129、130任意一个节点为Master（这里选择128为Master），也就是说我们需要把128的Cookie文件同步到129、130节点上去</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /var/lib/rabbitmq/.erlang.cookie 192.168.159.129:/var/lib/rabbitmq/</span><br><span class="line">scp /var/lib/rabbitmq/.erlang.cookie 192.168.159.130:/var/lib/rabbitmq/</span><br></pre></td></tr></table></figure>

<h2 id="组成集群步骤"><a href="#组成集群步骤" class="headerlink" title="组成集群步骤"></a>组成集群步骤</h2><ol>
<li>停止MQ服务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./rabbitmqctl stop_app</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改集群配置</li>
</ol>
<blockquote>
<p>接下来我们就可以使用集群命令，配置128、129、130为集群模式，3个节点（128、129、130）执行启动命令，后续启动集群使用此命令即可</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/rabbitmq/rabbitmq/etc/rabbitmq/</span><br><span class="line">vim rabbitmq-env.conf </span><br></pre></td></tr></table></figure>

<p>添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RABBITMQ_NODE_IP_ADDRESS&#x3D;192.168.159.128         #这里要与当前服务器ip对应</span><br><span class="line">RABBITMQ_NODE_PORT&#x3D;5672</span><br><span class="line">RABBITMQ_LOG_BASE&#x3D;&#x2F;usr&#x2F;local&#x2F;rabbitmq&#x2F;rabbitmq&#x2F;data</span><br><span class="line">RABBITMQ_MNESIA_BASE&#x3D;&#x2F;usr&#x2F;local&#x2F;rabbitmq&#x2F;rabbitmq&#x2F;data&#x2F;mnesia</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>加入集群操作</li>
</ol>
<p>在两台从节点分别使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./rabbitmqctl join_cluster rabbit@ly128</span><br><span class="line">./rabbitmqctl start_app</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/20/%E4%B8%AD%E9%97%B4%E4%BB%B6-RabbitMQ%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/20/%E4%B8%AD%E9%97%B4%E4%BB%B6-RabbitMQ%E5%AD%A6%E4%B9%A0/" itemprop="url">中间件-RabbitMQ学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-20T15:37:09+08:00">
                2021-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rabbitmq-rabbitmq%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">rabbitmq - rabbitmq学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是-rabbitmq"><a href="#什么是-rabbitmq" class="headerlink" title="什么是 rabbitmq"></a>什么是 rabbitmq</h1><p>采用 AMQP 高级消息队列协议的一种消息队列技术,最大的特点就是消费并不需要确保提供方存在,实现了服务之间的高度解耦</p>
<h1 id="为什么使用MQ？MQ的优点"><a href="#为什么使用MQ？MQ的优点" class="headerlink" title="为什么使用MQ？MQ的优点"></a>为什么使用MQ？MQ的优点</h1><ul>
<li>异步处理 - 相比于传统的串行、并行方式，提高了系统吞吐量。</li>
<li>应用解耦 - 系统间通过消息通信，不用关心其他系统的处理。</li>
<li>流量削锋 - 可以通过消息队列长度控制请求量；可以缓解短时间内的高并发请求。</li>
<li>日志处理 - 解决大量日志传输。</li>
<li>消息通讯 - 消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等。</li>
</ul>
<h1 id="使用消息队列有什么优点、缺点"><a href="#使用消息队列有什么优点、缺点" class="headerlink" title="使用消息队列有什么优点、缺点"></a>使用消息队列有什么优点、缺点</h1><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><p>异步、解耦、消峰填谷这是消息队列最大的优点</p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>系统复杂性增加：加了消息队列，需要保证消息不会重复消费，需要保证消息的可靠性，需要保证消息队列的高可用</li>
<li>系统的可用性降低：如果消息队列挂了，那么系统也会受到影响</li>
</ul>
<h1 id="Kafka、ActiveMQ、RabbitMQ、RocketMQ-有什么优缺点？"><a href="#Kafka、ActiveMQ、RabbitMQ、RocketMQ-有什么优缺点？" class="headerlink" title="Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？"></a>Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</h1><table>
<thead>
<tr>
<th></th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
<th>ZeroMQ</th>
</tr>
</thead>
<tbody><tr>
<td>单机吞吐量</td>
<td>比RabbitMQ低</td>
<td>2.6w/s（消息做持久化）</td>
<td>11.6w/s</td>
<td>17.3w/s</td>
<td>29w/s</td>
</tr>
<tr>
<td>开发语言</td>
<td>Java</td>
<td>Erlang</td>
<td>Java</td>
<td>Scala/Java</td>
<td>C</td>
</tr>
<tr>
<td>主要维护者</td>
<td>Apache</td>
<td>Mozilla/Spring</td>
<td>Alibaba</td>
<td>Apache</td>
<td>iMatix，创始人已去世</td>
</tr>
<tr>
<td>成熟度</td>
<td>成熟</td>
<td>成熟</td>
<td>开源版本不够成熟</td>
<td>比较成熟</td>
<td>只有C、PHP等版本成熟</td>
</tr>
<tr>
<td>订阅形式</td>
<td>点对点(p2p)、广播（发布-订阅）</td>
<td>提供了4种：direct, topic ,Headers和fanout。fanout就是广播模式</td>
<td>基于topic/messageTag以及按照消息类型、属性进行正则匹配的发布订阅模式</td>
<td>基于topic以及按照topic进行正则匹配的发布订阅模式</td>
<td>点对点(p2p)</td>
</tr>
<tr>
<td>持久化</td>
<td>支持少量堆积</td>
<td>支持少量堆积</td>
<td>支持大量堆积</td>
<td>支持大量堆积</td>
<td>不支持</td>
</tr>
<tr>
<td>顺序消息</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>性能稳定性</td>
<td>好</td>
<td>好</td>
<td>一般</td>
<td>较差</td>
<td>很好</td>
</tr>
<tr>
<td>集群方式</td>
<td>支持简单集群模式，比如’主-备’，对高级集群模式支持不好。</td>
<td>支持简单集群，’复制’模式，对高级集群模式支持不好。</td>
<td>常用 多对’Master-Slave’ 模式，开源版本需手动切换Slave变成Master</td>
<td>天然的‘Leader-Slave’无状态集群，每台服务器既是Master也是Slave</td>
<td>不支持</td>
</tr>
<tr>
<td>管理界面</td>
<td>一般</td>
<td>较好</td>
<td>一般</td>
<td>无</td>
<td>无</td>
</tr>
</tbody></table>
<p>使用建议：</p>
<ul>
<li>ActiveMQ，但是现在确实大家用的不多了，没经过大规模吞吐量场景的验证，社区也不是很活跃</li>
<li>RabbitMQ，但是确实 erlang 语言阻止了大量的Java工程师去深入研究和掌控它，开源，有稳定的支持，活跃度也高</li>
<li>RocketMQ，GitHub 上的活跃度其实不算高</li>
<li>大数据领域的实时计算、日志采集等场景，用 Kafka</li>
</ul>
<h1 id="消息中间件示例"><a href="#消息中间件示例" class="headerlink" title="消息中间件示例"></a>消息中间件示例</h1><h2 id="电商系统"><a href="#电商系统" class="headerlink" title="电商系统"></a>电商系统</h2><p>消息队列采用高可用，可持久化的消息中间件。比如Active MQ，Rabbit MQ，Rocket Mq。</p>
<p>（1）应用将主干逻辑处理完成后，写入消息队列。消息发送是否成功可以开启消息的确认模式。（消息队列返回消息接收成功状态后，应用再返回，这样保障消息的完整性）</p>
<p>（2）扩展流程（发短信，配送处理）订阅队列消息。采用推或拉的方式获取消息并处理。</p>
<p>（3）消息将应用解耦的同时，带来了数据一致性问题，可以采用最终一致性方式解决。比如主数据写入数据库，扩展应用根据消息队列，并结合数据库方式实现基于消息队列的后续处理。</p>
<h2 id="日志收集系统"><a href="#日志收集系统" class="headerlink" title="日志收集系统"></a>日志收集系统</h2><p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/ELK.png"></p>
<h1 id="AMQP核心概念"><a href="#AMQP核心概念" class="headerlink" title="AMQP核心概念"></a>AMQP核心概念</h1><ul>
<li><p>Server：又称Broker，接受客户端的连接，实现AMQP实体服务</p>
</li>
<li><p>Channel：网络信道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的通道。客户端可建立多个Channel，每个Channel代表一个会话任务</p>
</li>
<li><p>Message：消息，服务器和应用程序之间传送的数据，由Properties和Body组成。Properties可以对消息进行修饰，比如消息的优先级、延迟等高级特性；Body则就是消息体内容。</p>
</li>
<li><p>Virtual host：虚拟地址，用于进行逻辑隔离，有最上层的消息路由。一个VH里面可以有若干个Exchange和Queue，同一个Virtual Host里面不能有相同名称的Exchange或Queue</p>
</li>
<li><p>Exchange：交换机，接受消息，根据路右键转发消息到绑定的队列</p>
</li>
<li><p>Binding：Exchange和Queue之间的虚拟连接,binding中可以包含routing key</p>
</li>
<li><p>routing key：一个路由规则，虚拟机可用它来确认如何路由一个特定消息</p>
</li>
<li><p>Queue：消息队列，保存消息并将他们转发消费者</p>
</li>
</ul>
<h1 id="RabbitMQ的整体架构"><a href="#RabbitMQ的整体架构" class="headerlink" title="RabbitMQ的整体架构"></a>RabbitMQ的整体架构</h1><p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.png"></p>
<blockquote>
<p>Exchange和Queue可以设置多对多关系；但真实开发时使用一个Exchange对应多个队列，因为消息体和内容不一致，实现起来会很麻烦；</p>
<p>Consume和Queue可以设置1对多，但真实开发也不会使用</p>
</blockquote>
<h2 id="消息基于什么传输？"><a href="#消息基于什么传输？" class="headerlink" title="消息基于什么传输？"></a><strong>消息基于什么传输？</strong></h2><p>由于 TCP 连接的创建和销毁开销较大，且并发数受系统资源限制，会造成性能瓶颈。RabbitMQ 使用信道的方式来传输数据。信道是建立在真实的 TCP 连接内的虚拟连接，且每条 TCP 连接上的信道数量没有限制。\</p>
<h2 id="消息如何分发？"><a href="#消息如何分发？" class="headerlink" title="消息如何分发？"></a>消息如何分发？</h2><p>若该队列至少有一个消费者订阅，消息将以循环（round-robin）的方式发送给消费者。每条消息只会<br>分发给一个订阅的消费者（前提是消费者能够正常处理消息并进行确认）。<br>通过路由可实现多消费的功能</p>
<h1 id="消息怎么路由？"><a href="#消息怎么路由？" class="headerlink" title="消息怎么路由？"></a>消息怎么路由？</h1><p>消息提供方-&gt;路由-&gt;一至多个队列<br>消息发布到交换机时，消息将拥有一个路由键（routing key），在消息创建时设定。通过队列路由键，可以把队列绑定到交换器上。消息到达交换器后，RabbitMQ 会将消息的路由键与队列的路由键进行匹配（针对不同的交换器有不同的路由规则）；<br>常用的交换器主要分为一下三种<br>fanout：如果交换器收到消息，将会广播到所有绑定的队列上<br>direct：如果路由键完全匹配，消息就被投递到相应的队列<br>topic：可以使来自不同源头的消息能够到达同一个队列。 使用 topic 交换器时，可以使用通配符</p>
<h2 id="RabbitMQ相关概念"><a href="#RabbitMQ相关概念" class="headerlink" title="RabbitMQ相关概念"></a>RabbitMQ相关概念</h2><p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F.png"></p>
<table>
<thead>
<tr>
<th>标志</th>
<th>中文名</th>
<th>英文名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>P</td>
<td>生产者</td>
<td>Producer</td>
<td>消息的发送者，可以将消息发送到交换机</td>
</tr>
<tr>
<td>C</td>
<td>消费者</td>
<td>Consumer</td>
<td>消息的接收者，从队列中获取消息并进行消费</td>
</tr>
<tr>
<td>X</td>
<td>交换机</td>
<td>Exchange</td>
<td>接收生产者发送的消息，并根据路由键发送给指定队列</td>
</tr>
<tr>
<td>Q</td>
<td>队列</td>
<td>Queue</td>
<td>存储从交换机发来的消息</td>
</tr>
</tbody></table>
<hr>
<p><strong>Exchange属性</strong>：</p>
<ul>
<li>Name：交换机名称</li>
<li><strong>type</strong> 交换机类型，不同类型的交换机转发消息方式不同               <ul>
<li>fanout发布/订阅模式，广播消息给所有绑定交换机的队列</li>
<li>direct路由模式，根据路由键发送消息</li>
<li>topic通配符模式，根据路由键的匹配规则发送消息</li>
</ul>
</li>
<li>Durability：是否开启持久化，true为开启</li>
<li>Auto Delete：当最后一个绑定到该Exchange上的队列删除后，自动删除该Exchange</li>
</ul>
<h2 id="5种消息模式-消息怎么路由"><a href="#5种消息模式-消息怎么路由" class="headerlink" title="5种消息模式(消息怎么路由)"></a>5种消息模式(消息怎么路由)</h2><p>参考<a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/reference/rabbitmq_start?id=%E8%BF%9Erabbitmq%E7%9A%845%E7%A7%8D%E6%A0%B8%E5%BF%83%E6%B6%88%E6%81%AF%E6%A8%A1%E5%BC%8F%E9%83%BD%E4%B8%8D%E6%87%82%EF%BC%8C%E4%B9%9F%E6%95%A2%E8%AF%B4%E8%87%AA%E5%B7%B1%E4%BC%9A%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%81">连RabbitMQ的5种核心消息模式都不懂，也敢说自己会用消息队列！</a></p>
<h3 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a>简单模式</h3><blockquote>
<p>简单模式是最简单的消息模式，它包含一个生产者、一个消费者和一个队列。生产者向队列里发送消息，消费者从队列中获取消息并消费。</p>
</blockquote>
<h4 id="示意图"><a href="#示意图" class="headerlink" title="示意图"></a>示意图</h4><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E7%AE%80%E5%8D%95%E6%A8%A1%E5%BC%8F.png" style="zoom:67%;" />

<h3 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h3><blockquote>
<p>工作模式是指向多个互相竞争的消费者发送消息的模式，它包含一个生产者、两个消费者和一个队列。两个消费者同时绑定到一个队列上去，当消费者获取消息处理耗时任务时，空闲的消费者从队列中获取并消费消息。</p>
</blockquote>
<h4 id="示意图-1"><a href="#示意图-1" class="headerlink" title="示意图"></a>示意图</h4><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F.png" style="zoom:67%;" />

<h3 id="发布-fanout-模式"><a href="#发布-fanout-模式" class="headerlink" title="发布(fanout)模式"></a>发布(fanout)模式</h3><blockquote>
<p>发布/订阅模式是指同时向多个消费者发送消息的模式（类似广播的形式），它包含一个生产者、两个消费者、两个队列和一个交换机。两个消费者同时绑定到不同的队列上去，两个队列绑定到交换机上去，生产者通过发送消息到交换机，所有消费者接收并消费消息。</p>
</blockquote>
<h4 id="示意图-2"><a href="#示意图-2" class="headerlink" title="示意图"></a>示意图</h4><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F.png" style="zoom:67%;" />

<h3 id="路由-Direct-模式"><a href="#路由-Direct-模式" class="headerlink" title="路由(Direct)模式"></a>路由(Direct)模式</h3><blockquote>
<p>路由模式是可以根据<code>路由键</code>选择性给多个消费者发送消息的模式，它包含一个生产者、两个消费者、两个队列和一个交换机。两个消费者同时绑定到不同的队列上去，两个队列通过<code>路由键</code>绑定到交换机上去，生产者发送消息到交换机，交换机通过<code>路由键</code>转发到不同队列，队列绑定的消费者接收并消费消息。</p>
</blockquote>
<h4 id="示意图-3"><a href="#示意图-3" class="headerlink" title="示意图"></a>示意图</h4><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F.png" style="zoom:67%;" />

<p><em>注意：</em></p>
<p><strong>Direct模式可以使用RabbitMQ自带的Exchange：default Exchange，所以不用将Exchange进行任何绑定操作，消息传递时，RouteKey必须完全匹配才会被队列接受，否则会被抛弃</strong></p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F2.png" style="zoom:50%;" />

<h3 id="通配符-topic-模式"><a href="#通配符-topic-模式" class="headerlink" title="通配符(topic)模式"></a>通配符(topic)模式</h3><blockquote>
<p>通配符模式是可以根据<code>路由键匹配规则</code>选择性给多个消费者发送消息的模式，它包含一个生产者、两个消费者、两个队列和一个交换机。两个消费者同时绑定到不同的队列上去，两个队列通过<code>路由键匹配规则</code>绑定到交换机上去，生产者发送消息到交换机，交换机通过<code>路由键匹配规则</code>转发到不同队列，队列绑定的消费者接收并消费消息。</p>
</blockquote>
<h4 id="特殊匹配符号"><a href="#特殊匹配符号" class="headerlink" title="特殊匹配符号"></a>特殊匹配符号</h4><ul>
<li><code>*</code>：只能匹配一个单词；</li>
<li><code>#</code>：可以匹配零个或多个单词。</li>
</ul>
<p>例如：“log.#”能匹配到“log.info.oa”</p>
<p>​            “log.*”只会匹配到“log.error”</p>
<h4 id="示意图-4"><a href="#示意图-4" class="headerlink" title="示意图"></a>示意图</h4><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbit%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A8%A1%E5%BC%8F.png" style="zoom:67%;" />

<h1 id="RabbitMQ高级特性"><a href="#RabbitMQ高级特性" class="headerlink" title="RabbitMQ高级特性"></a>RabbitMQ高级特性</h1><h2 id="生产端的可靠性投递"><a href="#生产端的可靠性投递" class="headerlink" title="生产端的可靠性投递"></a>生产端的可靠性投递</h2><ul>
<li>保障消息的成功发出</li>
<li>保障MQ节点的成功接收</li>
<li>发送端收到MQ节点（Broker）确认应答</li>
<li>完善的消息进行补偿机制</li>
</ul>
<h2 id="消费端-幂等性保障"><a href="#消费端-幂等性保障" class="headerlink" title="消费端-幂等性保障"></a>消费端-幂等性保障</h2><ul>
<li>业务唯一ID（或）指纹码（时间戳之类的唯一证明）机制，利用数据库主键去重</li>
</ul>
<h2 id="Confirm确认消息"><a href="#Confirm确认消息" class="headerlink" title="Confirm确认消息"></a>Confirm确认消息</h2><p>将信道设置成 confirm 模式（发送方确认模式），则所有在信道上发布的消息都会被指派一个唯一的 ID。</p>
<p>一旦消息被投递到目的队列后，或者消息被写入磁盘后（可持久化的消息），信道会发送一个确认给生产者（包含消息唯一 ID）。</p>
<p>如果 RabbitMQ 发生内部错误从而导致消息丢失，会发送一条 nack（notacknowledged，未确认）消息。</p>
<p>发送方确认模式是异步的，生产者应用程序在等待确认的同时，可以继续发送消息。当确认消息到达生产者应用程序，生产者应用程序的回调方法就会被触发来处理确认消息。</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6%E6%B5%81%E7%A8%8B%E5%9B%BE.png" style="zoom:50%;" />

<h3 id="如何开启Confirm确认消息"><a href="#如何开启Confirm确认消息" class="headerlink" title="如何开启Confirm确认消息"></a>如何开启Confirm确认消息</h3><p>第一步：在channel上开启确认模式：<code>channel.confirmSelect()</code></p>
<p>第二部：在channel上添加监听：addConfirmListener,监听成功和失败返回结果，根据具体的结果对消息进行重新发送、或记录日志等或许处理</p>
<h2 id="Renturn消息机制"><a href="#Renturn消息机制" class="headerlink" title="Renturn消息机制"></a>Renturn消息机制</h2><ul>
<li>Return Listener 用于处理一些不可路由的消息</li>
<li>生产者指定Exchange和RoutingKey，将消息投递到某个队列，然后消费者监听队列，进行消息处理</li>
<li>但在某些情况下，在发送消息时，若当前的exchange不存在或指定的路由key路由失败，这时，如果需要监听这种不可达的消息，则要使用return listener</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/Return%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6.png" style="zoom:50%;" />

<h3 id="API配置"><a href="#API配置" class="headerlink" title="API配置"></a>API配置</h3><p>Mandatory：如果为true，则监听器会接收到路由不可达的消息，然后进行后续的处理，如果为false,那么broker端会自动删除该消息</p>
<h2 id="消费端限流"><a href="#消费端限流" class="headerlink" title="消费端限流"></a>消费端限流</h2><p>RabbitMQ提供一种qos(服务质量保证)功能，即在非自动确认消息的前提下，如果一定数目的消息（通过基于consume或者channel设置的Qos值）未被确认前，不进行消费新的消息</p>
<h2 id="消费端的手工ACK和NACK"><a href="#消费端的手工ACK和NACK" class="headerlink" title="消费端的手工ACK和NACK"></a>消费端的手工ACK和NACK</h2><p>消费端进行消费的时候由于业务异常我们可以进行日志的记录，然后进行补偿</p>
<p>如果因为服务器宕机等严重问题，那我们就需要手工进行ACK保障消费端消费成功</p>
<p>成功消费会ack，失败则会NACK</p>
<h2 id="消费端重回队列（可以忽视）"><a href="#消费端重回队列（可以忽视）" class="headerlink" title="消费端重回队列（可以忽视）"></a>消费端重回队列（可以忽视）</h2><p>消费端重回队列是为了对没有处理成功的消息，把消息重新递给Broker</p>
<blockquote>
<p>生产环境不用，影响性能（假设队列只有一条消息，处理失败会一直重新投递，死循环），自己多补偿或兜底</p>
</blockquote>
<h2 id="TTL队列（死信队列）"><a href="#TTL队列（死信队列）" class="headerlink" title="TTL队列（死信队列）"></a>TTL队列（死信队列）</h2><ul>
<li>DLX（死信队列），利用DLX，当消息在一个队列中变成死信（dead message）之后，他能被重新publish到另一个Exchange，这个Exchange就是DLX</li>
</ul>
<h3 id="消息变成死信队列的情况"><a href="#消息变成死信队列的情况" class="headerlink" title="消息变成死信队列的情况"></a>消息变成死信队列的情况</h3><ul>
<li>消息被拒绝(basic.reject/basic.nack)并且requeue=false(重回队列不开启)</li>
<li>消息TTL过期</li>
<li>队列打到最大长度</li>
</ul>
<h1 id="rabbitmq队列列与消费者的关系？"><a href="#rabbitmq队列列与消费者的关系？" class="headerlink" title="rabbitmq队列列与消费者的关系？"></a>rabbitmq队列列与消费者的关系？</h1><ol>
<li>一个队列列可以绑定多个消费者；</li>
<li>消息默认以循环的方式发送给消费者；</li>
<li>消费者收到消息默认自动确认，也可以改成手动确认。</li>
</ol>
<h1 id="RabbitMQ消息100-可靠性投递的解决方案实现"><a href="#RabbitMQ消息100-可靠性投递的解决方案实现" class="headerlink" title="RabbitMQ消息100%可靠性投递的解决方案实现"></a>RabbitMQ消息100%可靠性投递的解决方案实现</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012211603/article/details/85707760">RabbitMQ消息中间件技术精讲（三）—— 深入RabbitMQ高级特性</a></p>
</blockquote>
<p><strong>如何保证消息的可靠传输？如果消息丢了怎么办</strong></p>
<h2 id="数据丢失问题"><a href="#数据丢失问题" class="headerlink" title="数据丢失问题"></a>数据丢失问题</h2><p>可能出现在生产者、MQ、消费者</p>
<h3 id="生产者丢失"><a href="#生产者丢失" class="headerlink" title="生产者丢失"></a>生产者丢失</h3><ol>
<li><p><strong>开启RabbitMQ事务</strong>（同步，不推荐，吞吐量会下来，因为太耗性能）</p>
<p>生产者发送数据之前开启 RabbitMQ事务channel.txSelect，然后发送消息，如果消息没有成功被 RabbitMQ 接收到，那么生产者会收到异常报错，此时就可以回滚事务channel.txRollback，然后重试发送消息；如果收到了消息，那么可以提交事务channel.txCommit。</p>
</li>
<li><p><strong>开启confirm模式</strong>（异步，推荐）</p>
<p>每次写的消息都会分配一个唯一的 id，然后如果写入了 RabbitMQ 中，RabbitMQ 会给你回传一个ack消息，告诉你说这个消息 ok 了。如果 RabbitMQ 没能处理这个消息，会回调你一个nack接口，告诉你这个消息<br>接收失败，可以重试。</p>
<p>可以结合这个机制自己在数据库里维护每个消息 id 的状态，如果超过一定时间还没接收到这个消息的回调，那么你可以重发（见常见方案1的strp4左右）</p>
</li>
</ol>
<h3 id="MQ丢失"><a href="#MQ丢失" class="headerlink" title="MQ丢失"></a>MQ丢失</h3><ol>
<li><p>必须开启 RabbitMQ 的持久化，就是消息写入之后会持久化到磁盘，哪怕是 RabbitMQ 自己挂了，恢复之后会自动读取之前存储的数据。设置持久化有两个步骤：</p>
<ul>
<li><p>创建 queue 的时候将其设置为持久化，这样就可以保证 RabbitMQ 持久化 queue 的元数据，但是不会持久化 queue 里的数据。</p>
</li>
<li><p>发送消息的时候将消息的deliveryMode 设置为 2，就是将消息设置为持久化的，此时 RabbitMQ 就会将消息持久化到磁盘上去。RabbitMQ 宕机，重启，也会从磁盘上重启恢复queue，恢复这个 queue 里的数据。</p>
</li>
</ul>
</li>
<li><p>持久化可以跟生产者的confirm机制配合起来，只有消息被持久化到磁盘之后，才会通知生产者ack了，所以哪怕是在持久化到磁盘之前，RabbitMQ 挂了，数据丢了，生产者收不到ack，也是可以自己重发的。</p>
</li>
</ol>
<h3 id="消费端丢失"><a href="#消费端丢失" class="headerlink" title="消费端丢失"></a>消费端丢失</h3><blockquote>
<p>消费的时候，刚消费到，还没处理，结果进程挂了，RabbitMQ 认为你都消费了，这数据就丢了。这个时候得用 RabbitMQ 提供的ack机制</p>
</blockquote>
<p><strong>关闭 RabbitMQ 的自动ack</strong>，可以通过一个 api 来调用，然后每次代码里确保处理完的时候，再在程序里返回ack。如果没有ack，那 RabbitMQ 就认为你还没处理完，这个时候 RabbitMQ 会把这个消费分配给别的consumer 去处理，消息是不会丢的</p>
<h2 id="如何确保消息正确地发送至-RabbitMQ？如何确保消息接收方消费了消息"><a href="#如何确保消息正确地发送至-RabbitMQ？如何确保消息接收方消费了消息" class="headerlink" title="如何确保消息正确地发送至 RabbitMQ？如何确保消息接收方消费了消息?"></a>如何确保消息正确地发送至 RabbitMQ？如何确保消息接收方消费了消息?</h2><ol>
<li><p>发送方确认模式<strong>开启confirm模式</strong></p>
</li>
<li><p><strong>关闭 RabbitMQ 的自动ack</strong></p>
</li>
</ol>
<h2 id="常见解决方案"><a href="#常见解决方案" class="headerlink" title="常见解决方案"></a>常见解决方案</h2><h3 id="常见方案1：消息落库，对消息状态进行打标"><a href="#常见方案1：消息落库，对消息状态进行打标" class="headerlink" title="常见方案1：消息落库，对消息状态进行打标"></a>常见方案1：消息落库，对消息状态进行打标</h3><p><strong>消息落库（持久化至数据库），对消息状态进行打标，如若消息未响应，进行轮询操作</strong></p>
<blockquote>
<p>开启<strong>发送方确认模式</strong>，将信道设置成 confirm 模式（发送方确认模式）</p>
</blockquote>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92.png"></p>
<p>Step1：把业务消息落库，再生成一条消息落库到消息DB用来记录（譬如消息刚创建，正在发送中 status: 0）。（缺点：对数据库进行两次持久化，需要使用事务保证两次投递是原子操作）</p>
<p>Step2：生产端发送消息。</p>
<p>Step3：Broker端收到后，应答至生产端。<code>Confirm Listener</code>异步监听Broker的应答。</p>
<p>Step4：应答表明消息投递成功后，去消息DB中抓取到指定的消息记录，更新状态，如status: 1</p>
<p>Step5：<br>如在Step3中出现网络不稳定等情况，导致Listener未收到消息成功确认的应答。<br>那么消息数据库中的status就还是0，而Broker可能是接收到消息的状态。<br>因此设定一个规则（定时任务），例如消息在落库5分钟后（超时）还是0的状态，就把该条记录抽取出来。</p>
<p>Step6：重新投递<br>Step7：限制一个重试的次数，譬如3次，如果大于3次，即为投递失败，更新status的值。（用补偿机制去查询消息失败的原因，人工）</p>
<h3 id="常见方案2：消息的延迟投递，做二次确认，回调检查"><a href="#常见方案2：消息的延迟投递，做二次确认，回调检查" class="headerlink" title="常见方案2：消息的延迟投递，做二次确认，回调检查"></a>常见方案2：消息的延迟投递，做二次确认，回调检查</h3><p><strong>消息的延迟投递，做二次确认，回调检查（高并发场景）</strong></p>
<blockquote>
<p>开启<strong>发送方确认模式</strong>，将信道设置成 confirm 模式（发送方确认模式）</p>
<p>消费者接收每一条消息后都必须进行确认（消息接收和消息确认是两个不同操作）, 消费端的手工ACK和NACK</p>
</blockquote>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%922.png"></p>
<ul>
<li>Upstream service：上游服务，可能为生产端</li>
<li>Downstream service：下游服务，可能为消费端</li>
<li>MQ Broker：可能为集群</li>
<li>Callback service：回调服务，监听confirm消息</li>
</ul>
<p>Step1：业务消息落库后，发送消息至Broker。</p>
<p>Step2：紧接着发送第二条延迟（设置延迟时间）检查的消息。</p>
<p>Step3：消费端监听指定的队列接收到消息进行处理</p>
<p>Step4：处理完后，生成一条响应消息发送到Broker。</p>
<p>Step5：由Callback服务去监听该响应消息，收到该响应消息后持久化至消息DB（记录成功状态）。</p>
<p>Step6：到了延迟时间，延迟发送的消息也被Callback服务的监听器监听到后，去检查消息DB。如果未查询到成功的状态，Callback服务需要做补偿，发起RPC通讯，让生产端重新发送。生产端通过介绍到的命令中所带的id去数据库查询该业务消息，再重新发送，即跳转到Step1。</p>
<p>该方案减少了对数据库的存储，保证了性能。</p>
<h1 id="如何避免消息重复投递或重复消费"><a href="#如何避免消息重复投递或重复消费" class="headerlink" title="如何避免消息重复投递或重复消费"></a>如何避免消息重复投递或重复消费</h1><p>在消息生产时，MQ 内部针对每条生产者发送的消息生成一个 inner-msg-id，作为去重的依据（消息投递失败并重传），避免重复的消息进入队列；在消息消费时，要求消息体中必须要有一个 bizId（对于同一业务全局唯一，如支付 ID、订单 ID、帖子ID 等）作为去重和幂等的依据，避免同一条消息被重复消费。</p>
<h1 id="如何保证消息的顺序性"><a href="#如何保证消息的顺序性" class="headerlink" title="如何保证消息的顺序性"></a>如何保证消息的顺序性</h1><p>会错乱的场景：RabbitMQ：一个 queue，多个 consumer</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E9%A1%BA%E5%BA%8F%E6%8A%95%E9%80%92.png"></p>
<p><strong>通过合理的设计或者将问题分解来规避。</strong></p>
<ul>
<li>不关注乱序的应用实际大量存在</li>
<li>队列无序并不意味着消息无序</li>
</ul>
<p>所以从业务层面来保证消息的顺序而不仅仅是依赖于消息系统，是一种更合理的方式。</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E9%A1%BA%E5%BA%8F%E6%8A%95%E9%80%922.png"></p>
<h1 id="上千万条消息在mq中积压了几个小时还没解决："><a href="#上千万条消息在mq中积压了几个小时还没解决：" class="headerlink" title="上千万条消息在mq中积压了几个小时还没解决："></a>上千万条消息在mq中积压了几个小时还没解决：</h1><p>1）先修复consumer的问题，确保其恢复消费速度，然后将现有consumer都停掉；<br>2）新建⼀一个topic，partition是原来的10倍，临时建立好原先10倍或者20倍的queue数量量；<br>3）然后写⼀一个临时的分发数据的consumer程序，这个程序部署上去消费积压的数据；<br>消费之后不不做耗时的处理理，直接均匀轮询写⼊入临时建立好的10倍数量量的queue；<br>4）接着临时征用10倍的机器器来部署consumer，每一批consumer消费一个临时queue的数据；<br>5）这种做法相当于是临时将queue资源和consumer资源扩大10倍，以正常的10倍速度来消费数据；<br>6）等快速消费完积压数据之后，得恢复原先部署架构，重新用原先的consumer机器器来消费消息。<br>总结：</p>
<ol>
<li>修复并停掉consumer；</li>
<li>新建一个topic，partition是原来的10倍，建立临时queue，数量是原来的10倍或20倍；</li>
<li>写临时consumer程序，临时征用10倍的机器器去消费数据；</li>
<li>消费完成之后，恢复原先consumer；</li>
</ol>
<h1 id="rabbitmq设置过期时间，部分消息丢失："><a href="#rabbitmq设置过期时间，部分消息丢失：" class="headerlink" title="rabbitmq设置过期时间，部分消息丢失："></a>rabbitmq设置过期时间，部分消息丢失：</h1><blockquote>
<p>RabbtiMQ 是可以设置过期时间的，也就是 TTL。如果消息在 queue中积压超过一定的时间就会被 RabbitMQ 给清理掉，</p>
</blockquote>
<p>采取批量重导方法：将丢失的那批数据查询导入到mq里面。</p>
<p>直接丢弃数据了，然后等过了高峰期以后,将丢失的那批数据，写个临时程序，一点一点的查出来，然后重新灌入 mq 里面去，把白天丢的数据给补回来</p>
<h1 id="为什么不应该对所有的message都使用持久化机制"><a href="#为什么不应该对所有的message都使用持久化机制" class="headerlink" title="为什么不应该对所有的message都使用持久化机制"></a>为什么不应该对所有的message都使用持久化机制</h1><ul>
<li>性能会下降</li>
<li>message在rabbitmq内置的cluster方案是会出现问题<ul>
<li>message设置了persistent而queue未设置durable，那么queue的owner node出现异常后，未在（自己的或其他的）node上重建queue前，发向该queue的message都将被balckhold</li>
<li>message设置了persistent并且queue设置durable，那么queue的owner node出现异常后，该queue只能在自己的node上重建，发向该queue的message都将被balckhold</li>
</ul>
</li>
</ul>
<h1 id="mq-的缺点"><a href="#mq-的缺点" class="headerlink" title="mq 的缺点"></a>mq 的缺点</h1><h2 id="系统可用性降低"><a href="#系统可用性降低" class="headerlink" title="系统可用性降低"></a>系统可用性降低</h2><p>系统引入的外部依赖越多，越容易挂掉，本来 A 系统调用 BCD 三个系统的接口就好了系统正常运行，加个 MQ 进来，万一MQ 挂了，整套系统有崩溃风险。</p>
<h2 id="系统复杂性提高"><a href="#系统复杂性提高" class="headerlink" title="系统复杂性提高"></a>系统复杂性提高</h2><ul>
<li><p>保证消息没有重复消费</p>
</li>
<li><p>处理消息丢失的情况</p>
</li>
<li><p>保证消息传递的顺序性</p>
</li>
</ul>
<h2 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h2><h3 id="RabbitMQ如何保证数据⼀一致性？"><a href="#RabbitMQ如何保证数据⼀一致性？" class="headerlink" title="RabbitMQ如何保证数据⼀一致性？"></a>RabbitMQ如何保证数据⼀一致性？</h3><ol>
<li>生产者确认机制：消息持久化后异步回调通知⽣生产者，保证消息已经发出去；</li>
<li>消息持久化：设置消息持久化；</li>
<li>消费者确认机制：消费者成功消费消息之后，手动确认，保证消息已经消费。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/19/MyCat-MyCat%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/19/MyCat-MyCat%E9%85%8D%E7%BD%AE/" itemprop="url">MyCat-MyCat配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-19T16:57:48+08:00">
                2021-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mycat-Mycat%E9%85%8D%E7%BD%AE/" itemprop="url" rel="index">
                    <span itemprop="name">Mycat - Mycat配置</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="配置Mycat支持MySQL8-0"><a href="#配置Mycat支持MySQL8-0" class="headerlink" title="配置Mycat支持MySQL8.0"></a>配置Mycat支持MySQL8.0</h1><p><strong>下载jdbc 驱动</strong></p>
<p>下载<code>mysql-connector-java-8.0.23.jar</code>,将mycat/lib 文件夹下mysql-connector-java/5.1.35 删掉，上传mysql/mysql-connector-java/8.0.16/ 到mycat/lib 目录下,再给jar包赋权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 mysql-connector-java-8.0.23.jar </span><br></pre></td></tr></table></figure>

<p><strong>schema.xml</strong></p>
<ol>
<li>checkSQLschema=”true”：必须是ture</li>
<li>dbDriver=”jdbc” :dbDriver改为jdbc</li>
<li>url=”jdbc:mysql://192.168.159.130:3306?useSSL=false&amp;serverTimezone=UTC”：url使用jdbc</li>
</ol>
<p><strong>MySql 8</strong></p>
<p>主要是修改Mysql配置文件，在Windows平台是my.ini，在linux平台是my.cnf：</p>
<p>修改缺省加密方式：在安装完MySQL 8后，需将缺省的加密方式修改为mysql_native_password，以保持与5.x版本兼容。</p>
<p>如果是在Linux平台，在首次启动前设置lower_case_table_names = 1(表名大小写不敏感)，注意一旦数据库中已有数据，再如此设置会导致启动mysql失败。</p>
<p>为防止出现字符集不匹配，最好也显式设置字符集(可选)。</p>
<p><strong>my.cnf：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">...</span><br><span class="line">default-authentication-plugin&#x3D;mysql_native_password</span><br><span class="line">lower_case_table_names&#x3D;1</span><br><span class="line">character-set-server&#x3D;utf8</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set&#x3D;utf8</span><br></pre></td></tr></table></figure>




<h1 id="简单例子入门"><a href="#简单例子入门" class="headerlink" title="简单例子入门"></a>简单例子入门</h1><ul>
<li>server.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>user<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>user<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>user<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>schema.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn129,dn130&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn129&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;db129&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user_129&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn130&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;db130&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user_130&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;db129&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;M1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.159.129:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=UTC&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">password</span>=<span class="string">&quot;12345&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;db130&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;M1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.159.130:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=UTC&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">password</span>=<span class="string">&quot;12345&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>启动MyCat</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mycat]# ./bin/mycat console</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/19/MyCat-MyCat%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/19/MyCat-MyCat%E5%AD%A6%E4%B9%A0/" itemprop="url">MyCat-MyCat学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-19T16:52:33+08:00">
                2021-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mycat-Mycat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%EF%BC%8C%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" itemprop="url" rel="index">
                    <span itemprop="name">Mycat - Mycat读写分离，分库分表</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h1><ul>
<li>配置MyCat的用户名，密码，权限，Schema等</li>
<li>如同给MySQL新建用户</li>
<li>客户端连接MyCat与连接MySQL相同</li>
</ul>
<h2 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h2><ul>
<li>server.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如有多个schema用“，”号隔开--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>user,schema1,schema2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>schema.xml</li>
</ul>
<p><code>schema</code>的<code>name</code>字段与<code>&lt;property name=&quot;schemas&quot;&gt;user,schema1,schema2&lt;/property&gt;</code>对应</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn129,dn130&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="schema-xml"><a href="#schema-xml" class="headerlink" title="schema.xml"></a>schema.xml</h1><ul>
<li>配置dataHost（节点主机），包括读host，写host</li>
<li>配置dataNode（数据节点），指定到具体的数据库</li>
<li>配置schema，表名，数据节点，分片规则等</li>
</ul>
<h2 id="dataHost"><a href="#dataHost" class="headerlink" title="dataHost"></a>dataHost</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;db129&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;M1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.159.129:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=UTC&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">password</span>=<span class="string">&quot;12345&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>writeHost</strong></p>
<p>写库，**user=”root”，password=”12345”**一定要使用<code>mysql_native_password</code>加密方式</p>
</li>
<li><p><strong>readHost</strong></p>
</li>
<li><p><strong>balance</strong>：</p>
<ul>
<li> balance=”0”, 不开启读写分离机制，所有读操作都发送到当前可用的writeHost上。</li>
<li>balance=”1”，全部的readHost与stand by writeHost参与select语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与 M2互为主备)，正常情况下，M2,S1,S2都参与select语句的负载均衡。</li>
<li>balance=”2”，所有读操作都随机的在writeHost、readhost上分发。</li>
<li>balance=”3”，所有读请求随机的分发到wiriterHost对应的readhost执行，writerHost不负担读压力，注意balance=3只在1.4及其以后版本有，1.3没有。</li>
</ul>
</li>
<li><p><strong>writeType</strong>：</p>
<ol>
<li><p>writeType=”0”, 所有写操作发送到配置的第一个writeHost，第一个挂了切到还生存的第二个writeHost，重新启动后已切换后的为准，切换记录在配置文件中:dnindex.properties .</p>
<blockquote>
<p>如果第一个writeHost挂掉后又重启，还是会操作第二个writeHost，即挂掉后又重启后，第一个writeHost会排到第二个writeHost后</p>
</blockquote>
</li>
<li><p>writeType=”1”，所有写操作都随机的发送到配置的writeHost，1.5以后废弃不推荐。</p>
</li>
</ol>
</li>
</ul>
<h3 id="balance修改"><a href="#balance修改" class="headerlink" title="balance修改"></a>balance修改</h3><p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/129.png"></p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/130.png"></p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/131.png"></p>
<ol>
<li><p><strong>balance=”0”</strong>:不开启读写分离机制，所有读操作都发送到当前可用的writeHost上</p>
<ul>
<li><p>dataHost：129</p>
<ul>
<li>writeHost：129<ul>
<li>readHost ：131</li>
</ul>
</li>
</ul>
</li>
<li><p>dataHost：130</p>
<ul>
<li>writeHost：130</li>
</ul>
</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/balance%3D0.png" style="zoom:50%;" /></li>
</ol>
<ol start="2">
<li><p>**balance=”1”**，全部的readHost与stand by writeHost参与select语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与 M2互为主备)，正常情况下，M2,S1,S2都参与select语句的负载均衡。</p>
<ul>
<li><p>dataHost：129</p>
<ul>
<li>writeHost：129<ul>
<li>readHost ：131</li>
</ul>
</li>
</ul>
</li>
<li><p>dataHost：130</p>
<ul>
<li>writeHost：130</li>
</ul>
</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/balance%3D1.png" style="zoom:50%;" /></li>
<li><p>**balance=”2”**，所有读操作都随机的在writeHost、readhost上分发。</p>
<ul>
<li><p>dataHost：129</p>
<ul>
<li>writeHost：129<ul>
<li>readHost ：131</li>
</ul>
</li>
</ul>
</li>
<li><p>dataHost：130</p>
<ul>
<li>writeHost：130</li>
</ul>
</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/balance%3D2%281%29.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/balance%3D2.png" style="zoom:50%;" /></li>
<li><p>**balance=”3”**，所有读请求随机的分发到wiriterHost对应的readhost执行，writerHost不负担读压力，</p>
<ul>
<li><p>dataHost：129</p>
<ul>
<li>writeHost：129<ul>
<li>readHost ：131</li>
</ul>
</li>
</ul>
</li>
<li><p>dataHost：130</p>
<ul>
<li>writeHost：130</li>
</ul>
</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/balance%3D1.png" style="zoom:50%;" /></li>
</ol>
<h2 id="dataNode"><a href="#dataNode" class="headerlink" title="dataNode"></a>dataNode</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--dataNode自定义; dataHost下方dataHost的name; database为指定的数据库 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn129&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;db129&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user_129&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn130&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;db130&quot;</span> <span class="attr">database</span>=<span class="string">&quot;user_130&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="schema-1"><a href="#schema-1" class="headerlink" title="schema"></a>schema</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn129,dn130&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>checkSQLschema</strong>：checkSQLschema是否去掉SQL中的Schema</li>
<li><strong>sqlMaxLimit</strong>：检索时加上limit，防止运算压力过大，<strong>sql语句中有limit时默认不生效</strong></li>
<li>table：定义表</li>
<li>name：定义逻辑表的表名</li>
<li>dataNode：定义逻辑表的数据节点</li>
<li><strong>rule</strong>：定义分片表的分片规则，必须与rule.xml中的tableRule对应</li>
<li><strong>ruleRequired</strong>：是否绑定分片规则，为true却没有绑定分片规则，程序报错</li>
</ul>
<h3 id="rule属性"><a href="#rule属性" class="headerlink" title="rule属性"></a>rule属性</h3><p><code>schema.xml</code>中<code>&quot;auto-sharding-long&quot; </code>对应<code>rule.xml</code>中的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--按照那一列分片--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分片规则在<code>autopartition-long.txt</code></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># range start-end ,data node index</span><br><span class="line"># K=1000,M=10000.</span><br><span class="line">0-500M=0</span><br><span class="line">500M-1000M=1</span><br><span class="line"># 只配置了两个数据节点所以注释掉了</span><br><span class="line"># 1000M-1500M=2 </span><br></pre></td></tr></table></figure>



<h3 id="分片规则"><a href="#分片规则" class="headerlink" title="分片规则"></a>分片规则</h3><ol>
<li><p>sharding-by-intfile（<strong>分片枚举</strong>）</p>
<p>分片的列是固定的值（比如有些业务需要按照省份或区县来做保存，而全国省份区县固定的）</p>
<ul>
<li>rule.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>sharding_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;hash-int&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
其中分片函数配置中，mapFile标识配置文件名称，type默认值为0，0表示Integer，非零表示String，<br>所有的节点配置都是从0开始，及0代表节点1</li>
</ul>
<blockquote>
<p>defaultNode 默认节点:小于0表示不设置默认节点，大于等于0表示设置默认节点    </p>
<ul>
<li>默认节点的作用：枚举分片时，如果碰到不识别的枚举值，就让它路由到默认节点   </li>
<li>如果不配置默认节点（defaultNode值小于0表示不配置默认节点），碰到不识别的枚举值就会报错,like this：can’t find datanode for sharding column:column_name val:ffffffff</li>
</ul>
</blockquote>
<ul>
<li>partition-hash-int.txt<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10000=0</span><br><span class="line">10010=1</span><br><span class="line">DEFAULT_NODE=1</span><br></pre></td></tr></table></figure></li>
</ul>
<p>id为1000则放入第一个节点。id为10010则放入第二个节点。其他id放入第二个节点</p>
</li>
<li><p>mod-long（<strong>取模</strong>）</p>
<p>此规则为对分片字段求摸运算。</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.opencloudb.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- how many data nodes  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置说明：<br>上面columns 标识将要分片的表字段，algorithm 分片函数，<br>此种配置非常明确即根据id进行十进制求模预算，相比固定分片hash，此种在批量插入时可能存在批量插入单事务插入多数据分片，增大事务一致性难度。</p>
<p>count对应分片节点数</p>
</blockquote>
<blockquote>
<p>取模扩容最好以2的多少次方 2,4,8</p>
</blockquote>
<ol start="3">
<li>一致性hash（murmur）</li>
</ol>
<blockquote>
<p>将要分片的表字段是String类型的</p>
</blockquote>
<h1 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a>全局表</h1><p>字典表，数据量不大，不用分片，比如用户表和省市表，如果省市表分片了，那与用户表关联查询将很麻烦，省市表可作为全局表在各个分片中都存在一份</p>
<ul>
<li>type属性：<strong>global为全局表</strong>，不指定则为分片表</li>
</ul>
<h1 id="子表"><a href="#子表" class="headerlink" title="子表"></a>子表</h1><blockquote>
<p>可以理解为Order_Item,存放商品id，商品名称，商品数量，商品金额</p>
<p>订单表是按照订单的id进行切分，订单id取模为0的分配到第一个数据库，订单id取模为1的分配到第二个数据库，Order_Item表想跟随Order表落入相同的数据库，Order_Item表作为Order表的字表落入相同的数据库</p>
</blockquote>
<ul>
<li><p>childTable标签，定义分片字表</p>
</li>
<li><p>name属性，字表名称</p>
</li>
<li><p>joinKey属性，标志子表中的列，用于与父表做关联</p>
</li>
<li><p>parnetKey，标志父表中的列，与joinKey对应</p>
</li>
<li><p>primaryKey，子表主键，同table标签</p>
</li>
<li><p>needAddLimit属性，同table标签</p>
</li>
</ul>
<h1 id="mycatk控制台"><a href="#mycatk控制台" class="headerlink" title="mycatk控制台"></a>mycatk控制台</h1><p>端口号：9066</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reload @@config_all;</span><br></pre></td></tr></table></figure>

<h1 id="mycat高可用"><a href="#mycat高可用" class="headerlink" title="mycat高可用"></a>mycat高可用</h1><p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/%E6%95%B0%E6%8D%AE%E5%BA%93/mycat/mycat%E9%AB%98%E5%8F%AF%E7%94%A8.png"></p>
<p><strong>haproxy:</strong></p>
<p>mycat不是HTTP请求，mysql是TCP协议</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="配置Haproxy"><a href="#配置Haproxy" class="headerlink" title="配置Haproxy"></a>配置Haproxy</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="attr">defaults</span></span><br><span class="line"><span class="comment">   # mode                    http</span></span><br><span class="line">    <span class="attr">mode</span>                    <span class="string">tcp</span></span><br><span class="line">    <span class="attr">log</span>                     <span class="string">global</span></span><br><span class="line">    <span class="attr">option</span>                  <span class="string">httplog</span></span><br><span class="line">    <span class="attr">option</span>                  <span class="string">dontlognull</span></span><br><span class="line">    <span class="attr">option</span> <span class="string">http-server-close</span></span><br><span class="line">    <span class="attr">option</span> <span class="string">forwardfor       except 127.0.0.0/8</span></span><br><span class="line">    <span class="attr">option</span>                  <span class="string">redispatch</span></span><br><span class="line">    <span class="attr">retries</span>                 <span class="string">3</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">http-request    10s</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">queue           1m</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">connect         10s</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">client          1m</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">server          1m</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">http-keep-alive 10s</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">check           10s</span></span><br><span class="line">    <span class="attr">maxconn</span>                 <span class="string">3000</span></span><br><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="comment"># haproxy的端口5000</span></span><br><span class="line"><span class="attr">frontend</span>  <span class="string">main *:5000</span></span><br><span class="line">    <span class="attr">acl</span> <span class="string">url_static       path_beg       -i /static /images /javascript /stylesheets</span></span><br><span class="line">    <span class="attr">acl</span> <span class="string">url_static       path_end       -i .jpg .gif .png .css .js</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">use_backend</span> <span class="string">static          if url_static</span></span><br><span class="line">    <span class="attr">default_backend</span>             <span class="string">app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="attr">backend</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">balance</span>     <span class="string">roundrobin</span></span><br><span class="line">    <span class="attr">server</span>  <span class="string">app1 192.168.159.128:8066 check</span></span><br><span class="line">    <span class="attr">server</span>  <span class="string">app2 192.168.159.129:8066 check</span></span><br><span class="line"><span class="comment">    #server  app3 127.0.0.1:5003 check</span></span><br><span class="line"><span class="comment">    #server  app4 127.0.0.1:5004 check</span></span><br></pre></td></tr></table></figure>

<h3 id="启动Haproxy"><a href="#启动Haproxy" class="headerlink" title="启动Haproxy"></a>启动Haproxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">haproxy -f /etc/haproxy/haproxy.cfg </span><br></pre></td></tr></table></figure>

<h3 id="Navicat连接Haproxy"><a href="#Navicat连接Haproxy" class="headerlink" title="Navicat连接Haproxy"></a>Navicat连接Haproxy</h3><ul>
<li>连接名：192.168.159.130-haproxy</li>
<li>主机：192.168.159.130</li>
<li>端口：5000</li>
<li>用户名：root（mycat用户名）</li>
<li>密码：12345（mycat密码）</li>
</ul>
<h3 id="测试其中一个MyCat宕机"><a href="#测试其中一个MyCat宕机" class="headerlink" title="测试其中一个MyCat宕机"></a>测试其中一个MyCat宕机</h3><h3 id="keepalived避免Haproxy单点故障"><a href="#keepalived避免Haproxy单点故障" class="headerlink" title="keepalived避免Haproxy单点故障"></a>keepalived避免Haproxy单点故障</h3><p><a href="https://yuanyayuan.github.io/2021/03/24/Keepalived%E9%85%8D%E7%BD%AE%E5%AE%9E%E7%8E%B0nginx%E9%AB%98%E5%8F%AF%E7%94%A8/">参考keepalived避免Nginx单点故障</a>和<a href="https://yuanyayuan.github.io/2021/03/22/LVS-DR%E6%A8%A1%E5%BC%8F%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE/">keepalived避免LVS单点故障</a></p>
<h1 id="MyCat使用过程出现的错误"><a href="#MyCat使用过程出现的错误" class="headerlink" title="MyCat使用过程出现的错误"></a>MyCat使用过程出现的错误</h1><ol>
<li><p>分片规则要仔细思考</p>
<p>例如：</p>
<p>order表被垂直切分出，user表所在数据库与order表所在数据库分离order表与user表是根据user_id关联</p>
<p>如果order表选择以自己的id为分片列，那会导致同一个用户的订单落于不同的数据库。MyCat根据用户id检索用户所有订单时，MyCat会在所有节点上都执行sql语句，汇总结果集反馈至服务端，性能根据节点的增对会加大资源消耗。</p>
<p>如果order表选择以用户的id为分片列，同一个用户的订单一定会落入同一个数据库。</p>
</li>
<li><p><code>cant find (root) parnet sharding node for sql :...</code></p>
<p>原因：字表先于父表的数据库插入，Order_item先于Order在数据库中新增，Order_item插入数据时找不到Order</p>
<p>修改方法，代码逻辑更改，父表记录先于字表记录录入数据库</p>
</li>
<li><p><code>Sharding column cant be updated ...</code></p>
<p>原因：分片列是不能更新的，因为MyCat对数据进行水平切分是根据分片列进行切分得，分片列的值决定该条记录被分配到那个节点数据库，值一旦确定是不能跟新的，只改变是要重新计算分片的</p>
<p>修改方法，更新时将分片列值为空在使用<code>mapper.updateByPrimaryKeySelective(...)</code></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/19/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/19/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" itemprop="url">分步式-分库分表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-19T16:42:38+08:00">
                2021-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E6%AD%A5%E5%BC%8F-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" itemprop="url" rel="index">
                    <span itemprop="name">分步式 - 分库分表</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="垂直切分、水平切分"><a href="#垂直切分、水平切分" class="headerlink" title="垂直切分、水平切分"></a>垂直切分、水平切分</h1><h2 id="垂直切分"><a href="#垂直切分" class="headerlink" title="垂直切分"></a>垂直切分</h2><ul>
<li>按业务去切分</li>
<li>每种业务一个数据库</li>
<li>不同业务之间，禁止跨库join联查</li>
</ul>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>拆分后业务清晰，拆分规则明确</li>
<li>系统之间容易扩展和整合</li>
<li>数据维护简单</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>业务之间无法join，只能通过接口调用，提升了系统复杂度</li>
<li>跨库事务难以处理</li>
<li>垂直切分后，某些业务数据过于庞大，仍然存在单体性能瓶颈</li>
</ul>
<h2 id="水平切分"><a href="#水平切分" class="headerlink" title="水平切分"></a>水平切分</h2><ul>
<li>将一张表的数据按照某些规则分到不同的数据库中</li>
<li>需确定分片的规则</li>
<li>使用分片字段查询时，可确定实体库，其他字段查询，查询所有表</li>
</ul>
<h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ul>
<li>解决单库大数据、高并发的性能瓶颈;</li>
<li>拆分规则封装好，对应用端几乎透明，开发人员无需关心拆分细节</li>
</ul>
<h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>拆分规则很难抽象（按用户拆分还是按订单拆分）</li>
<li>分片事务一致性难以解决</li>
<li>二次扩展时、数据迁移、维护难度大</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/04/19/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85-MySQL%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/19/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85-MySQL%E5%AE%89%E8%A3%85/" itemprop="url">软件安装-MySQL安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-19T16:34:52+08:00">
                2021-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85-MySQL%E5%AE%89%E8%A3%85/" itemprop="url" rel="index">
                    <span itemprop="name">软件安装 - MySQL安装</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">rpm -ivh mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">yum install mysql-community-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 成功安装之后重启mysql服务</span></span><br><span class="line">service mysqld restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令查看数据库的密码</span></span><br><span class="line">cat /var/log/mysqld.log | grep password </span><br><span class="line"><span class="meta">#</span><span class="bash"> 登录输入查看出来的密码</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;命令查看数据库的密码&#x27;</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改密码策略</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW VARIABLES LIKE <span class="string">&#x27;validate_password%&#x27;</span>;</span> </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password.policy=LOW;</span> </span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password.length=5;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;12345&#x27;</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置允许远程用户访问</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> grant all privileges on *.* to <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> with grant option;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 报错：ERROR 1410 (42000): You are not allowed to create a user with GRANT</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use mysql;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> update user <span class="built_in">set</span> host = <span class="string">&#x27;%&#x27;</span> <span class="built_in">where</span> user = <span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span>    </span><br></pre></td></tr></table></figure>



          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <!--<a href="/archives/%7C%7Carchive">-->
                <a href="/archives/">
              
                  <span class="site-state-item-count">80</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yuanyayuan" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:liyuan0707@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiYuan</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
