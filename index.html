<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="工作中技术总结">
<meta property="og:type" content="website">
<meta property="og:title" content="Hikari的Java之路">
<meta property="og:url" content="https://yuanyayuan.github.io/index.html">
<meta property="og:site_name" content="Hikari的Java之路">
<meta property="og:description" content="工作中技术总结">
<meta property="og:locale">
<meta property="article:author" content="LiYuan">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yuanyayuan.github.io/"/>





  <title>Hikari的Java之路</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hikari的Java之路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Hello,world</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/17/%E4%B8%AD%E9%97%B4%E4%BB%B6-Sentinel%E6%B5%81%E9%87%8F%E9%98%B2%E6%8E%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/17/%E4%B8%AD%E9%97%B4%E4%BB%B6-Sentinel%E6%B5%81%E9%87%8F%E9%98%B2%E6%8E%A7/" itemprop="url">中间件-Sentinel流量防控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-17T15:11:26+08:00">
                2021-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sentinel-Sentinel%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">Sentinel - Sentinel学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Sentinel作用"><a href="#Sentinel作用" class="headerlink" title="Sentinel作用"></a>Sentinel作用</h1><ul>
<li>流量控制</li>
<li>熔断降级</li>
<li>系统保护</li>
<li>服务安全</li>
</ul>
<h1 id="Sentinel特性"><a href="#Sentinel特性" class="headerlink" title="Sentinel特性"></a>Sentinel特性</h1><ul>
<li><p>应用场景丰富</p>
<p>例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等</p>
</li>
<li><p>完备的实时监控</p>
<p>可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况</p>
</li>
<li><p>广泛的开源生态</p>
<p>例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel</p>
</li>
<li><p>完善的SPI扩展点</p>
<p>可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等</p>
</li>
</ul>
<h1 id="Sentinel组成部分"><a href="#Sentinel组成部分" class="headerlink" title="Sentinel组成部分"></a>Sentinel组成部分</h1><ul>
<li>控制库：sentinel-core</li>
<li>控制台：sentinel-dashboard</li>
<li>第三方支持组件：如spring、dubbo、rocketmq</li>
</ul>
<h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><h2 id="在应用中引入Sentinel-Jar包"><a href="#在应用中引入Sentinel-Jar包" class="headerlink" title="在应用中引入Sentinel Jar包"></a>在应用中引入Sentinel Jar包</h2><p>如果应用使用 pom 工程，则在 <code>pom.xml</code> 文件中加入以下代码即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--一个应用如果要接入Sentinel，需接入sentinel-core包，用于实现核心流控功能。</span></span><br><span class="line"><span class="comment">而想要接入Dashboard并与之通信则需要引入transport组件，Sentinel提供了两种选择：--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- sentinel-transport-simple-http：基于jdk net包实现的，通过http协议传输数据 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-transport-simple-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sentinel.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- sentinel-transport-netty-http：在netty的基础上实现，通过http协议传输数据 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-transport-netty-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sentinel.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="定义资源"><a href="#定义资源" class="headerlink" title="定义资源"></a>定义资源</h2><p>接下来，我们把需要控制流量的代码用 Sentinel API <code>SphU.entry(&quot;HelloWorld&quot;)</code> 和 <code>entry.exit()</code> 包围起来即可。在下面的例子中，我们将 <code>System.out.println(&quot;hello world&quot;);</code> 这端代码作为资源，用 API 包围起来（埋点）。参考代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    initFlowRules();</span><br><span class="line">    <span class="comment">//2.定义资源</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        Entry entry = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//2.1 定义资源名称</span></span><br><span class="line">	    	entry = SphU.entry(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2.2 执行资源逻辑代码</span></span><br><span class="line">            <span class="comment">/*您的业务逻辑 - 开始*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;hello world：访问数据库&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;hello world：远程访问redis&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;hello world：数据库持久化操作&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">20</span>);</span><br><span class="line">            <span class="comment">/*您的业务逻辑 - 结束*/</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (BlockException e1) &#123;</span><br><span class="line">                <span class="comment">/*流控逻辑处理 - 开始*/</span></span><br><span class="line">            System.out.println(<span class="string">&quot;要访问的资源被流控了，执行流控操控逻辑&quot;</span>);</span><br><span class="line">                <span class="comment">/*流控逻辑处理 - 结束*/</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">               entry.exit();</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成以上两步后，代码端的改造就完成了。当然，我们也提供了 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81">注解支持模块</a>，可以以低侵入性的方式定义资源。</p>
<p><strong>相比基于注解的断路器，密度更短</strong></p>
<h2 id="定义规则"><a href="#定义规则" class="headerlink" title="定义规则"></a>定义规则</h2><p>接下来，通过规则来指定允许该资源通过的请求次数，例如下面的代码定义了资源 <code>HelloWorld</code> 每秒最多只能通过 20 个请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initFlowRules</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;FlowRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    FlowRule rule = <span class="keyword">new</span> FlowRule();</span><br><span class="line">    <span class="comment">//需要和entry = SphU.entry(&quot;HelloWorld&quot;);一致进行绑定</span></span><br><span class="line">    rule.setResource(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line">    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">    <span class="comment">// Set limit QPS to 20.</span></span><br><span class="line">    rule.setCount(<span class="number">20</span>);</span><br><span class="line">    rules.add(rule);</span><br><span class="line">    FlowRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="检查效果"><a href="#检查效果" class="headerlink" title="检查效果"></a>检查效果</h2><p>Demo 运行之后，我们可以在日志 <code>~/logs/csp/$&#123;appName&#125;-metrics.log.xxx</code> 里看到下面的输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|--timestamp-|------date time----|-resource-|p |block|s |e|rt</span><br><span class="line">1529998904000|2018-06-26 15:41:44|HelloWorld|20|0    |20|0|0</span><br><span class="line">1529998905000|2018-06-26 15:41:45|HelloWorld|20|5579 |20|0|728</span><br><span class="line">1529998906000|2018-06-26 15:41:46|HelloWorld|20|15698|20|0|0</span><br><span class="line">1529998907000|2018-06-26 15:41:47|HelloWorld|20|19262|20|0|0</span><br><span class="line">1529998908000|2018-06-26 15:41:48|HelloWorld|20|19502|20|0|0</span><br><span class="line">1529998909000|2018-06-26 15:41:49|HelloWorld|20|18386|20|0|0</span><br></pre></td></tr></table></figure>

<p>其中 <code>p</code> 代表通过的请求, <code>block</code> 代表被阻止的请求, <code>s</code> 代表成功执行完成的请求个数, <code>e</code> 代表用户自定义的异常, <code>rt</code> 代表平均响应时长。</p>
<p>可以看到，这个程序每秒稳定输出 “hello world” 20 次，和规则中预先设定的阈值是一样的。</p>
<h1 id="流控策略"><a href="#流控策略" class="headerlink" title="流控策略"></a>流控策略</h1><p>对主流的5种流控策略做了 底层的抽象和资源的封装</p>
<ul>
<li> 对于规则： FlowRule（流量控制） 、DegradeRule（服务降级）、ParamFlowRule（热点参数）、SystemRule（系统自适应）、AuthorityRule（黑白名单）</li>
<li> 对于管理器：FlowRuleManager、DegradeRuleManager、ParamFlowRuleManager、SystemRuleManager、AuthorityRuleManager</li>
<li> 对于异常：FlowException、DegradeException、ParamFlowException、SystemBlockException、AuthorityException</li>
</ul>
<h2 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>监控应用流量的QPS或并发线程数等指标，当达到指定的阈值时对流量进行控制。</p>
<p>限流的直接表现为执行<code>Entry nodeA = SphU.entry(resourceName)</code>的时候抛出<code>FlowException</code>。<code>FlowException</code>为<code>BlockException</code>的子类。通过捕捉<code>BlockException</code>来自定义被限流后的处理逻辑。</p>
<h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h3><ul>
<li>resource：资源名，及限流规则的作用对象</li>
<li>count：限流阈值</li>
<li>grade：限流阈值类型（QPS或并发线程数）</li>
<li>limitApp：流控针对的调用来源，若为default则不区分调用来源</li>
<li>strategy：调用关系限流对策</li>
<li>controlBehavior：限流控制效果（直接拒绝、Warm Up、均速排队）</li>
</ul>
<h4 id="限流控制效果"><a href="#限流控制效果" class="headerlink" title="限流控制效果"></a>限流控制效果</h4><h5 id="QPS流量控制"><a href="#QPS流量控制" class="headerlink" title="QPS流量控制"></a>QPS流量控制</h5><p>当QPS超过某个阈值的时候，则采取措施进行流量控制：</p>
<ul>
<li><p>直接拒绝（默认）</p>
<p>新的请求会被立即拒绝</p>
</li>
<li><p>Warm UP（预热/冷启动）</p>
<p>当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过冷启动让通过的流量缓慢增加，在一定时间内逐步增加到阈值上限，给冷系统一个预热时间，避免冷系统被压垮。</p>
</li>
<li><p>匀速排队</p>
<p>严格控制请求通过的间隔时间，让请求以均匀的速度通过，对应算法为漏桶算法。</p>
<p>主要用于处理间隔性突发的流量，例如消息队列。（在某一秒有大量请求到来，而接下来的几秒则处于空闲状态，希望接下来的空闲期间逐步处理这些请求，而不是第一秒直接拒绝多余的请求）</p>
<h5 id="并发线程数流量控制"><a href="#并发线程数流量控制" class="headerlink" title="并发线程数流量控制"></a>并发线程数流量控制</h5><p>用于保护业务线程数不被耗尽。Sentinel并发线程数限流通过统计当前请求上下文的线程数目，如果超出阈值,新的请求会被立即拒绝。</p>
<h2 id="热点参数限流"><a href="#热点参数限流" class="headerlink" title="热点参数限流"></a>热点参数限流</h2></li>
</ul>
<h3 id="热点数据"><a href="#热点数据" class="headerlink" title="热点数据"></a>热点数据</h3><ul>
<li>商品ID为参数 ，统计一段时间内最常购买的商品ID并进行限制。</li>
<li>用户ID为参数，针对一段时间内频繁访问的用户ID进行限制。</li>
</ul>
<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。可看作特殊的流量控制，仅对包含热点参数的资源调用生效。</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/Sentinel/Sentinel1.png" style="zoom:67%;" />

<p>利用LRU策略统计最近最长访问的热点参数，结合令牌桶算法来进行参数级别的流控。</p>
<h2 id="黑白名单"><a href="#黑白名单" class="headerlink" title="黑白名单"></a>黑白名单</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>根据资源的请求来源闲置资源是否通过。若配置白名单则只有请求来源位于白名单时才可通过。若配置黑名单自来源位于黑名单时不通过，其他请求通过</p>
<h2 id="系统自使用限流"><a href="#系统自使用限流" class="headerlink" title="系统自使用限流"></a>系统自使用限流</h2><p>用初始负载策略作为启动流量控制的值，而允许通过的流量由请求的能力，即请求的响应时间以及当前系统正在处理的请求速率来决定。</p>
<h1 id="使用Sentinel注解实现流控"><a href="#使用Sentinel注解实现流控" class="headerlink" title="使用Sentinel注解实现流控"></a>使用Sentinel注解实现流控</h1><h2 id="引入以下依赖："><a href="#引入以下依赖：" class="headerlink" title="引入以下依赖："></a>引入以下依赖：</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-annotation-aspectj<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.y.z<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="SentinelResource-注解"><a href="#SentinelResource-注解" class="headerlink" title="@SentinelResource 注解"></a>@SentinelResource 注解</h2><ul>
<li><p>value：资源名称，必需项（不能为空）</p>
</li>
<li><p>entryType：entry 类型，可选项（默认为 EntryType.OUT[出站流量]）</p>
</li>
<li><p><strong>blockHandler</strong> / <strong>blockHandlerClass</strong>: blockHandler 对应处理 BlockException 的函数名称，可选项。blockHandler 函数访问范围需要是 public，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 BlockException。blockHandler 函数默认需要和原方法在同一个类中。<strong>若希望使用其他类的函数，则可以指定 blockHandlerClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析</strong>。</p>
</li>
<li><p><strong>fallback</strong> / <strong>fallbackClass</strong>：fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了 exceptionsToIgnore 里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：</p>
<ul>
<li>返回值类型必须与原函数返回值类型一致；</li>
<li>方法参数列表需要和原函数一致，或者可以额外多一个 Throwable 类型的参数用于接收对应的异常</li>
<li>fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ul>
</li>
<li><p>defaultFallback（since 1.6.0）：默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了exceptionsToIgnore 里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。defaultFallback 函数签名要求：</p>
<ul>
<li><p>返回值类型必须与原函数返回值类型一致；</p>
</li>
<li><p>方法参数列表需要为空，或者可以额外多一个 Throwable 类型的参数用于接收对应的异常。</p>
</li>
<li><p>defaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</p>
</li>
</ul>
</li>
<li><p>exceptionsToIgnore（since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</p>
</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><p>若您的应用使用了 Spring AOP（无论是 Spring Boot 还是传统 Spring 应用），您需要通过配置的方式将 <code>SentinelResourceAspect</code> 注册为一个 Spring Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentinelAspectConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SentinelResourceAspect <span class="title">sentinelResourceAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelResourceAspect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><blockquote>
<ul>
<li>blockHandler: 流控降级的时候进入的兜底函数</li>
<li>fallback: 抛出异常的时候进入的兜底函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1.6.0 之前的版本 fallback 函数只针对降级异常（DegradeException）进行处理，不能针对业务异常进行处理)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>blockHandler 和 fallback 都进行了配置，则被限流降级而抛出 <code>BlockException</code> 时只会进入 <code>blockHandler</code> 处理逻辑。</p>
<h3 id="blockHandler"><a href="#blockHandler" class="headerlink" title="blockHandler "></a><code>blockHandler </code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原函数</span></span><br><span class="line">    <span class="meta">@SentinelResource(</span></span><br><span class="line"><span class="meta">        value = &quot;com.Sentinel.demo.service.TestService:flow&quot;, </span></span><br><span class="line"><span class="meta">        blockHandler = &quot;flowBlockHandler&quot;, </span></span><br><span class="line"><span class="meta">   		fallback = &quot;&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">flow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.err.println(<span class="string">&quot;----&gt; 正常执行flow方法&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;flow&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">flowBlockHandler</span><span class="params">(BlockException ex)</span> </span>&#123;</span><br><span class="line">		System.err.println(<span class="string">&quot;----&gt; 触发 流控策略:&quot;</span> + ex);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;执行 流控方法&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fallback"><a href="#fallback" class="headerlink" title="fallback"></a><code>fallback</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DegradeService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">	<span class="meta">@SentinelResource(</span></span><br><span class="line"><span class="meta">			value = &quot;com.Sentinel.demo.service.DegradeService:degrade&quot;,</span></span><br><span class="line"><span class="meta">			blockHandler = &quot;degradeBlockHandler&quot;,</span></span><br><span class="line"><span class="meta">			fallback = &quot;degradeFallback&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">degrade</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.err.println(<span class="string">&quot;----&gt; 正常执行degrade方法&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(count.incrementAndGet() % <span class="number">3</span> == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;抛出业务异常&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;degrade&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">degradeBlockHandler</span><span class="params">(BlockException ex)</span> </span>&#123;</span><br><span class="line">		System.err.println(<span class="string">&quot;----&gt; 触发 降级流控策略:&quot;</span> + ex);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;执行 降级流控方法&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">degradeFallback</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">		System.err.println(<span class="string">&quot;----&gt; 触发 异常时的降级策略:&quot;</span> + t);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;执行 异常降级方法&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若未配置 <code>blockHandler</code>、<code>fallback</code> 和 <code>defaultFallback</code>，则被限流降级时会将 <code>BlockException</code> <strong>直接抛出</strong></p>
<h1 id="哨兵集群流控与替代方案"><a href="#哨兵集群流控与替代方案" class="headerlink" title="哨兵集群流控与替代方案"></a>哨兵集群流控与替代方案</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/Sentinel/Sentinel2.png" style="zoom:50%;" />

<p>找一个 server 来专门来统计总的调用量，其它的实例都与这台 server 通信来判断是否可以调用。这就是最基础的集群流控的方式</p>
<p>集群流控还可以解决流量不均匀导致总体限流效果不佳的问题。假设集群中有 10 台机器，我们给每台机器设置单机限流阈值为 10  QPS，理想情况下整个集群的限流阈值就为 100 QPS。不过实际情况下流量到每台机器可能会不均匀，会导致总量没有到的情况下某些机器就开始限流</p>
<p>集群流控中共有两种身份：</p>
<ul>
<li>Token Client：集群流控客户端，用于向所属 Token Server 通信请求 token。集群限流服务端会返回给客户端结果，决定是否限流。</li>
<li>Token Server：即集群流控服务端，处理来自 Token Client 的请求，根据配置的集群规则判断是否应该发放 token（是否允许通过）。</li>
</ul>
<p><strong>若在生产环境使用集群限流，管控端还需要关注以下的问题：</strong></p>
<ul>
<li>Token Server 自动管理、调度（分配/选举 Token Server）</li>
<li>Token Server 高可用，在某个 server 不可用时自动 failover 到其它机器</li>
</ul>
<h2 id="替代方案-使用Gateway"><a href="#替代方案-使用Gateway" class="headerlink" title="替代方案-使用Gateway"></a>替代方案-使用Gateway</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/Sentinel/Sentinel3.png" style="zoom:50%;" />

<p>使用Gateway的与Eureka集成来解决上述问题</p>
<h1 id="生产环境使用Sentinel"><a href="#生产环境使用Sentinel" class="headerlink" title="生产环境使用Sentinel"></a><strong>生产环境使用Sentinel</strong></h1><ul>
<li>规则管理（基于内存的应做可靠性持久化）</li>
<li>格则推送</li>
<li>流量监控</li>
</ul>
<h2 id="规则管理及推送模式"><a href="#规则管理及推送模式" class="headerlink" title="规则管理及推送模式"></a>规则管理及推送模式</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/Sentinel/Sentinel4.png" style="zoom:50%;" />

<h2 id="Push模式"><a href="#Push模式" class="headerlink" title="Push模式"></a>Push模式</h2><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/Sentinel/Sentinel5.png" style="zoom: 50%;" />

<h3 id="Apollo"><a href="#Apollo" class="headerlink" title="Apollo"></a>Apollo</h3><p>集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。</p>
<ul>
<li>生产环境参数分支</li>
<li>灰度发布</li>
</ul>
<h3 id="基于Apollo，客户端使用配置"><a href="#基于Apollo，客户端使用配置" class="headerlink" title="基于Apollo，客户端使用配置"></a>基于Apollo，客户端使用配置</h3><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-transport-netty-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sentinel.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-annotation-aspectj<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.y.z<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Apollo的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ctrip.framework.apollo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apollo-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>开启Apollo</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableApolloConfig</span>		<span class="comment">//	开启apoll 客户端注解(配置文件的方式)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Application.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>application.yml配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## apollo配置如下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## apollo应用id(app.id)</span></span><br><span class="line"><span class="attr">app.id:</span></span><br><span class="line">  <span class="string">apollo-test</span></span><br><span class="line"><span class="comment">## apollo-config-service 地址</span></span><br><span class="line"><span class="attr">app.meta:</span></span><br><span class="line">  <span class="string">http://192.168.11.111:8080</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Apollo上新增配置</li>
<li>JavaConfigBean读取配置</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Date</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaConfigBean</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;timeout:20&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> timeout;</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;newKey:&#x27;hello&#x27;&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String newKey;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Apollo开放平台（通过代码实现Apollo配置修改）"><a href="#Apollo开放平台（通过代码实现Apollo配置修改）" class="headerlink" title="Apollo开放平台（通过代码实现Apollo配置修改）"></a>Apollo开放平台（通过代码实现Apollo配置修改）</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.apolloconfig.com/#/zh/usage/apollo-open-api-platform?id=_21-%E6%B3%A8%E5%86%8C%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%94%E7%94%A8">注册第三方应用</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.apolloconfig.com/#/zh/usage/apollo-open-api-platform?id=_22-%E7%BB%99%E5%B7%B2%E6%B3%A8%E5%86%8C%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%94%E7%94%A8%E6%8E%88%E6%9D%83">给已注册的第三方应用授权</a>（创建第三方应用获取token）</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.apolloconfig.com/#/zh/usage/apollo-open-api-platform?id=_23-%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%94%E7%94%A8%E8%B0%83%E7%94%A8apollo-open-api">第三方应用调用Apollo Open API</a></p>
<ul>
<li><h5 id="调用Http-REST接口"><a href="#调用Http-REST接口" class="headerlink" title=" 调用Http REST接口"></a><a target="_blank" rel="noopener" href="https://www.apolloconfig.com/#/zh/usage/apollo-open-api-platform?id=_231-%E8%B0%83%E7%94%A8http-rest%E6%8E%A5%E5%8F%A3"> 调用Http REST接口</a></h5><p>任何语言的第三方应用都可以调用Apollo的Open API，在调用接口时，需要设置注意以下两点：</p>
<ul>
<li>Http Header中增加一个Authorization字段，字段值为申请的token</li>
<li>Http Header的Content-Type字段需要设置成application/json;charset=UTF-8</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.apolloconfig.com/#/zh/usage/apollo-open-api-platform?id=_232-java%E5%BA%94%E7%94%A8%E9%80%9A%E8%BF%87apollo-openapi%E8%B0%83%E7%94%A8apollo-open-api">Java应用通过apollo-openapi调用Apollo Open API</a></p>
<p>从1.1.0版本开始，Apollo提供了<a target="_blank" rel="noopener" href="https://github.com/ctripcorp/apollo/tree/master/apollo-openapi">apollo-openapi</a>客户端，所以Java语言的第三方应用可以更方便地调用Apollo Open API。</p>
</li>
</ul>
<p>首先引入<code>apollo-openapi</code>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ctrip.framework.apollo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apollo-openapi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在程序中构造<code>ApolloOpenApiClient</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String portalUrl = <span class="string">&quot;http://localhost:8070&quot;</span>; <span class="comment">// portal url</span></span><br><span class="line">String token = <span class="string">&quot;e16e5cd903fd0c97a116c873b448544b9d086de9&quot;</span>; <span class="comment">// 申请的token</span></span><br><span class="line">ApolloOpenApiClient client = ApolloOpenApiClient.newBuilder()</span><br><span class="line">                                                .withPortalUrl(portalUrl)</span><br><span class="line">                                                .withToken(token)</span><br><span class="line">                                                .build();</span><br></pre></td></tr></table></figure>

<p>后续就可以通过<code>ApolloOpenApiClient</code>的接口直接操作Apollo Open API了</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(OAuth2)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(OAuth2)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(OAuth2)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T23:57:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/oauth2?id=spring-cloud-security%EF%BC%9Aoauth2%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8">Spring Cloud Security：Oauth2使用入门</a></p>
<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/oauth2_jwt?id=spring-cloud-security%EF%BC%9Aoauth2%E7%BB%93%E5%90%88jwt%E4%BD%BF%E7%94%A8">Spring Cloud Security：Oauth2结合JWT使用</a></p>
<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/gateway_oauth2?id=%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E7%BB%88%E6%9E%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%8Cspring-cloud-gateway-oauth2-%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81%E5%92%8C%E9%89%B4%E6%9D%83%EF%BC%81">微服务权限终极解决方案，Spring Cloud Gateway + Oauth2 实现统一认证和鉴权！</a></p>
<h1 id="OAuth2"><a href="#OAuth2" class="headerlink" title="OAuth2"></a>OAuth2</h1><h2 id="OAuth2-相关名词解释"><a href="#OAuth2-相关名词解释" class="headerlink" title="OAuth2 相关名词解释"></a>OAuth2 相关名词解释</h2><ul>
<li>Resource owner（资源拥有者）：拥有该资源的最终用户，他有访问资源的账号密码；</li>
<li>Resource server（资源服务器）：拥有受保护资源的服务器，如果请求包含正确的访问令牌，可以访问资源；</li>
<li>Client（客户端）：访问资源的客户端，会使用访问令牌去获取资源服务器的资源，可以是浏览器、移动设备或者服务器；</li>
<li>Authorization server（认证服务器）：用于认证用户的服务器，如果客户端认证通过，发放访问资源服务器的令牌。</li>
</ul>
<h2 id="四种授权模式"><a href="#四种授权模式" class="headerlink" title="四种授权模式"></a>四种授权模式</h2><ul>
<li>Authorization Code（授权码模式）：正宗的OAuth2的授权模式，客户端先将用户导向认证服务器，登录后获取授权码，然后进行授权，最后根据授权码获取访问令牌；</li>
<li>Implicit（简化模式）：和授权码模式相比，取消了获取授权码的过程，直接获取访问令牌；</li>
<li>Resource Owner Password Credentials（密码模式）：客户端直接向用户获取用户名和密码，之后向认证服务器获取访问令牌；</li>
<li>Client Credentials（客户端模式）：客户端直接通过客户端认证（比如client_id和client_secret）从认证服务器获取访问令牌。</li>
</ul>
<h3 id="常用的两种"><a href="#常用的两种" class="headerlink" title="常用的两种"></a>常用的两种</h3><h4 id="授权码模式-CAS"><a href="#授权码模式-CAS" class="headerlink" title="授权码模式(CAS)"></a>授权码模式(CAS)</h4><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/oauth2/%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F.png" style="zoom:50%;" />

<ul>
<li>(A)客户端将用户导向认证服务器；</li>
<li>(B)用户在认证服务器进行登录并授权；</li>
<li>(C)认证服务器返回授权码给客户端；</li>
<li>(D)客户端通过授权码和跳转地址向认证服务器获取访问令牌；</li>
<li>(E)认证服务器发放访问令牌（有需要带上刷新令牌）。</li>
</ul>
<h4 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h4><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/oauth2/%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F.png" style="zoom:50%;" />

<ul>
<li>(A)客户端从用户获取用户名和密码；</li>
<li>(B)客户端通过用户的用户名和密码访问认证服务器；</li>
<li>(C)认证服务器返回访问令牌（有需要带上刷新令牌）。</li>
</ul>
<h2 id="OAuth2自定义处理结果"><a href="#OAuth2自定义处理结果" class="headerlink" title="OAuth2自定义处理结果"></a>OAuth2自定义处理结果</h2><h3 id="认证成功结果"><a href="#认证成功结果" class="headerlink" title="认证成功结果"></a>认证成功结果</h3><ul>
<li><code>org.springframework.security.oauth2.provider.endpoint.TokenEndpoint</code>,其中定义了我们非常熟悉的登录认证接口，我们只要自己重写登录认证接口，直接调用默认的实现逻辑，然后把默认返回的结果处理下即可</li>
<li>创建一个<code>AuthController</code>，自定义实现Oauth2默认的登录认证接口；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义Oauth2获取令牌接口</span></span><br><span class="line"><span class="comment"> * Created by macro on 2020/7/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/oauth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenEndpoint tokenEndpoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Oauth2登录认证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/token&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Oauth2TokenDto&gt; <span class="title">postAccessToken</span><span class="params">(Principal principal, <span class="meta">@RequestParam</span> Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException </span>&#123;</span><br><span class="line">        OAuth2AccessToken oAuth2AccessToken = tokenEndpoint.postAccessToken(principal, parameters).getBody();</span><br><span class="line">        Oauth2TokenDto oauth2TokenDto = Oauth2TokenDto.builder()</span><br><span class="line">                .token(oAuth2AccessToken.getValue())</span><br><span class="line">                .refreshToken(oAuth2AccessToken.getRefreshToken().getValue())</span><br><span class="line">                .expiresIn(oAuth2AccessToken.getExpiresIn())</span><br><span class="line">                .tokenHead(<span class="string">&quot;Bearer &quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(oauth2TokenDto);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="认证失败结果"><a href="#认证失败结果" class="headerlink" title="认证失败结果"></a>认证失败结果</h3><ul>
<li>认证失败的操作都会直接抛出<code>OAuth2Exception</code>异常，对于在<code>Controller</code>中抛出的异常，我们可以使用<code>@ControllerAdvice</code>注解来进行全局处理；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局处理Oauth2抛出的异常</span></span><br><span class="line"><span class="comment"> * Created by macro on 2020/7/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Oauth2ExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = OAuth2Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">handleOauth2</span><span class="params">(OAuth2Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CommonResult.failed(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义网关鉴权失败结果"><a href="#自定义网关鉴权失败结果" class="headerlink" title="自定义网关鉴权失败结果"></a>自定义网关鉴权失败结果</h3><ul>
<li>修改网关的安全配置<code>ResourceServerConfig</code>，设置好资源服务器的<code>ServerAuthenticationEntryPoint</code>即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthorizationManager authorizationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IgnoreUrlsConfig ignoreUrlsConfig;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestfulAccessDeniedHandler restfulAccessDeniedHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestAuthenticationEntryPoint restAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityWebFilterChain <span class="title">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123;</span><br><span class="line">        http.oauth2ResourceServer().jwt()</span><br><span class="line">                .jwtAuthenticationConverter(jwtAuthenticationConverter());</span><br><span class="line">        <span class="comment">//自定义处理JWT请求头过期或签名错误的结果（新添加的）</span></span><br><span class="line">        http.oauth2ResourceServer().authenticationEntryPoint(restAuthenticationEntryPoint);</span><br><span class="line">        http.authorizeExchange()</span><br><span class="line">                .pathMatchers(ArrayUtil.toArray(ignoreUrlsConfig.getUrls(),String.class)).permitAll()<span class="comment">//白名单配置</span></span><br><span class="line">                .anyExchange().access(authorizationManager)<span class="comment">//鉴权管理器配置</span></span><br><span class="line">                .and().exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(restfulAccessDeniedHandler)<span class="comment">//处理未授权</span></span><br><span class="line">                .authenticationEntryPoint(restAuthenticationEntryPoint)<span class="comment">//处理未认证</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="白名单接口"><a href="#白名单接口" class="headerlink" title="白名单接口"></a>白名单接口</h3><p>在Oauth2默认的认证过滤器前面再加个过滤器，如果是白名单接口，直接移除认证头即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IgnoreUrlsRemoveJwtFilter</span> <span class="keyword">implements</span> <span class="title">WebFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IgnoreUrlsConfig ignoreUrlsConfig;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> </span>&#123;</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        URI uri = request.getURI();</span><br><span class="line">        PathMatcher pathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line">        <span class="comment">//白名单路径移除JWT请求头</span></span><br><span class="line">        List&lt;String&gt; ignoreUrls = ignoreUrlsConfig.getUrls();</span><br><span class="line">        <span class="keyword">for</span> (String ignoreUrl : ignoreUrls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pathMatcher.match(ignoreUrl, uri.getPath())) &#123;</span><br><span class="line">                request = exchange.getRequest().mutate().header(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;&quot;</span>).build();</span><br><span class="line">                exchange = exchange.mutate().request(request).build();</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>过滤器配置到默认的认证过滤器之前即可，在ResourceServerConfig中进行配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthorizationManager authorizationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IgnoreUrlsConfig ignoreUrlsConfig;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestfulAccessDeniedHandler restfulAccessDeniedHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestAuthenticationEntryPoint restAuthenticationEntryPoint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IgnoreUrlsRemoveJwtFilter ignoreUrlsRemoveJwtFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityWebFilterChain <span class="title">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123;</span><br><span class="line">        http.oauth2ResourceServer().jwt()</span><br><span class="line">                .jwtAuthenticationConverter(jwtAuthenticationConverter());</span><br><span class="line">        <span class="comment">//自定义处理JWT请求头过期或签名错误的结果</span></span><br><span class="line">        http.oauth2ResourceServer().authenticationEntryPoint(restAuthenticationEntryPoint);</span><br><span class="line">        <span class="comment">//对白名单路径，直接移除JWT请求头（新添加的）</span></span><br><span class="line">        http.addFilterBefore(ignoreUrlsRemoveJwtFilter, SecurityWebFiltersOrder.AUTHENTICATION);</span><br><span class="line">        http.authorizeExchange()</span><br><span class="line">                .pathMatchers(ArrayUtil.toArray(ignoreUrlsConfig.getUrls(),String.class)).permitAll()<span class="comment">//白名单配置</span></span><br><span class="line">                .anyExchange().access(authorizationManager)<span class="comment">//鉴权管理器配置</span></span><br><span class="line">                .and().exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(restfulAccessDeniedHandler)<span class="comment">//处理未授权</span></span><br><span class="line">                .authenticationEntryPoint(restAuthenticationEntryPoint)<span class="comment">//处理未认证</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Gateway-Oauth2实现统一认证和鉴权"><a href="#Gateway-Oauth2实现统一认证和鉴权" class="headerlink" title="Gateway+Oauth2实现统一认证和鉴权"></a>Gateway+Oauth2实现统一认证和鉴权</h1><h2 id="应用架构"><a href="#应用架构" class="headerlink" title="应用架构"></a>应用架构</h2><ul>
<li><p>Gateway——网关服务，负责请求转发和鉴权功能，整合Spring Security+Oauth2</p>
</li>
<li><p>Oauth2——Oauth2认证服务，负责对登录用户进行认证，整合Spring Security+Oauth2；</p>
</li>
<li><p>api——受保护的API服务，用户鉴权通过后可以访问该服务，不整合Spring Security+Oauth2。</p>
</li>
</ul>
<h2 id="Oauth2模块"><a href="#Oauth2模块" class="headerlink" title="Oauth2模块"></a>Oauth2模块</h2><blockquote>
<p>简单说明：实现SpringSecurity相关功能（实现UserDetails，配置SecurityConfig），可通过username查询用户权限</p>
</blockquote>
<p>认证服务，它将作为Oauth2的认证服务使用，并且网关服务的鉴权功能也需要依赖它</p>
<ul>
<li>在<code>pom.xml</code>中添加相关依赖，主要是Spring Security、Oauth2、JWT、Redis相关依赖；</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nimbusds<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nimbus-jose-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>application.yml</code>中添加相关配置，主要是Nacos和Redis相关配置；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9401</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">micro-oauth2-auth</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="attr">date-format:</span> <span class="string">yyyy-MM-dd</span> <span class="string">HH:mm:ss</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">password:</span> </span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>keytool</code>生成RSA证书<code>jwt.jks</code>，复制到<code>resource</code>目录下，在JDK的<code>bin</code>目录下使用如下命令即可；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -<span class="built_in">alias</span> jwt -keyalg RSA -keystore jwt.jks</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>UserServiceImpl</code>类实现Spring Security的<code>UserDetailsService</code>接口，用于加载用户信息；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户管理业务类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;UserDTO&gt; userList;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String password = passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        userList.add(<span class="keyword">new</span> UserDTO(<span class="number">1L</span>,<span class="string">&quot;macro&quot;</span>, password,<span class="number">1</span>, CollUtil.toList(<span class="string">&quot;ADMIN&quot;</span>)));</span><br><span class="line">        userList.add(<span class="keyword">new</span> UserDTO(<span class="number">2L</span>,<span class="string">&quot;andy&quot;</span>, password,<span class="number">1</span>, CollUtil.toList(<span class="string">&quot;TEST&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        List&lt;UserDTO&gt; findUserList = userList.stream().filter(item -&gt; item.getUsername().equals(username)).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isEmpty(findUserList)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(MessageConstant.USERNAME_PASSWORD_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        SecurityUser securityUser = <span class="keyword">new</span> SecurityUser(findUserList.get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">if</span> (!securityUser.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DisabledException(MessageConstant.ACCOUNT_DISABLED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!securityUser.isAccountNonLocked()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException(MessageConstant.ACCOUNT_LOCKED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!securityUser.isAccountNonExpired()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AccountExpiredException(MessageConstant.ACCOUNT_EXPIRED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!securityUser.isCredentialsNonExpired()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CredentialsExpiredException(MessageConstant.CREDENTIALS_EXPIRED);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> securityUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加认证服务相关配置<code>Oauth2ServerConfig</code>，需要配置加载用户信息的服务<code>UserServiceImpl</code>及RSA的钥匙对<code>KeyPair</code>；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证服务器配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Oauth2ServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserServiceImpl userDetailsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenEnhancer jwtTokenEnhancer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(<span class="string">&quot;client-app&quot;</span>)<span class="comment">//配置client_id</span></span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>))<span class="comment">//配置client_secret</span></span><br><span class="line">                .scopes(<span class="string">&quot;all&quot;</span>)<span class="comment">//配置申请的权限范围</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>)<span class="comment">//配置grant_type，表示授权类型</span></span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">3600</span>)<span class="comment">//配置访问token的有效期</span></span><br><span class="line">                .refreshTokenValiditySeconds(<span class="number">86400</span>);<span class="comment">//配置刷新token的有效期</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TokenEnhancerChain enhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">        List&lt;TokenEnhancer&gt; delegates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        delegates.add(jwtTokenEnhancer); </span><br><span class="line">        delegates.add(accessTokenConverter());</span><br><span class="line">        enhancerChain.setTokenEnhancers(delegates); <span class="comment">//配置JWT的内容增强器</span></span><br><span class="line">        endpoints.authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService) <span class="comment">//配置加载用户信息的服务</span></span><br><span class="line">                .accessTokenConverter(accessTokenConverter())</span><br><span class="line">                .tokenEnhancer(enhancerChain);<span class="comment">//配置令牌存储策略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        security.allowFormAuthenticationForClients();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">accessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter jwtAccessTokenConverter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        jwtAccessTokenConverter.setKeyPair(keyPair());</span><br><span class="line">        <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyPair <span class="title">keyPair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从classpath下的证书中获取秘钥对</span></span><br><span class="line">        KeyStoreKeyFactory keyStoreKeyFactory = <span class="keyword">new</span> KeyStoreKeyFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;jwt.jks&quot;</span>), <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">        <span class="keyword">return</span> keyStoreKeyFactory.getKeyPair(<span class="string">&quot;jwt&quot;</span>, <span class="string">&quot;123456&quot;</span>.toCharArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果你想往JWT中添加自定义信息的话，比如说<code>登录用户的ID</code>，可以自己实现<code>TokenEnhancer</code>接口；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT内容增强器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenEnhancer</span> <span class="keyword">implements</span> <span class="title">TokenEnhancer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">enhance</span><span class="params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span> </span>&#123;</span><br><span class="line">        SecurityUser securityUser = (SecurityUser) authentication.getPrincipal();</span><br><span class="line">        Map&lt;String, Object&gt; info = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//把用户ID设置到JWT中</span></span><br><span class="line">        info.put(<span class="string">&quot;id&quot;</span>, securityUser.getId());</span><br><span class="line">        ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(info);</span><br><span class="line">        <span class="keyword">return</span> accessToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>由于我们的网关服务需要RSA的公钥来验证签名是否合法，所以认证服务需要有个接口把公钥暴露出来；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取RSA公钥接口</span></span><br><span class="line"><span class="comment"> * Created by macro on 2020/6/19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyPairController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KeyPair keyPair;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rsa/publicKey&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();</span><br><span class="line">        RSAKey key = <span class="keyword">new</span> RSAKey.Builder(publicKey).build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JWKSet(key).toJSONObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不要忘了还需要配置Spring Security，允许获取公钥接口的访问；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpringSecurity配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry registry = httpSecurity.authorizeRequests();</span><br><span class="line">        registry.requestMatchers(EndpointRequest.toAnyEndpoint())</span><br><span class="line">            	.permitAll();</span><br><span class="line">        registry.antMatchers(<span class="string">&quot;/rsa/publicKey&quot;</span>)</span><br><span class="line">            	.permitAll();</span><br><span class="line">        <span class="comment">//允许跨域请求的OPTIONS请求</span></span><br><span class="line">        registry.antMatchers(HttpMethod.OPTIONS)</span><br><span class="line">                .permitAll();</span><br><span class="line">        <span class="comment">// 任何请求需要身份认证</span></span><br><span class="line">        registry.and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个资源服务<code>ResourceServiceImpl</code>，初始化的时候把资源与角色匹配关系缓存到Redis中，方便网关服务进行鉴权的时候获取。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源与角色匹配关系管理业务类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServiceImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; resourceRolesMap;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        resourceRolesMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        resourceRolesMap.put(<span class="string">&quot;/api/hello&quot;</span>, CollUtil.toList(<span class="string">&quot;ADMIN&quot;</span>));</span><br><span class="line">        resourceRolesMap.put(<span class="string">&quot;/api/user/currentUser&quot;</span>, CollUtil.toList(<span class="string">&quot;ADMIN&quot;</span>, <span class="string">&quot;TEST&quot;</span>));</span><br><span class="line">        redisTemplate.opsForHash().putAll(RedisConstant.RESOURCE_ROLES_MAP, resourceRolesMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Gateway模块"><a href="#Gateway模块" class="headerlink" title="Gateway模块"></a>Gateway模块</h2><blockquote>
<p>网关服务，它将作为Oauth2的资源服务、客户端服务使用，对访问微服务的请求进行统一的校验认证和鉴权操作。</p>
</blockquote>
<ul>
<li><p>对网关服务进行配置安全配置，由于Gateway使用的是<code>WebFlux</code>，所以需要使用<code>@EnableWebFluxSecurity</code>注解开启</p>
</li>
<li><p>在<code>WebFluxSecurity</code>中自定义鉴权操作（根据角色还是根据路径自行实现）需要实现<code>ReactiveAuthorizationManager</code>接口</p>
</li>
<li><p>当鉴权通过后将JWT令牌中的用户信息解析出来，然后存入请求的Header中，这样后续服务就不需要解析JWT令牌了，可以直接从请求的Header中获取到用户信息</p>
</li>
<li><p>在<code>pom.xml</code>中添加相关依赖，主要是Gateway、Oauth2和JWT相关依赖；</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-jose<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nimbusds<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nimbus-jose-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>application.yml</code>中添加相关配置，主要是路由规则的配置、Oauth2中RSA公钥的配置及路由白名单的配置；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9201</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">micro-oauth2-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment">#配置路由规则</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">oauth2-api-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://demo-oauth2-api</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">oauth2-auth-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://demo-oauth2-auth</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/auth/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启从注册中心动态创建路由的功能</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span> <span class="comment">#使用小写服务名，默认是大写</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">jwt:</span></span><br><span class="line">          <span class="attr">jwk-set-uri:</span> <span class="string">&#x27;http://localhost:9401/rsa/publicKey&#x27;</span> <span class="comment">#配置RSA的公钥访问地址</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">password:</span> </span><br><span class="line"><span class="attr">secure:</span></span><br><span class="line">  <span class="attr">ignore:</span></span><br><span class="line">    <span class="attr">urls:</span> <span class="comment">#配置白名单路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/actuator/**&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/auth/oauth/token&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>对网关服务进行配置安全配置，由于Gateway使用的是<code>WebFlux</code>，所以需要使用<code>@EnableWebFluxSecurity</code>注解开启；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源服务器配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthorizationManager authorizationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IgnoreUrlsConfig ignoreUrlsConfig;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestfulAccessDeniedHandler restfulAccessDeniedHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestAuthenticationEntryPoint restAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityWebFilterChain <span class="title">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> </span>&#123;</span><br><span class="line">        http.oauth2ResourceServer().jwt()</span><br><span class="line">                .jwtAuthenticationConverter(jwtAuthenticationConverter());</span><br><span class="line">        http.authorizeExchange()</span><br><span class="line">                .pathMatchers(ArrayUtil.toArray(ignoreUrlsConfig.getUrls(),String.class)).permitAll()<span class="comment">//白名单配置</span></span><br><span class="line">                .anyExchange().access(authorizationManager)<span class="comment">//鉴权管理器配置</span></span><br><span class="line">                .and().exceptionHandling()</span><br><span class="line">                .accessDeniedHandler(restfulAccessDeniedHandler)<span class="comment">//处理未授权</span></span><br><span class="line">                .authenticationEntryPoint(restAuthenticationEntryPoint)<span class="comment">//处理未认证</span></span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;Jwt, ? extends Mono&lt;? extends AbstractAuthenticationToken&gt;&gt; jwtAuthenticationConverter() &#123;</span><br><span class="line">        JwtGrantedAuthoritiesConverter jwtGrantedAuthoritiesConverter = <span class="keyword">new</span> JwtGrantedAuthoritiesConverter();</span><br><span class="line">        jwtGrantedAuthoritiesConverter.setAuthorityPrefix(AuthConstant.AUTHORITY_PREFIX);</span><br><span class="line">        jwtGrantedAuthoritiesConverter.setAuthoritiesClaimName(AuthConstant.AUTHORITY_CLAIM_NAME);</span><br><span class="line">        JwtAuthenticationConverter jwtAuthenticationConverter = <span class="keyword">new</span> JwtAuthenticationConverter();</span><br><span class="line">        jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(jwtGrantedAuthoritiesConverter);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReactiveJwtAuthenticationConverterAdapter(jwtAuthenticationConverter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>WebFluxSecurity</code>中自定义鉴权操作需要实现<code>ReactiveAuthorizationManager</code>接口；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鉴权管理器，用于判断是否有资源的访问权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationManager</span> <span class="keyword">implements</span> <span class="title">ReactiveAuthorizationManager</span>&lt;<span class="title">AuthorizationContext</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AuthorizationDecision&gt; <span class="title">check</span><span class="params">(Mono&lt;Authentication&gt; mono, AuthorizationContext authorizationContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从Redis中获取当前路径可访问角色列表</span></span><br><span class="line">        URI uri = authorizationContext.getExchange().getRequest().getURI();</span><br><span class="line">        Object obj = redisTemplate.opsForHash().get(RedisConstant.RESOURCE_ROLES_MAP, uri.getPath());</span><br><span class="line">        List&lt;String&gt; authorities = Convert.toList(String.class,obj);</span><br><span class="line">        authorities = authorities.stream().map(i -&gt; i = AuthConstant.AUTHORITY_PREFIX + i).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//认证通过且角色匹配的用户可访问当前路径</span></span><br><span class="line">        <span class="keyword">return</span> mono</span><br><span class="line">                .filter(Authentication::isAuthenticated)</span><br><span class="line">                .flatMapIterable(Authentication::getAuthorities)</span><br><span class="line">                .map(GrantedAuthority::getAuthority)</span><br><span class="line">                .any(authorities::contains)</span><br><span class="line">                .map(AuthorizationDecision::<span class="keyword">new</span>)</span><br><span class="line">                .defaultIfEmpty(<span class="keyword">new</span> AuthorizationDecision(<span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里我们还需要实现一个全局过滤器<code>AuthGlobalFilter</code>，当鉴权通过后将JWT令牌中的用户信息解析出来，然后存入请求的Header中，这样后续服务就不需要解析JWT令牌了，可以直接从请求的Header中获取到用户信息。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将登录用户的JWT转化成用户信息的全局过滤器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(AuthGlobalFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        String token = exchange.getRequest().getHeaders().getFirst(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//从token中解析用户信息并设置到Header中去</span></span><br><span class="line">            String realToken = token.replace(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            JWSObject jwsObject = JWSObject.parse(realToken);</span><br><span class="line">            String userStr = jwsObject.getPayload().toString();</span><br><span class="line">            LOGGER.info(<span class="string">&quot;AuthGlobalFilter.filter() user:&#123;&#125;&quot;</span>,userStr);</span><br><span class="line">            ServerHttpRequest request = exchange.getRequest().mutate().header(<span class="string">&quot;user&quot;</span>, userStr).build();</span><br><span class="line">            exchange = exchange.mutate().request(request).build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="api模块"><a href="#api模块" class="headerlink" title="api模块"></a>api模块</h2><blockquote>
<p>后我们搭建一个API服务，它不会集成和实现任何安全相关逻辑，全靠网关来保护它。</p>
</blockquote>
<ul>
<li>在<code>pom.xml</code>中添加相关依赖，就添加了一个web依赖；</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>application.yml</code>添加相关配置，很常规的配置；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9501</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">micro-oauth2-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个测试接口，网关验证通过即可访问；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个<code>LoginUserHolder</code>组件，用于从请求的Header中直接获取登录用户信息；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取登录用户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginUserHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDTO <span class="title">getCurrentUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//从Header中获取用户信息</span></span><br><span class="line">        ServletRequestAttributes servletRequestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest request = servletRequestAttributes.getRequest();</span><br><span class="line">        String userStr = request.getHeader(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        JSONObject userJsonObject = <span class="keyword">new</span> JSONObject(userStr);</span><br><span class="line">        UserDTO userDTO = <span class="keyword">new</span> UserDTO();</span><br><span class="line">        userDTO.setUsername(userJsonObject.getStr(<span class="string">&quot;user_name&quot;</span>));</span><br><span class="line">        userDTO.setId(Convert.toLong(userJsonObject.get(<span class="string">&quot;id&quot;</span>)));</span><br><span class="line">        userDTO.setRoles(Convert.toList(String.class,userJsonObject.get(<span class="string">&quot;authorities&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> userDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个获取当前用户信息的接口。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取登录用户信息接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginUserHolder loginUserHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/currentUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDTO <span class="title">currentUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loginUserHolder.getCurrentUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="功能演示"><a href="#功能演示" class="headerlink" title="功能演示"></a>功能演示</h2><p>使用密码模式获取JWT令牌，访问地址：<a target="_blank" rel="noopener" href="http://localhost:9201/auth/oauth/token">http://localhost:9201/auth/oauth/token</a></p>
<p>使用获取到的JWT令牌访问需要权限的接口，访问地址：<a target="_blank" rel="noopener" href="http://localhost:9201/api/hello">http://localhost:9201/api/hello</a></p>
<p>使用获取到的JWT令牌访问获取当前登录用户信息的接口，访问地址：<a target="_blank" rel="noopener" href="http://localhost:9201/api/user/currentUser">http://localhost:9201/api/user/currentUser</a></p>
<p>当JWT令牌过期时，使用refresh_token获取新的JWT令牌，访问地址：<a target="_blank" rel="noopener" href="http://localhost:9201/auth/oauth/token">http://localhost:9201/auth/oauth/token</a></p>
<p>使用没有访问权限的<code>andy</code>账号登录，访问接口时会返回如下信息，访问地址：<a target="_blank" rel="noopener" href="http://localhost:9201/api/hello">http://localhost:9201/api/hello</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Sleuth,Zipkin)%E5%AD%A6%E4%B9%A0%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Sleuth,Zipkin)%E5%AD%A6%E4%B9%A0%20/" itemprop="url">Spring-SpringCloud(Sleuth,Zipkin)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T23:57:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="链路追踪"><a href="#链路追踪" class="headerlink" title="链路追踪"></a>链路追踪</h1><ul>
<li>梳理微服务上下游调用关系</li>
<li>排查故障</li>
</ul>
<h2 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h2><ul>
<li>分布式环境下链路追踪</li>
<li>Timing信息</li>
<li>定位链路</li>
<li>信息收集展示</li>
</ul>
<h1 id="Sleuth链路追踪"><a href="#Sleuth链路追踪" class="headerlink" title="Sleuth链路追踪"></a>Sleuth链路追踪</h1><ul>
<li>服务节点添加相关依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 链路追踪 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Zipkin --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>服务节点修改application.yml文件，配置收集日志的zipkin-server访问地址：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="comment"># base-url: http://localhost:9411</span></span><br><span class="line">    <span class="comment">#如果实现高可用 配置Eureka中的地址</span></span><br><span class="line">    <span class="attr">discoveryClientEnabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://ZIPKIN-SERVER/</span></span><br><span class="line">    <span class="attr">locator:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span> <span class="comment">#设置Sleuth的抽样收集概率</span></span><br></pre></td></tr></table></figure>

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/Sleuth/Sleuth%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA.png" alt="图片描述" style="zoom:50%;" />



<p>借助Sleuth链路追踪能力，可以完成<br>1、线上故障定位<br>2、依赖分析梳理<br>3、链路优化<br>4、性能分析</p>
<h1 id="Sleuth架构体系"><a href="#Sleuth架构体系" class="headerlink" title="Sleuth架构体系"></a>Sleuth架构体系</h1><p>Sleuth采用集成底层Log系统的方式实现数据埋点</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/Sleuth/sleuth%E5%9F%8B%E7%82%B9.png" alt="图片描述" style="zoom:67%;" />

<h2 id="数据埋点"><a href="#数据埋点" class="headerlink" title="数据埋点"></a>数据埋点</h2><ul>
<li>链路ID：当前调用链的唯一ID，在这次调用请求开始到结束的过程中，所有经过的节点都拥有一个相同的链路iD</li>
<li>单元ID：一次链路请求会访问不同的服务节点上的服务，每一次服务调用都相当于一个独立单元。会有一个独立的单元ID。同时每一个独立单元都要知道调用请求来自哪里（对当前服务发起直接调用的哪一方的单元ID，记为Parent ID）</li>
</ul>
<h2 id="Log系统集成"><a href="#Log系统集成" class="headerlink" title="Log系统集成"></a>Log系统集成</h2><p>使用<code>MDC+FormatPattern</code>的方式输出信息：Format决定输出格式，MDC决定输出什么</p>
<ul>
<li>Log formatPattern：定义了日志输出格式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;%5p [sleuth-traceA,%X&#123;X-B3-TraceId:-&#125;,%X&#123;X-B3-SpanId:-&#125;,%X&#123;X-Span-Export:-&#125;]&quot;</span><br></pre></td></tr></table></figure>

<h2 id="埋点信息的传递"><a href="#埋点信息的传递" class="headerlink" title="埋点信息的传递"></a>埋点信息的传递</h2><ul>
<li>MDC</li>
</ul>
<p>通过InheritableThreadLocal来实现，可以携带当前线程的上下文信息，底层是一个Map，存储一系列key-value值。借助AOP实现日志采集。        </p>
<p>由于MDC基于InheritableThreadLocal而不是ThreadLocal实现，新词当线程中又开启了新的子线程，那么子线程依然会保留父线程的上下文信息</p>
<h1 id="Zipkin"><a href="#Zipkin" class="headerlink" title="Zipkin"></a>Zipkin</h1><blockquote>
<p>Zipkin是Twitter的一个开源项目，可以用来获取和分析Spring Cloud Sleuth 中产生的请求链路跟踪日志，它提供了Web界面来帮助我们直观地查看请求链路跟踪信息。</p>
</blockquote>
<h2 id="Zipkin的核心功能"><a href="#Zipkin的核心功能" class="headerlink" title="Zipkin的核心功能"></a>Zipkin的核心功能</h2><p>1、数据收集 聚合客户端数据</p>
<p>2、数据查找 通过不同维度对调用链路进行查找</p>
<h2 id="使用方式—使用jar包"><a href="#使用方式—使用jar包" class="headerlink" title="使用方式—使用jar包"></a>使用方式—使用jar包</h2><ul>
<li><p>SpringBoot 2.0以上版本已经不需要自行搭建zipkin-server，我们可以从该地址下载zipkin-server：<a target="_blank" rel="noopener" href="https://repo1.maven.org/maven2/io/zipkin/java/zipkin-server/2.12.9/zipkin-server-2.12.9-exec.jar">https://repo1.maven.org/maven2/io/zipkin/java/zipkin-server/2.12.9/zipkin-server-2.12.9-exec.jar</a></p>
</li>
<li><p>下载完成后使用以下命令运行zipkin-server：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin-server-2.12.9-exec.jar</span><br></pre></td></tr></table></figure></li>
<li><p>Zipkin页面访问地址：<a target="_blank" rel="noopener" href="http://localhost:9411/">http://localhost:9411</a></p>
</li>
</ul>
<h3 id="使用Elasticsearch存储跟踪信息"><a href="#使用Elasticsearch存储跟踪信息" class="headerlink" title="使用Elasticsearch存储跟踪信息"></a>使用Elasticsearch存储跟踪信息</h3><blockquote>
<p>如果我们把zipkin-server重启一下就会发现刚刚的存储的跟踪信息全部丢失了，可见其是存储在内存中的，有时候我们需要将所有信息存储下来</p>
</blockquote>
<h3 id="修改启动参数将信息存储到Elasticsearch"><a href="#修改启动参数将信息存储到Elasticsearch" class="headerlink" title="修改启动参数将信息存储到Elasticsearch"></a>修改启动参数将信息存储到Elasticsearch</h3><ul>
<li>使用以下命令运行，就可以把跟踪信息存储到Elasticsearch里面去了，重新启动也不会丢失；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># STORAGE_TYPE：表示存储类型 ES_HOSTS：表示ES的访问地址</span></span><br><span class="line">java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=elasticsearch --ES_HOSTS=localhost:9200 </span><br></pre></td></tr></table></figure>

<h2 id="使用方式—使用jar包-1"><a href="#使用方式—使用jar包-1" class="headerlink" title="使用方式—使用jar包"></a>使用方式—使用jar包</h2><p>搭建zipkin-server的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-autoconfigure-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Zipkin接受客户端信息方式"><a href="#Zipkin接受客户端信息方式" class="headerlink" title="Zipkin接受客户端信息方式"></a>Zipkin接受客户端信息方式</h3><ul>
<li><p>WEB</p>
</li>
<li><p>通过rabbitmq接收客户端信息<br><code>zipkin-autoconfigure-collector-rabbitmq</code></p>
</li>
<li><p>借助ES来保存信息<br><code>zipkin-autoconfigure-storage-elasticsearch-http</code></p>
</li>
</ul>
<h3 id="修改Zipkin接受客户端信息方式"><a href="#修改Zipkin接受客户端信息方式" class="headerlink" title="修改Zipkin接受客户端信息方式"></a>修改Zipkin接受客户端信息方式</h3><ul>
<li>修改yml中信息</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment"># 链路追踪</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">discoveryClientEnabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://ZIPKIN-SERVER/</span></span><br><span class="line">    <span class="attr">locator:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 以HTTP上传数据到Zipkin</span></span><br><span class="line">    <span class="comment"># WHY? bus依赖项导入了rabbitmq的依赖项，zipkin会默认使用mq</span></span><br><span class="line">    <span class="attr">sender:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Stream)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Stream)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Stream)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T23:57:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-Cloud-Bus和Spring-Cloud-Stream的区别是啥？使用场景有啥区别？"><a href="#Spring-Cloud-Bus和Spring-Cloud-Stream的区别是啥？使用场景有啥区别？" class="headerlink" title="Spring Cloud Bus和Spring Cloud Stream的区别是啥？使用场景有啥区别？"></a>Spring Cloud Bus和Spring Cloud Stream的区别是啥？使用场景有啥区别？</h1><p>Spring Cloud Stream通过对消息中间件进行抽象封装，提供一个统一的接口供我们发送和监听消息，而Bus则是在Stream基础之上再次进行抽象封装，使得我们可以在不用理解消息发送、监听等概念的基础上使用消息来完成业务逻辑的处理。Spring Cloud Stream中，异步调用能让各个服务充分解耦而且也更加灵活。而Spring Cloud Bus就是借助消息驱动来实现将消息（事件）广播到各个服务中，然后服务对这些消息进行消费</p>
<h1 id="消息驱动在微服务中的应用"><a href="#消息驱动在微服务中的应用" class="headerlink" title="消息驱动在微服务中的应用"></a>消息驱动在微服务中的应用</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/Sleuth/1.png" style="zoom:50%;" />

<h1 id="Stream体系架构和交互模型"><a href="#Stream体系架构和交互模型" class="headerlink" title="Stream体系架构和交互模型"></a>Stream体系架构和交互模型</h1><ul>
<li>专门为构建消息驱动服务所涉及的应用框架</li>
<li>stream底层使用Spring Integration为消息代理层提供网络支持</li>
</ul>
<h1 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h1><ul>
<li>应用模式<ul>
<li>   输入通道</li>
<li>   输出通道</li>
<li>   通道与底层中间件的代理</li>
</ul>
</li>
<li>适配层抽象</li>
</ul>
<p>Stram将组件与底层中间件之间的通信过程抽象成了Binder层，不再关心底层是RabbitMQ还是kafka，只注重业务就行</p>
<ul>
<li>插件式适配层</li>
</ul>
<p>Binder层采用插件的形式提供服务</p>
<ul>
<li><p>持久化的发布订阅模型</p>
</li>
<li><p>消费组：一条消息只能被组内一个实例消费</p>
</li>
<li><p>分区：支持在消费者实例之间创建分区</p>
</li>
</ul>
<h1 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h1><ul>
<li>引用</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>消息体</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基于发布订阅实现广播"><a href="#基于发布订阅实现广播" class="headerlink" title="基于发布订阅实现广播"></a>基于发布订阅实现广播</h2><blockquote>
<p>发布/订阅模式是指同时向多个消费者发送消息的模式（类似广播的形式），它包含一个生产者、两个消费者、两个队列和一个交换机。两个消费者同时绑定到不同的队列上去，两个队列绑定到交换机上去，生产者通过发送消息到交换机，所有消费者接收并消费消息。</p>
</blockquote>
<ul>
<li>交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyTopic</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">&quot;myTopic-consumer&quot;</span>;</span><br><span class="line">    String OUTPUT = <span class="string">&quot;myTopic-producer&quot;</span>;</span><br><span class="line">    <span class="meta">@Input(INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output(OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(value = &#123;</span></span><br><span class="line"><span class="meta">        MyTopic.class,</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 自定义消息广播</span></span><br><span class="line">    <span class="meta">@StreamListener(MyTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeMyMessage</span><span class="params">(Object payload)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;My message consumed successfully, payload=&#123;&#125;&quot;</span>, payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyTopic producer;</span><br><span class="line">    <span class="comment">// 简单广播消息</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;send&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body)</span> </span>&#123;</span><br><span class="line">        producer.output().send(MessageBuilder.withPayload(body).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绑定Channel到broadcast</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="attr">myTopic-consumer:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">broadcast</span></span><br><span class="line">		<span class="attr">myTopic-producer:</span></span><br><span class="line">		  <span class="attr">destination:</span> <span class="string">broadcast</span></span><br></pre></td></tr></table></figure>



<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/rabbitmq%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F.png"></p>
<h2 id="单播模式"><a href="#单播模式" class="headerlink" title="单播模式"></a>单播模式</h2><h3 id="消费组"><a href="#消费组" class="headerlink" title="消费组"></a>消费组</h3><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/2.png" style="zoom:50%;" />

<p><strong>消息会被所有消费组消费，但每个消费组只会有一个消费者消费</strong></p>
<ul>
<li>交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyTopic</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">&quot;group-consumer&quot;</span>;</span><br><span class="line">    String OUTPUT = <span class="string">&quot;group-producer&quot;</span>;</span><br><span class="line">    <span class="meta">@Input(INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output(OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(value = &#123;</span></span><br><span class="line"><span class="meta">        GroupTopic.class,</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 消息分组 &amp; 消费分区示例</span></span><br><span class="line">    <span class="meta">@StreamListener(GroupTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeGroupMessage</span><span class="params">(Object payload)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Group message consumed successfully, payload=&#123;&#125;&quot;</span>, payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyTopic producer;</span><br><span class="line">    <span class="comment">// 消息分组和消息分区</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;sendToGroup&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageToGroup</span><span class="params">(<span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body)</span> </span>&#123;</span><br><span class="line">        groupTopicProducer.output().send(MessageBuilder.withPayload(body).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消息分组示例</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.group-consumer.destination</span>=<span class="string">group-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.group-producer.destination</span>=<span class="string">group-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.group-consumer.group</span>=<span class="string">Group-A</span></span><br></pre></td></tr></table></figure>

<h3 id="消费分区"><a href="#消费分区" class="headerlink" title="消费分区"></a>消费分区</h3><p>多次请求到同一分区，此分区对应消费组内的消费者轮询消费</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/rabbitmq/3.png" style="zoom:50%;" />

<ul>
<li>交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyTopic</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">&quot;group-consumer&quot;</span>;</span><br><span class="line">    String OUTPUT = <span class="string">&quot;group-producer&quot;</span>;</span><br><span class="line">    <span class="meta">@Input(INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output(OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(value = &#123;</span></span><br><span class="line"><span class="meta">        GroupTopic.class,</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 消息分组 &amp; 消费分区示例</span></span><br><span class="line">    <span class="meta">@StreamListener(GroupTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeGroupMessage</span><span class="params">(Object payload)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Group message consumed successfully, payload=&#123;&#125;&quot;</span>, payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyTopic producer;</span><br><span class="line">    <span class="comment">// 消息分组和消息分区</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;sendToGroup&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageToGroup</span><span class="params">(<span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body)</span> </span>&#123;</span><br><span class="line">        groupTopicProducer.output().send(MessageBuilder.withPayload(body).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消息分区配置</span></span><br><span class="line"><span class="comment">## 打开消费者的消费分区功能</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.group-consumer.consumer.partitioned</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">## 两个消息分区</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.group-producer.producer.partition-count</span>=<span class="string">2</span></span><br><span class="line"><span class="comment"># SpEL (Key resolver) 可以定义复杂表达式生成Key</span></span><br><span class="line"><span class="comment"># 我们这里用最简化的配置，只有索引参数为1的节点（消费者），才能消费消息</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.group-producer.producer.partition-key-expression</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 当前消费者实例总数</span></span><br><span class="line"><span class="meta">spring.cloud.stream.instanceCount</span>=<span class="string">2</span></span><br><span class="line"><span class="comment"># 最大值instanceCount-1，当前实例的索引号</span></span><br><span class="line"><span class="comment"># spring.cloud.stream.instanceIndex=1</span></span><br><span class="line"><span class="meta">spring.cloud.stream.instanceIndex</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<h2 id="延迟消息"><a href="#延迟消息" class="headerlink" title="延迟消息"></a>延迟消息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1.	下载插件</span><br><span class="line">https:&#x2F;&#x2F;www.rabbitmq.com&#x2F;community-plugins.html</span><br><span class="line"></span><br><span class="line">找到rabbitmq_delayed_message_exchange</span><br><span class="line">下载对应版本的插件，3.6和3.7版本插件不一样</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2. 下载以后解压，copy到rabbitmq安装目录下的plugins文件夹</span><br><span class="line"></span><br><span class="line">3.	安装插件</span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line"></span><br><span class="line">4.	安装完一定要重启RabbitMQ，不是单单重启UI管理界面！</span><br><span class="line">如果只是单单调用rabbitmqctl  stop_app然后再rabbitmqctl  start_app是没有作用的！</span><br><span class="line">正确的步骤是先rabbitmqctl stop，然后再直接执行rabbitmq-server</span><br></pre></td></tr></table></figure>

<h3 id="业务场景-1"><a href="#业务场景-1" class="headerlink" title="业务场景"></a>业务场景</h3><ul>
<li>用户进行下单操作（会有锁定商品库存、使用优惠券、积分一系列的操作）；</li>
<li>生成订单，获取订单的id；</li>
<li>获取到设置的订单超时时间（假设设置的为60分钟不支付取消订单）；</li>
<li>按订单超时时间发送一个延迟消息给RabbitMQ，让它在订单超时后触发取消订单的操作；</li>
<li>如果用户没有支付，进行取消订单操作（释放锁定商品库存、返还优惠券、返回积分一系列操作）。</li>
</ul>
<hr>
<ul>
<li>交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DelayedTopic</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">&quot;delayed-consumer&quot;</span>;</span><br><span class="line">    String OUTPUT = <span class="string">&quot;delayed-producer&quot;</span>;</span><br><span class="line">    <span class="meta">@Input(INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output(OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(value = &#123;</span></span><br><span class="line"><span class="meta">        DelayedTopic.class,</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamConsumer</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 延迟消息示例</span></span><br><span class="line">    <span class="meta">@StreamListener(DelayedTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeDelayedMessage</span><span class="params">(MessageBean bean)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Delayed message consumed successfully, payload=&#123;&#125;&quot;</span>, bean.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyTopic producer;</span><br><span class="line">     <span class="comment">// 延迟消息</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;sendDM&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendDelayedMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(value = &quot;seconds&quot;)</span> Integer seconds)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MessageBean msg = <span class="keyword">new</span> MessageBean();</span><br><span class="line">        msg.setPayload(body);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;ready to send delayed message&quot;</span>);</span><br><span class="line">        delayedTopicProducer.output().send(</span><br><span class="line">                MessageBuilder.withPayload(msg)</span><br><span class="line">                        .setHeader(<span class="string">&quot;x-delay&quot;</span>, seconds * <span class="number">1000</span>)</span><br><span class="line">                        .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 延迟消息配置</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.delayed-consumer.destination</span>=<span class="string">delayed-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.delayed-producer.destination</span>=<span class="string">delayed-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rabbit.bindings.delayed-producer.producer.delayed-exchange</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h2 id="Stream出现异常处理"><a href="#Stream出现异常处理" class="headerlink" title="Stream出现异常处理"></a>Stream出现异常处理</h2><h4 id="异常情况："><a href="#异常情况：" class="headerlink" title="异常情况："></a>异常情况：</h4><ol>
<li>消息被拒接（重试次数Max）</li>
<li>消息过期（TTl）</li>
<li>队列长度已满</li>
</ol>
<h3 id="直接发起重试"><a href="#直接发起重试" class="headerlink" title="直接发起重试"></a>直接发起重试</h3><ul>
<li>异常重试（单机版）</li>
</ul>
<p>重试只会发在消费端，Stream将失败消息原封不动的发给当前这个消费者，重试只会发生在当前机器，不会换一个节点重试</p>
<ul>
<li>重入队列重试</li>
</ul>
<ol>
<li>消息来源：重入队列重试等于是新发一个消息</li>
<li>消费地点：可能会被其他Comsumer消费</li>
</ol>
<ul>
<li>交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DelayedTopic</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">&quot;error-consumer&quot;</span>;</span><br><span class="line">    String OUTPUT = <span class="string">&quot;error-producer&quot;</span>;</span><br><span class="line">    <span class="meta">@Input(INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output(OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(value = &#123;</span></span><br><span class="line"><span class="meta">        ErrorTopic.class,</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异常重试（单机版）</span></span><br><span class="line">    <span class="meta">@StreamListener(ErrorTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeErrorMessage</span><span class="params">(MessageBean bean)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Are you OK?&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count.incrementAndGet() % <span class="number">3</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Fine, thank you. And you?&quot;</span>);</span><br><span class="line">            count.set(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;What&#x27;s your problem?&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;I&#x27;m not OK&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常重试（联机版-重新入列）</span></span><br><span class="line">    <span class="meta">@StreamListener(RequeueTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requeueErrorMessage</span><span class="params">(MessageBean bean)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Are you OK?&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        throw new RuntimeException(&quot;I&#x27;m not OK&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ErrorTopic errorTopicProducer;</span><br><span class="line">    <span class="comment">// 异常重试（单机版）</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;sendError&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendErrorMessage</span><span class="params">(<span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body)</span> </span>&#123;</span><br><span class="line">        MessageBean msg = <span class="keyword">new</span> MessageBean();</span><br><span class="line">        msg.setPayload(body);</span><br><span class="line">        errorTopicProducer.output().send(MessageBuilder.withPayload(msg).build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常重试（联机版 - 重新入列）</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;requeue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendErrorMessageToMQ</span><span class="params">(<span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body)</span> </span>&#123;</span><br><span class="line">        MessageBean msg = <span class="keyword">new</span> MessageBean();</span><br><span class="line">        msg.setPayload(body);</span><br><span class="line">        requeueTopicProducer.output().send(MessageBuilder.withPayload(msg).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异常消息（单机版重试）</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.error-consumer.destination</span>=<span class="string">error-out-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.error-producer.destination</span>=<span class="string">error-out-topic</span></span><br><span class="line"><span class="comment"># 重试次数（本机重试）</span></span><br><span class="line"><span class="comment"># 次数=1相当于不重试</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.error-consumer.consumer.max-attempts</span>=<span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 异常消息（requeue重试）</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.requeue-consumer.destination</span>=<span class="string">requeue-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.requeue-producer.destination</span>=<span class="string">requeue-topic</span></span><br><span class="line"><span class="comment"># 必须把max-attempts设置为1，否则requeue不能生效</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.requeue-consumer.consumer.max-attempts</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.requeue-consumer.group</span>=<span class="string">requeue-group</span></span><br><span class="line"><span class="comment"># 仅对当前requeue-consumer，开启requeue</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rabbit.bindings.requeue-consumer.consumer.requeueRejected</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h3 id="降级"><a href="#降级" class="headerlink" title="降级"></a>降级</h3><ul>
<li>交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FallbackTopic</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">&quot;fallback-consumer&quot;</span>;</span><br><span class="line">    String OUTPUT = <span class="string">&quot;fallback-producer&quot;</span>;</span><br><span class="line">    <span class="meta">@Input(INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output(OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(value = &#123;</span></span><br><span class="line"><span class="meta">       FallbackTopic.class</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Fallback + 升级版本</span></span><br><span class="line">    <span class="meta">@StreamListener(FallbackTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goodbyeBadGuy</span><span class="params">(MessageBean bean,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="meta">@Header(&quot;version&quot;)</span> String version)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Fallback - Are you OK?&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;1.0&quot;</span>.equalsIgnoreCase(version)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Fallback - Fine, thank you. And you?&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;2.0&quot;</span>.equalsIgnoreCase(version)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;unsupported version&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;I&#x27;m not OK&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Fallback - version=&#123;&#125;&quot;</span>, version);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 降级流程</span></span><br><span class="line">    <span class="meta">@ServiceActivator(inputChannel = &quot;fallback-topic.fallback-group.errors&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fallback</span><span class="params">(Message&lt;?&gt; message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;fallback entered&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FallbackTopic fallbackTopicProducer;</span><br><span class="line">    <span class="comment">// fallback + 升版</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;fallback&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageToFallback</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(value = &quot;version&quot;, defaultValue = &quot;1.0&quot;)</span> String version)</span> </span>&#123;</span><br><span class="line">        MessageBean msg = <span class="keyword">new</span> MessageBean();</span><br><span class="line">        msg.setPayload(body);</span><br><span class="line">        fallbackTopicProducer.output().send(</span><br><span class="line">                MessageBuilder.withPayload(msg)</span><br><span class="line">                        .setHeader(<span class="string">&quot;version&quot;</span>, version)</span><br><span class="line">                        .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Fallback配置</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.fallback-consumer.destination</span>=<span class="string">fallback-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.fallback-producer.destination</span>=<span class="string">fallback-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.fallback-consumer.consumer.max-attempts</span>=<span class="string">2</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.fallback-consumer.group</span>=<span class="string">fallback-group</span></span><br><span class="line"><span class="comment"># input channel -&gt;    fallback-topic.fallback-group.errors</span></span><br></pre></td></tr></table></figure>

<h3 id="死信交换机-死信队列处理"><a href="#死信交换机-死信队列处理" class="headerlink" title="死信交换机(死信队列处理)"></a>死信交换机(死信队列处理)</h3><p>DLX-死信交换器，将异常消息路由到死信队列<br>DLK-Dead Letter Routing key</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/stream/%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97.png" style="zoom:50%;" />

<ul>
<li>交换机</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DlqTopic</span> </span>&#123;</span><br><span class="line">    String INPUT = <span class="string">&quot;dlq-consumer&quot;</span>;</span><br><span class="line">    String OUTPUT = <span class="string">&quot;dlq-producer&quot;</span>;</span><br><span class="line">    <span class="meta">@Input(INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Output(OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableBinding(value = &#123;</span></span><br><span class="line"><span class="meta">        DlqTopic.class</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 死信队列</span></span><br><span class="line">    <span class="meta">@StreamListener(DlqTopic.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeDlqMessage</span><span class="params">(MessageBean bean)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Dlq - Are you OK?&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (count.incrementAndGet() % <span class="number">3</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Dlq - Fine, thank you. And you?&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Dlq - What&#x27;s your problem?&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;I&#x27;m not OK&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DlqTopic dlqTopicProducer;</span><br><span class="line">    <span class="comment">// 死信队列测试</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;dlq&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageToDlq</span><span class="params">(<span class="meta">@RequestParam(value = &quot;body&quot;)</span> String body)</span> </span>&#123;</span><br><span class="line">        MessageBean msg = <span class="keyword">new</span> MessageBean();</span><br><span class="line">        msg.setPayload(body);</span><br><span class="line">        dlqTopicProducer.output().send(MessageBuilder.withPayload(msg).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yml配置</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 死信队列配置</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.dlq-consumer.destination</span>=<span class="string">dlq-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.dlq-producer.destination</span>=<span class="string">dlq-topic</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.dlq-consumer.consumer.max-attempts</span>=<span class="string">2</span></span><br><span class="line"><span class="meta">spring.cloud.stream.bindings.dlq-consumer.group</span>=<span class="string">dlq-group</span></span><br><span class="line"><span class="comment"># 开启死信队列（默认 topic.dlq）</span></span><br><span class="line"><span class="meta">spring.cloud.stream.rabbit.bindings.dlq-consumer.consumer.auto-bind-dlq</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>



<h1 id="如何选取合适的异常处理策略"><a href="#如何选取合适的异常处理策略" class="headerlink" title="如何选取合适的异常处理策略"></a>如何选取合适的异常处理策略</h1><ul>
<li><p><strong>可以抛弃的异常</strong>——转入其他队列或直接丢弃</p>
<p>1、参数异常<br>2、非法数据</p>
</li>
<li><p><strong>谨慎使用重回队列</strong>——遇到重试也无法解决的异常（如上述两个异常）服务将进入无限循环中</p>
</li>
<li><p><strong>重试+状态检查</strong>——添加version乐观锁，如果操作对象的当前版本高于消息中的版本，就不做处理</p>
</li>
</ul>
<p>例如有些分步操作的业务（商品批量上下架），先进行下架的消息任务，在进行上架的消息业务，如果业务没问题那么商品状态最终为<strong>上架</strong></p>
<p>但是，下架操作失败了，触发重试，再重试之前出发了上架消息业务，之后又重试下架成功，最后商品状态为<strong>下架</strong>。</p>
<ul>
<li><p>适合<strong>重试</strong>的场景：</p>
<ol>
<li>读数据服务</li>
<li>实现幂等性的写服务</li>
</ol>
</li>
<li><p>优先考虑<strong>降级</strong></p>
<p>比如一些操作无法立即重试，可以使用降级让请求在延迟队列等待一段时间在重试。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Zuul,Gateway)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Zuul,Gateway)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Zuul,Gateway)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T23:57:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/zuul?id=spring-cloud-zuul%EF%BC%9Aapi%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1">Spring Cloud Zuul：API网关服务</a></p>
<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/gateway?id=spring-cloud-gateway%EF%BC%9A%E6%96%B0%E4%B8%80%E4%BB%A3api%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1">Spring Cloud Gateway：新一代API网关服务</a></p>
<h1 id="什么是网关，和过滤器有什么区别"><a href="#什么是网关，和过滤器有什么区别" class="headerlink" title="什么是网关，和过滤器有什么区别"></a>什么是网关，和过滤器有什么区别</h1><p>网关相当于一个网络服务架构的入口，所有网络请求必须通过网关转发到具体服务，作用：服务请求，权限控制，负载均衡，路由转发，监控，黑白名单</p>
<p>网关是对所有服务的请求进行分析过滤，过滤器是对单个服务而言</p>
<h1 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h1><p>API网关为微服务架构中的服务提供了统一的访问入口，客户端通过API网关访问相关服务。API网关的定义类似于设计模式中的门面模式，它相当于整个微服务架构中的门面，所有客户端的访问都通过它来进行路由及过滤。它实现了请求路由、负载均衡、校验过滤、服务容错、服务聚合等功能。</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><h4 id="配置路由规则"><a href="#配置路由规则" class="headerlink" title="配置路由规则"></a>配置路由规则</h4><ul>
<li><p>我们可以通过修改application.yml中的配置来配置路由规则</p>
<p>这里我们将匹配/ribbonService/**的请求路由到demo-service-consumer服务上去， 匹配/feignService/**的请求路由到demo-service-consumer-feign上去。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  routes: #给服务配置路由</span><br><span class="line">    demo-service-consumer:</span><br><span class="line">      path: &#x2F;ribbonService&#x2F;**</span><br><span class="line">    demo-service-consumer-feign:</span><br><span class="line">      path: &#x2F;feignService&#x2F;**</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8801/feignService/user/1">http://localhost:8801/feignService/user/1</a> 可以发现请求路由到demo-service-consumer-feign了；</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8801/ribbonService/user/1">http://localhost:8801/ribbonService/user/1</a> 可以发现请求路由到demo-service-consumer了；</p>
<h4 id="默认路由规则"><a href="#默认路由规则" class="headerlink" title="默认路由规则"></a>默认路由规则</h4><ul>
<li>Zuul和Eureka结合使用，可以实现路由的自动配置，自动配置的路由以服务名称为匹配路径，相当于如下配置：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  routes: #给服务配置路由</span><br><span class="line">    demo-service-consumer:</span><br><span class="line">      path: &#x2F;demo-service-consumer&#x2F;**</span><br><span class="line">    demo-service-consumer-feign:</span><br><span class="line">      path: &#x2F;demo-service-consumer-feign&#x2F;**</span><br></pre></td></tr></table></figure>

<ul>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8801/demo-service-consumer/user/1%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E8%B7%AF%E7%94%B1%E5%88%B0%E4%BA%86demo-service-consumer%E4%B8%8A%E4%BA%86%EF%BC%9B">http://localhost:8801/demo-service-consumer/user/1同样可以路由到了demo-service-consumer上了；</a></li>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8801/demo-service-consumer-feign/user/1%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E8%B7%AF%E7%94%B1%E5%88%B0%E4%BA%86demo-service-consumer-feign%E4%B8%8A%E4%BA%86%E3%80%82">http://localhost:8801/demo-service-consumer-feign/user/1同样可以路由到了demo-service-consumer-feign上了。</a></li>
<li>如果不想使用默认的路由规则，可以添加以下配置来忽略默认路由配置：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  ignored-services: user-service,feign-service #关闭默认路由配置</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡功能"><a href="#负载均衡功能" class="headerlink" title="负载均衡功能"></a>负载均衡功能</h3><blockquote>
<p>多次调用 <a target="_blank" rel="noopener" href="http://localhost:8801/feignService/user/1">http://localhost:8801/feignService/user/1</a> 进行测试</p>
</blockquote>
<p>发现demo-provide1和demo-provide2交替打印日志</p>
<h3 id="配置访问前缀"><a href="#配置访问前缀" class="headerlink" title="配置访问前缀"></a>配置访问前缀</h3><p>我们可以通过以下配置来给网关路径添加前缀，此处添加了/proxy前缀，这样我们需要访问<a target="_blank" rel="noopener" href="http://localhost:8801/proxy/feignService/user/1%E6%89%8D%E8%83%BD%E8%AE%BF%E9%97%AE%E5%88%B0user-service%E4%B8%AD%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82">http://localhost:8801/proxy/feignService/user/1才能访问到user-service中的接口。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  prefix: &#x2F;proxy #给网关路由添加前缀</span><br></pre></td></tr></table></figure>

<h3 id="Header过滤及重定向添加Host"><a href="#Header过滤及重定向添加Host" class="headerlink" title="Header过滤及重定向添加Host"></a>Header过滤及重定向添加Host</h3><ul>
<li>Zuul在请求路由时，默认会过滤掉一些敏感的头信息，以下配置可以防止路由时的Cookie及Authorization的丢失：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  sensitive-headers: Cookie,Set-Cookie,Authorization #配置过滤敏感的请求头信息，设置为空就不会过滤</span><br></pre></td></tr></table></figure>

<ul>
<li>Zuul在请求路由时，不会设置最初的host头信息，以下配置可以解决：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  add-host-header: true #设置为true重定向是会添加host请求头</span><br></pre></td></tr></table></figure>

<h3 id="查看路由信息"><a href="#查看路由信息" class="headerlink" title="查看路由信息"></a>查看路由信息</h3><blockquote>
<p>我们可以通过SpringBoot Actuator来查看Zuul中的路由信息。</p>
</blockquote>
<ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改application.yaml配置文件，开启查看路由的端点：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &#39;routes&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过访问<a target="_blank" rel="noopener" href="http://localhost:8801/actuator/routes%E6%9F%A5%E7%9C%8B%E7%AE%80%E5%8D%95%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF%EF%BC%9A">http://localhost:8801/actuator/routes查看简单路由信息：</a></li>
</ul>
<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><h4 id="过滤器类型"><a href="#过滤器类型" class="headerlink" title="过滤器类型"></a>过滤器类型</h4><blockquote>
<p>Zuul中有以下几种典型的过滤器类型。</p>
</blockquote>
<ul>
<li>pre：在请求被路由到目标服务前执行，比如权限校验、打印日志等功能；</li>
<li>routing：在请求被路由到目标服务时执行，这是使用Apache HttpClient或Netflix Ribbon构建和发送原始HTTP请求的地方；</li>
<li>post：在请求被路由到目标服务后执行，比如给目标服务的响应添加头信息，收集统计数据等功能；</li>
<li>error：请求在其他阶段发生错误时执行。</li>
</ul>
<h4 id="过滤器的生命周期"><a href="#过滤器的生命周期" class="headerlink" title="过滤器的生命周期"></a>过滤器的生命周期</h4><blockquote>
<p>下图描述了一个HTTP请求到达API网关后，如何在各种不同类型的过滤器中流转的过程。</p>
</blockquote>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/zuul/zuul%E8%BF%87%E6%BB%A4%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" style="zoom: 67%;" />

<h4 id="定义过滤器"><a href="#定义过滤器" class="headerlink" title="定义过滤器"></a>定义过滤器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使过滤器生效"><a href="#使过滤器生效" class="headerlink" title="使过滤器生效"></a>使过滤器生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class FilterConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public CustomFilter customFilter() &#123;</span><br><span class="line">        return new CustomFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤器中传递数据"><a href="#过滤器中传递数据" class="headerlink" title="过滤器中传递数据"></a>过滤器中传递数据</h4><p>项目中往往会存在很多的过滤器，执行的顺序是根据 filterOrder 决定的，那么肯定有一些过滤器是在后面执行的，如果你有这样的需求：第一个过滤器需要告诉第二个过滤器一些信息，这个时候就涉及在过滤器中怎么去传递数据给后面的过滤器。</p>
<p>实现这种传值的方式笔者第一时间就想到了用 ThreadLocal，既然我们用了 Zuul，那么 Zuul 肯定有解决方案，比如可以通过 RequestContext 的 set 方法进行传递，RequestContext 的原理就是 ThreadLocal。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx &#x3D; RequestContext.getCurrentContext();</span><br><span class="line">ctx.set(&quot;msg&quot;, &quot;你好吗&quot;);</span><br></pre></td></tr></table></figure>

<p>后面的过滤就可以通过 RequestContext 的 get 方法来获取数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx &#x3D; RequestContext.getCurrentContext();</span><br><span class="line">ctx.get(&quot;msg&quot;);</span><br></pre></td></tr></table></figure>

<h4 id="过滤器拦截请求"><a href="#过滤器拦截请求" class="headerlink" title="过滤器拦截请求"></a>过滤器拦截请求</h4><p>在过滤器中对请求进行拦截是一个很常见的需求。如果请求在黑名单中，就不能让该请求继续往下执行，需要对其进行拦截并返回结果给客户端。</p>
<p>拦截和返回结果只需要 5 行代码即可实现，代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">ctx.set(<span class="string">&quot;sendForwardFilter.ran&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">ctx.setResponseBody(<span class="string">&quot;返回信息&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ctx.setSendZuulResponse(false);告诉 Zuul 不需要将当前请求转发到后端的服务</strong></p>
<p>当前的过滤器中确实将请求进行拦截了，并且可以给客户端返回信息。但是当你的项目中有多个过滤器的时候，假如你需要过滤的那个过滤器是第一个执行的，发现非法请求，然后进行拦截，在 chain.doFilter 之前进行返回就可以让过滤器不往下执行了。</p>
<p>但是 <strong>Zuul 中的过滤器不一样，即使你刚刚通过 ctx.setSendZuulResponse(false) 设置了不路由到服务，并且返回 null，那只是当前的过滤器执行完成了，后面还有很多过滤器在等着执行</strong>。</p>
<h5 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h5><p>解决这个问题的办法就是通过 shouldFilter 来处理，即在拦截之后通过数据传递的方式告诉下一个过滤器是否要执行。</p>
<p>增加一行数据传递的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">&quot;isSuccess&quot;</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>

<p>在 RequestContext 中设置一个值来标识是否成功，当为 true 的时候，后续的过滤器才执行，若为 false 则不执行。</p>
<p>利用这种方法，在后面的过滤器就需要用到这个值来决定自己此时是否需要执行，此时只需要在 shouldFilter 方法中加上如下所示的代码即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">    Object success = ctx.get(<span class="string">&quot;isSuccess&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> success == <span class="keyword">null</span> ? <span class="keyword">true</span> : Boolean.parseBoolean(success.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤器中异常处理"><a href="#过滤器中异常处理" class="headerlink" title="过滤器中异常处理"></a>过滤器中异常处理</h4><p>过滤器中的异常主要发生在 run 方法中，可以用 try catch 来处理。Zuul 中也为我们提供了一个异常处理的过滤器，当过滤器在执行过程中发生异常，若没有被捕获到，就会进入 error 过滤器中</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><blockquote>
<p>由于Zuul自动集成了Ribbon和Hystrix，所以Zuul天生就有负载均衡和服务容错能力，我们可以通过Ribbon和Hystrix的配置来配置Zuul中的相应功能。</p>
</blockquote>
<ul>
<li>可以使用Hystrix的配置来设置路由转发时HystrixCommand的执行超时时间：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span> <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">1000</span> <span class="comment">#配置HystrixCommand执行的超时时间，执行超过该时间会进行服务降级处理</span></span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用Ribbon的配置来设置路由转发时请求连接及处理的超时时间：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span> <span class="comment">#全局配置</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">1000</span> <span class="comment">#服务请求连接超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">3000</span> <span class="comment">#服务请求处理超时时间（毫秒）</span></span><br></pre></td></tr></table></figure>

<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span> <span class="comment">#给服务配置路由</span></span><br><span class="line">    <span class="attr">user-service:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/userService/**</span></span><br><span class="line">    <span class="attr">feign-service:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/feignService/**</span></span><br><span class="line">  <span class="attr">ignored-services:</span> <span class="string">user-service,feign-service</span> <span class="comment">#关闭默认路由配置</span></span><br><span class="line">  <span class="attr">prefix:</span> <span class="string">/proxy</span> <span class="comment">#给网关路由添加前缀</span></span><br><span class="line">  <span class="attr">sensitive-headers:</span> <span class="string">Cookie,Set-Cookie,Authorization</span> <span class="comment">#配置过滤敏感的请求头信息，设置为空就不会过滤</span></span><br><span class="line">  <span class="attr">add-host-header:</span> <span class="literal">true</span> <span class="comment">#设置为true重定向是会添加host请求头</span></span><br><span class="line">  <span class="attr">retryable:</span> <span class="literal">true</span> <span class="comment"># 关闭重试机制</span></span><br><span class="line">  <span class="attr">PreLogFilter:</span></span><br><span class="line">    <span class="attr">pre:</span></span><br><span class="line">      <span class="attr">disable:</span> <span class="literal">false</span> <span class="comment">#控制是否启用过滤器</span></span><br></pre></td></tr></table></figure>

<h2 id="面试点"><a href="#面试点" class="headerlink" title="面试点"></a>面试点</h2><h3 id="Zuul和Zuul2"><a href="#Zuul和Zuul2" class="headerlink" title="Zuul和Zuul2"></a>Zuul和Zuul2</h3><ul>
<li>Zuul使用的是阻塞式线程完成业务调用</li>
<li>Zuul2使用的是异步式线程完成业务调用</li>
</ul>
<h3 id="Cookie和头信息处理"><a href="#Cookie和头信息处理" class="headerlink" title="Cookie和头信息处理"></a>Cookie和头信息处理</h3><p>zuul默认会过滤一些头信息，需要进行过滤设置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 会过滤客户端请求中的和该配置项匹配的headers，如果客户端在发请求是带了Cookie，那么Cookie不会传递给下游服务</span></span><br><span class="line"><span class="attr">sensitive-headers:</span> <span class="string">Cookie,Set-Cookie,Authorization</span> <span class="comment">#配置过滤敏感的请求头信息，设置为空就不会过滤</span></span><br><span class="line"><span class="comment"># 会过滤服务之间通信附带的headers，如果客户端在发请求是带了X-ABC，那么X-ABC依然会传递给下游服务。但是如果下游服务再转发就会被过滤</span></span><br><span class="line"><span class="attr">ignoredHeaders:</span> <span class="string">X-ABC</span></span><br></pre></td></tr></table></figure>



<h1 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h1><ul>
<li>网关</li>
<li>Spring Cloud 生态系中的网关，其目标是替代 Netflix Zuul</li>
<li>提供统一的路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全、监控/埋点和限流等。</li>
<li>依赖 Spring Boot 和 Spring WebFlux，基于 Netty 运行。它不能在传统的 servlet 容器中工作，也不能构建成 war 包</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>动态路由：能够匹配任何请求属性；</li>
<li>Predicate（断言）和 Filter（过滤器）；</li>
<li>集成Hystrix的断路器功能；</li>
<li>集成 Spring Cloud 服务发现功能；</li>
<li>请求限流功能；</li>
<li>支持路径重写。</li>
</ul>
<h2 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h2><p>限流</p>
<p>熔断回退</p>
<p>跨域</p>
<p>统一异常处理</p>
<p>重试</p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>1）Route</strong></p>
<p>Route 是网关的基础元素，由 ID、目标 URI、断言、过滤器组成。当请求到达网关时，由 Gateway Handler Mapping 通过断言进行路由匹配（Mapping），当断言为真时，匹配到路由。</p>
<p><strong>2）Predicate</strong></p>
<p>匹配条件。</p>
<p><strong>3）Filter</strong></p>
<p>Filter 是 Gateway 中的过滤器，可以在请求发出前后进行一些业务上的处理。</p>
<blockquote>
<p>Gateway 的 Filter 只有 pre 和 post 两种</p>
</blockquote>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/zuul/gateway%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="image" style="zoom: 67%;" />

<ul>
<li><p>客户端向 Spring Cloud Gateway 发出请求，如果请求与网关程序定义的路由匹配，则该请求就会被发送到网关 Web 处理程序，此时处理程序运行特定的请求过滤器链。</p>
</li>
<li><p>过滤器之间用虚线分开的原因是过滤器可能会在发送代理请求的前后执行逻辑。所有 pre 过滤器逻辑先执行，然后执行代理请求；代理请求完成后，执行 post 过滤器逻辑。</p>
</li>
</ul>
<h2 id="Route-网关-Predicate-的使用"><a href="#Route-网关-Predicate-的使用" class="headerlink" title="Route(网关) Predicate 的使用"></a>Route(网关) Predicate 的使用</h2><p>Spring Cloud Gateway将路由匹配作为Spring WebFlux HandlerMapping基础架构的一部分。 Spring Cloud Gateway包括许多内置的Route Predicate工厂。 所有这些Predicate都与HTTP请求的不同属性匹配。 多个Route Predicate工厂可以进行组合</p>
<h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><h4 id="使用yml配置"><a href="#使用yml配置" class="headerlink" title="使用yml配置"></a>使用yml配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9201</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">user-service:</span> <span class="string">http://localhost:8201</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path_route</span> <span class="comment">#路由的ID</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">$&#123;service-url.user-service&#125;/user/&#123;id&#125;</span> <span class="comment">#匹配后路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/&#123;id&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>application-eureka.yml</code>配置文件启动api-gateway服务，访问<code>http://localhost:9201/1</code> ，可以路由到<code>http://localhost:8201/user/1</code>处。</p>
<h4 id="使用Java-Bean配置"><a href="#使用Java-Bean配置" class="headerlink" title="使用Java Bean配置"></a>使用Java Bean配置</h4><ul>
<li>添加相关配置类，并配置一个RouteLocator对象：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">                .route(<span class="string">&quot;path_route2&quot;</span>, r -&gt; r.path(<span class="string">&quot;/user/getByUsername&quot;</span>)</span><br><span class="line">                        .uri(<span class="string">&quot;http://localhost:8201/user/getByUsername&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重新启动api-gateway服务，并调用该地址测试：<a target="_blank" rel="noopener" href="http://localhost:9201/user/getByUsername?username=neo">http://localhost:9201/user/getByUsername?username=neo</a></li>
<li>我们发现该请求被路由到了user-service的该路径上：<a target="_blank" rel="noopener" href="http://localhost:8201/user/getByUsername?username=neo">http://localhost:8201/user/getByUsername?username=neo</a></li>
</ul>
<h2 id="Route-Predicate-的使用"><a href="#Route-Predicate-的使用" class="headerlink" title="Route Predicate 的使用"></a>Route Predicate 的使用</h2><p>Spring Cloud Gateway将路由匹配作为Spring WebFlux HandlerMapping基础架构的一部分。 Spring Cloud Gateway包括许多内置的Route Predicate工厂。 所有这些Predicate都与HTTP请求的不同属性匹配。 多个Route Predicate工厂可以进行组合，下面我们来介绍下一些常用的Route Predicate。</p>
<blockquote>
<p>注意：Predicate中提到的配置都在application-predicate.yml文件中进行修改，并用该配置启动api-gateway服务。</p>
</blockquote>
<h3 id="After-Route-Predicate"><a href="#After-Route-Predicate" class="headerlink" title="After Route Predicate"></a>After Route Predicate</h3><blockquote>
<p>在指定时间之后的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: after_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - After&#x3D;2019-09-24T16:30:00+08:00[Asia&#x2F;Shanghai]</span><br></pre></td></tr></table></figure>

<h3 id="Before-Route-Predicate"><a href="#Before-Route-Predicate" class="headerlink" title="Before Route Predicate"></a>Before Route Predicate</h3><blockquote>
<p>在指定时间之前的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: before_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Before&#x3D;2019-09-24T16:30:00+08:00[Asia&#x2F;Shanghai]</span><br></pre></td></tr></table></figure>

<h3 id="Between-Route-Predicate"><a href="#Between-Route-Predicate" class="headerlink" title="Between Route Predicate"></a>Between Route Predicate</h3><blockquote>
<p>在指定时间区间内的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: before_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Between&#x3D;2019-09-24T16:30:00+08:00[Asia&#x2F;Shanghai], 2019-09-25T16:30:00+08:00[Asia&#x2F;Shanghai]</span><br></pre></td></tr></table></figure>

<h3 id="Cookie-Route-Predicate"><a href="#Cookie-Route-Predicate" class="headerlink" title="Cookie Route Predicate"></a>Cookie Route Predicate</h3><blockquote>
<p>带有指定Cookie的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: cookie_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Cookie&#x3D;username,macro</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带有cookie为username=macro的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1 --cookie &quot;username&#x3D;macro&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Header-Route-Predicate"><a href="#Header-Route-Predicate" class="headerlink" title="Header Route Predicate"></a>Header Route Predicate</h3><blockquote>
<p>带有指定请求头的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: header_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;</span><br><span class="line">        predicates:</span><br><span class="line">        - Header&#x3D;X-Request-Id, \d+</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带有请求头为X-Request-Id:123的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1 -H &quot;X-Request-Id:123&quot; </span><br></pre></td></tr></table></figure>

<h3 id="Host-Route-Predicate"><a href="#Host-Route-Predicate" class="headerlink" title="Host Route Predicate"></a>Host Route Predicate</h3><blockquote>
<p>带有指定Host的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: host_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Host&#x3D;**.macrozheng.com</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带有请求头为Host:<a target="_blank" rel="noopener" href="http://www.macrozheng.com的请求可以匹配该路由./">www.macrozheng.com的请求可以匹配该路由。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1 -H &quot;Host:www.macrozheng.com&quot; </span><br></pre></td></tr></table></figure>

<h3 id="Method-Route-Predicate"><a href="#Method-Route-Predicate" class="headerlink" title="Method Route Predicate"></a>Method Route Predicate</h3><p>发送指定方法的请求会匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: method_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;</span><br><span class="line">        predicates:</span><br><span class="line">        - Method&#x3D;GET</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送GET请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送POST请求无法匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="Path-Route-Predicate"><a href="#Path-Route-Predicate" class="headerlink" title="Path Route Predicate"></a>Path Route Predicate</h3><p>发送指定路径的请求会匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: path_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;&#x2F;user&#x2F;&#123;id&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Path&#x3D;&#x2F;user&#x2F;&#123;id&#125;</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送/user/1路径请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送/abc/1路径请求无法匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;abc&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="Query-Route-Predicate"><a href="#Query-Route-Predicate" class="headerlink" title="Query Route Predicate"></a>Query Route Predicate</h3><p>带指定查询参数的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: query_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;&#x2F;user&#x2F;getByUsername</span><br><span class="line">        predicates:</span><br><span class="line">        - Query&#x3D;username</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带username=macro查询参数的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;getByUsername?username&#x3D;macro</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带不带查询参数的请求无法匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;getByUsername</span><br></pre></td></tr></table></figure>

<h3 id="RemoteAddr-Route-Predicate"><a href="#RemoteAddr-Route-Predicate" class="headerlink" title="RemoteAddr Route Predicate"></a>RemoteAddr Route Predicate</h3><p>从指定远程地址发起的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: remoteaddr_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;</span><br><span class="line">        predicates:</span><br><span class="line">        - RemoteAddr&#x3D;192.168.1.1&#x2F;24</span><br></pre></td></tr></table></figure>

<p>使用curl工具从192.168.1.1发起请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="Weight-Route-Predicate"><a href="#Weight-Route-Predicate" class="headerlink" title="Weight Route Predicate"></a>Weight Route Predicate</h3><p>使用权重来路由相应请求，以下表示有80%的请求会被路由到localhost:8201，20%会被路由到localhost:8202。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: weight_high</span><br><span class="line">        uri: http:&#x2F;&#x2F;localhost:8201</span><br><span class="line">        predicates:</span><br><span class="line">        - Weight&#x3D;group1, 8</span><br><span class="line">      - id: weight_low</span><br><span class="line">        uri: http:&#x2F;&#x2F;localhost:8202</span><br><span class="line">        predicates:</span><br><span class="line">        - Weight&#x3D;group1, 2</span><br></pre></td></tr></table></figure>

<h3 id="自定义路由断言工厂"><a href="#自定义路由断言工厂" class="headerlink" title="自定义路由断言工厂"></a>自定义路由断言工厂</h3><p>自定义路由断言工厂需要继承<code>AbstractRoutePredicateFactory</code>类，重写 apply 方法的逻辑。</p>
<p>在 apply 方法中可以通过<code>exchange.getRequest()</code>拿到<code>ServerHttpRequest</code> 对象，从而可以获取到请求的参数、请求方式、请求头等信息。</p>
<p><code>apply</code>方法的参数是自定义的配置类，在使用的时候配置参数，在<code>apply</code> 方法中直接获取使用。</p>
<p>命名需要以<code>RoutePredicateFactory</code>结尾，比如 CheckAuthRoutePredicateFactory，那么在使用的时候 CheckAuth 就是这个路由断言工厂的名称。代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> CheckAuthRoutePredicateFactory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //自定义路由断言工厂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/8/26</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckAuthRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">CheckAuthRoutePredicateFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CheckAuthRoutePredicateFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt; &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;进入了CheckAuthRoutePredicateFactory\t&quot;</span> + config.getName());</span><br><span class="line">            <span class="keyword">if</span> (config.getName().equals(<span class="string">&quot;zhangsan&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="application-yml配置"><a href="#application-yml配置" class="headerlink" title="application.yml配置"></a>application.yml配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">#自定义路由断言工厂的使用</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: customer_route</span><br><span class="line">          uri: http:&#x2F;&#x2F;c.biancheng.net</span><br><span class="line">          predicates:</span><br><span class="line">            - name: CheckAuth</span><br><span class="line">          args:</span><br><span class="line">            name: zhangsan</span><br></pre></td></tr></table></figure>

<h3 id="过滤器-1"><a href="#过滤器-1" class="headerlink" title="过滤器"></a>过滤器</h3><blockquote>
<p>在结合注册中心使用过滤器的时候，我们需要注意的是uri的协议为<code>lb</code>，这样才能启用Gateway的负载均衡功能。</p>
</blockquote>
<p>修改application-eureka.yml文件，使用了PrefixPath过滤器，会为所有GET请求路径添加<code>自定义</code>路径并路由；</p>
<h4 id="结合Eureka使用"><a href="#结合Eureka使用" class="headerlink" title="结合Eureka使用"></a>结合Eureka使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9201</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">prefixpath_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://demo-service-provider</span> <span class="comment">#此处需要使用lb协议</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">PrefixPath=/user</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启从注册中心动态创建路由的功能</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span> <span class="comment">#使用小写服务名，默认是大写</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8001/eureka/</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.springframework.cloud.gateway:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>使用application-eureka.yml配置文件启动api-gateway服务，访问<code>http://localhost:9201/1</code> ，可以路由到<code>user-service</code>的<code>http://localhost:7101/user/1</code>处。</p>
<h4 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h4><blockquote>
<p>全局过滤器作用于所有的路由，不需要单独配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleConfiguration</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(ExampleConfiguration.class);</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@Order(-1)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">&quot;first pre filter&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;third post filter&quot;</span>);</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@Order(0)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">&quot;second pre filter&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;second post filter&quot;</span>);</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@Order(1)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">&quot;third pre filter&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;first post filter&quot;</span>);</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面定义了 3 个 GlobalFilter，通过 @Order 来指定执行的顺序，数字越小，优先级越高。下面就是输出的日志，从日志就可以看出执行的顺序，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2019-8-26 16:08:52.406  INFO 55062 --- [ioEventLoop-4-1] c.c.gateway.config.ExampleConfiguration  : first pre filter</span><br><span class="line">2019-8-26 16:08:52.406  INFO 55062 --- [ioEventLoop-4-1] c.c.gateway.config.ExampleConfiguration  : second pre filter</span><br><span class="line">2019-8-26 16:08:52.407  INFO 55062 --- [ioEventLoop-4-1] c.c.gateway.config.ExampleConfiguration  : third pre filter</span><br><span class="line">2019-8-26 16:08:52.437  INFO 55062 --- [ctor-http-nio-7] c.c.gateway.config.ExampleConfiguration  : first post filter</span><br><span class="line">2019-8-26 16:08:52.438  INFO 55062 --- [ctor-http-nio-7] c.c.gateway.config.ExampleConfiguration  : second post filter</span><br><span class="line">2019-8-26 16:08:52.438  INFO 55062 --- [ctor-http-nio-7] c.c.gateway.config.ExampleConfiguration  : third post filter</span><br></pre></td></tr></table></figure>

<p><strong>当 GlobalFilter 的逻辑比较多时单独写一个 GlobalFilter 来处理</strong>，比如我们要实现对 IP 的访问限制，即不在 IP 白名单中就不能调用的需求。</p>
<p>单独定义只需要实现 GlobalFilter、Ordered 两个接口就可以了，具体代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IPCheckFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        HttpHeaders headers = exchange.getRequest().getHeaders();</span><br><span class="line">        <span class="comment">// 此处写得非常绝对, 只作演示用, 实际中需要采取配置的方式</span></span><br><span class="line">        <span class="keyword">if</span> (getIp(headers).equals(<span class="string">&quot;127.0.0.1&quot;</span>)) &#123;</span><br><span class="line">            ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">            ResponseData data = <span class="keyword">new</span> ResponseData();</span><br><span class="line">            data.setCode(<span class="number">401</span>);</span><br><span class="line">            data.setMessage(<span class="string">&quot;非法请求&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] datas = JsonUtils.toJson(data).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">            DataBuffer buffer = response.bufferFactory().wrap(datas);</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            response.getHeaders().add(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里从请求头中获取用户的实际IP,根据Nginx转发的请求头获取</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getIp</span><span class="params">(HttpHeaders headers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Config%EF%BC%8CBus)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Config%EF%BC%8CBus)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Config，Bus)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T19:50:18+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud练习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E9%85%8D%E7%BD%AE%E9%A1%B9.png" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/config?id=spring-cloud-config%EF%BC%9A%E5%A4%96%E9%83%A8%E9%9B%86%E4%B8%AD%E5%8C%96%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86">Spring Cloud Config：外部集中化配置管理</a></p>
<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/bus?id=spring-cloud-bus%EF%BC%9A%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF">Spring Cloud Bus：消息总线</a></p>
<h1 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h1><p>Spring Cloud Config 分为服务端和客户端两个部分。</p>
<p>服务端被称为分布式配置中心，它是个独立的应用，可以从配置仓库获取配置信息并提供给客户端使用。</p>
<p>客户端可以通过配置中心来获取配置信息，在启动时加载配置。</p>
<p>Spring Cloud Config 的配置中心默认采用Git来存储配置信息，所以天然就支持配置信息的版本管理，并且可以使用Git客户端来方便地管理和访问配置信息。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>统一配置</li>
<li>环境隔离</li>
<li>动态刷新</li>
</ul>
<h1 id="外部集中化配置管理"><a href="#外部集中化配置管理" class="headerlink" title="外部集中化配置管理"></a>外部集中化配置管理</h1><blockquote>
<p>Spring Cloud Config 可以为微服务架构中的应用提供集中化的外部配置支持，它分为服务端和客户端两个部分</p>
</blockquote>
<h2 id="在Git仓库中准备配置信息"><a href="#在Git仓库中准备配置信息" class="headerlink" title="在Git仓库中准备配置信息"></a>在Git仓库中准备配置信息</h2><blockquote>
<p>由于Spring Cloud Config 需要一个存储配置信息的Git仓库，这里我们先在Git仓库中添加好配置文件再演示其功能<br>Git:仓库地址为：<a target="_blank" rel="noopener" href="https://github.com/yuanyayuan/springcloud-config.git">https://github.com/yuanyayuan/springcloud-config.git</a></p>
</blockquote>
<h3 id="配置仓库目录结构"><a href="#配置仓库目录结构" class="headerlink" title="配置仓库目录结构"></a>配置仓库目录结构</h3><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/config.png" alt="image" style="zoom:67%;" />

<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><p><strong>master分支下的配置信息</strong></p>
<ul>
<li>config/config-dev.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for dev(master)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config/config-test.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for test(master)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config/config-prod.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for prod(master)&quot;</span><br></pre></td></tr></table></figure>

<p><strong>dev分支下的配置信息</strong></p>
<ul>
<li>config/config-dev.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for dev(dev)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config-test.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for test(dev)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config-prod.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for prod(dev)&quot;</span><br></pre></td></tr></table></figure>

<h1 id="创建demo-config-server模块"><a href="#创建demo-config-server模块" class="headerlink" title="创建demo_config_server模块"></a>创建demo_config_server模块</h1><blockquote>
<p>这里我们创建一个demo_config_server模块来演示Spring Cloud Config 作为配置中心的功能。 </p>
</blockquote>
<h2 id="在pom-xml中添加相关依赖"><a href="#在pom-xml中添加相关依赖" class="headerlink" title="在pom.xml中添加相关依赖"></a>在pom.xml中添加相关依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8901</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-server</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span> <span class="comment">#配置存储配置信息的Git仓库</span></span><br><span class="line">          <span class="attr">uri:</span> </span><br><span class="line">          <span class="attr">username:</span> </span><br><span class="line">          <span class="attr">password:</span> </span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span> <span class="comment">#配置文件分支</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">config</span>  <span class="comment">#配置文件所在根目录</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>
<h2 id="在启动类上添加-EnableConfigServer注解来启用配置中心功能"><a href="#在启动类上添加-EnableConfigServer注解来启用配置中心功能" class="headerlink" title="在启动类上添加@EnableConfigServer注解来启用配置中心功能"></a>在启动类上添加@EnableConfigServer注解来启用配置中心功能</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.config.server.EnableConfigServer;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> DemoConfigServerApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/7/2</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConfigServerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoConfigServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过demo-config-server获取配置信息"><a href="#通过demo-config-server获取配置信息" class="headerlink" title="通过demo_config_server获取配置信息"></a>通过demo_config_server获取配置信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取配置信息</span></span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;</span><br><span class="line"><span class="comment"># 获取配置文件信息</span></span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br></pre></td></tr></table></figure>

<h3 id="占位符相关解释"><a href="#占位符相关解释" class="headerlink" title="占位符相关解释"></a>占位符相关解释</h3><ul>
<li>application：代表应用名称，默认为配置文件中的spring.application.name，如果配置了spring.cloud.config.name，则为该名称；</li>
<li>label：代表分支名称，对应配置文件中的spring.cloud.config.label；</li>
<li>profile：代表环境名称，对应配置文件中的spring.cloud.config.profile。</li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/master/config-dev">http://localhost:8901/master/config-dev</a></li>
</ul>
<p>获取master分支上dev环境的配置信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;master&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;profiles&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;config-dev&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0af0655db64cb0800054551e584cebad2f5e4028&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;state&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;propertySources&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/dev/config-dev">http://localhost:8901/dev/config-dev</a></li>
</ul>
<p>获取dev分支上dev环境的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;dev&quot;,</span><br><span class="line">    &quot;profiles&quot;: [</span><br><span class="line">        &quot;config-dev&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;label&quot;: null,</span><br><span class="line">    &quot;version&quot;: &quot;0af0655db64cb0800054551e584cebad2f5e4028&quot;,</span><br><span class="line">    &quot;state&quot;: null,</span><br><span class="line">    &quot;propertySources&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/master/config-dev.yml">http://localhost:8901/master/config-dev.yml</a></li>
</ul>
<p>获取master分支上dev环境的配置文件信息，对比上面信息，可以看出配置信息和配置文件信息并不是同一个概念</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: config info for dev(master)</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/master/config-test.yml">http://localhost:8901/master/config-test.yml</a></li>
</ul>
<p>获取master分支上test环境的配置文件信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: config info for test(master)</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/dev/config-dev.yml">http://localhost:8901/dev/config-dev.yml</a></li>
</ul>
<p>获取dev分支上dev环境的配置文件信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: config info for dev(dev)</span><br></pre></td></tr></table></figure>

<h1 id="创建demo-config-client"><a href="#创建demo-config-client" class="headerlink" title="创建demo_config_client"></a>创建demo_config_client</h1><h2 id="github上创建"><a href="#github上创建" class="headerlink" title="github上创建"></a>github上创建</h2><ul>
<li>config/config-single-client-dev.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  env: config-single-client-dev（Spring Cloud Bus）</span><br><span class="line">  user:</span><br><span class="line">    username: liyuanSama（Spring Cloud Bus）</span><br><span class="line">    password: liyuanSama（Spring Cloud Bus）</span><br></pre></td></tr></table></figure>

<ul>
<li>config/config-single-client-prod.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  env: config-single-client-prod</span><br><span class="line">  user:</span><br><span class="line">    username: liyuan</span><br><span class="line">    password: liyuan123</span><br></pre></td></tr></table></figure>

<h2 id="在pom-xml中添加相关依赖-1"><a href="#在pom-xml中添加相关依赖-1" class="headerlink" title="在pom.xml中添加相关依赖"></a>在pom.xml中添加相关依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="application-yml-1"><a href="#application-yml-1" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">NaN</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">NaN</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">NaN</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">NaN</span></span><br></pre></td></tr></table></figure>
<h2 id="bootstrap-yml"><a href="#bootstrap-yml" class="headerlink" title="bootstrap.yml"></a>bootstrap.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span> <span class="comment">#Config客户端配置</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-single-client</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8901</span> <span class="comment">#配置中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>
<h2 id="添加GitAutoRefreshConfig类用于获取配置"><a href="#添加GitAutoRefreshConfig类用于获取配置" class="headerlink" title="添加GitAutoRefreshConfig类用于获取配置"></a>添加GitAutoRefreshConfig类用于获取配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;data&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GitAutoRefreshConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String username;</span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> username;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.username = username;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> password;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.password = password;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;UserInfo&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;username=&#x27;&quot;</span> + username + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&quot;, password=&#x27;&quot;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String env;</span><br><span class="line">    <span class="keyword">private</span> UserInfo user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建RESTController显示数据"><a href="#创建RESTController显示数据" class="headerlink" title="创建RESTController显示数据"></a>创建RESTController显示数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;test2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RESTController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitConfig gitConfig;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitAutoRefreshConfig gitAutoRefreshConfig;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;show&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitConfig;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;autoShow&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">autoShow</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitAutoRefreshConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="演示从配置中心获取配置"><a href="#演示从配置中心获取配置" class="headerlink" title="演示从配置中心获取配置"></a>演示从配置中心获取配置</h2><ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8848/test2/show">http://localhost:8848/test2/show</a></li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/1.png" style="zoom: 80%;" />


<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8848/test2/autoShow">http://localhost:8848/test2/autoShow</a></li>
</ul>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/2.png"></p>
<h2 id="获取子目录下的配置"><a href="#获取子目录下的配置" class="headerlink" title="获取子目录下的配置"></a>获取子目录下的配置</h2><blockquote>
<p>我们不仅可以把每个项目的配置放在不同的Git仓库存储，也可以在一个Git仓库中存储多个项目的配置，此时就会用到在子目录中搜索配置信息的配置。</p>
</blockquote>
<ul>
<li>首先我们需要在config-server中添加相关配置，用于搜索子目录中的配置，这里我们用到了application占位符，表示对于不同的应用，我们从对应应用名称的子目录中搜索配置，比如config子目录中的配置对应config应用；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span> </span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">&#x27;&#123;application&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8848/test1/configInfo">http://localhost:8848/test1/configInfo</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config info for dev(dev)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="刷新配置"><a href="#刷新配置" class="headerlink" title="刷新配置"></a>刷新配置</h2><blockquote>
<p>当Git仓库中的配置信息更改后，我们可以通过SpringBoot Actuator的refresh端点来刷新客户端配置信息，以下更改都需要在config-client中进行。</p>
</blockquote>
<ul>
<li><p>在pom.xml中添加Actuator的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>application.yml中开启refresh端点：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;refresh&#x27;</span></span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在RESTController类添加@RefreshScope注解用于刷新配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;test2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RESTController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitConfig gitConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitAutoRefreshConfig gitAutoRefreshConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;show&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;autoShow&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">autoShow</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitAutoRefreshConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>更改github上的数据</p>
</li>
<li><p>客户端调用refresh端点进行配置刷新：</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://localhost:8848/test2/autoShow">http://localhost:8848/test2/autoShow</a> 进行测试发现更改</p>
</li>
</ul>
<h1 id="配置中心添加安全认证"><a href="#配置中心添加安全认证" class="headerlink" title="配置中心添加安全认证"></a>配置中心添加安全认证</h1><blockquote>
<p>我们可以通过整合SpringSecurity来为配置中心添加安全认证。</p>
</blockquote>
<h2 id="创建config-security-server模块"><a href="#创建config-security-server模块" class="headerlink" title="创建config-security-server模块"></a>创建config-security-server模块</h2><ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在application.yml中进行配置：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8905</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-security-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> </span><br><span class="line">          <span class="attr">username:</span> </span><br><span class="line">          <span class="attr">password:</span> </span><br><span class="line">          <span class="attr">clone-on-start:</span> <span class="literal">true</span> <span class="comment">#开启启动时直接从git获取配置</span></span><br><span class="line">  <span class="attr">security:</span> <span class="comment">#配置用户名和密码</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> </span><br><span class="line">      <span class="attr">password:</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>启动config-security-server服务。</li>
</ul>
<h2 id="config-client的配置"><a href="#config-client的配置" class="headerlink" title="config-client的配置"></a>config-client的配置</h2><ul>
<li>添加bootstrap-security.yml配置文件，主要是配置了配置中心的用户名和密码：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">dev</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8901</span> <span class="comment">#配置中心地址</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">username:</span> </span><br><span class="line">      <span class="attr">password:</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>使用bootstrap-security.yml启动config-client服务；</li>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8901/configInfo%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E5%88%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E3%80%82">http://localhost:8901/configInfo进行测试，发现可以获取到配置信息。</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config info <span class="keyword">for</span> dev(dev)</span><br></pre></td></tr></table></figure>

<h1 id="配置config-sever集群搭建"><a href="#配置config-sever集群搭建" class="headerlink" title="配置config-sever集群搭建"></a>配置config-sever集群搭建</h1><blockquote>
<p>在微服务架构中，所有服务都从配置中心获取配置，配置中心一旦宕机，会发生很严重的问题，下面我们搭建一个双节点的配置中心集群来解决该问题。</p>
</blockquote>
<ul>
<li><p>启动两个config-server分别运行在8901和8902端口上；</p>
</li>
<li><p>添加config-client的配置文件bootstrap-cluster.yml，主要是添加了从注册中心获取配置中心地址的配置并去除了配置中心uri的配置：</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span> <span class="comment">#Config客户端配置</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-single-client</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="comment"># 集群配置</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">demo-config-server</span></span><br></pre></td></tr></table></figure>

<p>以bootstrap-cluster.yml启动config-client服务，注册中心显示信息如下：</p>
<p><strong>注意：</strong></p>
<p>client的Eureka，cloud.config的配置信息需配置到bootstrap.yml中，在启动前读取信息，因为没有cloud.config的配置信息，会去localhost：8888去寻找配置信息，需要启动前指定</p>
<h1 id="Spring-Cloud-Bus：消息总线"><a href="#Spring-Cloud-Bus：消息总线" class="headerlink" title="Spring Cloud Bus：消息总线"></a>Spring Cloud Bus：消息总线</h1><blockquote>
<p>Spring Cloud Bus 使用轻量级的消息代理来连接微服务架构中的各个服务，可以将其用于广播状态更改（例如配置中心配置更改）或其他管理指令，本文将对其用法进行详细介绍。</p>
</blockquote>
<h2 id="Spring-Cloud-Bus-简介-面试点"><a href="#Spring-Cloud-Bus-简介-面试点" class="headerlink" title="Spring Cloud Bus 简介(面试点)"></a>Spring Cloud Bus 简介(面试点)</h2><p>我们通常会使用消息代理来构建一个主题，然后把微服务架构中的所有服务都连接到这个主题上去，当我们向该主题发送消息时，所有订阅该主题的服务都会收到消息并进行消费。使用 Spring Cloud Bus 可以方便地构建起这套机制，所以 Spring Cloud Bus 又被称为消息总线。Spring Cloud Bus 配合 Spring Cloud Config 使用可以实现配置的动态刷新。目前  Spring Cloud Bus  支持两种消息代理：RabbitMQ 和 Kafka，下面以 RabbitMQ 为例来演示下使用Spring Cloud Bus  动态刷新配置的功能。</p>
<p><strong>安装RabbitMQ</strong></p>
<h2 id="动态刷新配置"><a href="#动态刷新配置" class="headerlink" title="动态刷新配置"></a>动态刷新配置</h2><blockquote>
<p>使用 Spring Cloud Bus 动态刷新配置需要配合 Spring Cloud Config 一起使用 在demo-config-server上操作</p>
</blockquote>
<h2 id="给demo-config-server添加消息总线支持"><a href="#给demo-config-server添加消息总线支持" class="headerlink" title="给demo-config-server添加消息总线支持"></a>给demo-config-server添加消息总线支持</h2><ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>添加配置文件application-amqp.yml，主要是添加了RabbitMQ的配置及暴露了刷新配置的Actuator端点；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8901</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span> <span class="comment">#配置存储配置信息的Git仓库</span></span><br><span class="line">          <span class="attr">uri:</span> </span><br><span class="line">          <span class="attr">username:</span> </span><br><span class="line">          <span class="attr">password:</span> </span><br><span class="line">          <span class="attr">clone-on-start:</span> <span class="literal">true</span> <span class="comment">#开启启动时直接从git获取配置</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span> <span class="comment">#配置文件分支</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">&#x27;&#123;application&#125;&#x27;</span>  <span class="comment">#配置文件所在根目录</span></span><br><span class="line">  <span class="comment"># 添加rabbitmq的配置</span></span><br><span class="line">  <span class="attr">rabbitmq:</span> <span class="comment">#rabbitmq相关配置</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"><span class="comment"># 暴露bus刷新配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span> <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        <span class="comment">#include: &#x27;bus-refresh&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="给config-client添加消息总线支持"><a href="#给config-client添加消息总线支持" class="headerlink" title="给config-client添加消息总线支持"></a>给config-client添加消息总线支持</h2><ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">NaN</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">NaN</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">NaN</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">NaN</span></span><br></pre></td></tr></table></figure>

<ul>
<li>bootstrap.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span> <span class="comment">#Config客户端配置</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-single-client</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="comment"># 集群配置</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">demo-config-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动所有服务后 </li>
</ul>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/3.png"></p>
<ul>
<li>我们登录RabbitMQ的控制台可以发现Spring Cloud Bus 创建了一个叫springCloudBus的交换机及三个以 springCloudBus.anonymous开头的队列： </li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/4.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/5.png" style="zoom:50%;" />

<ul>
<li>修改github配置信息</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/6.png" style="zoom: 67%;" />

<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/12.png"></p>
<ul>
<li>访问config-server</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/7.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/8.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/9.png" style="zoom:50%;" />

<h2 id="配合WebHooks使用"><a href="#配合WebHooks使用" class="headerlink" title="配合WebHooks使用"></a>配合WebHooks使用</h2><p>WebHooks相当于是一个钩子函数，我们可以配置当向Git仓库push代码时触发这个钩子函数，这里以Gitee为例来介绍下其使用方式，这里当我们向配置仓库push代码时就会自动刷新服务配置了。</p>
<p><img src="http://www.macrozheng.com/images/springcloud_config_12.png" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(feign)%E9%A1%B9%E7%9B%AE%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(feign)%E9%A1%B9%E7%9B%AE%E5%BA%94%E7%94%A8/" itemprop="url">Spring-SpringCloud(feign)项目应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T14:20:00+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="创建demo-consumer-feign模块"><a href="#创建demo-consumer-feign模块" class="headerlink" title="创建demo-consumer-feign模块"></a>创建demo-consumer-feign模块</h1><h2 id="POM文件"><a href="#POM文件" class="headerlink" title="POM文件"></a>POM文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="yml中配置"><a href="#yml中配置" class="headerlink" title="yml中配置"></a>yml中配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">log4j,wall,mergeStat</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-service-consumer-feign</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7203</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mappers/*.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:com/**/mappers/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">#在Feign中开启Hystrix</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:logback-spring.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">user-service:</span> <span class="string">http://demo-service-provider</span></span><br></pre></td></tr></table></figure>

<h2 id="在启动类上添加-EnableFeignClients注解来启用Feign的客户端功能"><a href="#在启动类上添加-EnableFeignClients注解来启用Feign的客户端功能" class="headerlink" title="在启动类上添加@EnableFeignClients注解来启用Feign的客户端功能"></a>在启动类上添加@EnableFeignClients注解来启用Feign的客户端功能</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> DemoConsumerFeignApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConsumerFeignApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoConsumerFeignApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加UserService接口完成对demo-service-provider服务的接口-controller-绑定"><a href="#添加UserService接口完成对demo-service-provider服务的接口-controller-绑定" class="headerlink" title="添加UserService接口完成对demo-service-provider服务的接口(controller)绑定"></a>添加UserService接口完成对demo-service-provider服务的接口(controller)绑定</h2><blockquote>
<p>我们通过@FeignClient注解实现了一个Feign客户端，其中的value为user-service表示这是对user-service服务的接口调用客户端。我们可以回想下user-service中的UserController，只需将其改为接口，保留原来的SpringMvc注释即可。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> 添加UserService接口完成对demo-service-provider服务的接口绑定</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;demo-service-provider&quot;,</span></span><br><span class="line"><span class="meta">        primary = true,</span></span><br><span class="line"><span class="meta">        configuration = FeignConfig.class,</span></span><br><span class="line"><span class="meta">        path = &quot;/user&quot;,</span></span><br><span class="line"><span class="meta">        fallback = UserFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中create方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:52 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getUser方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:54 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getByUsername方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getByUsername&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getByUsername</span><span class="params">(<span class="meta">@RequestParam</span> String username)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中update方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse <span class="title">update</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中delete方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:56 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse <span class="title">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注解”-FeignClient-primary-true-”的作用"><a href="#注解”-FeignClient-primary-true-”的作用" class="headerlink" title="注解”@FeignClient(primary = true)”的作用"></a>注解”@FeignClient(primary = true)”的作用</h3><blockquote>
<p>表明接口实现类是哪个,如果上面的primary设为false，下面注释开放，则会执行下面的方法（<strong>如果你能设计比Feign还好的实现类可以这样做</strong>）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Service</span></span><br><span class="line"><span class="comment">//@Primary</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:52 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:54 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:56 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">delete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡演示："><a href="#负载均衡演示：" class="headerlink" title="负载均衡演示："></a>负载均衡演示：</h2><blockquote>
<p>启动 eureka-server1、eureka-server2、demo-service-provider、demo-service-provider、demo-service-consumer-feign</p>
</blockquote>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign1.png"></p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign2.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign3.png" style="zoom: 50%;" />

<h2 id="feign中的服务降级"><a href="#feign中的服务降级" class="headerlink" title="feign中的服务降级"></a>feign中的服务降级</h2><blockquote>
<p>Feign中的服务降级使用起来非常方便，只需要为Feign客户端定义的接口添加一个服务降级处理的实现类即可，下面我们为UserService接口添加一个服务降级实现类。</p>
</blockquote>
<h3 id="添加服务降级实现类UserFallbackService"><a href="#添加服务降级实现类UserFallbackService" class="headerlink" title="添加服务降级实现类UserFallbackService"></a>添加服务降级实现类UserFallbackService</h3><blockquote>
<p>需要注意的是它实现了UserService接口，并且对接口中的每个实现方法进行了服务降级逻辑的实现。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserFallbackService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 服务降级</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFallbackService</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中create方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:52 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getUser方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:54 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">2L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getByUsername方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">3L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中update方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.failed(<span class="string">&quot;调用失败，进入服务降级方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中delete方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:56 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">delete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.failed(<span class="string">&quot;调用失败，进入服务降级方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改UserService接口，设置服务降级处理类为UserFallbackService"><a href="#修改UserService接口，设置服务降级处理类为UserFallbackService" class="headerlink" title="修改UserService接口，设置服务降级处理类为UserFallbackService"></a>修改UserService接口，设置服务降级处理类为UserFallbackService</h3><blockquote>
<p>修改@FeignClient注解中的参数，设置fallback为UserFallbackService.class即可。</p>
</blockquote>
<p>添加<strong>fallback = UserFallbackService.class</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;demo-service-provider&quot;,</span></span><br><span class="line"><span class="meta">        primary = true,</span></span><br><span class="line"><span class="meta">        configuration = FeignConfig.class,</span></span><br><span class="line"><span class="meta">        path = &quot;/user&quot;,</span></span><br><span class="line"><span class="meta">        fallback = UserFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改application-yml，开启Hystrix功能"><a href="#修改application-yml，开启Hystrix功能" class="headerlink" title="修改application.yml，开启Hystrix功能"></a>修改application.yml，开启Hystrix功能</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#在Feign中开启Hystrix`</span></span><br></pre></td></tr></table></figure>

<h2 id="服务降级功能演示"><a href="#服务降级功能演示" class="headerlink" title="服务降级功能演示"></a>服务降级功能演示</h2><ul>
<li>关闭两个demo-service-provider服务，重新启动demo-service-consumer-feign;</li>
<li>调用<a target="_blank" rel="noopener" href="http://localhost:8701/user/1%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E8%BF%94%E5%9B%9E%E4%BA%86%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E4%BF%A1%E6%81%AF%E3%80%82">http://localhost:8701/user/1进行测试，可以发现返回了服务降级信息。</a></li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign4.png" style="zoom:50%;" />

<h1 id="日志打印功能"><a href="#日志打印功能" class="headerlink" title="日志打印功能"></a>日志打印功能</h1><h2 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h2><ul>
<li>NONE：默认的，不显示任何日志；</li>
<li>BASIC：仅记录请求方法、URL、响应状态码及执行时间；</li>
<li>HEADERS：除了BASIC中定义的信息之外，还有请求和响应的头信息；</li>
<li>FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。</li>
</ul>
<h2 id="通过配置开启更为详细的日志"><a href="#通过配置开启更为详细的日志" class="headerlink" title="通过配置开启更为详细的日志"></a>通过配置开启更为详细的日志</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在application-yml中配置需要开启日志的Feign客户端"><a href="#在application-yml中配置需要开启日志的Feign客户端" class="headerlink" title="在application.yml中配置需要开启日志的Feign客户端"></a>在application.yml中配置需要开启日志的Feign客户端</h2><blockquote>
<p>配置UserService的日志级别为debug。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.macro.cloud.service.UserService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p><em>注：</em> 不能与自己的logback-spring.xml同时存在，需删除logback-spring.xml</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign5.png"></p>
<h1 id="Feign-继承特性"><a href="#Feign-继承特性" class="headerlink" title="Feign 继承特性"></a>Feign 继承特性</h1><blockquote>
<p>Feign 的继承特性可以让服务的接口定义单独抽出来，作为公共的依赖，以方便使用。</p>
</blockquote>
<h2 id="1-创建一个-Maven-项目-demo-feign-inherit-api，用于存放-API-接口的定义，增加-Feign-的依赖，代码如下所示。"><a href="#1-创建一个-Maven-项目-demo-feign-inherit-api，用于存放-API-接口的定义，增加-Feign-的依赖，代码如下所示。" class="headerlink" title="1.创建一个 Maven 项目 demo_feign_inherit_api，用于存放 API 接口的定义，增加 Feign 的依赖，代码如下所示。"></a>1.创建一个 Maven 项目 demo_feign_inherit_api，用于存放 API 接口的定义，增加 Feign 的依赖，代码如下所示。</h2><ul>
<li>POM依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建服务提供者的接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserFeignApis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 调用provide的接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProvideFeignApis</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> feign调用接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 16:35 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.api.user.vo.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user/&#123;id&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>vo看需求添加</em></p>
<h2 id="2-创建demo-feign-inherit-provide-项目引入-demo-feign-inherit-api项目"><a href="#2-创建demo-feign-inherit-provide-项目引入-demo-feign-inherit-api项目" class="headerlink" title="2.创建demo_feign_inherit_provide 项目引入 demo_feign_inherit_api项目"></a>2.创建demo_feign_inherit_provide 项目引入 demo_feign_inherit_api项目</h2><ul>
<li>pom 文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nexus.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo-feign-inherit-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>yml文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">log4j,wall,mergeStat</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-feign-inherit-provide</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7103</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mappers/*.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:com/**/mappers/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:logback-spring.xml</span></span><br></pre></td></tr></table></figure>

<ul>
<li>model</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> User</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> userService.getUserById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>IUserService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> IUserService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 15:14 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.provide.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>UserServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserServiceImpl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.provide.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 15:14 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        User user;</span><br><span class="line">        <span class="keyword">if</span>(id&gt;<span class="number">1</span>)&#123;</span><br><span class="line">            user = <span class="keyword">new</span> User(<span class="number">1L</span>,<span class="string">&quot;teacher&quot;</span>,<span class="string">&quot;feign-inherit-provide&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            user = <span class="keyword">new</span> User(<span class="number">2L</span>,<span class="string">&quot;student&quot;</span>,<span class="string">&quot;feign-inherit-provide&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;根据id获取用户信息，用户名称为：&#123;&#125;&quot;</span>,user.getUsername());</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-创建demo-feign-inherit-consume-引入-demo-feign-inherit-api"><a href="#3-创建demo-feign-inherit-consume-引入-demo-feign-inherit-api" class="headerlink" title="3.创建demo_feign_inherit_consume 引入 demo_feign_inherit_api"></a>3.创建demo_feign_inherit_consume 引入 demo_feign_inherit_api</h2><ul>
<li>pom</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nexus.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo-feign-inherit-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">log4j,wall,mergeStat</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-feign-inherit-consume</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7204</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mappers/*.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:com/**/mappers/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#在Feign中开启Hystrix</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对请求进行GZIP压缩</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/xml,application/xml,application/json</span> <span class="comment">#指定压缩的请求数据类型</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span> <span class="comment">#超过该大小的请求会被压缩</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对响应进行GZIP压缩</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:logback-spring.xml</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建apis包用于存放将要调用的接口，新建ProvideFeignApi继承demo_feign_inherit_api项目下的ProvideFeignApis</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserFeignApi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;demo-feign-inherit-provide&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProvideFeignApi</span> <span class="keyword">extends</span> <span class="title">ProvideFeignApis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller，正常调用自己的service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/consume&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumeController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IConsumeService consumeService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 16:25 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">ConsumeController</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> consumeService.consumeService(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>IConsumeService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IConsumeService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 16:07 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="function">ServerResponse <span class="title">consumeService</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ConsumeServiceImpl，注入ProvideFeignApi实现接口调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumeServiceImpl</span> <span class="keyword">implements</span> <span class="title">IConsumeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProvideFeignApi provideFeignApi;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 16:07 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">consumeService</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        ServerResponse&lt;User&gt; result = provideFeignApi.getUserById(id);</span><br><span class="line">        User user = result.getData();</span><br><span class="line">        log.info(<span class="string">&quot;根据id获取用户信息，用户名称为：&#123;&#125;&quot;</span>,user.getUsername());</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign6.png" style="zoom:50%;" />

<h1 id="多参数请求构造"><a href="#多参数请求构造" class="headerlink" title="多参数请求构造"></a>多参数请求构造</h1><p>多参数请求构造分为 GET 请求和 POST 请求两种方式</p>
<h2 id="GET-请求的多参数请求构造方式"><a href="#GET-请求的多参数请求构造方式" class="headerlink" title="GET 请求的多参数请求构造方式"></a>GET 请求的多参数请求构造方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/info&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">getUserInfo</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span>String name,<span class="meta">@RequestParam(&quot;age&quot;)</span><span class="keyword">int</span> age)</span></span>;</span><br></pre></td></tr></table></figure>

<p>另一种是通过 Map 来传递多个参数，参数数量可以动态改变</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/detail&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">getUserDetail</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; param)</span></span>;</span><br></pre></td></tr></table></figure>

<p>注： <code>Map 传递参数最大的问题是可以随意传参</code></p>
<h2 id="POST-请求多参数就定义一个参数类，通过-RequestBody-注解的方式来实现"><a href="#POST-请求多参数就定义一个参数类，通过-RequestBody-注解的方式来实现" class="headerlink" title="POST 请求多参数就定义一个参数类，通过 @RequestBody 注解的方式来实现"></a>POST 请求多参数就定义一个参数类，通过 @RequestBody 注解的方式来实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/user/add&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br></pre></td></tr></table></figure>

<p>实现类中也需要加上 @RequestBody 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> <span class="keyword">implements</span> <span class="title">UserRemoteClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user.getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(feign)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(feign)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(feign)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T13:58:02+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Feign（面试点）"><a href="#Feign（面试点）" class="headerlink" title="Feign（面试点）"></a>Feign（面试点）</h1><p>Feign是声明式的服务调用工具，我们只需创建一个接口并用注解的方式来配置它，就可以实现对某个服务接口的调用，简化了直接使用RestTemplate来调用服务接口的开发量。Feign具备可插拔的注解支持，同时支持Feign注解、JAX-RS注解及SpringMvc注解。当使用Feign时，Spring Cloud集成了Ribbon和Eureka以提供负载均衡的服务调用及基于Hystrix的服务容错保护功能。</p>
<h2 id="构建请求"><a href="#构建请求" class="headerlink" title="构建请求"></a>构建请求</h2><h3 id="集成Ribbon、Hystrix"><a href="#集成Ribbon、Hystrix" class="headerlink" title="集成Ribbon、Hystrix"></a>集成Ribbon、Hystrix</h3><ul>
<li>Ribbon：利用负载均衡策略选定目标机器</li>
<li>Hystrix：根据熔断器的开启状态，决定是否发起此次调用</li>
</ul>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>Feign通过代理接口进行远程调用，Feign中动态代理通过Feign.build返回的构造器来装配相关参数,然后调用ReflectFeign的newInstance方法创建</p>
<h4 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h4><p><strong>Feign只有接口，为什么可以使用？</strong>：自动生成FeignClient实现类</p>
<h3 id="Contract协议"><a href="#Contract协议" class="headerlink" title="Contract协议"></a>Contract协议</h3><p>contract协议会构造复杂的元数据对象MethodMetadata，这里面包含动态代理接口定义的所有特征</p>
<h4 id="面试-1"><a href="#面试-1" class="headerlink" title="面试"></a>面试</h4><p><strong>为什么可以使用SpringMVC方式的注解</strong>：SpringMVCContract+相匹配的编解码器</p>
<h2 id="发起调用"><a href="#发起调用" class="headerlink" title="发起调用"></a>发起调用</h2><h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>feign使用拦截器对request和response对象进行装饰</p>
<h3 id="发起请求"><a href="#发起请求" class="headerlink" title="发起请求"></a>发起请求</h3><ul>
<li>重试：Feign借助Ribbon的配置实现重试操作</li>
<li>降级：Feign接口在声明时可以指定Hystrix的降级策略实现类，如果达到Hystrix的判定标准，或得到了异常结果，将执行指定的降级逻辑。</li>
</ul>
<h2 id="FeignClient参数配置"><a href="#FeignClient参数配置" class="headerlink" title="@FeignClient参数配置"></a>@FeignClient参数配置</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yinjihuan/p/12159986.html">那天晚上和@FeignClient注解的深度交流</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;demo-service-provider&quot;,</span></span><br><span class="line"><span class="meta">        primary = true,</span></span><br><span class="line"><span class="meta">        configuration = FeignConfig.class,</span></span><br><span class="line"><span class="meta">        path = &quot;/user&quot;,</span></span><br><span class="line"><span class="meta">        fallback = UserFallbackService.class)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>value, name</strong>：value和name的作用一样，如果没有配置url那么配置的值将作为服务名称，用于服务发现</li>
<li><strong>contextId</strong>：<br>比如我们有个user服务，但user服务中有很多个接口，我们不想将所有的调用接口都定义在一个类中，比如：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;optimization-user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRemoteClient</span> </span>&#123;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/user/get&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;optimization-user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRemoteClient2</span> </span>&#123;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/user2/get&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种情况下启动就会报错了，因为Bean的名称冲突了，具体错误如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line">The bean &#39;optimization-user.FeignClientSpecification&#39;, defined in null, could not be registered. A bean with that name has already been defined in null and overriding is disabled.</span><br><span class="line">Action:</span><br><span class="line">Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding&#x3D;true</span><br></pre></td></tr></table></figure>

<p>解决方案可以增加下面的配置，作用是允许出现beanName一样的BeanDefinition。</p>
<p>另一种解决方案就是为每个Client手动指定不同的contextId，这样就不会冲突了。</p>
<blockquote>
<p>contextId在Feign Client的作用，在注册Feign Client Configuration的时候需要一个名称，名称是通过getClientName方法获取的。</p>
<p>如果配置了contextId就会用contextId，如果没有配置就会去value然后是name最后是serviceId。默认都没有配置，当出现一个服务有多个Feign Client的时候就会报错了</p>
<p>其次的作用是在注册FeignClient中，contextId会作为Client 别名的一部分，如果配置了qualifier优先用qualifier作为别名。</p>
</blockquote>
<ul>
<li><p><strong>url</strong>：url用于配置指定服务的地址，相当于直接请求这个服务，不经过Ribbon的服务选择。像调试等场景可以使用</p>
</li>
<li><p><strong>primary</strong>：primary对应的是@Primary注解，默认为true。当我们的Feign实现了fallback后，也就意味着Feign Client有多个相同的Bean在Spring容器中，当我们在使用@Autowired进行注入的时候，不知道注入哪个，所以我们需要设置一个优先级高的，@Primary注解就是干这件事情的。</p>
</li>
<li><p><strong>configuration</strong>：onfiguration是配置Feign配置类，在配置类中可以自定义Feign的Encoder、Decoder、LogLevel、Contract等</p>
</li>
<li><p><strong>path</strong>：path定义当前FeignClient访问接口时的统一前缀，比如接口地址是/user/get, 如果你定义了前缀是user, 那么具体方法上的路径就只需要写/get 即可。</p>
</li>
<li><p><strong>fallback</strong>：定义容错的处理类，也就是回退逻辑，fallback的类必须实现Feign Client的接口，无法知道熔断的异常信息</p>
</li>
<li><p><strong>qualifier</strong>：qualifier对应的是@Qualifier注解，可以配置一个qualifier，然后使用@Qualifier注解进行注入</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;optimization-user&quot;, path=&quot;user&quot;, qualifier=&quot;userRemoteClient&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRemoteClient</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;userRemoteClient&quot;)</span></span><br><span class="line"><span class="keyword">private</span> UserRemoteClient userRemoteClient;</span><br></pre></td></tr></table></figure>

<h2 id="Feign常用配置"><a href="#Feign常用配置" class="headerlink" title="Feign常用配置"></a>Feign常用配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#在Feign中开启Hystrix</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对请求进行GZIP压缩</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/xml,application/xml,application/json</span> <span class="comment">#指定压缩的请求数据类型</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span> <span class="comment">#超过该大小的请求会被压缩</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对响应进行GZIP压缩</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="comment">#修改日志级别</span></span><br><span class="line">    <span class="attr">com.macro.cloud.service.UserService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h3 id="Feign超时判定"><a href="#Feign超时判定" class="headerlink" title="Feign超时判定"></a>Feign超时判定</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"> <span class="attr">client:</span></span><br><span class="line">   <span class="attr">config:</span></span><br><span class="line">     <span class="comment"># 全局默认配置</span></span><br><span class="line">     <span class="attr">default:</span></span><br><span class="line">       <span class="attr">connectTimeout:</span> <span class="number">1000</span></span><br><span class="line">       <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">     <span class="comment"># 单独配置优先级比全局的高</span></span><br><span class="line">     <span class="attr">foodie-user-service:</span></span><br><span class="line">       <span class="attr">connectTimeout:</span> <span class="number">1000</span></span><br><span class="line">       <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h2 id="降价参数"><a href="#降价参数" class="headerlink" title="降价参数"></a>降价参数</h2><h3 id="fallback"><a href="#fallback" class="headerlink" title="fallback"></a>fallback</h3><ul>
<li><p>实现接口并且完成降级业务逻辑</p>
</li>
<li><p>添加fallback参数，并且指定fallback的实现子类</p>
</li>
</ul>
<h3 id="fallbackFactory"><a href="#fallbackFactory" class="headerlink" title="fallbackFactory"></a>fallbackFactory</h3><ul>
<li>创建工厂类并实现fallbackfactory接口</li>
<li>在create方法中完成fallback子类实现</li>
<li>添加fallbackfactory参数，并指定相应的工厂类</li>
<li>优缺点：参见工厂模式</li>
</ul>
<h3 id="Feign中的Ribbon配置"><a href="#Feign中的Ribbon配置" class="headerlink" title="Feign中的Ribbon配置"></a>Feign中的Ribbon配置</h3><p>在Feign中配置Ribbon可以直接使用Ribbon的配置</p>
<h3 id="Feign中的Hystrix配置"><a href="#Feign中的Hystrix配置" class="headerlink" title="Feign中的Hystrix配置"></a>Feign中的Hystrix配置</h3><p>在Feign中配置Hystrix可以直接使用Hystrix的配置</p>
<h1 id="Feign项目优化（面试点）"><a href="#Feign项目优化（面试点）" class="headerlink" title="Feign项目优化（面试点）"></a>Feign项目优化（面试点）</h1><h2 id="Feign配置后启动报错：ambiguous-mapping"><a href="#Feign配置后启动报错：ambiguous-mapping" class="headerlink" title="Feign配置后启动报错：ambiguous mapping"></a>Feign配置后启动报错：ambiguous mapping</h2><p>原因：</p>
<p>1、foodie-item-api在服务调用层也加入了<code>@RequestMapping(&quot;item-comments-api&quot;)</code>获得访问路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;foodie-item-service&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;item-comments-api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemCommentsService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;myComments&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PagedGridResult <span class="title">queryMyComments</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> String userId,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="meta">@RequestParam(value = &quot;page&quot;, required = false)</span> Integer page,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="meta">@RequestParam(value = &quot;pageSize&quot;, required = false)</span>Integer pageSize)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;saveComments&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveComments</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String, Object&gt; map)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、foodie-order-service在业务处理层集成ItemCommentsService同样也获取访问路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;foodie-item-service&quot;, fallbackFactory = ItemCommentsFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemCommentsFeignClient</span> <span class="keyword">extends</span> <span class="title">ItemCommentsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>处理方法</strong></p>
<ol>
<li></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*在启动类扫包的时候，不要把原始Feign接口扫描进来</span><br><span class="line">* 具体做法：可以使用EnableFeignClients注解的clients属性，只加载需要的Feign接口</span><br><span class="line">*  * 优点：服务提供者和服务调用者都不需要额外的配置</span><br><span class="line">*  * 缺点：启动的时候配置麻烦一点，要指定加载每一个用到的接口</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>参考Feign继承特性的使用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*原始Feign接口不要定义RequestMapping注解</span><br><span class="line">* 优点：启动的时候直接扫包即可，不用指定加载接口</span><br><span class="line">* 缺点：a, 服务提供者要额外配置路径访问的注解</span><br><span class="line">*      b, 任何情况下，即使不需要在调用端定义fallback类，服务调用者都需要声明一个</span><br><span class="line">* 我比较喜欢这个</span><br></pre></td></tr></table></figure>

<ol start="3">
<li></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*原始Feign接口不要定义@FeignClients注解，这样就不会被加载到上下文当中</span><br><span class="line">*  * 优点：启动的时候直接扫包即可，不用指定加载接口，服务提供者不用额外配置</span><br><span class="line">*  * 缺点：任何情况下，服务调用者都需要声明一个额外@FeignCliet接口</span><br></pre></td></tr></table></figure>

<h2 id="替换高性能HTTPClient"><a href="#替换高性能HTTPClient" class="headerlink" title="替换高性能HTTPClient"></a>替换高性能HTTPClient</h2><ol>
<li>修改pom配置引入feign-httpclient</li>
<li>application.yml中添加<code>feign.httpclient.enabled=true</code></li>
</ol>
<h2 id="HTTP请求和响应数据压缩"><a href="#HTTP请求和响应数据压缩" class="headerlink" title="HTTP请求和响应数据压缩"></a>HTTP请求和响应数据压缩</h2><p>Feign支持Gzip的请求解压缩</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">feign.compression.request.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">feign.compression.request.mime-types</span>=<span class="string">text/xml,application/xml,application/json</span></span><br><span class="line"><span class="meta">feign.compression.request.min-request-size</span>=<span class="string">2048</span></span><br><span class="line"><span class="meta">feign.compression.response.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>解压缩是需要时间的，如果数据过小得不偿失，需要根据业务自行平衡</p>
<h1 id="Ribbon和Feign的区别？"><a href="#Ribbon和Feign的区别？" class="headerlink" title="Ribbon和Feign的区别？"></a>Ribbon和Feign的区别？</h1><p>1.Ribbon都是调用其他服务的，但方式不同。<br>2.启动类注解不同，Ribbon是@RibbonClient feign的是@EnableFeignClients<br>3.服务指定的位置不同，Ribbon是在@RibbonClient注解上声明，Feign则是在定义抽象方法的接口中<br>使用@FeignClient声明。<br>4.调用方式不同，Ribbon需要自己构建http请求，模拟http请求然后使用RestTemplate发送给其他服<br>务，步骤相当繁琐。Feign需要将调用的方法定义成抽象方法即可。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7-%E8%B0%83%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7-%E8%B0%83%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3/" itemprop="url">项目工具-调用第三方接口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T01:33:40+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7-%E8%B0%83%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3/" itemprop="url" rel="index">
                    <span itemprop="name">常用工具 - 调用第三方接口</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RestTemplate的使用"><a href="#RestTemplate的使用" class="headerlink" title="RestTemplate的使用"></a>RestTemplate的使用</h2><blockquote>
<p>RestTemplate是一个HTTP客户端，使用它我们可以方便的调用HTTP接口，支持GET、POST、PUT、DELETE等方法。</p>
</blockquote>
<h3 id="GET请求"><a href="#GET请求" class="headerlink" title="GET请求"></a>GET请求</h3><blockquote>
<p>获取数据结果可通过 RestTemplate 的 getForObject 方法（如下代码所示）来实现，此方法有三个重载的实现：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url：请求的 API 地址，有两种方式，其中一种是字符串，另一种是 URI 形式。</span><br><span class="line">responseType：返回值的类型。</span><br><span class="line">uriVariables：PathVariable 参数，有两种方式，其中一种是可变参数，另一种是 Map 形式。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>getForEntity 中可以获取返回的状态码、请求头等信息，通过 getBody 获取响应的内容。其余的和 getForObject 一样，也是有 3 个重载的实现。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;返回对象为响应体中数据转化成的对象</span><br><span class="line">&lt;T&gt; T getForObject(String url, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T getForObject(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T getForObject(URI url, Class&lt;T&gt; responseType);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;返回对象为ResponseEntity对象，包含了响应中的一些重要信息，比如响应头、响应状态码、响应体等，举例如下：</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; getForEntity(String url, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; getForEntity(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; getForEntity(URI var1, Class&lt;T&gt; responseType);</span><br></pre></td></tr></table></figure>

<h3 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; T postForObject(String url, @Nullable Object request, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T postForObject(String url, @Nullable Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T postForObject(URI url, @Nullable Object request, Class&lt;T&gt; responseType);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; postForEntity(String url, @Nullable Object request, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; postForEntity(String url, @Nullable Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; postForEntity(URI url, @Nullable Object request, Class&lt;T&gt; responseType);</span><br></pre></td></tr></table></figure>

<h3 id="PUT请求"><a href="#PUT请求" class="headerlink" title="PUT请求"></a>PUT请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void put(String url, @Nullable Object request, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">void put(String url, @Nullable Object request, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">void put(URI url, @Nullable Object request);</span><br></pre></td></tr></table></figure>

<h3 id="DELETE请求"><a href="#DELETE请求" class="headerlink" title="DELETE请求"></a>DELETE请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void delete(String url, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">void delete(String url, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">void delete(URI url);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(hystrix)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(hystrix)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Hystrix)练习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T01:26:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud练习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="服务雪崩"><a href="#服务雪崩" class="headerlink" title="服务雪崩"></a>服务雪崩</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9.png" style="zoom:67%;" />

<p>服务C超时，则会逐渐蔓延至服务B服务A，后台整个服务集群瘫痪。</p>
<h1 id="TomCat线程池耗尽"><a href="#TomCat线程池耗尽" class="headerlink" title="TomCat线程池耗尽"></a>TomCat线程池耗尽</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%80%97%E5%B0%BD.png" style="zoom:67%;" />

<p>假设服务A，B，C的请求频率相同，服务C响应时间过长，随着时间的推移，Tomcat中的线程会逐渐被C占据，直到挤满。</p>
<h1 id="生产故障"><a href="#生产故障" class="headerlink" title="生产故障"></a>生产故障</h1><ul>
<li>延迟</li>
<li>服务不可用</li>
</ul>
<h1 id="降低故障影响"><a href="#降低故障影响" class="headerlink" title="降低故障影响"></a>降低故障影响</h1><ul>
<li>隔离异常服务[降低串联影响（线程隔离）]</li>
<li>减压[快速失败（熔断）]</li>
<li>备选方案[最小可用性（降级）]</li>
</ul>
<h1 id="什么是Hystrix（面试点）"><a href="#什么是Hystrix（面试点）" class="headerlink" title="什么是Hystrix（面试点）"></a>什么是Hystrix（面试点）</h1><p>Hystrix 是一个延迟和容错库，旨在隔离远程系统，服务和第三方库的访问点，当出现故障是不可避免的故障时，停止级联故障并在复杂的分布式系统中实现弹性</p>
<h1 id="服务降级（面试点）"><a href="#服务降级（面试点）" class="headerlink" title="服务降级（面试点）"></a>服务降级（面试点）</h1><blockquote>
<p>假设服务出现出现异常，导致响应超时，那么所有依赖他的下游系统的响应时间都会被拉长，会引发雪崩效应，由最上游的的系统问题，引发了一系列下游系统响应超时，最终导致整个系统被拖垮。</p>
</blockquote>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E9%99%8D%E7%BA%A7.png" style="zoom:50%;" />

<p>假如Hystrix调用目标请求的时候发生异常，这时Hystrix会自动把这个请求转发到降级逻辑中，由服务调用方来编写异常处理逻辑。</p>
<p>对响应超时的场景，可以通过配置Hystrix的超时等待时间（Ribbon的timeout是两个不同配置），把超时响应的服务调用也当作是异常情况，转发到fallback逻辑中进行处理</p>
<h2 id="HystrixCommand原理"><a href="#HystrixCommand原理" class="headerlink" title="@HystrixCommand原理"></a>@HystrixCommand原理</h2><h3 id="HystrixCommand参数"><a href="#HystrixCommand参数" class="headerlink" title="@HystrixCommand参数"></a>@HystrixCommand参数</h3><p><strong>常用参数</strong>:</p>
<ul>
<li>fallbackMethod：指定服务降级处理方法；</li>
<li>ignoreExceptions：忽略某些异常，不发生服务降级；</li>
<li>commandKey：命令名称，用于区分不同的命令；</li>
<li>groupKey：分组名称，Hystrix会根据不同的分组来统计命令的告警及仪表盘信息；</li>
<li>threadPoolKey：线程池名称，用于划分线程池。</li>
</ul>
<h3 id="HystrixCommand实现降级"><a href="#HystrixCommand实现降级" class="headerlink" title="@HystrixCommand实现降级"></a>@HystrixCommand实现降级</h3><p>注解中指定<code>fallbackMethod</code>，需要注意降级方法的参数列表需要和原方法的保持一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userServiceUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;getDefaultUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getUser</span><span class="params">(Long  id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">&quot;/user/&#123;1&#125;&quot;</span>, ServerResponse.class, id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getDefaultUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结合Feign实现降级"><a href="#结合Feign实现降级" class="headerlink" title="结合Feign实现降级"></a>结合Feign实现降级</h3><p>Hystrix Feign共同使用，还有一种配置方式，那就是FeignClient注解中指定一个class，再class里可以处理Feign接口中声明的所有方法的降级需求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;feign-service-provider&quot;, fallback = Fallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyHelloService</span> <span class="keyword">extends</span> <span class="title">HelloService</span> </span>&#123;    </span><br><span class="line">    <span class="comment">//方法1</span></span><br><span class="line">   	<span class="comment">//方法2</span></span><br><span class="line">    <span class="comment">//……</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fallback</span> <span class="keyword">implements</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">    <span class="comment">//方法1降级处理</span></span><br><span class="line">   	<span class="comment">//方法2降级处理</span></span><br><span class="line">    <span class="comment">//……降级处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HystrixCommand执行逻辑"><a href="#HystrixCommand执行逻辑" class="headerlink" title="@HystrixCommand执行逻辑"></a>@HystrixCommand执行逻辑</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/hystrix.png" style="zoom:50%;" />

<ul>
<li><p>@HysrixCommand： 安插在方法上，标识此方法由Hystrix监管。</p>
</li>
<li><p>AspectJ：运用Spring的切面能力，给带有@HystrixCommand注解的方法配置了切面</p>
</li>
<li><p>Request Cache：</p>
<ul>
<li>开启，尝试从缓存中获取数据，也就不用发起方法调用了。</li>
<li>关闭，执行注册Observer</li>
</ul>
</li>
<li><p>注册Observer：运用RxJava注册了异步回调函数，当方法正常执行、异常抛出、结束或其他状态的时候，将会触发对应的回调函数进行处理</p>
</li>
<li><p>发起调用： 在发起调用之前，将会检查熔断状态，如果短路器当前处于开启的状态，那么将直接走向fallback流程。如果断路器处于关闭状态，则发起真正的调用</p>
</li>
<li><p>异常：异常触发了注册的回调函数，然后直接转给了降级方法</p>
</li>
</ul>
<h2 id="服务降级常用方案"><a href="#服务降级常用方案" class="headerlink" title="服务降级常用方案"></a>服务降级常用方案</h2><ul>
<li><p>静默处理：在fallback中返回null，（try catch不能做超时判定。其次使用try catch就要在代码里包含异常处理块。）</p>
</li>
<li><p>默认值：返回默认值，如非核心链路中，商品优惠价格服务发生故障返回商品价格原价</p>
</li>
<li><p>进行补偿处理：</p>
<ul>
<li>缓存异常：假如因为缓存故障无法获取数据，在fallback逻辑中可以转而访问底层数据库。反过来如果数据库发生故障，也可以在fallback里访问缓存，但要注意数据一致性</li>
<li>切换备库：一般大型应用会采用+备库的方式做灾备。假如我们的主从库都发生了故障，往往需要人工将数据库源切换到备份数据库，我们在fallback中可以先人工干预之前自动访问备份数据。这个场景尽量限定在核心主链路接口上，不要动不动就去访问备库，以免造成脏读幻读</li>
<li>重试：Ribbon可以处理超时重试，但对于异常情况来说，我们可以在fallback中自己尝试重新发起接口调用</li>
<li>人工干预：有些极其重要的接口，对异常不饿能容忍，这里可以借助fallback启动人工干预流程 ，比如做日志打点，通过监控组件触发报警，通知人工介入</li>
</ul>
</li>
</ul>
<h2 id="Hystrix实现Timeout降级"><a href="#Hystrix实现Timeout降级" class="headerlink" title="Hystrix实现Timeout降级"></a>Hystrix实现Timeout降级</h2><h3 id="全局yml配置"><a href="#全局yml配置" class="headerlink" title="全局yml配置"></a>全局yml配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span> <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">timeout:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand的执行是否启用超时时间</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">2000</span> <span class="comment">#配置HystrixCommand执行的超时时间，执行超过该时间会进行服务降级处理</span></span><br><span class="line">            <span class="attr">interruptOnTimeout:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行超时的时候是否要中断</span></span><br><span class="line">            <span class="attr">interruptOnFutureCancel:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行被取消的时候是否要中断</span></span><br></pre></td></tr></table></figure>

<h2 id="多级降级"><a href="#多级降级" class="headerlink" title="多级降级"></a>多级降级</h2><p>降级处理方法仍可以继续指定降级处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fallback</span> <span class="keyword">implements</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;fallback2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">error</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Fallback: I&#x27;m not a black sheep any more&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;first fallback&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;fallback3&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fallback2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;fallback again&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;fallback again&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fallback3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;fallback again and again&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="服务熔断（面试点）"><a href="#服务熔断（面试点）" class="headerlink" title="服务熔断（面试点）"></a>服务熔断（面试点）</h1><blockquote>
<p>服务熔断是建立在服务降级之上的一个异常处理措施，服务降级需要等待HTTP请求从服务节点返回异常或超时，在转向fallback</p>
</blockquote>
<p>服务熔断引入“熔断器”机制，当熔断器打开的时候，对服务的调用请求不会发送到目标服务节点，而是直接转向fallback逻辑</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%86%94%E6%96%AD.png" style="zoom:50%;" />

<h2 id="熔断配置"><a href="#熔断配置" class="headerlink" title="熔断配置"></a>熔断配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 核心配置</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span></span><br><span class="line">      	<span class="comment"># 熔断的前提条件（请求的数量），在一定的时间窗口内，请求达到5个以后，才开始进行熔断判断</span></span><br><span class="line">        <span class="attr">requestVolumeThreshold:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment"># 超过50%的失败请求，则熔断开关开启</span></span><br><span class="line">        <span class="attr">errorThresholdPercentage:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment"># 当熔断开启以后，经过多少秒再进入半开状态</span></span><br><span class="line">		<span class="attr">sleepWindowInMilliseconds:</span> <span class="number">15000</span></span><br><span class="line">		<span class="comment"># 配置时间窗口</span></span><br><span class="line">		<span class="attr">timeInMilliseconds:</span> <span class="number">20000</span></span><br><span class="line"><span class="comment"># 辅助配置</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span></span><br><span class="line">        <span class="comment"># 熔断功能打开</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 强制开启熔断开关</span></span><br><span class="line">        <span class="attr">forceOpen:</span> <span class="literal">false</span></span><br><span class="line">        <span class="comment"># 强制关闭熔断开关</span></span><br><span class="line">        <span class="attr">forceClosed:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="熔断原理"><a href="#熔断原理" class="headerlink" title="熔断原理"></a>熔断原理</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%86%94%E6%96%AD%E5%8E%9F%E7%90%86.png" style="zoom:50%;" />

<ul>
<li>发起调用，切面拦截：在向<code>@HystrixCommand</code>注解修饰的方法调用时，将会触发由Aspect切面逻辑</li>
<li>检查熔断器：当熔断状态开启的时候，直接进入fallback，不执行远程调用</li>
<li>发起远程调用-异常：进入回调函数</li>
<li>计算Metrics（衡量指标），如果达到熔断标准，则开启断路开关，后续的请求直接进入fallback流程</li>
</ul>
<h2 id="熔断器三个状态"><a href="#熔断器三个状态" class="headerlink" title="熔断器三个状态"></a>熔断器三个状态</h2><p>1、open：服务在一定时间内不得发起外部调用</p>
<p>2、half-open：如果降级时间过长，可以尝试发起真实的服务调用，但这一切都是在监控下进行</p>
<p>3、closed：half-open状态下调用成功了，熔断器可以关闭</p>
<h2 id="熔断器的判断阀值"><a href="#熔断器的判断阀值" class="headerlink" title="熔断器的判断阀值"></a>熔断器的判断阀值</h2><p>1、在一定时间窗口内，发生异常的请求数量达到临界值<br>2、在一定时间窗口内，发生异常的请求数量占请求总数量达到一定比例</p>
<h1 id="线程隔离"><a href="#线程隔离" class="headerlink" title="线程隔离"></a>线程隔离</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB.png" style="zoom:50%;" />

<p>web容器通常用线程池来接待来访请求，如果并发量过高，线程池被打满，就会影响后面请求的响应。    </p>
<p>Hystrix通过线程隔离的方案，将执行服务调用的代码与容器本身的线程池（如tomcat thread pool）进行隔离，配置每个服务所需线程的最大数量。这样即便一个服务的线程池被吃满，也不会影响其他服务    </p>
<p>与线程隔离类似还有一个“信号量”的方案    </p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%E5%8E%9F%E7%90%86.png" style="zoom:50%;" />

<p><strong>线程池拒绝</strong>：由线程隔离机制直接负责，假如当前商品服务分配了10个线程，那么当线程池已经饱和的时候，可以拒绝服务，调用请求会接受到Thread Pool Rejects，转到fallback逻辑，由多个参数共同控制：</p>
<ul>
<li>coreSize：核心线程数</li>
<li>maximumSize：设置最大允许的线程数，需要打allowMaximumSizeToDivergeFromCoreSize才生效</li>
<li>queueSizeRejectionThreshould：控制队列最大阈值，Hystix默认设置5，即便把maximumSize该打，因为线程队列阈值的约束，程序依然无法承载很多并发量，当改大线程池时，需要这两个属性一同增大。</li>
<li> keepAliveTimeMinutes:这个属性与线程回收有关。当线程空闲时间，多余线程会被后手，此属性指定线程被回收前存活时间，默认2分钟。</li>
</ul>
<p><strong>线程Timeout</strong>：调用失败和延迟也可能发生在远程调用之前（比如一次超长FullGC导致的超时，或者方法只是一个本地业务计算，并不会调用外部方法。），此方法调用过程中发生超时，产生Thread Timeout，调用请求被流转到fallback</p>
<p><strong>服务异常、超时</strong>：就是服务降级</p>
<h2 id="隔离方式"><a href="#隔离方式" class="headerlink" title="隔离方式"></a>隔离方式</h2><ul>
<li>线程池技术（默认）</li>
<li>信号量技术</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换信号量</span></span><br><span class="line"><span class="meta">execution.isolation.strategy</span> = <span class="string">ExecutionIsolationStrategy.SEMAPHORE</span></span><br></pre></td></tr></table></figure>

<h2 id="线程隔离方式VS信号量隔离方式"><a href="#线程隔离方式VS信号量隔离方式" class="headerlink" title="线程隔离方式VS信号量隔离方式"></a>线程隔离方式VS信号量隔离方式</h2><p><strong>原理</strong>   </p>
<p>线程池技术： 使用Hystrix内建的线程池去执行方法调用，而不是Tomcat的容器线程</p>
<p>信号量技术：直接使用Tomcat的容器线程去执行方法，不会另外创建新的线程，信号量只充当开关和计数器的作用。获取信号量的线程可以执行方法，没有获取到的就转到fallback</p>
<p><strong>性能角度</strong>    </p>
<p>线程池技术：涉及到线程的创建、销毁和任务调度，而且CPU在执行多线程任务的时候会在不同线程之间做切换，操作系统层面cpu线程切换是一个相对耗时的操作，因此从资源利用率和效率的角度看，线程池技术比信号量慢</p>
<p>信号量技术：直接使用tomcat容器线程去访问方法，信号量只是充当一个计数器的作用，没有额外的系统资源消费，所有在性能方面有明显的优势</p>
<p><strong>超时判断</strong>    </p>
<p>线程池技术：相当于多了一层保护机制（Hystrix自建线程），可以直接进行超时判断<br>信号量技术：只能等待诸如网络请求超时等“被动超时”的情况</p>
<p><strong>使用场景：</strong>    </p>
<p>信号量适合在超高并发的非外部接口调用，其他场景尽量使用线程隔离</p>
<h1 id="请求缓存"><a href="#请求缓存" class="headerlink" title="请求缓存"></a>请求缓存</h1><h2 id="相关注解"><a href="#相关注解" class="headerlink" title="相关注解"></a>相关注解</h2><ul>
<li>@CacheResult：开启缓存，默认所有参数作为缓存的key，cacheKeyMethod可以通过返回String类型的方法指定key；</li>
<li>@CacheKey：指定缓存的key，可以指定参数或指定参数中的属性值为缓存key，cacheKeyMethod还可以通过返回String类型的方法指定；</li>
<li>@CacheRemove：移除缓存，需要指定commandKey。</li>
</ul>
<h2 id="注意问题"><a href="#注意问题" class="headerlink" title="注意问题"></a>注意问题</h2><p><strong>在缓存使用过程中，我们需要在每次使用缓存的请求前后对HystrixRequestContext进行初始化和关闭，否则会出现如下异常</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Request caching is not available. Maybe you need to initialize the HystrixRequestContext?</span><br><span class="line">    at com.netflix.hystrix.HystrixRequestCache.get(HystrixRequestCache.java:104) ~[hystrix-core-1.5.18.jar:1.5.18]</span><br><span class="line">    at com.netflix.hystrix.AbstractCommand$7.call(AbstractCommand.java:478) ~[hystrix-core-1.5.18.jar:1.5.18]</span><br><span class="line">    at com.netflix.hystrix.AbstractCommand$7.call(AbstractCommand.java:454) ~[hystrix-core-1.5.18.jar:1.5.18]</span><br></pre></td></tr></table></figure>

<p><strong>这里我们通过使用过滤器，在每个请求前后初始化和关闭HystrixRequestContext来解决该问题：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/*&quot;,asyncSupported = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixRequestContextFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            context.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用请求缓存"><a href="#使用请求缓存" class="headerlink" title="使用请求缓存"></a>使用请求缓存</h2><ul>
<li>在UserService中添加具有缓存功能的getUserCache方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheResult(cacheKeyMethod = &quot;getCacheKey&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;getDefaultUser&quot;, commandKey = &quot;getUserCache&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getUserCache</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;getUserCache id:&#123;&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">&quot;/user/&#123;1&#125;&quot;</span>, ServerResponse.class, id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为缓存生成key的方法，对应cacheKeyMethod = &quot;getCacheKey&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCacheKey</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * key只能是String类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CacheResult</span></span><br><span class="line"><span class="meta">@HystrixCommand(commandKey = &quot;cacheKey&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Friend <span class="title">requestCache</span><span class="params">(<span class="meta">@CacheKey</span> String name)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;request cache &quot;</span> + name);</span><br><span class="line">    Friend friend = <span class="keyword">new</span> Friend();</span><br><span class="line">    friend.setName(name);</span><br><span class="line">    friend = service.sayHiPost(friend);</span><br><span class="line">    log.info(<span class="string">&quot;after requesting cache &quot;</span> + name);</span><br><span class="line">    <span class="keyword">return</span> friend;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="移除缓存"><a href="#移除缓存" class="headerlink" title="移除缓存"></a>移除缓存</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheRemove(commandKey = &quot;getUserCache&quot;, cacheKeyMethod = &quot;getCacheKey&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServerResponse <span class="title">removeCache</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;removeCache id:&#123;&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">return</span> restTemplate.postForObject(userServiceUrl + <span class="string">&quot;/user/delete/&#123;1&#125;&quot;</span>, <span class="keyword">null</span>, ServerResponse.class, id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCacheKey</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="请求合并"><a href="#请求合并" class="headerlink" title="请求合并"></a>请求合并</h1><blockquote>
<p>微服务系统中的服务间通信，需要通过远程调用来实现，随着调用次数越来越多，占用线程资源也会越来越多。Hystrix中提供了@HystrixCollapser用于合并请求，从而达到减少通信消耗及线程数量的效果。</p>
</blockquote>
<p>@HystrixCollapser的常用属性</p>
<ul>
<li>batchMethod：用于设置请求合并的方法；</li>
<li>collapserProperties：请求合并属性，用于控制实例属性，有很多；</li>
<li>timerDelayInMilliseconds：collapserProperties中的属性，用于控制每隔多少时间合并一次请求；</li>
</ul>
<h1 id="Hystrix业务总结（重要）"><a href="#Hystrix业务总结（重要）" class="headerlink" title="Hystrix业务总结（重要）"></a>Hystrix业务总结（重要）</h1><ol>
<li><p>判断有没有缓存</p>
<ul>
<li>请求缓存<ul>
<li>覆盖重写getCacheKey方法</li>
<li>请求缓存必须在同一个请求上下文中</li>
<li>开启请求缓存开关<ul>
<li>Hystrix默认是开启状态</li>
</ul>
</li>
</ul>
</li>
<li>请求合并<ul>
<li>主要优化点，多个服务调用的多次HTTP请求合并</li>
<li>缺点：很少有机会对同一个服务进行多次HTTP调用，同时还要足够的”近”</li>
</ul>
</li>
</ul>
</li>
<li><p>熔断有没有开启</p>
<ul>
<li><p>触发开关状态的核心指标</p>
<ul>
<li><p>单位时间</p>
</li>
<li><p>请求总数是否达到预设的阈值</p>
</li>
<li><p>失败率是否达到预设的阈值</p>
</li>
</ul>
</li>
<li><p>状态</p>
<ul>
<li><p>开启状态：阻断所有业务处理逻辑，直接fallback</p>
</li>
<li><p>关闭状态：所有的业务逻辑都会进行后续处理</p>
</li>
<li><p>半开启状态</p>
<ul>
<li>间隔性请求后端业务，成功则退出熔断器开启状态【5秒】</li>
</ul>
</li>
<li><p>强制开启和关闭</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>限流有没有触发</p>
</li>
<li><p>业务执行有没有失败</p>
</li>
<li><p>业务执行有没有超时</p>
</li>
<li><p>所有的失败都会触发fallback</p>
<pre><code>1、fallback方法与run方法是一一对应的关系
2、fallback中一般都是定义自己的业务异常
</code></pre>
</li>
</ol>
<h1 id="Hystrix全局配置"><a href="#Hystrix全局配置" class="headerlink" title="Hystrix全局配置"></a>Hystrix全局配置</h1><h2 id="Command基础配置："><a href="#Command基础配置：" class="headerlink" title="Command基础配置："></a>Command基础配置：</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">  <span class="attr">command:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">THREAD</span> <span class="comment">#控制HystrixCommand的隔离策略，THREAD-&gt;线程池隔离策略(默认)，SEMAPHORE-&gt;信号量隔离策略</span></span><br><span class="line">      <span class="comment"># 用于控制是否启用服务降级</span></span><br><span class="line">      <span class="attr">fallback:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 信号量隔离配置：</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">semaphore:</span></span><br><span class="line">            <span class="attr">maxConcurrentRequests:</span> <span class="number">5</span> <span class="comment"># 失败任务执行信号量最大数</span></span><br><span class="line">      <span class="attr">timeout:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand的执行是否启用超时时间    </span></span><br></pre></td></tr></table></figure>
<h2 id="请求上下文配置："><a href="#请求上下文配置：" class="headerlink" title="请求上下文配置："></a>请求上下文配置：</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">  <span class="attr">command:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="comment"># 用于控制是否开启请求缓存</span></span><br><span class="line">      <span class="attr">requestCache:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> </span><br><span class="line">      <span class="comment"># 是否开启请求日志，默认为true</span></span><br><span class="line">      <span class="attr">requestLog:</span> </span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 设置批处理中允许的最大请求数</span></span><br><span class="line">      <span class="attr">maxRequestsInBatch:</span> <span class="number">50</span></span><br><span class="line">      <span class="comment"># 设置批处理创建到执行之间的毫秒数</span></span><br><span class="line">      <span class="attr">timerDelayInMilliseconds:</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<h2 id="线程池相关配置："><a href="#线程池相关配置：" class="headerlink" title="线程池相关配置："></a>线程池相关配置：</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span> <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">1000</span> <span class="comment">#配置HystrixCommand执行的超时时间，执行超过该时间会进行服务降级处理</span></span><br><span class="line">            <span class="attr">interruptOnTimeout:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行超时的时候是否要中断</span></span><br><span class="line">            <span class="attr">interruptOnFutureCancel:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行被取消的时候是否要中断</span></span><br><span class="line">  <span class="comment"># 用于控制HystrixCommand执行所在线程池的行为</span></span><br><span class="line">  <span class="attr">threadpool:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">10</span> <span class="comment"># 线程池的核心线程数</span></span><br><span class="line">      <span class="attr">maximumSize:</span> <span class="number">10</span> <span class="comment"># 线程池的最大线程数，超过该线程数的请求会被拒绝</span></span><br><span class="line">      <span class="attr">maxQueueSize:</span> <span class="number">-1</span> <span class="comment"># 用于设置线程池的最大队列大小，-1采用SynchronousQueue，其他正数采用LinkedBlockingQueue</span></span><br><span class="line">      <span class="attr">queueSizeRejectionThreshold:</span> <span class="number">5</span> <span class="comment"># 用于设置线程池队列的拒绝阀值，由于LinkedBlockingQueue不能动态改版大小，使用时需要用该参数来控制线程数</span></span><br><span class="line">      <span class="attr">allowMaximumSizeToDivergeFromCoreSize:</span> <span class="literal">true</span> <span class="comment"># 是否开启最大线程数 </span></span><br></pre></td></tr></table></figure>
<h2 id="信号量隔离配置："><a href="#信号量隔离配置：" class="headerlink" title="信号量隔离配置："></a>信号量隔离配置：</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">  <span class="attr">command:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">SEMAPHORE</span> <span class="comment">#控制HystrixCommand的隔离策略，THREAD-&gt;线程池隔离策略(默认)，SEMAPHORE-&gt;信号量隔离策略</span></span><br><span class="line">      <span class="comment"># 用于控制是否启用服务降级</span></span><br><span class="line">      <span class="attr">fallback:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">semaphore:</span></span><br><span class="line">            <span class="attr">maxConcurrentRequests:</span> <span class="number">5</span> <span class="comment"># 失败任务执行信号量最大数</span></span><br><span class="line">            <span class="attr">maxConcurrentRequests:</span> <span class="number">10</span> <span class="comment">#当使用信号量隔离策略时，用来控制并发量的大小，超过该并发量的请求会被拒绝</span></span><br></pre></td></tr></table></figure>

<h2 id="熔断机制相关配置"><a href="#熔断机制相关配置" class="headerlink" title="熔断机制相关配置"></a>熔断机制相关配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">  <span class="attr">command:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="comment"># 用于控制HystrixCircuitBreaker的行为</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span> </span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#用于控制断路器是否跟踪健康状况以及熔断请求</span></span><br><span class="line">        <span class="attr">requestVolumeThreshold:</span> <span class="number">20</span> <span class="comment">#超过该请求数的请求会被拒绝</span></span><br><span class="line">        <span class="attr">sleepWindowInMilliseconds:</span> <span class="number">10000</span> <span class="comment"># 10秒之后进入半开状态</span></span><br><span class="line">        <span class="attr">errorThresholdPercentage:</span> <span class="number">50</span>  <span class="comment"># 超过50%错误，那么开启熔断</span></span><br><span class="line">        <span class="attr">forceOpen:</span> <span class="literal">false</span> <span class="comment"># 强制打开断路器，拒绝所有请求</span></span><br><span class="line">        <span class="attr">forceClosed:</span> <span class="literal">false</span> <span class="comment"># 强制关闭断路器，接收所有请求</span></span><br></pre></td></tr></table></figure>

<h2 id="请求合并-1"><a href="#请求合并-1" class="headerlink" title="请求合并"></a>请求合并</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCollapser请求合并的执行行为</span></span><br><span class="line">  <span class="attr">collapser:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">maxRequestsInBatch:</span> <span class="number">100</span> <span class="comment">#控制一次合并请求合并的最大请求数</span></span><br><span class="line">      <span class="attr">timerDelayinMilliseconds:</span> <span class="number">10</span> <span class="comment">#控制多少毫秒内的请求会被合并成一个</span></span><br><span class="line">      <span class="attr">requestCache:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#控制合并请求是否开启缓存</span></span><br></pre></td></tr></table></figure>

<h2 id="metrics-统计时间-相关配置"><a href="#metrics-统计时间-相关配置" class="headerlink" title="metrics(统计时间)相关配置"></a>metrics(统计时间)相关配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="comment"># 关于熔断的属性</span></span><br><span class="line">    <span class="comment"># 有的属性是默认值，写不写都行</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="comment"># 滑动窗口相关配置</span></span><br><span class="line">      <span class="attr">metrics:</span></span><br><span class="line">        <span class="attr">rollingStats:</span></span><br><span class="line">          <span class="comment"># 此配置项指定了窗口的大小，单位是 ms，默认值是 1000</span></span><br><span class="line">          <span class="attr">timeInMilliseconds:</span> <span class="number">20000</span></span><br><span class="line">          <span class="comment"># 生成统计数据流时滑动窗口应该拆分的桶数（代码注解已配置）</span></span><br><span class="line">          <span class="attr">numBuckets:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#统计方法响应时间</span></span><br><span class="line">        <span class="attr">rollingPercentile:</span></span><br><span class="line">          <span class="comment">#统计响应时间百分比时的窗口大小</span></span><br><span class="line">          <span class="attr">timeInMilliseconds:</span> <span class="number">20000</span></span><br><span class="line"> 		  <span class="comment"># 统计响应时间百分比时滑动窗口要划分的桶用，默认为6</span></span><br><span class="line">          <span class="attr">numBuckets:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># 统计响应时间百分比时，每个滑动窗口的桶内要保留的请求数</span></span><br><span class="line">          <span class="attr">bucketSize:</span> <span class="number">300</span></span><br><span class="line">        <span class="attr">healthSnapshot:</span></span><br><span class="line">          <span class="attr">intervalInMilliseconds:</span> <span class="number">500</span> <span class="comment">#它指定了健康数据统计器中每个桶的大小，默认是 500ms</span></span><br></pre></td></tr></table></figure>

<h1 id="Ribbon与Hystrix超时配置问题"><a href="#Ribbon与Hystrix超时配置问题" class="headerlink" title="Ribbon与Hystrix超时配置问题"></a>Ribbon与Hystrix超时配置问题</h1><p>Ribbon超时时间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ribbon计算公式：最大超时时间&#x3D;（连接超时时间+接口超时时间）*（当前节点重试次数+1）*（换节点重试次数+1）</span><br></pre></td></tr></table></figure>
<p>Hystrix超时时间默认1000ms：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds&#x3D;1000</span><br></pre></td></tr></table></figure>

<p>Hystrix超时时间小于Ribbon超时时间，还没来得及重试就进入fallback逻辑</p>
<p><strong>Hystrix的熔断时间要比Ribbon的最长超时时间设置的略长一些，这样就可以让Ribbon的重试机制充分发挥作用</strong></p>
<h2 id="Hystrix方法级别超时控制"><a href="#Hystrix方法级别超时控制" class="headerlink" title="Hystrix方法级别超时控制"></a>Hystrix方法级别超时控制</h2><h3 id="具体方法（实例）配置"><a href="#具体方法（实例）配置" class="headerlink" title="具体方法（实例）配置"></a>具体方法（实例）配置</h3><blockquote>
<p>实例配置只需要将全局配置中的default换成与之对应的key即可。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">HystrixComandKey:</span> <span class="comment">#将default换成HystrixComrnandKey</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">THREAD</span></span><br><span class="line">  <span class="attr">collapser:</span></span><br><span class="line">    <span class="attr">HystrixCollapserKey:</span> <span class="comment">#将default换成HystrixCollapserKey</span></span><br><span class="line">      <span class="attr">maxRequestsInBatch:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">HystrixThreadPoolKey:</span> <span class="comment">#将default换成HystrixThreadPoolKey</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h4 id="配置文件中相关key的说明"><a href="#配置文件中相关key的说明" class="headerlink" title="配置文件中相关key的说明"></a>配置文件中相关key的说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HystrixComandKey对应@HystrixCommand中的commandKey属性；没有指定commandKey默认使用方法名</span><br><span class="line">HystrixCollapserKey对应@HystrixCollapser注解中的collapserKey属性；</span><br><span class="line">HystrixThreadPoolKey对应@HystrixCommand中的threadPoolKey属性。</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：各方法不同超时时间在相互调用时冲突，</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <!--<a href="/archives/%7C%7Carchive">-->
                <a href="/archives/">
              
                  <span class="site-state-item-count">108</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yuanyayuan" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:liyuan0707@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiYuan</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
