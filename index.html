<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="工作中技术总结">
<meta property="og:type" content="website">
<meta property="og:title" content="Hikari的Java之路">
<meta property="og:url" content="https://yuanyayuan.github.io/index.html">
<meta property="og:site_name" content="Hikari的Java之路">
<meta property="og:description" content="工作中技术总结">
<meta property="og:locale">
<meta property="article:author" content="LiYuan">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yuanyayuan.github.io/"/>





  <title>Hikari的Java之路</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hikari的Java之路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Hello,world</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(zuul,Gateway)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(zuul,Gateway)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(zuul,Gateway)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T23:57:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/zuul?id=spring-cloud-zuul%EF%BC%9Aapi%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1">Spring Cloud Zuul：API网关服务</a></p>
<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/gateway?id=spring-cloud-gateway%EF%BC%9A%E6%96%B0%E4%B8%80%E4%BB%A3api%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1">Spring Cloud Gateway：新一代API网关服务</a></p>
<h1 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h1><p>API网关为微服务架构中的服务提供了统一的访问入口，客户端通过API网关访问相关服务。API网关的定义类似于设计模式中的门面模式，它相当于整个微服务架构中的门面，所有客户端的访问都通过它来进行路由及过滤。它实现了请求路由、负载均衡、校验过滤、服务容错、服务聚合等功能。</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><h4 id="配置路由规则"><a href="#配置路由规则" class="headerlink" title="配置路由规则"></a>配置路由规则</h4><ul>
<li><p>我们可以通过修改application.yml中的配置来配置路由规则</p>
<p>这里我们将匹配/ribbonService/**的请求路由到demo-service-consumer服务上去， 匹配/feignService/**的请求路由到demo-service-consumer-feign上去。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  routes: #给服务配置路由</span><br><span class="line">    demo-service-consumer:</span><br><span class="line">      path: &#x2F;ribbonService&#x2F;**</span><br><span class="line">    demo-service-consumer-feign:</span><br><span class="line">      path: &#x2F;feignService&#x2F;**</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8801/feignService/user/1">http://localhost:8801/feignService/user/1</a> 可以发现请求路由到demo-service-consumer-feign了；</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8801/ribbonService/user/1">http://localhost:8801/ribbonService/user/1</a> 可以发现请求路由到demo-service-consumer了；</p>
<h4 id="默认路由规则"><a href="#默认路由规则" class="headerlink" title="默认路由规则"></a>默认路由规则</h4><ul>
<li>Zuul和Eureka结合使用，可以实现路由的自动配置，自动配置的路由以服务名称为匹配路径，相当于如下配置：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  routes: #给服务配置路由</span><br><span class="line">    demo-service-consumer:</span><br><span class="line">      path: &#x2F;demo-service-consumer&#x2F;**</span><br><span class="line">    demo-service-consumer-feign:</span><br><span class="line">      path: &#x2F;demo-service-consumer-feign&#x2F;**</span><br></pre></td></tr></table></figure>

<ul>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8801/demo-service-consumer/user/1%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E8%B7%AF%E7%94%B1%E5%88%B0%E4%BA%86demo-service-consumer%E4%B8%8A%E4%BA%86%EF%BC%9B">http://localhost:8801/demo-service-consumer/user/1同样可以路由到了demo-service-consumer上了；</a></li>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8801/demo-service-consumer-feign/user/1%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E8%B7%AF%E7%94%B1%E5%88%B0%E4%BA%86demo-service-consumer-feign%E4%B8%8A%E4%BA%86%E3%80%82">http://localhost:8801/demo-service-consumer-feign/user/1同样可以路由到了demo-service-consumer-feign上了。</a></li>
<li>如果不想使用默认的路由规则，可以添加以下配置来忽略默认路由配置：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  ignored-services: user-service,feign-service #关闭默认路由配置</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡功能"><a href="#负载均衡功能" class="headerlink" title="负载均衡功能"></a>负载均衡功能</h3><blockquote>
<p>多次调用 <a target="_blank" rel="noopener" href="http://localhost:8801/feignService/user/1">http://localhost:8801/feignService/user/1</a> 进行测试</p>
</blockquote>
<p>发现demo-provide1和demo-provide2交替打印日志</p>
<h3 id="配置访问前缀"><a href="#配置访问前缀" class="headerlink" title="配置访问前缀"></a>配置访问前缀</h3><p>我们可以通过以下配置来给网关路径添加前缀，此处添加了/proxy前缀，这样我们需要访问<a target="_blank" rel="noopener" href="http://localhost:8801/proxy/feignService/user/1%E6%89%8D%E8%83%BD%E8%AE%BF%E9%97%AE%E5%88%B0user-service%E4%B8%AD%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82">http://localhost:8801/proxy/feignService/user/1才能访问到user-service中的接口。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  prefix: &#x2F;proxy #给网关路由添加前缀</span><br></pre></td></tr></table></figure>

<h3 id="Header过滤及重定向添加Host"><a href="#Header过滤及重定向添加Host" class="headerlink" title="Header过滤及重定向添加Host"></a>Header过滤及重定向添加Host</h3><ul>
<li>Zuul在请求路由时，默认会过滤掉一些敏感的头信息，以下配置可以防止路由时的Cookie及Authorization的丢失：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  sensitive-headers: Cookie,Set-Cookie,Authorization #配置过滤敏感的请求头信息，设置为空就不会过滤</span><br></pre></td></tr></table></figure>

<ul>
<li>Zuul在请求路由时，不会设置最初的host头信息，以下配置可以解决：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul:</span><br><span class="line">  add-host-header: true #设置为true重定向是会添加host请求头</span><br></pre></td></tr></table></figure>

<h3 id="查看路由信息"><a href="#查看路由信息" class="headerlink" title="查看路由信息"></a>查看路由信息</h3><blockquote>
<p>我们可以通过SpringBoot Actuator来查看Zuul中的路由信息。</p>
</blockquote>
<ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改application.yaml配置文件，开启查看路由的端点：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">management:</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: &#39;routes&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过访问<a target="_blank" rel="noopener" href="http://localhost:8801/actuator/routes%E6%9F%A5%E7%9C%8B%E7%AE%80%E5%8D%95%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF%EF%BC%9A">http://localhost:8801/actuator/routes查看简单路由信息：</a></li>
</ul>
<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><h4 id="过滤器类型"><a href="#过滤器类型" class="headerlink" title="过滤器类型"></a>过滤器类型</h4><blockquote>
<p>Zuul中有以下几种典型的过滤器类型。</p>
</blockquote>
<ul>
<li>pre：在请求被路由到目标服务前执行，比如权限校验、打印日志等功能；</li>
<li>routing：在请求被路由到目标服务时执行，这是使用Apache HttpClient或Netflix Ribbon构建和发送原始HTTP请求的地方；</li>
<li>post：在请求被路由到目标服务后执行，比如给目标服务的响应添加头信息，收集统计数据等功能；</li>
<li>error：请求在其他阶段发生错误时执行。</li>
</ul>
<h4 id="过滤器的生命周期"><a href="#过滤器的生命周期" class="headerlink" title="过滤器的生命周期"></a>过滤器的生命周期</h4><blockquote>
<p>下图描述了一个HTTP请求到达API网关后，如何在各种不同类型的过滤器中流转的过程。</p>
</blockquote>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/zuul/zuul%E8%BF%87%E6%BB%A4%E5%99%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" style="zoom: 67%;" />

<h4 id="定义过滤器"><a href="#定义过滤器" class="headerlink" title="定义过滤器"></a>定义过滤器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使过滤器生效"><a href="#使过滤器生效" class="headerlink" title="使过滤器生效"></a>使过滤器生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class FilterConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public CustomFilter customFilter() &#123;</span><br><span class="line">        return new CustomFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤器中传递数据"><a href="#过滤器中传递数据" class="headerlink" title="过滤器中传递数据"></a>过滤器中传递数据</h4><p>项目中往往会存在很多的过滤器，执行的顺序是根据 filterOrder 决定的，那么肯定有一些过滤器是在后面执行的，如果你有这样的需求：第一个过滤器需要告诉第二个过滤器一些信息，这个时候就涉及在过滤器中怎么去传递数据给后面的过滤器。</p>
<p>实现这种传值的方式笔者第一时间就想到了用 ThreadLocal，既然我们用了 Zuul，那么 Zuul 肯定有解决方案，比如可以通过 RequestContext 的 set 方法进行传递，RequestContext 的原理就是 ThreadLocal。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx &#x3D; RequestContext.getCurrentContext();</span><br><span class="line">ctx.set(&quot;msg&quot;, &quot;你好吗&quot;);</span><br></pre></td></tr></table></figure>

<p>后面的过滤就可以通过 RequestContext 的 get 方法来获取数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx &#x3D; RequestContext.getCurrentContext();</span><br><span class="line">ctx.get(&quot;msg&quot;);</span><br></pre></td></tr></table></figure>

<h4 id="过滤器拦截请求"><a href="#过滤器拦截请求" class="headerlink" title="过滤器拦截请求"></a>过滤器拦截请求</h4><p>在过滤器中对请求进行拦截是一个很常见的需求。如果请求在黑名单中，就不能让该请求继续往下执行，需要对其进行拦截并返回结果给客户端。</p>
<p>拦截和返回结果只需要 5 行代码即可实现，代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">ctx.set(<span class="string">&quot;sendForwardFilter.ran&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">ctx.setResponseBody(<span class="string">&quot;返回信息&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ctx.setSendZuulResponse(false);告诉 Zuul 不需要将当前请求转发到后端的服务</strong></p>
<p>当前的过滤器中确实将请求进行拦截了，并且可以给客户端返回信息。但是当你的项目中有多个过滤器的时候，假如你需要过滤的那个过滤器是第一个执行的，发现非法请求，然后进行拦截，在 chain.doFilter 之前进行返回就可以让过滤器不往下执行了。</p>
<p>但是 <strong>Zuul 中的过滤器不一样，即使你刚刚通过 ctx.setSendZuulResponse(false) 设置了不路由到服务，并且返回 null，那只是当前的过滤器执行完成了，后面还有很多过滤器在等着执行</strong>。</p>
<h5 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h5><p>解决这个问题的办法就是通过 shouldFilter 来处理，即在拦截之后通过数据传递的方式告诉下一个过滤器是否要执行。</p>
<p>增加一行数据传递的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">&quot;isSuccess&quot;</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>

<p>在 RequestContext 中设置一个值来标识是否成功，当为 true 的时候，后续的过滤器才执行，若为 false 则不执行。</p>
<p>利用这种方法，在后面的过滤器就需要用到这个值来决定自己此时是否需要执行，此时只需要在 shouldFilter 方法中加上如下所示的代码即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">    Object success = ctx.get(<span class="string">&quot;isSuccess&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> success == <span class="keyword">null</span> ? <span class="keyword">true</span> : Boolean.parseBoolean(success.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤器中异常处理"><a href="#过滤器中异常处理" class="headerlink" title="过滤器中异常处理"></a>过滤器中异常处理</h4><p>过滤器中的异常主要发生在 run 方法中，可以用 try catch 来处理。Zuul 中也为我们提供了一个异常处理的过滤器，当过滤器在执行过程中发生异常，若没有被捕获到，就会进入 error 过滤器中</p>
<h1 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h1><ul>
<li>网关</li>
<li>Spring Cloud 生态系中的网关，其目标是替代 Netflix Zuul</li>
<li>提供统一的路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全、监控/埋点和限流等。</li>
<li>依赖 Spring Boot 和 Spring WebFlux，基于 Netty 运行。它不能在传统的 servlet 容器中工作，也不能构建成 war 包</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>动态路由：能够匹配任何请求属性；</li>
<li>Predicate（断言）和 Filter（过滤器）；</li>
<li>集成Hystrix的断路器功能；</li>
<li>集成 Spring Cloud 服务发现功能；</li>
<li>请求限流功能；</li>
<li>支持路径重写。</li>
</ul>
<h2 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h2><p>限流</p>
<p>熔断回退</p>
<p>跨域</p>
<p>统一异常处理</p>
<p>重试</p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>1）Route</strong></p>
<p>Route 是网关的基础元素，由 ID、目标 URI、断言、过滤器组成。当请求到达网关时，由 Gateway Handler Mapping 通过断言进行路由匹配（Mapping），当断言为真时，匹配到路由。</p>
<p><strong>2）Predicate</strong></p>
<p>匹配条件。</p>
<p><strong>3）Filter</strong></p>
<p>Filter 是 Gateway 中的过滤器，可以在请求发出前后进行一些业务上的处理。</p>
<blockquote>
<p>Gateway 的 Filter 只有 pre 和 post 两种</p>
</blockquote>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/zuul/gateway%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="image" style="zoom: 67%;" />

<ul>
<li><p>客户端向 Spring Cloud Gateway 发出请求，如果请求与网关程序定义的路由匹配，则该请求就会被发送到网关 Web 处理程序，此时处理程序运行特定的请求过滤器链。</p>
</li>
<li><p>过滤器之间用虚线分开的原因是过滤器可能会在发送代理请求的前后执行逻辑。所有 pre 过滤器逻辑先执行，然后执行代理请求；代理请求完成后，执行 post 过滤器逻辑。</p>
</li>
</ul>
<h2 id="Route-网关-Predicate-的使用"><a href="#Route-网关-Predicate-的使用" class="headerlink" title="Route(网关) Predicate 的使用"></a>Route(网关) Predicate 的使用</h2><p>Spring Cloud Gateway将路由匹配作为Spring WebFlux HandlerMapping基础架构的一部分。 Spring Cloud Gateway包括许多内置的Route Predicate工厂。 所有这些Predicate都与HTTP请求的不同属性匹配。 多个Route Predicate工厂可以进行组合</p>
<h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><h4 id="使用yml配置"><a href="#使用yml配置" class="headerlink" title="使用yml配置"></a>使用yml配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9201</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">user-service:</span> <span class="string">http://localhost:8201</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path_route</span> <span class="comment">#路由的ID</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">$&#123;service-url.user-service&#125;/user/&#123;id&#125;</span> <span class="comment">#匹配后路由地址</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/&#123;id&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>application-eureka.yml</code>配置文件启动api-gateway服务，访问<code>http://localhost:9201/1</code> ，可以路由到<code>http://localhost:8201/user/1</code>处。</p>
<h4 id="使用Java-Bean配置"><a href="#使用Java-Bean配置" class="headerlink" title="使用Java Bean配置"></a>使用Java Bean配置</h4><ul>
<li>添加相关配置类，并配置一个RouteLocator对象：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">                .route(<span class="string">&quot;path_route2&quot;</span>, r -&gt; r.path(<span class="string">&quot;/user/getByUsername&quot;</span>)</span><br><span class="line">                        .uri(<span class="string">&quot;http://localhost:8201/user/getByUsername&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重新启动api-gateway服务，并调用该地址测试：<a target="_blank" rel="noopener" href="http://localhost:9201/user/getByUsername?username=neo">http://localhost:9201/user/getByUsername?username=neo</a></li>
<li>我们发现该请求被路由到了user-service的该路径上：<a target="_blank" rel="noopener" href="http://localhost:8201/user/getByUsername?username=neo">http://localhost:8201/user/getByUsername?username=neo</a></li>
</ul>
<h2 id="Route-Predicate-的使用"><a href="#Route-Predicate-的使用" class="headerlink" title="Route Predicate 的使用"></a>Route Predicate 的使用</h2><p>Spring Cloud Gateway将路由匹配作为Spring WebFlux HandlerMapping基础架构的一部分。 Spring Cloud Gateway包括许多内置的Route Predicate工厂。 所有这些Predicate都与HTTP请求的不同属性匹配。 多个Route Predicate工厂可以进行组合，下面我们来介绍下一些常用的Route Predicate。</p>
<blockquote>
<p>注意：Predicate中提到的配置都在application-predicate.yml文件中进行修改，并用该配置启动api-gateway服务。</p>
</blockquote>
<h3 id="After-Route-Predicate"><a href="#After-Route-Predicate" class="headerlink" title="After Route Predicate"></a>After Route Predicate</h3><blockquote>
<p>在指定时间之后的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: after_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - After&#x3D;2019-09-24T16:30:00+08:00[Asia&#x2F;Shanghai]</span><br></pre></td></tr></table></figure>

<h3 id="Before-Route-Predicate"><a href="#Before-Route-Predicate" class="headerlink" title="Before Route Predicate"></a>Before Route Predicate</h3><blockquote>
<p>在指定时间之前的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: before_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Before&#x3D;2019-09-24T16:30:00+08:00[Asia&#x2F;Shanghai]</span><br></pre></td></tr></table></figure>

<h3 id="Between-Route-Predicate"><a href="#Between-Route-Predicate" class="headerlink" title="Between Route Predicate"></a>Between Route Predicate</h3><blockquote>
<p>在指定时间区间内的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: before_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Between&#x3D;2019-09-24T16:30:00+08:00[Asia&#x2F;Shanghai], 2019-09-25T16:30:00+08:00[Asia&#x2F;Shanghai]</span><br></pre></td></tr></table></figure>

<h3 id="Cookie-Route-Predicate"><a href="#Cookie-Route-Predicate" class="headerlink" title="Cookie Route Predicate"></a>Cookie Route Predicate</h3><blockquote>
<p>带有指定Cookie的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: cookie_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Cookie&#x3D;username,macro</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带有cookie为username=macro的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1 --cookie &quot;username&#x3D;macro&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Header-Route-Predicate"><a href="#Header-Route-Predicate" class="headerlink" title="Header Route Predicate"></a>Header Route Predicate</h3><blockquote>
<p>带有指定请求头的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: header_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;</span><br><span class="line">        predicates:</span><br><span class="line">        - Header&#x3D;X-Request-Id, \d+</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带有请求头为X-Request-Id:123的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1 -H &quot;X-Request-Id:123&quot; </span><br></pre></td></tr></table></figure>

<h3 id="Host-Route-Predicate"><a href="#Host-Route-Predicate" class="headerlink" title="Host Route Predicate"></a>Host Route Predicate</h3><blockquote>
<p>带有指定Host的请求会匹配该路由。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: host_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Host&#x3D;**.macrozheng.com</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带有请求头为Host:<a target="_blank" rel="noopener" href="http://www.macrozheng.com的请求可以匹配该路由./">www.macrozheng.com的请求可以匹配该路由。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1 -H &quot;Host:www.macrozheng.com&quot; </span><br></pre></td></tr></table></figure>

<h3 id="Method-Route-Predicate"><a href="#Method-Route-Predicate" class="headerlink" title="Method Route Predicate"></a>Method Route Predicate</h3><p>发送指定方法的请求会匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: method_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;</span><br><span class="line">        predicates:</span><br><span class="line">        - Method&#x3D;GET</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送GET请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送POST请求无法匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="Path-Route-Predicate"><a href="#Path-Route-Predicate" class="headerlink" title="Path Route Predicate"></a>Path Route Predicate</h3><p>发送指定路径的请求会匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: path_route</span><br><span class="line">          uri: $&#123;service-url.user-service&#125;&#x2F;user&#x2F;&#123;id&#125;</span><br><span class="line">          predicates:</span><br><span class="line">            - Path&#x3D;&#x2F;user&#x2F;&#123;id&#125;</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送/user/1路径请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送/abc/1路径请求无法匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;abc&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="Query-Route-Predicate"><a href="#Query-Route-Predicate" class="headerlink" title="Query Route Predicate"></a>Query Route Predicate</h3><p>带指定查询参数的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: query_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;&#x2F;user&#x2F;getByUsername</span><br><span class="line">        predicates:</span><br><span class="line">        - Query&#x3D;username</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带username=macro查询参数的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;getByUsername?username&#x3D;macro</span><br></pre></td></tr></table></figure>

<p>使用curl工具发送带不带查询参数的请求无法匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;getByUsername</span><br></pre></td></tr></table></figure>

<h3 id="RemoteAddr-Route-Predicate"><a href="#RemoteAddr-Route-Predicate" class="headerlink" title="RemoteAddr Route Predicate"></a>RemoteAddr Route Predicate</h3><p>从指定远程地址发起的请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: remoteaddr_route</span><br><span class="line">        uri: $&#123;service-url.user-service&#125;</span><br><span class="line">        predicates:</span><br><span class="line">        - RemoteAddr&#x3D;192.168.1.1&#x2F;24</span><br></pre></td></tr></table></figure>

<p>使用curl工具从192.168.1.1发起请求可以匹配该路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9201&#x2F;user&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="Weight-Route-Predicate"><a href="#Weight-Route-Predicate" class="headerlink" title="Weight Route Predicate"></a>Weight Route Predicate</h3><p>使用权重来路由相应请求，以下表示有80%的请求会被路由到localhost:8201，20%会被路由到localhost:8202。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: weight_high</span><br><span class="line">        uri: http:&#x2F;&#x2F;localhost:8201</span><br><span class="line">        predicates:</span><br><span class="line">        - Weight&#x3D;group1, 8</span><br><span class="line">      - id: weight_low</span><br><span class="line">        uri: http:&#x2F;&#x2F;localhost:8202</span><br><span class="line">        predicates:</span><br><span class="line">        - Weight&#x3D;group1, 2</span><br></pre></td></tr></table></figure>

<h3 id="自定义路由断言工厂"><a href="#自定义路由断言工厂" class="headerlink" title="自定义路由断言工厂"></a>自定义路由断言工厂</h3><p>自定义路由断言工厂需要继承<code>AbstractRoutePredicateFactory</code>类，重写 apply 方法的逻辑。</p>
<p>在 apply 方法中可以通过<code>exchange.getRequest()</code>拿到<code>ServerHttpRequest</code> 对象，从而可以获取到请求的参数、请求方式、请求头等信息。</p>
<p><code>apply</code>方法的参数是自定义的配置类，在使用的时候配置参数，在<code>apply</code> 方法中直接获取使用。</p>
<p>命名需要以<code>RoutePredicateFactory</code>结尾，比如 CheckAuthRoutePredicateFactory，那么在使用的时候 CheckAuth 就是这个路由断言工厂的名称。代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @className CheckAuthRoutePredicateFactory</span><br><span class="line"> * @description &#x2F;&#x2F;自定义路由断言工厂</span><br><span class="line"> * @author LiYuan</span><br><span class="line"> * @date 2020&#x2F;8&#x2F;26</span><br><span class="line">**&#x2F;</span><br><span class="line">@Component</span><br><span class="line">public class CheckAuthRoutePredicateFactory extends AbstractRoutePredicateFactory&lt;CheckAuthRoutePredicateFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public CheckAuthRoutePredicateFactory() &#123;</span><br><span class="line">        super(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Predicate&lt;ServerWebExchange&gt; apply(Config config) &#123;</span><br><span class="line">        return exchange -&gt; &#123;</span><br><span class="line">            System.err.println(&quot;进入了CheckAuthRoutePredicateFactory\t&quot; + config.getName());</span><br><span class="line">            if (config.getName().equals(&quot;zhangsan&quot;)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class Config &#123;</span><br><span class="line">        private String name;</span><br><span class="line">        public void setName(String name) &#123;</span><br><span class="line">            this.name &#x3D; name;</span><br><span class="line">        &#125;</span><br><span class="line">        public String getName() &#123;</span><br><span class="line">            return name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="application-yml配置"><a href="#application-yml配置" class="headerlink" title="application.yml配置"></a>application.yml配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">#自定义路由断言工厂的使用</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: customer_route</span><br><span class="line">          uri: http:&#x2F;&#x2F;c.biancheng.net</span><br><span class="line">          predicates:</span><br><span class="line">            - name: CheckAuth</span><br><span class="line">          args:</span><br><span class="line">            name: zhangsan</span><br></pre></td></tr></table></figure>

<h3 id="过滤器-1"><a href="#过滤器-1" class="headerlink" title="过滤器"></a>过滤器</h3><blockquote>
<p>在结合注册中心使用过滤器的时候，我们需要注意的是uri的协议为<code>lb</code>，这样才能启用Gateway的负载均衡功能。</p>
</blockquote>
<p>修改application-eureka.yml文件，使用了PrefixPath过滤器，会为所有GET请求路径添加<code>自定义</code>路径并路由；</p>
<h4 id="结合Eureka使用"><a href="#结合Eureka使用" class="headerlink" title="结合Eureka使用"></a>结合Eureka使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9201</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">prefixpath_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://demo-service-provider</span> <span class="comment">#此处需要使用lb协议</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">PrefixPath=/user</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启从注册中心动态创建路由的功能</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span> <span class="comment">#使用小写服务名，默认是大写</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8001/eureka/</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.springframework.cloud.gateway:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>使用application-eureka.yml配置文件启动api-gateway服务，访问<code>http://localhost:9201/1</code> ，可以路由到<code>user-service</code>的<code>http://localhost:7101/user/1</code>处。</p>
<h4 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h4><blockquote>
<p>全局过滤器作用于所有的路由，不需要单独配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleConfiguration</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(ExampleConfiguration.class);</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@Order(-1)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">&quot;first pre filter&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;third post filter&quot;</span>);</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@Order(0)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">&quot;second pre filter&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;second post filter&quot;</span>);</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@Order(1)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">                log.info(<span class="string">&quot;third pre filter&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;first post filter&quot;</span>);</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面定义了 3 个 GlobalFilter，通过 @Order 来指定执行的顺序，数字越小，优先级越高。下面就是输出的日志，从日志就可以看出执行的顺序，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2019-8-26 16:08:52.406  INFO 55062 --- [ioEventLoop-4-1] c.c.gateway.config.ExampleConfiguration  : first pre filter</span><br><span class="line">2019-8-26 16:08:52.406  INFO 55062 --- [ioEventLoop-4-1] c.c.gateway.config.ExampleConfiguration  : second pre filter</span><br><span class="line">2019-8-26 16:08:52.407  INFO 55062 --- [ioEventLoop-4-1] c.c.gateway.config.ExampleConfiguration  : third pre filter</span><br><span class="line">2019-8-26 16:08:52.437  INFO 55062 --- [ctor-http-nio-7] c.c.gateway.config.ExampleConfiguration  : first post filter</span><br><span class="line">2019-8-26 16:08:52.438  INFO 55062 --- [ctor-http-nio-7] c.c.gateway.config.ExampleConfiguration  : second post filter</span><br><span class="line">2019-8-26 16:08:52.438  INFO 55062 --- [ctor-http-nio-7] c.c.gateway.config.ExampleConfiguration  : third post filter</span><br></pre></td></tr></table></figure>

<p><strong>当 GlobalFilter 的逻辑比较多时单独写一个 GlobalFilter 来处理</strong>，比如我们要实现对 IP 的访问限制，即不在 IP 白名单中就不能调用的需求。</p>
<p>单独定义只需要实现 GlobalFilter、Ordered 两个接口就可以了，具体代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IPCheckFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        HttpHeaders headers = exchange.getRequest().getHeaders();</span><br><span class="line">        <span class="comment">// 此处写得非常绝对, 只作演示用, 实际中需要采取配置的方式</span></span><br><span class="line">        <span class="keyword">if</span> (getIp(headers).equals(<span class="string">&quot;127.0.0.1&quot;</span>)) &#123;</span><br><span class="line">            ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">            ResponseData data = <span class="keyword">new</span> ResponseData();</span><br><span class="line">            data.setCode(<span class="number">401</span>);</span><br><span class="line">            data.setMessage(<span class="string">&quot;非法请求&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] datas = JsonUtils.toJson(data).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">            DataBuffer buffer = response.bufferFactory().wrap(datas);</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            response.getHeaders().add(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里从请求头中获取用户的实际IP,根据Nginx转发的请求头获取</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getIp</span><span class="params">(HttpHeaders headers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Config%EF%BC%8CBus)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Config%EF%BC%8CBus)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Config，Bus)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T19:50:18+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud练习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E9%85%8D%E7%BD%AE%E9%A1%B9.png" style="zoom:50%;" />

<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/config?id=spring-cloud-config%EF%BC%9A%E5%A4%96%E9%83%A8%E9%9B%86%E4%B8%AD%E5%8C%96%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86">Spring Cloud Config：外部集中化配置管理</a></p>
<p><a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/cloud/bus?id=spring-cloud-bus%EF%BC%9A%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF">Spring Cloud Bus：消息总线</a></p>
<h1 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h1><p>Spring Cloud Config 分为服务端和客户端两个部分。</p>
<p>服务端被称为分布式配置中心，它是个独立的应用，可以从配置仓库获取配置信息并提供给客户端使用。</p>
<p>客户端可以通过配置中心来获取配置信息，在启动时加载配置。</p>
<p>Spring Cloud Config 的配置中心默认采用Git来存储配置信息，所以天然就支持配置信息的版本管理，并且可以使用Git客户端来方便地管理和访问配置信息。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>统一配置</li>
<li>环境隔离</li>
<li>动态刷新</li>
</ul>
<h1 id="外部集中化配置管理"><a href="#外部集中化配置管理" class="headerlink" title="外部集中化配置管理"></a>外部集中化配置管理</h1><blockquote>
<p>Spring Cloud Config 可以为微服务架构中的应用提供集中化的外部配置支持，它分为服务端和客户端两个部分</p>
</blockquote>
<h2 id="在Git仓库中准备配置信息"><a href="#在Git仓库中准备配置信息" class="headerlink" title="在Git仓库中准备配置信息"></a>在Git仓库中准备配置信息</h2><blockquote>
<p>由于Spring Cloud Config 需要一个存储配置信息的Git仓库，这里我们先在Git仓库中添加好配置文件再演示其功能<br>Git:仓库地址为：<a target="_blank" rel="noopener" href="https://github.com/yuanyayuan/springcloud-config.git">https://github.com/yuanyayuan/springcloud-config.git</a></p>
</blockquote>
<h3 id="配置仓库目录结构"><a href="#配置仓库目录结构" class="headerlink" title="配置仓库目录结构"></a>配置仓库目录结构</h3><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/config.png" alt="image" style="zoom:67%;" />

<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><p><strong>master分支下的配置信息</strong></p>
<ul>
<li>config/config-dev.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for dev(master)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config/config-test.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for test(master)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config/config-prod.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for prod(master)&quot;</span><br></pre></td></tr></table></figure>

<p><strong>dev分支下的配置信息</strong></p>
<ul>
<li>config/config-dev.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for dev(dev)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config-test.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for test(dev)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>config-prod.yml:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: &quot;config info for prod(dev)&quot;</span><br></pre></td></tr></table></figure>

<h1 id="创建demo-config-server模块"><a href="#创建demo-config-server模块" class="headerlink" title="创建demo_config_server模块"></a>创建demo_config_server模块</h1><blockquote>
<p>这里我们创建一个demo_config_server模块来演示Spring Cloud Config 作为配置中心的功能。 </p>
</blockquote>
<h2 id="在pom-xml中添加相关依赖"><a href="#在pom-xml中添加相关依赖" class="headerlink" title="在pom.xml中添加相关依赖"></a>在pom.xml中添加相关依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8901</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-server</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span> <span class="comment">#配置存储配置信息的Git仓库</span></span><br><span class="line">          <span class="attr">uri:</span> </span><br><span class="line">          <span class="attr">username:</span> </span><br><span class="line">          <span class="attr">password:</span> </span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span> <span class="comment">#配置文件分支</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">config</span>  <span class="comment">#配置文件所在根目录</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>
<h2 id="在启动类上添加-EnableConfigServer注解来启用配置中心功能"><a href="#在启动类上添加-EnableConfigServer注解来启用配置中心功能" class="headerlink" title="在启动类上添加@EnableConfigServer注解来启用配置中心功能"></a>在启动类上添加@EnableConfigServer注解来启用配置中心功能</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.config.server.EnableConfigServer;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> DemoConfigServerApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/7/2</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConfigServerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoConfigServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过demo-config-server获取配置信息"><a href="#通过demo-config-server获取配置信息" class="headerlink" title="通过demo_config_server获取配置信息"></a>通过demo_config_server获取配置信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取配置信息</span></span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;</span><br><span class="line"><span class="comment"># 获取配置文件信息</span></span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br></pre></td></tr></table></figure>

<h3 id="占位符相关解释"><a href="#占位符相关解释" class="headerlink" title="占位符相关解释"></a>占位符相关解释</h3><ul>
<li>application：代表应用名称，默认为配置文件中的spring.application.name，如果配置了spring.cloud.config.name，则为该名称；</li>
<li>label：代表分支名称，对应配置文件中的spring.cloud.config.label；</li>
<li>profile：代表环境名称，对应配置文件中的spring.cloud.config.profile。</li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/master/config-dev">http://localhost:8901/master/config-dev</a></li>
</ul>
<p>获取master分支上dev环境的配置信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;master&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;profiles&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;config-dev&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0af0655db64cb0800054551e584cebad2f5e4028&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;state&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;propertySources&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/dev/config-dev">http://localhost:8901/dev/config-dev</a></li>
</ul>
<p>获取dev分支上dev环境的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;dev&quot;,</span><br><span class="line">    &quot;profiles&quot;: [</span><br><span class="line">        &quot;config-dev&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;label&quot;: null,</span><br><span class="line">    &quot;version&quot;: &quot;0af0655db64cb0800054551e584cebad2f5e4028&quot;,</span><br><span class="line">    &quot;state&quot;: null,</span><br><span class="line">    &quot;propertySources&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/master/config-dev.yml">http://localhost:8901/master/config-dev.yml</a></li>
</ul>
<p>获取master分支上dev环境的配置文件信息，对比上面信息，可以看出配置信息和配置文件信息并不是同一个概念</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: config info for dev(master)</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/master/config-test.yml">http://localhost:8901/master/config-test.yml</a></li>
</ul>
<p>获取master分支上test环境的配置文件信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: config info for test(master)</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8901/dev/config-dev.yml">http://localhost:8901/dev/config-dev.yml</a></li>
</ul>
<p>获取dev分支上dev环境的配置文件信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: config info for dev(dev)</span><br></pre></td></tr></table></figure>

<h1 id="创建demo-config-client"><a href="#创建demo-config-client" class="headerlink" title="创建demo_config_client"></a>创建demo_config_client</h1><h2 id="github上创建"><a href="#github上创建" class="headerlink" title="github上创建"></a>github上创建</h2><ul>
<li>config/config-single-client-dev.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  env: config-single-client-dev（Spring Cloud Bus）</span><br><span class="line">  user:</span><br><span class="line">    username: liyuanSama（Spring Cloud Bus）</span><br><span class="line">    password: liyuanSama（Spring Cloud Bus）</span><br></pre></td></tr></table></figure>

<ul>
<li>config/config-single-client-prod.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  env: config-single-client-prod</span><br><span class="line">  user:</span><br><span class="line">    username: liyuan</span><br><span class="line">    password: liyuan123</span><br></pre></td></tr></table></figure>

<h2 id="在pom-xml中添加相关依赖-1"><a href="#在pom-xml中添加相关依赖-1" class="headerlink" title="在pom.xml中添加相关依赖"></a>在pom.xml中添加相关依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="application-yml-1"><a href="#application-yml-1" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">NaN</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">NaN</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">NaN</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">NaN</span></span><br></pre></td></tr></table></figure>
<h2 id="bootstrap-yml"><a href="#bootstrap-yml" class="headerlink" title="bootstrap.yml"></a>bootstrap.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span> <span class="comment">#Config客户端配置</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-single-client</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8901</span> <span class="comment">#配置中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>
<h2 id="添加GitAutoRefreshConfig类用于获取配置"><a href="#添加GitAutoRefreshConfig类用于获取配置" class="headerlink" title="添加GitAutoRefreshConfig类用于获取配置"></a>添加GitAutoRefreshConfig类用于获取配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;data&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GitAutoRefreshConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String username;</span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> username;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.username = username;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> password;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.password = password;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;UserInfo&#123;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;username=&#x27;&quot;</span> + username + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&quot;, password=&#x27;&quot;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String env;</span><br><span class="line">    <span class="keyword">private</span> UserInfo user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建RESTController显示数据"><a href="#创建RESTController显示数据" class="headerlink" title="创建RESTController显示数据"></a>创建RESTController显示数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;test2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RESTController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitConfig gitConfig;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitAutoRefreshConfig gitAutoRefreshConfig;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;show&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitConfig;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;autoShow&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">autoShow</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitAutoRefreshConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="演示从配置中心获取配置"><a href="#演示从配置中心获取配置" class="headerlink" title="演示从配置中心获取配置"></a>演示从配置中心获取配置</h2><ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8848/test2/show">http://localhost:8848/test2/show</a></li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/1.png" style="zoom: 80%;" />


<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8848/test2/autoShow">http://localhost:8848/test2/autoShow</a></li>
</ul>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/2.png"></p>
<h2 id="获取子目录下的配置"><a href="#获取子目录下的配置" class="headerlink" title="获取子目录下的配置"></a>获取子目录下的配置</h2><blockquote>
<p>我们不仅可以把每个项目的配置放在不同的Git仓库存储，也可以在一个Git仓库中存储多个项目的配置，此时就会用到在子目录中搜索配置信息的配置。</p>
</blockquote>
<ul>
<li>首先我们需要在config-server中添加相关配置，用于搜索子目录中的配置，这里我们用到了application占位符，表示对于不同的应用，我们从对应应用名称的子目录中搜索配置，比如config子目录中的配置对应config应用；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span> </span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">&#x27;&#123;application&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8848/test1/configInfo">http://localhost:8848/test1/configInfo</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config info for dev(dev)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="刷新配置"><a href="#刷新配置" class="headerlink" title="刷新配置"></a>刷新配置</h2><blockquote>
<p>当Git仓库中的配置信息更改后，我们可以通过SpringBoot Actuator的refresh端点来刷新客户端配置信息，以下更改都需要在config-client中进行。</p>
</blockquote>
<ul>
<li><p>在pom.xml中添加Actuator的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>application.yml中开启refresh端点：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;refresh&#x27;</span></span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在RESTController类添加@RefreshScope注解用于刷新配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;test2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RESTController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitConfig gitConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GitAutoRefreshConfig gitAutoRefreshConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;show&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;autoShow&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">autoShow</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gitAutoRefreshConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>更改github上的数据</p>
</li>
<li><p>客户端调用refresh端点进行配置刷新：</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://localhost:8848/test2/autoShow">http://localhost:8848/test2/autoShow</a> 进行测试发现更改</p>
</li>
</ul>
<h1 id="配置中心添加安全认证"><a href="#配置中心添加安全认证" class="headerlink" title="配置中心添加安全认证"></a>配置中心添加安全认证</h1><blockquote>
<p>我们可以通过整合SpringSecurity来为配置中心添加安全认证。</p>
</blockquote>
<h2 id="创建config-security-server模块"><a href="#创建config-security-server模块" class="headerlink" title="创建config-security-server模块"></a>创建config-security-server模块</h2><ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在application.yml中进行配置：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8905</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-security-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> </span><br><span class="line">          <span class="attr">username:</span> </span><br><span class="line">          <span class="attr">password:</span> </span><br><span class="line">          <span class="attr">clone-on-start:</span> <span class="literal">true</span> <span class="comment">#开启启动时直接从git获取配置</span></span><br><span class="line">  <span class="attr">security:</span> <span class="comment">#配置用户名和密码</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> </span><br><span class="line">      <span class="attr">password:</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>启动config-security-server服务。</li>
</ul>
<h2 id="config-client的配置"><a href="#config-client的配置" class="headerlink" title="config-client的配置"></a>config-client的配置</h2><ul>
<li>添加bootstrap-security.yml配置文件，主要是配置了配置中心的用户名和密码：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">dev</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8901</span> <span class="comment">#配置中心地址</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">username:</span> </span><br><span class="line">      <span class="attr">password:</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>使用bootstrap-security.yml启动config-client服务；</li>
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8901/configInfo%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E5%88%B0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E3%80%82">http://localhost:8901/configInfo进行测试，发现可以获取到配置信息。</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config info <span class="keyword">for</span> dev(dev)</span><br></pre></td></tr></table></figure>

<h1 id="配置config-sever集群搭建"><a href="#配置config-sever集群搭建" class="headerlink" title="配置config-sever集群搭建"></a>配置config-sever集群搭建</h1><blockquote>
<p>在微服务架构中，所有服务都从配置中心获取配置，配置中心一旦宕机，会发生很严重的问题，下面我们搭建一个双节点的配置中心集群来解决该问题。</p>
</blockquote>
<ul>
<li><p>启动两个config-server分别运行在8901和8902端口上；</p>
</li>
<li><p>添加config-client的配置文件bootstrap-cluster.yml，主要是添加了从注册中心获取配置中心地址的配置并去除了配置中心uri的配置：</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span> <span class="comment">#Config客户端配置</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-single-client</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="comment"># 集群配置</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">demo-config-server</span></span><br></pre></td></tr></table></figure>

<p>以bootstrap-cluster.yml启动config-client服务，注册中心显示信息如下：</p>
<p><strong>注意：</strong></p>
<p>client的Eureka，cloud.config的配置信息需配置到bootstrap.yml中，在启动前读取信息，因为没有cloud.config的配置信息，会去localhost：8888去寻找配置信息，需要启动前指定</p>
<h1 id="Spring-Cloud-Bus：消息总线"><a href="#Spring-Cloud-Bus：消息总线" class="headerlink" title="Spring Cloud Bus：消息总线"></a>Spring Cloud Bus：消息总线</h1><blockquote>
<p>Spring Cloud Bus 使用轻量级的消息代理来连接微服务架构中的各个服务，可以将其用于广播状态更改（例如配置中心配置更改）或其他管理指令，本文将对其用法进行详细介绍。</p>
</blockquote>
<h2 id="Spring-Cloud-Bus-简介"><a href="#Spring-Cloud-Bus-简介" class="headerlink" title="Spring Cloud Bus 简介"></a>Spring Cloud Bus 简介</h2><p>我们通常会使用消息代理来构建一个主题，然后把微服务架构中的所有服务都连接到这个主题上去，当我们向该主题发送消息时，所有订阅该主题的服务都会收到消息并进行消费。使用 Spring Cloud Bus 可以方便地构建起这套机制，所以 Spring Cloud Bus 又被称为消息总线。Spring Cloud Bus 配合 Spring Cloud Config 使用可以实现配置的动态刷新。目前  Spring Cloud Bus  支持两种消息代理：RabbitMQ 和 Kafka，下面以 RabbitMQ 为例来演示下使用Spring Cloud Bus  动态刷新配置的功能。</p>
<p><strong>安装RabbitMQ</strong></p>
<h2 id="动态刷新配置"><a href="#动态刷新配置" class="headerlink" title="动态刷新配置"></a>动态刷新配置</h2><blockquote>
<p>使用 Spring Cloud Bus 动态刷新配置需要配合 Spring Cloud Config 一起使用 在demo-config-server上操作</p>
</blockquote>
<h2 id="给demo-config-server添加消息总线支持"><a href="#给demo-config-server添加消息总线支持" class="headerlink" title="给demo-config-server添加消息总线支持"></a>给demo-config-server添加消息总线支持</h2><ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>添加配置文件application-amqp.yml，主要是添加了RabbitMQ的配置及暴露了刷新配置的Actuator端点；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8901</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span> <span class="comment">#配置存储配置信息的Git仓库</span></span><br><span class="line">          <span class="attr">uri:</span> </span><br><span class="line">          <span class="attr">username:</span> </span><br><span class="line">          <span class="attr">password:</span> </span><br><span class="line">          <span class="attr">clone-on-start:</span> <span class="literal">true</span> <span class="comment">#开启启动时直接从git获取配置</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span> <span class="comment">#配置文件分支</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">&#x27;&#123;application&#125;&#x27;</span>  <span class="comment">#配置文件所在根目录</span></span><br><span class="line">  <span class="comment"># 添加rabbitmq的配置</span></span><br><span class="line">  <span class="attr">rabbitmq:</span> <span class="comment">#rabbitmq相关配置</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"><span class="comment"># 暴露bus刷新配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span> <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        <span class="comment">#include: &#x27;bus-refresh&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="给config-client添加消息总线支持"><a href="#给config-client添加消息总线支持" class="headerlink" title="给config-client添加消息总线支持"></a>给config-client添加消息总线支持</h2><ul>
<li>在pom.xml中添加相关依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">NaN</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">NaN</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">NaN</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">NaN</span></span><br></pre></td></tr></table></figure>

<ul>
<li>bootstrap.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span> <span class="comment">#Config客户端配置</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#启用配置后缀名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-single-client</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="comment"># 集群配置</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">demo-config-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动所有服务后 </li>
</ul>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/3.png"></p>
<ul>
<li>我们登录RabbitMQ的控制台可以发现Spring Cloud Bus 创建了一个叫springCloudBus的交换机及三个以 springCloudBus.anonymous开头的队列： </li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/4.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/5.png" style="zoom:50%;" />

<ul>
<li>修改github配置信息</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/6.png" style="zoom: 67%;" />

<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/12.png"></p>
<ul>
<li>访问config-server</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/7.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/8.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/config/9.png" style="zoom:50%;" />

<h2 id="配合WebHooks使用"><a href="#配合WebHooks使用" class="headerlink" title="配合WebHooks使用"></a>配合WebHooks使用</h2><p>WebHooks相当于是一个钩子函数，我们可以配置当向Git仓库push代码时触发这个钩子函数，这里以Gitee为例来介绍下其使用方式，这里当我们向配置仓库push代码时就会自动刷新服务配置了。</p>
<p><img src="http://www.macrozheng.com/images/springcloud_config_12.png" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(feign)%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(feign)%E7%BB%83%E4%B9%A0/" itemprop="url">Spring-SpringCloud(feign)练习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T14:20:00+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="创建demo-consumer-feign模块"><a href="#创建demo-consumer-feign模块" class="headerlink" title="创建demo-consumer-feign模块"></a>创建demo-consumer-feign模块</h1><h2 id="POM文件"><a href="#POM文件" class="headerlink" title="POM文件"></a>POM文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="yml中配置"><a href="#yml中配置" class="headerlink" title="yml中配置"></a>yml中配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">log4j,wall,mergeStat</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-service-consumer-feign</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7203</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mappers/*.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:com/**/mappers/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">#在Feign中开启Hystrix</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:logback-spring.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">user-service:</span> <span class="string">http://demo-service-provider</span></span><br></pre></td></tr></table></figure>

<h2 id="在启动类上添加-EnableFeignClients注解来启用Feign的客户端功能"><a href="#在启动类上添加-EnableFeignClients注解来启用Feign的客户端功能" class="headerlink" title="在启动类上添加@EnableFeignClients注解来启用Feign的客户端功能"></a>在启动类上添加@EnableFeignClients注解来启用Feign的客户端功能</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> DemoConsumerFeignApplication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConsumerFeignApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoConsumerFeignApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加UserService接口完成对demo-service-provider服务的接口-controller-绑定"><a href="#添加UserService接口完成对demo-service-provider服务的接口-controller-绑定" class="headerlink" title="添加UserService接口完成对demo-service-provider服务的接口(controller)绑定"></a>添加UserService接口完成对demo-service-provider服务的接口(controller)绑定</h2><blockquote>
<p>我们通过@FeignClient注解实现了一个Feign客户端，其中的value为user-service表示这是对user-service服务的接口调用客户端。我们可以回想下user-service中的UserController，只需将其改为接口，保留原来的SpringMvc注释即可。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> 添加UserService接口完成对demo-service-provider服务的接口绑定</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;demo-service-provider&quot;,</span></span><br><span class="line"><span class="meta">        primary = true,</span></span><br><span class="line"><span class="meta">        configuration = FeignConfig.class,</span></span><br><span class="line"><span class="meta">        path = &quot;/user&quot;,</span></span><br><span class="line"><span class="meta">        fallback = UserFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中create方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:52 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getUser方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:54 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getByUsername方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getByUsername&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getByUsername</span><span class="params">(<span class="meta">@RequestParam</span> String username)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中update方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse <span class="title">update</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中delete方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:56 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse <span class="title">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注解”-FeignClient-primary-true-”的作用"><a href="#注解”-FeignClient-primary-true-”的作用" class="headerlink" title="注解”@FeignClient(primary = true)”的作用"></a>注解”@FeignClient(primary = true)”的作用</h3><blockquote>
<p>表明接口实现类是哪个,如果上面的primary设为false，下面注释开放，则会执行下面的方法（<strong>如果你能设计比Feign还好的实现类可以这样做</strong>）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Service</span></span><br><span class="line"><span class="comment">//@Primary</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:52 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:54 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义远程调用方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:56 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">delete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡演示："><a href="#负载均衡演示：" class="headerlink" title="负载均衡演示："></a>负载均衡演示：</h2><blockquote>
<p>启动 eureka-server1、eureka-server2、demo-service-provider、demo-service-provider、demo-service-consumer-feign</p>
</blockquote>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign1.png"></p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign2.png" style="zoom:50%;" />

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign3.png" style="zoom: 50%;" />

<h2 id="feign中的服务降级"><a href="#feign中的服务降级" class="headerlink" title="feign中的服务降级"></a>feign中的服务降级</h2><blockquote>
<p>Feign中的服务降级使用起来非常方便，只需要为Feign客户端定义的接口添加一个服务降级处理的实现类即可，下面我们为UserService接口添加一个服务降级实现类。</p>
</blockquote>
<h3 id="添加服务降级实现类UserFallbackService"><a href="#添加服务降级实现类UserFallbackService" class="headerlink" title="添加服务降级实现类UserFallbackService"></a>添加服务降级实现类UserFallbackService</h3><blockquote>
<p>需要注意的是它实现了UserService接口，并且对接口中的每个实现方法进行了服务降级逻辑的实现。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserFallbackService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 服务降级</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFallbackService</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中create方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:52 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getUser方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:54 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">2L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.consumer.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中getByUsername方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">3L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中update方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:55 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.failed(<span class="string">&quot;调用失败，进入服务降级方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 调用provider的controller中delete方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 8:56 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">delete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.failed(<span class="string">&quot;调用失败，进入服务降级方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改UserService接口，设置服务降级处理类为UserFallbackService"><a href="#修改UserService接口，设置服务降级处理类为UserFallbackService" class="headerlink" title="修改UserService接口，设置服务降级处理类为UserFallbackService"></a>修改UserService接口，设置服务降级处理类为UserFallbackService</h3><blockquote>
<p>修改@FeignClient注解中的参数，设置fallback为UserFallbackService.class即可。</p>
</blockquote>
<p>添加<strong>fallback = UserFallbackService.class</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;demo-service-provider&quot;,</span></span><br><span class="line"><span class="meta">        primary = true,</span></span><br><span class="line"><span class="meta">        configuration = FeignConfig.class,</span></span><br><span class="line"><span class="meta">        path = &quot;/user&quot;,</span></span><br><span class="line"><span class="meta">        fallback = UserFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改application-yml，开启Hystrix功能"><a href="#修改application-yml，开启Hystrix功能" class="headerlink" title="修改application.yml，开启Hystrix功能"></a>修改application.yml，开启Hystrix功能</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#在Feign中开启Hystrix`</span></span><br></pre></td></tr></table></figure>

<h2 id="服务降级功能演示"><a href="#服务降级功能演示" class="headerlink" title="服务降级功能演示"></a>服务降级功能演示</h2><ul>
<li>关闭两个demo-service-provider服务，重新启动demo-service-consumer-feign;</li>
<li>调用<a target="_blank" rel="noopener" href="http://localhost:8701/user/1%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E8%BF%94%E5%9B%9E%E4%BA%86%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E4%BF%A1%E6%81%AF%E3%80%82">http://localhost:8701/user/1进行测试，可以发现返回了服务降级信息。</a></li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign4.png" style="zoom:50%;" />

<h1 id="日志打印功能"><a href="#日志打印功能" class="headerlink" title="日志打印功能"></a>日志打印功能</h1><h2 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h2><ul>
<li>NONE：默认的，不显示任何日志；</li>
<li>BASIC：仅记录请求方法、URL、响应状态码及执行时间；</li>
<li>HEADERS：除了BASIC中定义的信息之外，还有请求和响应的头信息；</li>
<li>FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。</li>
</ul>
<h2 id="通过配置开启更为详细的日志"><a href="#通过配置开启更为详细的日志" class="headerlink" title="通过配置开启更为详细的日志"></a>通过配置开启更为详细的日志</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在application-yml中配置需要开启日志的Feign客户端"><a href="#在application-yml中配置需要开启日志的Feign客户端" class="headerlink" title="在application.yml中配置需要开启日志的Feign客户端"></a>在application.yml中配置需要开启日志的Feign客户端</h2><blockquote>
<p>配置UserService的日志级别为debug。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.macro.cloud.service.UserService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p><em>注：</em> 不能与自己的logback-spring.xml同时存在，需删除logback-spring.xml</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign5.png"></p>
<h1 id="Feign-继承特性"><a href="#Feign-继承特性" class="headerlink" title="Feign 继承特性"></a>Feign 继承特性</h1><blockquote>
<p>Feign 的继承特性可以让服务的接口定义单独抽出来，作为公共的依赖，以方便使用。</p>
</blockquote>
<h2 id="1-创建一个-Maven-项目-demo-feign-inherit-api，用于存放-API-接口的定义，增加-Feign-的依赖，代码如下所示。"><a href="#1-创建一个-Maven-项目-demo-feign-inherit-api，用于存放-API-接口的定义，增加-Feign-的依赖，代码如下所示。" class="headerlink" title="1.创建一个 Maven 项目 demo_feign_inherit_api，用于存放 API 接口的定义，增加 Feign 的依赖，代码如下所示。"></a>1.创建一个 Maven 项目 demo_feign_inherit_api，用于存放 API 接口的定义，增加 Feign 的依赖，代码如下所示。</h2><ul>
<li>POM依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建服务提供者的接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserFeignApis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 调用provide的接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProvideFeignApis</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> feign调用接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 16:35 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.api.user.vo.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="keyword">long</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>vo看需求添加</em></p>
<h2 id="2-创建demo-feign-inherit-provide-项目引入-demo-feign-inherit-api项目"><a href="#2-创建demo-feign-inherit-provide-项目引入-demo-feign-inherit-api项目" class="headerlink" title="2.创建demo_feign_inherit_provide 项目引入 demo_feign_inherit_api项目"></a>2.创建demo_feign_inherit_provide 项目引入 demo_feign_inherit_api项目</h2><ul>
<li>pom 文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nexus.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo-feign-inherit-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>yml文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">log4j,wall,mergeStat</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-feign-inherit-provide</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7103</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mappers/*.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:com/**/mappers/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:logback-spring.xml</span></span><br></pre></td></tr></table></figure>

<ul>
<li>model</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> User</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> userService.getUserById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>IUserService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> IUserService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 15:14 2020/6/30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.provide.model.User&gt;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="function">ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>UserServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span> UserServiceImpl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> //TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiYuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.nexus.cloud.common.api.ServerResponse&lt;com.nexus.cloud.demo.provide.model.User&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> LiYuan</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> //TODO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span> 15:14 2020/6/30</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        User user;</span><br><span class="line">        <span class="keyword">if</span>(id&gt;<span class="number">1</span>)&#123;</span><br><span class="line">            user = <span class="keyword">new</span> User(<span class="number">1L</span>,<span class="string">&quot;teacher&quot;</span>,<span class="string">&quot;feign-inherit-provide&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            user = <span class="keyword">new</span> User(<span class="number">2L</span>,<span class="string">&quot;student&quot;</span>,<span class="string">&quot;feign-inherit-provide&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;根据id获取用户信息，用户名称为：&#123;&#125;&quot;</span>,user.getUsername());</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-创建demo-feign-inherit-consume-引入-demo-feign-inherit-api"><a href="#3-创建demo-feign-inherit-consume-引入-demo-feign-inherit-api" class="headerlink" title="3.创建demo_feign_inherit_consume 引入 demo_feign_inherit_api"></a>3.创建demo_feign_inherit_consume 引入 demo_feign_inherit_api</h2><ul>
<li>pom</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nexus.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo-feign-inherit-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mall?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">12345</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">log4j,wall,mergeStat</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-feign-inherit-consume</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7204</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mappers/*.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:com/**/mappers/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#在Feign中开启Hystrix</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对请求进行GZIP压缩</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/xml,application/xml,application/json</span> <span class="comment">#指定压缩的请求数据类型</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span> <span class="comment">#超过该大小的请求会被压缩</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对响应进行GZIP压缩</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:logback-spring.xml</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建apis包用于存放将要调用的接口，新建ProvideFeignApi继承demo_feign_inherit_api项目下的ProvideFeignApis</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @className UserFeignApi</span><br><span class="line"> * @description &#x2F;&#x2F;TODO</span><br><span class="line"> * @author LiYuan</span><br><span class="line"> * @date 2020&#x2F;6&#x2F;30</span><br><span class="line">**&#x2F;</span><br><span class="line">@FeignClient(name &#x3D; &quot;demo-feign-inherit-provide&quot;)</span><br><span class="line">public interface ProvideFeignApi extends ProvideFeignApis &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller，正常调用自己的service</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;&#x2F;consume&quot;)</span><br><span class="line">public class ConsumeController &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private IConsumeService consumeService;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @Author LiYuan</span><br><span class="line">     * @Description &#x2F;&#x2F;TODO</span><br><span class="line">     * @Date 16:25 2020&#x2F;6&#x2F;30</span><br><span class="line">     * @param</span><br><span class="line">     * @return com.nexus.cloud.common.api.ServerResponse</span><br><span class="line">    **&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;&#123;id&#125;&quot;)</span><br><span class="line">    public ServerResponse ConsumeController(@PathVariable(&quot;id&quot;) long id)&#123;</span><br><span class="line">        return consumeService.consumeService(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>IConsumeService</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public interface IConsumeService &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @Author LiYuan</span><br><span class="line">     * @Description &#x2F;&#x2F;TODO</span><br><span class="line">     * @Date 16:07 2020&#x2F;6&#x2F;30</span><br><span class="line">     * @param id</span><br><span class="line">     * @return com.nexus.cloud.common.api.ServerResponse</span><br><span class="line">    **&#x2F;</span><br><span class="line">    ServerResponse consumeService(long id);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ConsumeServiceImpl，注入ProvideFeignApi实现接口调用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class ConsumeServiceImpl implements IConsumeService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ProvideFeignApi provideFeignApi;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @param id</span><br><span class="line">     * @return com.nexus.cloud.common.api.ServerResponse</span><br><span class="line">     * @Author LiYuan</span><br><span class="line">     * @Description &#x2F;&#x2F;TODO</span><br><span class="line">     * @Date 16:07 2020&#x2F;6&#x2F;30</span><br><span class="line">     **&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public ServerResponse consumeService(long id) &#123;</span><br><span class="line">        ServerResponse&lt;User&gt; result &#x3D; provideFeignApi.getUserById(id);</span><br><span class="line">        User user &#x3D; result.getData();</span><br><span class="line">        log.info(&quot;根据id获取用户信息，用户名称为：&#123;&#125;&quot;,user.getUsername());</span><br><span class="line">        return ServerResponse.success(user.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/feign6.png" style="zoom:50%;" />

<h1 id="多参数请求构造"><a href="#多参数请求构造" class="headerlink" title="多参数请求构造"></a>多参数请求构造</h1><p>多参数请求构造分为 GET 请求和 POST 请求两种方式</p>
<h2 id="GET-请求的多参数请求构造方式"><a href="#GET-请求的多参数请求构造方式" class="headerlink" title="GET 请求的多参数请求构造方式"></a>GET 请求的多参数请求构造方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/info&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">getUserInfo</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span>String name,<span class="meta">@RequestParam(&quot;age&quot;)</span><span class="keyword">int</span> age)</span></span>;</span><br></pre></td></tr></table></figure>

<p>另一种是通过 Map 来传递多个参数，参数数量可以动态改变</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/detail&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">getUserDetail</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; param)</span></span>;</span><br></pre></td></tr></table></figure>

<p>注： <code>Map 传递参数最大的问题是可以随意传参</code></p>
<h2 id="POST-请求多参数就定义一个参数类，通过-RequestBody-注解的方式来实现"><a href="#POST-请求多参数就定义一个参数类，通过-RequestBody-注解的方式来实现" class="headerlink" title="POST 请求多参数就定义一个参数类，通过 @RequestBody 注解的方式来实现"></a>POST 请求多参数就定义一个参数类，通过 @RequestBody 注解的方式来实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/user/add&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br></pre></td></tr></table></figure>

<p>实现类中也需要加上 @RequestBody 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> <span class="keyword">implements</span> <span class="title">UserRemoteClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user.getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(feign)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(feign)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(feign)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T13:58:02+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h1><h2 id="构建请求"><a href="#构建请求" class="headerlink" title="构建请求"></a>构建请求</h2><h3 id="集成Ribbon、Hystrix"><a href="#集成Ribbon、Hystrix" class="headerlink" title="集成Ribbon、Hystrix"></a>集成Ribbon、Hystrix</h3><ul>
<li>Ribbon：利用负载均衡策略选定目标机器</li>
<li>Hystrix：根据熔断器的开启状态，决定是否发起此次调用</li>
</ul>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>Feign通过代理接口进行远程调用，Feign中动态代理通过Feign.build返回的构造器来装配相关参数,然后调用ReflectFeign的newInstance方法创建</p>
<h3 id="Contract协议"><a href="#Contract协议" class="headerlink" title="Contract协议"></a>Contract协议</h3><p>contract协议会构造复杂的元数据对象MethodMetadata，这里面包含动态代理接口定义的所有特征</p>
<h2 id="发起调用"><a href="#发起调用" class="headerlink" title="发起调用"></a>发起调用</h2><h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>feign使用拦截器对request和response对象进行装饰</p>
<h3 id="发起请求"><a href="#发起请求" class="headerlink" title="发起请求"></a>发起请求</h3><ul>
<li>重试：Feign借助Ribbon的配置实现重试操作</li>
<li>降级：Feign接口在声明时可以指定Hystrix的降级策略实现类，如果达到Hystrix的判定标准，或得到了异常结果，将执行指定的降级逻辑。</li>
</ul>
<h2 id="FeignClient参数配置"><a href="#FeignClient参数配置" class="headerlink" title="@FeignClient参数配置"></a>@FeignClient参数配置</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yinjihuan/p/12159986.html">那天晚上和@FeignClient注解的深度交流</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;demo-service-provider&quot;,</span></span><br><span class="line"><span class="meta">        primary = true,</span></span><br><span class="line"><span class="meta">        configuration = FeignConfig.class,</span></span><br><span class="line"><span class="meta">        path = &quot;/user&quot;,</span></span><br><span class="line"><span class="meta">        fallback = UserFallbackService.class)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>value, name</strong>：value和name的作用一样，如果没有配置url那么配置的值将作为服务名称，用于服务发现</li>
<li><strong>contextId</strong>：<br>比如我们有个user服务，但user服务中有很多个接口，我们不想将所有的调用接口都定义在一个类中，比如：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;optimization-user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRemoteClient</span> </span>&#123;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/user/get&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;optimization-user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRemoteClient2</span> </span>&#123;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/user2/get&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种情况下启动就会报错了，因为Bean的名称冲突了，具体错误如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line">The bean &#39;optimization-user.FeignClientSpecification&#39;, defined in null, could not be registered. A bean with that name has already been defined in null and overriding is disabled.</span><br><span class="line">Action:</span><br><span class="line">Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding&#x3D;true</span><br></pre></td></tr></table></figure>

<p>解决方案可以增加下面的配置，作用是允许出现beanName一样的BeanDefinition。</p>
<p>另一种解决方案就是为每个Client手动指定不同的contextId，这样就不会冲突了。</p>
<blockquote>
<p>contextId在Feign Client的作用，在注册Feign Client Configuration的时候需要一个名称，名称是通过getClientName方法获取的。</p>
<p>如果配置了contextId就会用contextId，如果没有配置就会去value然后是name最后是serviceId。默认都没有配置，当出现一个服务有多个Feign Client的时候就会报错了</p>
<p>其次的作用是在注册FeignClient中，contextId会作为Client 别名的一部分，如果配置了qualifier优先用qualifier作为别名。</p>
</blockquote>
<ul>
<li><p><strong>url</strong>：url用于配置指定服务的地址，相当于直接请求这个服务，不经过Ribbon的服务选择。像调试等场景可以使用</p>
</li>
<li><p><strong>primary</strong>：primary对应的是@Primary注解，默认为true。当我们的Feign实现了fallback后，也就意味着Feign Client有多个相同的Bean在Spring容器中，当我们在使用@Autowired进行注入的时候，不知道注入哪个，所以我们需要设置一个优先级高的，@Primary注解就是干这件事情的。</p>
</li>
<li><p><strong>configuration</strong>：onfiguration是配置Feign配置类，在配置类中可以自定义Feign的Encoder、Decoder、LogLevel、Contract等</p>
</li>
<li><p><strong>path</strong>：path定义当前FeignClient访问接口时的统一前缀，比如接口地址是/user/get, 如果你定义了前缀是user, 那么具体方法上的路径就只需要写/get 即可。</p>
</li>
<li><p><strong>fallback</strong>：定义容错的处理类，也就是回退逻辑，fallback的类必须实现Feign Client的接口，无法知道熔断的异常信息</p>
</li>
<li><p><strong>qualifier</strong>：qualifier对应的是@Qualifier注解，可以配置一个qualifier，然后使用@Qualifier注解进行注入</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;optimization-user&quot;, path=&quot;user&quot;, qualifier=&quot;userRemoteClient&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRemoteClient</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> <span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;userRemoteClient&quot;)</span></span><br><span class="line"><span class="keyword">private</span> UserRemoteClient userRemoteClient;</span><br></pre></td></tr></table></figure>

<h2 id="Feign常用配置"><a href="#Feign常用配置" class="headerlink" title="Feign常用配置"></a>Feign常用配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#在Feign中开启Hystrix</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对请求进行GZIP压缩</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/xml,application/xml,application/json</span> <span class="comment">#指定压缩的请求数据类型</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span> <span class="comment">#超过该大小的请求会被压缩</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#是否对响应进行GZIP压缩</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="comment">#修改日志级别</span></span><br><span class="line">    <span class="attr">com.macro.cloud.service.UserService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7-%E8%B0%83%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7-%E8%B0%83%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3/" itemprop="url">项目工具-调用第三方接口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T01:33:40+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7-%E8%B0%83%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8E%A5%E5%8F%A3/" itemprop="url" rel="index">
                    <span itemprop="name">常用工具 - 调用第三方接口</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RestTemplate的使用"><a href="#RestTemplate的使用" class="headerlink" title="RestTemplate的使用"></a>RestTemplate的使用</h2><blockquote>
<p>RestTemplate是一个HTTP客户端，使用它我们可以方便的调用HTTP接口，支持GET、POST、PUT、DELETE等方法。</p>
</blockquote>
<h3 id="GET请求"><a href="#GET请求" class="headerlink" title="GET请求"></a>GET请求</h3><blockquote>
<p>获取数据结果可通过 RestTemplate 的 getForObject 方法（如下代码所示）来实现，此方法有三个重载的实现：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url：请求的 API 地址，有两种方式，其中一种是字符串，另一种是 URI 形式。</span><br><span class="line">responseType：返回值的类型。</span><br><span class="line">uriVariables：PathVariable 参数，有两种方式，其中一种是可变参数，另一种是 Map 形式。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>getForEntity 中可以获取返回的状态码、请求头等信息，通过 getBody 获取响应的内容。其余的和 getForObject 一样，也是有 3 个重载的实现。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;返回对象为响应体中数据转化成的对象</span><br><span class="line">&lt;T&gt; T getForObject(String url, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T getForObject(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T getForObject(URI url, Class&lt;T&gt; responseType);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;返回对象为ResponseEntity对象，包含了响应中的一些重要信息，比如响应头、响应状态码、响应体等，举例如下：</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; getForEntity(String url, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; getForEntity(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; getForEntity(URI var1, Class&lt;T&gt; responseType);</span><br></pre></td></tr></table></figure>

<h3 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; T postForObject(String url, @Nullable Object request, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T postForObject(String url, @Nullable Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; T postForObject(URI url, @Nullable Object request, Class&lt;T&gt; responseType);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; postForEntity(String url, @Nullable Object request, Class&lt;T&gt; responseType, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; postForEntity(String url, @Nullable Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; postForEntity(URI url, @Nullable Object request, Class&lt;T&gt; responseType);</span><br></pre></td></tr></table></figure>

<h3 id="PUT请求"><a href="#PUT请求" class="headerlink" title="PUT请求"></a>PUT请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void put(String url, @Nullable Object request, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">void put(String url, @Nullable Object request, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">void put(URI url, @Nullable Object request);</span><br></pre></td></tr></table></figure>

<h3 id="DELETE请求"><a href="#DELETE请求" class="headerlink" title="DELETE请求"></a>DELETE请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void delete(String url, Object... uriVariables);</span><br><span class="line"></span><br><span class="line">void delete(String url, Map&lt;String, ?&gt; uriVariables);</span><br><span class="line"></span><br><span class="line">void delete(URI url);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Ribbon)%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Ribbon)%E7%BB%83%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Ribbon)练习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T01:26:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud练习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-Cloud-Ribbon：负载均衡的服务调用"><a href="#Spring-Cloud-Ribbon：负载均衡的服务调用" class="headerlink" title="Spring Cloud Ribbon：负载均衡的服务调用"></a>Spring Cloud Ribbon：负载均衡的服务调用</h1><h2 id="改造demo-service-provider"><a href="#改造demo-service-provider" class="headerlink" title="改造demo-service-provider"></a>改造demo-service-provider</h2><h3 id="UserController添加对User对象常见的CRUD接口"><a href="#UserController添加对User对象常见的CRUD接口" class="headerlink" title="UserController添加对User对象常见的CRUD接口"></a>UserController添加对User对象常见的CRUD接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        userService.create(user);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(<span class="string">&quot;操作成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> </span>&#123;</span><br><span class="line">        User user = userService.getUser(id);</span><br><span class="line">        log.info(<span class="string">&quot;根据id获取用户信息，用户名称为：&#123;&#125;&quot;</span>,user.getUsername());</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getUserByIds&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ServerResponse&lt;List&lt;User&gt;&gt; getUserByIds(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids) &#123;</span><br><span class="line">        List&lt;User&gt; userList= userService.getUsersByIds(ids);</span><br><span class="line">        log.info(<span class="string">&quot;根据ids获取用户信息，用户列表为：&#123;&#125;&quot;</span>,userList);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(userList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getByUsername&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse&lt;User&gt; <span class="title">getByUsername</span><span class="params">(<span class="meta">@RequestParam</span> String username)</span> </span>&#123;</span><br><span class="line">        User user = userService.getUserByName(username);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">update</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        userService.update(user);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(<span class="string">&quot;操作成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> </span>&#123;</span><br><span class="line">        userService.delete(id);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(<span class="string">&quot;操作成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IUserService和UserServiceImpl中做简单实现"><a href="#IUserService和UserServiceImpl中做简单实现" class="headerlink" title="IUserService和UserServiceImpl中做简单实现"></a>IUserService和UserServiceImpl中做简单实现</h3><h2 id="改造demo-service-consumer"><a href="#改造demo-service-consumer" class="headerlink" title="改造demo-service-consumer"></a>改造demo-service-consumer</h2><h3 id="pom-xml中添加相关依赖"><a href="#pom-xml中添加相关依赖" class="headerlink" title="pom.xml中添加相关依赖"></a>pom.xml中添加相关依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="在application-yml中进行配置"><a href="#在application-yml中进行配置" class="headerlink" title="在application.yml中进行配置"></a>在application.yml中进行配置</h3><p>新增：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">user-service:</span> <span class="string">http://demo-service-provider</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-LoadBalanced注解赋予RestTemplate负载均衡的能力"><a href="#使用-LoadBalanced注解赋予RestTemplate负载均衡的能力" class="headerlink" title="使用@LoadBalanced注解赋予RestTemplate负载均衡的能力"></a>使用@LoadBalanced注解赋予RestTemplate负载均衡的能力</h3><blockquote>
<p>可以看出使用Ribbon的负载均衡功能非常简单，和直接使用RestTemplate没什么两样，只需给RestTemplate添加一个@LoadBalanced即可。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by macro on 2019/8/29.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改接口调用的代码，将 IP+PORT 改成服务名称，也就是注册到 Eureka 中的名称，代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/article/callHello2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">callHello2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://demo-service-provider/user/hello&quot;</span>, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加UserController用于提供调用接口"><a href="#添加UserController用于提供调用接口" class="headerlink" title="添加UserController用于提供调用接口"></a>添加UserController用于提供调用接口</h3><blockquote>
<p>注入RestTemplate，使用其调用user-service中提供的相关接口，这里对GET和POST调用进行了演示，其他方法调用均可参考。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userServiceUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">&quot;/user/&#123;1&#125;&quot;</span>, ServerResponse.class, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getByUsername&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getByUsername</span><span class="params">(<span class="meta">@RequestParam</span> String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">&quot;/user/getByUsername?username=&#123;1&#125;&quot;</span>, ServerResponse.class, username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getEntityByUsername&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getEntityByUsername</span><span class="params">(<span class="meta">@RequestParam</span> String username)</span> </span>&#123;</span><br><span class="line">        ResponseEntity&lt;ServerResponse&gt; entity = restTemplate.getForEntity(userServiceUrl + <span class="string">&quot;/user/getByUsername?username=&#123;1&#125;&quot;</span>, ServerResponse.class, username);</span><br><span class="line">        <span class="keyword">if</span> (entity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">            <span class="keyword">return</span> entity.getBody();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ServerResponse.failed(<span class="string">&quot;操作失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(userServiceUrl + <span class="string">&quot;/user/create&quot;</span>, user, ServerResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">update</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(userServiceUrl + <span class="string">&quot;/user/update&quot;</span>, user, ServerResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(userServiceUrl + <span class="string">&quot;/user/delete/&#123;1&#125;&quot;</span>, <span class="keyword">null</span>, ServerResponse.class, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/Ribbon1.png" alt="image" style="zoom:50%;" />

<h1 id="负载均衡测试"><a href="#负载均衡测试" class="headerlink" title="负载均衡测试"></a>负载均衡测试</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务列表</span></span><br><span class="line">List&lt;Server&gt; serverList = Lists.newArrayList(<span class="keyword">new</span> Server(<span class="string">&quot;localhost&quot;</span>, <span class="number">7101</span>), <span class="keyword">new</span> Server(<span class="string">&quot;localhost&quot;</span>, <span class="number">7102</span>));</span><br><span class="line"><span class="comment">// 构建负载实例</span></span><br><span class="line">ILoadBalancer loadBalancer = LoadBalancerBuilder.newBuilder().buildFixedServerListLoadBalancer(serverList);</span><br><span class="line"><span class="comment">// 调用 5 次来测试效果</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/Ribbon/test&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">        String result = LoadBalancerCommand.&lt;String&gt;builder().withLoadBalancer(loadBalancer).build()</span><br><span class="line">            .submit(server -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String addr = <span class="string">&quot;http://&quot;</span> + server.getHost() + <span class="string">&quot;:&quot;</span> + server.getPort() + <span class="string">&quot;/user/hello&quot;</span>;</span><br><span class="line">                    System.out.println(<span class="string">&quot; 调用地址：&quot;</span> + addr);</span><br><span class="line">                    URL url = <span class="keyword">new</span> URL(addr);</span><br><span class="line">                    HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">                    conn.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">                    conn.connect();</span><br><span class="line">                    InputStream in = conn.getInputStream();</span><br><span class="line">                    <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[in.available()];</span><br><span class="line">                    in.read(data);</span><br><span class="line">                    <span class="keyword">return</span> Observable.just(<span class="keyword">new</span> String(data));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Observable.error(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).toBlocking().first();</span><br><span class="line">        System.out.println(<span class="string">&quot; 调用结果：&quot;</span> + result);</span><br><span class="line">        System.out.println(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/Ribbon2.png" style="zoom:50%;" />

<h1 id="Ribbon-API-使用"><a href="#Ribbon-API-使用" class="headerlink" title="Ribbon API 使用"></a>Ribbon API 使用</h1><p>当你有一些特殊的需求，想通过 Ribbon 获取对应的服务信息时，可以使用 Load-Balancer Client 来获取，比如你想获取一个 ribbon-eureka-demo 服务的服务地址，可以通过 LoadBalancerClient 的 choose 方法来选择一个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LoadBalancerClient loadBalancer;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/choose&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">chooseUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ServiceInstance instance = loadBalancer.choose(<span class="string">&quot;ribbon-eureka-demo&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问接口，可以看到返回的信息如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    serviceId: &quot;ribbon-eureka-demo&quot;,</span><br><span class="line">    server: &#123;</span><br><span class="line">        host: &quot;localhost&quot;,</span><br><span class="line">        port: 8081,</span><br><span class="line">        id: &quot;localhost:8081&quot;,</span><br><span class="line">        zone: &quot;UNKNOWN&quot;,</span><br><span class="line">        readyToServe: true,</span><br><span class="line">        alive: true,</span><br><span class="line">        hostPort: &quot;localhost:8081&quot;,</span><br><span class="line">        metaInfo: &#123;</span><br><span class="line">            serverGroup: null,</span><br><span class="line">            serviceIdForDiscovery: null, instanceId: &quot;localhost:8081&quot;,</span><br><span class="line">            appName: null</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    secure: false, metadata: &#123; &#125;, host: &quot;localhost&quot;, port: 8081,</span><br><span class="line">    uri: &quot;http://localhost:8081&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(hystrix)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(hystrix)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Hystrix)练习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T01:26:08+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud练习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="服务雪崩"><a href="#服务雪崩" class="headerlink" title="服务雪崩"></a>服务雪崩</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9.png" style="zoom:67%;" />

<p>服务C超时，则会逐渐蔓延至服务B服务A，后台整个服务集群瘫痪。</p>
<h1 id="TomCat线程池耗尽"><a href="#TomCat线程池耗尽" class="headerlink" title="TomCat线程池耗尽"></a>TomCat线程池耗尽</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%80%97%E5%B0%BD.png" style="zoom:67%;" />

<p>假设服务A，B，C的请求频率相同，服务C响应时间过长，随着时间的推移，Tomcat中的线程会逐渐被C占据，直到挤满。</p>
<h1 id="生产故障"><a href="#生产故障" class="headerlink" title="生产故障"></a>生产故障</h1><ul>
<li>延迟</li>
<li>服务不可用</li>
</ul>
<h1 id="降低故障影响"><a href="#降低故障影响" class="headerlink" title="降低故障影响"></a>降低故障影响</h1><ul>
<li>隔离异常服务[降低串联影响（线程隔离）]</li>
<li>减压[快速失败（熔断）]</li>
<li>备选方案[最小可用性（降级）]</li>
</ul>
<h1 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h1><blockquote>
<p>假设服务出现出现异常，导致响应超时，那么搜有依赖他的下游系统的响应时间都会被拉长，会引发雪崩效应，有最上游的的系统问题，引发了一系列下游系统响应超时，最终导致整个系统被拖垮。</p>
</blockquote>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E9%99%8D%E7%BA%A7.png" style="zoom:50%;" />

<p>假如Hystrix调用目标请求的时候发生异常，这时Hystrix会自动把这个请求转发到降级逻辑中，由服务调用方来编写异常处理逻辑。</p>
<p>对响应超时的场景，可以通过配置Hystrix的超时等待时间（Ribbon的timeout是两个不同配置），把超时响应的服务调用也当作是异常情况，转发到fallback逻辑中进行处理</p>
<h2 id="HystrixCommand原理"><a href="#HystrixCommand原理" class="headerlink" title="@HystrixCommand原理"></a>@HystrixCommand原理</h2><h3 id="HystrixCommand参数"><a href="#HystrixCommand参数" class="headerlink" title="@HystrixCommand参数"></a>@HystrixCommand参数</h3><p><strong>常用参数</strong>:</p>
<ul>
<li>fallbackMethod：指定服务降级处理方法；</li>
<li>ignoreExceptions：忽略某些异常，不发生服务降级；</li>
<li>commandKey：命令名称，用于区分不同的命令；</li>
<li>groupKey：分组名称，Hystrix会根据不同的分组来统计命令的告警及仪表盘信息；</li>
<li>threadPoolKey：线程池名称，用于划分线程池。</li>
</ul>
<h3 id="HystrixCommand实现降级"><a href="#HystrixCommand实现降级" class="headerlink" title="@HystrixCommand实现降级"></a>@HystrixCommand实现降级</h3><p>注解中指定<code>fallbackMethod</code>，需要注意降级方法的参数列表需要和原方法的保持一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userServiceUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;getDefaultUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getUser</span><span class="params">(Long  id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">&quot;/user/&#123;1&#125;&quot;</span>, ServerResponse.class, id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getDefaultUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">&quot;defaultUser&quot;</span>, <span class="string">&quot;进入服务降级方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.success(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结合Feign实现降级"><a href="#结合Feign实现降级" class="headerlink" title="结合Feign实现降级"></a>结合Feign实现降级</h3><p>Hystrix Feign共同使用，还有一种配置方式，那就是FeignClient注解中指定一个class，再class里可以处理Feign接口中声明的所有方法的降级需求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;feign-service-provider&quot;, fallback = Fallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyHelloService</span> <span class="keyword">extends</span> <span class="title">HelloService</span> </span>&#123;    </span><br><span class="line">    <span class="comment">//方法1</span></span><br><span class="line">   	<span class="comment">//方法2</span></span><br><span class="line">    <span class="comment">//……</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fallback</span> <span class="keyword">implements</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">    <span class="comment">//方法1降级处理</span></span><br><span class="line">   	<span class="comment">//方法2降级处理</span></span><br><span class="line">    <span class="comment">//……降级处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="HystrixCommand执行逻辑"><a href="#HystrixCommand执行逻辑" class="headerlink" title="@HystrixCommand执行逻辑"></a>@HystrixCommand执行逻辑</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/hystrix.png" style="zoom:50%;" />

<ul>
<li><p>@HysrixCommand： 安插在方法上，标识此方法由Hystrix监管。</p>
</li>
<li><p>AspectJ：运用Spring的切面能力，给带有@HystrixCommand注解的方法配置了切面</p>
</li>
<li><p>Request Cache：</p>
<ul>
<li>开启，尝试从缓存中获取数据，也就不用发起方法调用了。</li>
<li>关闭，执行注册Observer</li>
</ul>
</li>
<li><p>注册Observer：运用RxJava注册了异步回调函数，当方法正常执行、异常抛出、结束或其他状态的时候，将会触发对应的回调函数进行处理</p>
</li>
<li><p>发起调用： 在发起调用之前，将会检查熔断状态，如果短路器当前处于开启的状态，那么将直接走向fallback流程。如果断路器处于关闭状态，则发起真正的调用</p>
</li>
<li><p>异常：异常触发了注册的回调函数，然后直接转给了降级方法</p>
</li>
</ul>
<h2 id="服务降级常用方案"><a href="#服务降级常用方案" class="headerlink" title="服务降级常用方案"></a>服务降级常用方案</h2><ul>
<li><p>静默处理：在fallback中返回null，（try catch不能做超时判定。其次使用try catch就要在代码里包含异常处理块。）</p>
</li>
<li><p>默认值：返回默认值，如非核心链路中，商品优惠价格服务发生故障返回商品价格原价</p>
</li>
<li><p>进行补偿处理：</p>
<ul>
<li>缓存异常：假如因为缓存故障无法获取数据，在fallback逻辑中可以转而访问底层数据库。反过来如果数据库发生故障，也可以在fallback里访问缓存，但要注意数据一致性</li>
<li>切换备库：一般大型应用会采用+备库的方式做灾备。假如我们的主从库都发生了故障，往往需要人工将数据库源切换到备份数据库，我们在fallback中可以先人工干预之前自动访问备份数据。这个场景尽量限定在核心主链路接口上，不要动不动就去访问备库，以免造成脏读幻读</li>
<li>重试：Ribbon可以处理超时重试，但对于异常情况来说，我们可以在fallback中自己尝试重新发起接口调用</li>
<li>人工干预：有些极其重要的接口，对异常不饿能容忍，这里可以借助fallback启动人工干预流程 ，比如做日志打点，通过监控组件触发报警，通知人工介入</li>
</ul>
</li>
</ul>
<h2 id="Hystrix实现Timeout降级"><a href="#Hystrix实现Timeout降级" class="headerlink" title="Hystrix实现Timeout降级"></a>Hystrix实现Timeout降级</h2><h3 id="全局yml配置"><a href="#全局yml配置" class="headerlink" title="全局yml配置"></a>全局yml配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span> <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">timeout:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand的执行是否启用超时时间</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">2000</span> <span class="comment">#配置HystrixCommand执行的超时时间，执行超过该时间会进行服务降级处理</span></span><br><span class="line">            <span class="attr">interruptOnTimeout:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行超时的时候是否要中断</span></span><br><span class="line">            <span class="attr">interruptOnFutureCancel:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行被取消的时候是否要中断</span></span><br></pre></td></tr></table></figure>

<h2 id="多级降级"><a href="#多级降级" class="headerlink" title="多级降级"></a>多级降级</h2><p>降级处理方法仍可以继续指定降级处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fallback</span> <span class="keyword">implements</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;fallback2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">error</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Fallback: I&#x27;m not a black sheep any more&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;first fallback&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;fallback3&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fallback2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;fallback again&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;fallback again&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fallback3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;fallback again and again&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h1><blockquote>
<p>服务熔断是建立在服务降级之上的一个异常处理措施，服务降级需要等待HTTP请求从服务节点返回异常或超时，在转向fallback</p>
</blockquote>
<p>服务熔断引入“熔断器”机制，当熔断器打开的时候，对服务的调用请求不会发送到目标服务节点，而是直接转向fallback逻辑</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%86%94%E6%96%AD.png" style="zoom:50%;" />

<h2 id="熔断配置"><a href="#熔断配置" class="headerlink" title="熔断配置"></a>熔断配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 核心配置</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span></span><br><span class="line">      	<span class="comment"># 熔断的前提条件（请求的数量），在一定的时间窗口内，请求达到5个以后，才开始进行熔断判断</span></span><br><span class="line">        <span class="attr">requestVolumeThreshold:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment"># 超过50%的失败请求，则熔断开关开启</span></span><br><span class="line">        <span class="attr">errorThresholdPercentage:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment"># 当熔断开启以后，经过多少秒再进入半开状态</span></span><br><span class="line">		<span class="attr">sleepWindowInMilliseconds:</span> <span class="number">15000</span></span><br><span class="line">		<span class="comment"># 配置时间窗口</span></span><br><span class="line">		<span class="attr">timeInMilliseconds:</span> <span class="number">20000</span></span><br><span class="line"><span class="comment"># 辅助配置</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span></span><br><span class="line">        <span class="comment"># 熔断功能打开</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 强制开启熔断开关</span></span><br><span class="line">        <span class="attr">forceOpen:</span> <span class="literal">false</span></span><br><span class="line">        <span class="comment"># 强制关闭熔断开关</span></span><br><span class="line">        <span class="attr">forceClosed:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="熔断原理"><a href="#熔断原理" class="headerlink" title="熔断原理"></a>熔断原理</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%86%94%E6%96%AD%E5%8E%9F%E7%90%86.png" style="zoom:50%;" />

<ul>
<li>发起调用，切面拦截：在向<code>@HystrixCommand</code>注解修饰的方法调用时，将会触发由Aspect切面逻辑</li>
<li>检查熔断器：当熔断状态开启的时候，直接进入fallback，不执行远程调用</li>
<li>发起远程调用-异常：进入回调函数</li>
<li>计算Metrics（衡量指标），如果达到熔断标准，则开启断路开关，后续的请求直接进入fallback流程</li>
</ul>
<h2 id="熔断器三个状态"><a href="#熔断器三个状态" class="headerlink" title="熔断器三个状态"></a>熔断器三个状态</h2><p>1、open：服务在一定时间内不得发起外部调用</p>
<p>2、half-open：如果降级时间过长，可以尝试发起真实的服务调用，但这一切都是在监控下进行</p>
<p>3、closed：half-open状态下调用成功了，熔断器可以关闭</p>
<h2 id="熔断器的判断阀值"><a href="#熔断器的判断阀值" class="headerlink" title="熔断器的判断阀值"></a>熔断器的判断阀值</h2><p>1、在一定时间窗口内，发生异常的请求数量达到临界值<br>2、在一定时间窗口内，发生异常的请求数量占请求总数量达到一定比例</p>
<h1 id="线程隔离"><a href="#线程隔离" class="headerlink" title="线程隔离"></a>线程隔离</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB.png" style="zoom:50%;" />

<p>web容器通常用线程池来接待来访请求，如果并发量过高，线程池被打满，就会影响后面请求的响应。    </p>
<p>Hystrix通过线程隔离的方案，将执行服务调用的代码与容器本身的线程池（如tomcat thread pool）进行隔离，配置每个服务所需线程的最大数量。这样即便一个服务的线程池被吃满，也不会影响其他服务    </p>
<p>与线程隔离类似还有一个“信号量”的方案    </p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/hystrix/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%E5%8E%9F%E7%90%86.png" style="zoom:50%;" />

<p><strong>线程池拒绝</strong>：由线程隔离机制直接负责，假如当前商品服务分配了10个线程，那么当线程池已经饱和的时候，可以拒绝服务，调用请求会接受到Thread Pool Rejects，转到fallback逻辑，由多个参数共同控制：</p>
<ul>
<li>coreSize：核心线程数</li>
<li>maximumSize：设置最大允许的线程数，需要打allowMaximumSizeToDivergeFromCoreSize才生效</li>
<li>queueSizeRejectionThreshould：控制队列最大阈值，Hystix默认设置5，即便把maximumSize该打，因为线程队列阈值的约束，程序依然无法承载很多并发量，当改大线程池时，需要这两个属性一同增大。</li>
<li> keepAliveTimeMinutes:这个属性与线程回收有关。当线程空闲时间，多余线程会被后手，此属性指定线程被回收前存活时间，默认2分钟。</li>
</ul>
<p><strong>线程Timeout</strong>：调用失败和延迟也可能发生在远程调用之前（比如一次超长FullGC导致的超时，或者方法只是一个本地业务计算，并不会调用外部方法。），此方法调用过程中发生超时，产生Thread Timeout，调用请求被流转到fallback</p>
<p><strong>服务异常、超时</strong>：就是服务降级</p>
<h2 id="隔离方式"><a href="#隔离方式" class="headerlink" title="隔离方式"></a>隔离方式</h2><ul>
<li>线程池技术（默认）</li>
<li>信号量技术</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换信号量</span></span><br><span class="line"><span class="meta">execution.isolation.strategy</span> = <span class="string">ExecutionIsolationStrategy.SEMAPHORE</span></span><br></pre></td></tr></table></figure>

<h2 id="线程隔离方式VS信号量隔离方式"><a href="#线程隔离方式VS信号量隔离方式" class="headerlink" title="线程隔离方式VS信号量隔离方式"></a>线程隔离方式VS信号量隔离方式</h2><p><strong>原理</strong>   </p>
<p>线程池技术： 使用Hystrix内建的线程池去执行方法调用，而不是Tomcat的容器线程</p>
<p>信号量技术：直接使用Tomcat的容器线程去执行方法，不会另外创建新的线程，信号量只充当开关和计数器的作用。获取信号量的线程可以执行方法，没有获取到的就转到fallback</p>
<p><strong>性能角度</strong>    </p>
<p>线程池技术：涉及到线程的创建、销毁和任务调度，而且CPU在执行多线程任务的时候会在不同线程之间做切换，操作系统层面cpu线程切换是一个相对耗时的操作，因此从资源利用率和效率的角度看，线程池技术比信号量慢</p>
<p>信号量技术：直接使用tomcat容器线程去访问方法，信号量只是充当一个计数器的作用，没有额外的系统资源消费，所有在性能方面有明显的优势</p>
<p><strong>超时判断</strong>    </p>
<p>线程池技术：相当于多了一层保护机制（Hystrix自建线程），可以直接进行超时判断<br>信号量技术：只能等待诸如网络请求超时等“被动超时”的情况</p>
<p><strong>使用场景：</strong>    </p>
<p>信号量适合在超高并发的非外部接口调用，其他场景尽量使用线程隔离</p>
<h1 id="请求缓存"><a href="#请求缓存" class="headerlink" title="请求缓存"></a>请求缓存</h1><h2 id="相关注解"><a href="#相关注解" class="headerlink" title="相关注解"></a>相关注解</h2><ul>
<li>@CacheResult：开启缓存，默认所有参数作为缓存的key，cacheKeyMethod可以通过返回String类型的方法指定key；</li>
<li>@CacheKey：指定缓存的key，可以指定参数或指定参数中的属性值为缓存key，cacheKeyMethod还可以通过返回String类型的方法指定；</li>
<li>@CacheRemove：移除缓存，需要指定commandKey。</li>
</ul>
<h2 id="注意问题"><a href="#注意问题" class="headerlink" title="注意问题"></a>注意问题</h2><p><strong>在缓存使用过程中，我们需要在每次使用缓存的请求前后对HystrixRequestContext进行初始化和关闭，否则会出现如下异常</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Request caching is not available. Maybe you need to initialize the HystrixRequestContext?</span><br><span class="line">    at com.netflix.hystrix.HystrixRequestCache.get(HystrixRequestCache.java:104) ~[hystrix-core-1.5.18.jar:1.5.18]</span><br><span class="line">    at com.netflix.hystrix.AbstractCommand$7.call(AbstractCommand.java:478) ~[hystrix-core-1.5.18.jar:1.5.18]</span><br><span class="line">    at com.netflix.hystrix.AbstractCommand$7.call(AbstractCommand.java:454) ~[hystrix-core-1.5.18.jar:1.5.18]</span><br></pre></td></tr></table></figure>

<p><strong>这里我们通过使用过滤器，在每个请求前后初始化和关闭HystrixRequestContext来解决该问题：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/*&quot;,asyncSupported = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixRequestContextFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            context.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用请求缓存"><a href="#使用请求缓存" class="headerlink" title="使用请求缓存"></a>使用请求缓存</h2><ul>
<li>在UserService中添加具有缓存功能的getUserCache方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheResult(cacheKeyMethod = &quot;getCacheKey&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;getDefaultUser&quot;, commandKey = &quot;getUserCache&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServerResponse <span class="title">getUserCache</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;getUserCache id:&#123;&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">&quot;/user/&#123;1&#125;&quot;</span>, ServerResponse.class, id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为缓存生成key的方法，对应cacheKeyMethod = &quot;getCacheKey&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCacheKey</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * key只能是String类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CacheResult</span></span><br><span class="line"><span class="meta">@HystrixCommand(commandKey = &quot;cacheKey&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Friend <span class="title">requestCache</span><span class="params">(<span class="meta">@CacheKey</span> String name)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;request cache &quot;</span> + name);</span><br><span class="line">    Friend friend = <span class="keyword">new</span> Friend();</span><br><span class="line">    friend.setName(name);</span><br><span class="line">    friend = service.sayHiPost(friend);</span><br><span class="line">    log.info(<span class="string">&quot;after requesting cache &quot;</span> + name);</span><br><span class="line">    <span class="keyword">return</span> friend;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="移除缓存"><a href="#移除缓存" class="headerlink" title="移除缓存"></a>移除缓存</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheRemove(commandKey = &quot;getUserCache&quot;, cacheKeyMethod = &quot;getCacheKey&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServerResponse <span class="title">removeCache</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;removeCache id:&#123;&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">return</span> restTemplate.postForObject(userServiceUrl + <span class="string">&quot;/user/delete/&#123;1&#125;&quot;</span>, <span class="keyword">null</span>, ServerResponse.class, id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCacheKey</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="请求合并"><a href="#请求合并" class="headerlink" title="请求合并"></a>请求合并</h1><blockquote>
<p>微服务系统中的服务间通信，需要通过远程调用来实现，随着调用次数越来越多，占用线程资源也会越来越多。Hystrix中提供了@HystrixCollapser用于合并请求，从而达到减少通信消耗及线程数量的效果。</p>
</blockquote>
<p>@HystrixCollapser的常用属性</p>
<ul>
<li>batchMethod：用于设置请求合并的方法；</li>
<li>collapserProperties：请求合并属性，用于控制实例属性，有很多；</li>
<li>timerDelayInMilliseconds：collapserProperties中的属性，用于控制每隔多少时间合并一次请求；</li>
</ul>
<h1 id="Hystrix全局配置"><a href="#Hystrix全局配置" class="headerlink" title="Hystrix全局配置"></a>Hystrix全局配置</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCommand的行为</span></span><br><span class="line">  <span class="attr">command:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">THREAD</span> <span class="comment">#控制HystrixCommand的隔离策略，THREAD-&gt;线程池隔离策略(默认)，SEMAPHORE-&gt;信号量隔离策略</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">1000</span> <span class="comment">#配置HystrixCommand执行的超时时间，执行超过该时间会进行服务降级处理</span></span><br><span class="line">            <span class="attr">interruptOnTimeout:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行超时的时候是否要中断</span></span><br><span class="line">            <span class="attr">interruptOnFutureCancel:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand执行被取消的时候是否要中断</span></span><br><span class="line">          <span class="attr">timeout:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#配置HystrixCommand的执行是否启用超时时间</span></span><br><span class="line">          <span class="attr">semaphore:</span></span><br><span class="line">            <span class="attr">maxConcurrentRequests:</span> <span class="number">10</span> <span class="comment">#当使用信号量隔离策略时，用来控制并发量的大小，超过该并发量的请求会被拒绝</span></span><br><span class="line">      <span class="comment">#用于控制是否启用服务降级</span></span><br><span class="line">      <span class="attr">fallback:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> </span><br><span class="line">      <span class="comment">#用于控制HystrixCircuitBreaker的行为</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span> </span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#用于控制断路器是否跟踪健康状况以及熔断请求</span></span><br><span class="line">        <span class="attr">requestVolumeThreshold:</span> <span class="number">20</span> <span class="comment">#超过该请求数的请求会被拒绝</span></span><br><span class="line">        <span class="attr">forceOpen:</span> <span class="literal">false</span> <span class="comment">#强制打开断路器，拒绝所有请求</span></span><br><span class="line">        <span class="attr">forceClosed:</span> <span class="literal">false</span> <span class="comment">#强制关闭断路器，接收所有请求</span></span><br><span class="line">      <span class="comment">#用于控制是否开启请求缓存</span></span><br><span class="line">      <span class="attr">requestCache:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="comment">#用于控制HystrixCollapser请求合并的执行行为</span></span><br><span class="line">  <span class="attr">collapser:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">maxRequestsInBatch:</span> <span class="number">100</span> <span class="comment">#控制一次合并请求合并的最大请求数</span></span><br><span class="line">      <span class="attr">timerDelayinMilliseconds:</span> <span class="number">10</span> <span class="comment">#控制多少毫秒内的请求会被合并成一个</span></span><br><span class="line">      <span class="attr">requestCache:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#控制合并请求是否开启缓存</span></span><br><span class="line">  <span class="comment">#用于控制HystrixCommand执行所在线程池的行为</span></span><br><span class="line">  <span class="attr">threadpool:</span> </span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">10</span> <span class="comment">#线程池的核心线程数</span></span><br><span class="line">      <span class="attr">maximumSize:</span> <span class="number">10</span> <span class="comment">#线程池的最大线程数，超过该线程数的请求会被拒绝</span></span><br><span class="line">      <span class="attr">maxQueueSize:</span> <span class="number">-1</span> <span class="comment">#用于设置线程池的最大队列大小，-1采用SynchronousQueue，其他正数采用LinkedBlockingQueue</span></span><br><span class="line">      <span class="attr">queueSizeRejectionThreshold:</span> <span class="number">5</span> <span class="comment">#用于设置线程池队列的拒绝阀值，由于LinkedBlockingQueue不能动态改版大小，使用时需要用该参数来控</span></span><br></pre></td></tr></table></figure>

<h1 id="Ribbon与Hystrix超时配置问题"><a href="#Ribbon与Hystrix超时配置问题" class="headerlink" title="Ribbon与Hystrix超时配置问题"></a>Ribbon与Hystrix超时配置问题</h1><p>Ribbon超时时间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ribbon计算公式：最大超时时间&#x3D;（连接超时时间+接口超时时间）*（当前节点重试次数+1）*（换节点重试次数+1）</span><br></pre></td></tr></table></figure>
<p>Hystrix超时时间默认1000ms：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds&#x3D;1000</span><br></pre></td></tr></table></figure>

<p>Hystrix超时时间小于Ribbon超时时间，还没来得及重试就进入fallback逻辑</p>
<p><strong>Hystrix的熔断时间要比Ribbon的最长超时时间设置的略长一些，这样就可以让Ribbon的重试机制充分发挥作用</strong></p>
<h2 id="Hystrix方法级别超时控制"><a href="#Hystrix方法级别超时控制" class="headerlink" title="Hystrix方法级别超时控制"></a>Hystrix方法级别超时控制</h2><h3 id="具体方法（实例）配置"><a href="#具体方法（实例）配置" class="headerlink" title="具体方法（实例）配置"></a>具体方法（实例）配置</h3><blockquote>
<p>实例配置只需要将全局配置中的default换成与之对应的key即可。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">HystrixComandKey:</span> <span class="comment">#将default换成HystrixComrnandKey</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">THREAD</span></span><br><span class="line">  <span class="attr">collapser:</span></span><br><span class="line">    <span class="attr">HystrixCollapserKey:</span> <span class="comment">#将default换成HystrixCollapserKey</span></span><br><span class="line">      <span class="attr">maxRequestsInBatch:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">HystrixThreadPoolKey:</span> <span class="comment">#将default换成HystrixThreadPoolKey</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h4 id="配置文件中相关key的说明"><a href="#配置文件中相关key的说明" class="headerlink" title="配置文件中相关key的说明"></a>配置文件中相关key的说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HystrixComandKey对应@HystrixCommand中的commandKey属性；</span><br><span class="line">HystrixCollapserKey对应@HystrixCollapser注解中的collapserKey属性；</span><br><span class="line">HystrixThreadPoolKey对应@HystrixCommand中的threadPoolKey属性。</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：各方法不同超时时间在相互调用时冲突</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Ribbon)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Ribbon)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Ribbon)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T00:38:53+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Ribbon简介"><a href="#Ribbon简介" class="headerlink" title="Ribbon简介"></a>Ribbon简介</h2><p>在微服务架构中，很多服务都会部署多个，其他服务去调用该服务的时候，如何保证负载均衡是个不得不去考虑的问题。负载均衡可以增加系统的可用性和扩展性，当我们使用RestTemplate来调用其他服务时，Ribbon可以很方便的实现负载均衡功能。</p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><h2 id="客户端负载均衡"><a href="#客户端负载均衡" class="headerlink" title="客户端负载均衡"></a>客户端负载均衡</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png" style="zoom: 33%;" />

<h2 id="服务端负载均衡"><a href="#服务端负载均衡" class="headerlink" title="服务端负载均衡"></a>服务端负载均衡</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png" style="zoom: 33%;" />

<h2 id="模式比较"><a href="#模式比较" class="headerlink" title="模式比较"></a>模式比较</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%AF%94%E8%BE%83.png" style="zoom: 33%;" />

<h1 id="基本工作流程"><a href="#基本工作流程" class="headerlink" title="基本工作流程"></a>基本工作流程</h1><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/Ribbon%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" style="zoom:50%;" />

<p>http请求先被转发到服务节点（Eureka Clinet）上，此时服务节点（Eureka Clinet）仍然通过服务发现获取了所有服务节点的物理地址，但服务节点（Eureka Clinet）不知道该调用哪一个，所以把请求转到ribbon手中<br>1、IPing IPing是Ribbon的一套healthcheck机制，即Ping一下目标机器是否在线，一般情况下IPing并不会主动向服务节点发起healthcheck请求，Ribbon后台通过静默处理返回true默认表示所有节点都处于存活状态（和Eureka集成的时候回去检查节点UP状态）。</p>
<p>2、IRule ribbon组件库，各种负载均衡策略都继承自IRule接口，所有经过ribbon的请求都会去请示IRule，找到负载均衡策略选定的目标机器，再把请求转发过去。</p>
<h1 id="Ribbon懒加载机制"><a href="#Ribbon懒加载机制" class="headerlink" title="Ribbon懒加载机制"></a>Ribbon懒加载机制</h1><p>ribbon及有懒加载，第一次去调用时才初始化LoadBalance，如果http方法本身比较耗时，再加上loadbalance创建耗时，而且超时时间又设置的比较短，很可能出现第一次http调用失败。</p>
<p><strong>解决方法</strong>:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启饥饿加载模式</span></span><br><span class="line"><span class="meta">ribbon.eager-load.enabled</span>=<span class="string">true </span></span><br><span class="line"><span class="comment"># 指定饥饿加载的服务名称</span></span><br><span class="line"><span class="meta">ribbon.eager-load.clients</span>=<span class="string">ribbon-consumer</span></span><br></pre></td></tr></table></figure>

<h1 id="Ribbon的负载均衡策略"><a href="#Ribbon的负载均衡策略" class="headerlink" title="Ribbon的负载均衡策略"></a>Ribbon的负载均衡策略</h1><blockquote>
<p>所谓的负载均衡策略，就是当A服务调用B服务时，此时B服务有多个实例，这时A服务以何种方式来选择调用的B实例，ribbon可以选择以下几种负载均衡策略。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#修改负载均衡算法</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>RandomRule</code>：</li>
</ul>
<p>从提供服务的实例中以随机的方式；使用了yieid+自旋的方式重试，还采用防御性编程（为了保证对程序的不可预见的使用，不会造成程序功能上的损坏）</p>
<ul>
<li><code>RoundRobinRule</code>：</li>
</ul>
<p>以线性轮询的方式，就是维护一个计数器，从提供服务的实例中按顺序选取，第一次选第一个，第二次选第二个，以此类推，到最后一个以后再从头来过；</p>
<p>底层用的是自旋锁+CAS防止两个请求访问这个Rule时读取到相同节点。Eureka为了方式服务下线重复调用，也是使用的AtomicBoolean的CSA方法做同步控制。</p>
<ul>
<li><code>RetryRule</code>：</li>
</ul>
<p>在RoundRobinRule的基础上添加重试机制（类似修饰器模式的RoundRobinRule），即在指定的重试时间内，反复使用线性轮询策略来选择可用实例；</p>
<ul>
<li><code>WeightedResponseTimeRule</code>：</li>
</ul>
<p>对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择，如果统计结果未生成采用轮询；</p>
<ul>
<li><code>BestAvailableRule</code>：</li>
</ul>
<p>在过滤掉故障服务后，选择并发量较小的实例，如果统计结果未生成采用轮询；</p>
<ul>
<li><code>AvailabilityFilteringRule</code>：</li>
</ul>
<p>每次<code>AvailabilityFilteringRule</code>（ARF）都会请求RobinRule挑选一个节点，然后对这个节点进行两步检查</p>
<ol>
<li>是否处于熔断状态</li>
<li>节点当前active请求连接数超过阈值</li>
</ol>
<p>如果未通过检查，ARF会重试（最多十次），如果还不行，让RobinRule重新选择一个节点</p>
<ul>
<li><code>ZoneAwareLoadBalancer</code>： </li>
</ul>
<p>采用双重过滤，同时过滤不是同一区域的实例和故障实例，选择并发较小</p>
<h2 id="如何选择负载均衡策略"><a href="#如何选择负载均衡策略" class="headerlink" title="如何选择负载均衡策略"></a>如何选择负载均衡策略</h2><ul>
<li>时间——RT（Response Time）响应时间</li>
<li>空间——服务器的可用连接数</li>
</ul>
<p><strong>连接数敏感模型</strong>：    </p>
<p>对响应时间短，或RT和业务复杂度是非线性相关关系的接口，采用基于可用连接数的负载均衡策略更加合适RT（response time）敏感模型；</p>
<p><strong>对重量级接口</strong><br>根据参数不同会导致系统资源使用浮动较大的接口（RT与业务复杂度线性相关），建议采用基于响应时间的负载均衡策略</p>
<h1 id="Ribbon原理"><a href="#Ribbon原理" class="headerlink" title="Ribbon原理"></a>Ribbon原理</h1><h2 id="LoadBalance"><a href="#LoadBalance" class="headerlink" title="@LoadBalance"></a>@LoadBalance</h2><ul>
<li><p>@LoadBalanced这个注解一头挂在RestTemplate上，另一个挂在LoadBalancerAutoConfig这个类上</p>
</li>
<li><p>@LoadBalanced这个注解会将RestTemplate传送到Ribbon的自动装配类(LoadBalancerAutoConfig)里面进行改造</p>
<h3 id="LoadBalancerAutoConfig"><a href="#LoadBalancerAutoConfig" class="headerlink" title="LoadBalancerAutoConfig"></a>LoadBalancerAutoConfig</h3></li>
</ul>
<p>对网络请求进行拦截，加工</p>
<h2 id="IPing"><a href="#IPing" class="headerlink" title="IPing"></a>IPing</h2><p>IPing作用获取服务节点的状态，只有可用节点才进行负载均衡</p>
<p>IPing的三种工作模式</p>
<ul>
<li><p>DummyPing    自娱自乐式：静默模式，默认返回true，认为所有节点都可用</p>
</li>
<li><p>NIWSDiscoveryPing    隔山打牛式：借助Eureka服务发现机制获取节点状态，状态为：UP则可用（默认这一种）</p>
</li>
<li><p>PingUrl    主动出击式：增加后台服务器压力</p>
</li>
</ul>
<h1 id="Ribbon参数配置"><a href="#Ribbon参数配置" class="headerlink" title="Ribbon参数配置"></a>Ribbon参数配置</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span> <span class="comment">#对超时请求启用重试机制（真实环境Get请求可以重试或实现了幂等性的其他类型请求）</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">1000</span> <span class="comment">#服务请求连接超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">2000</span> <span class="comment">#服务请求处理超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">2</span> <span class="comment"># 当前节点的重试次数，2代表重试2次，首次调用超时后，会再次向同一个服务节点发起最多两次重试（总共向当前节点1+2=3次请求）</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">2</span> <span class="comment">#切换重试实例的最大个数，2代表换2个节点重试，当前节点超时后，Fegin将最多切换2台机器发起调用，在新机器上再次发起最多（MaxAutoRetries+1）次调用</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#修改负载均衡算法</span></span><br></pre></td></tr></table></figure>

<h2 id="极限值计算"><a href="#极限值计算" class="headerlink" title="极限值计算"></a>极限值计算</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAX(Response Time) &#x3D; (ConnectTimeout + ReadTimeout) * (MaxAutoRetries + 1) * (MaxAutoRetriesNextServer + 1)</span><br><span class="line">27000ms &#x3D; （2000 + 1000）*（2 + 1）*（2 + 1）</span><br></pre></td></tr></table></figure>

<h2 id="制定服务进行配置"><a href="#制定服务进行配置" class="headerlink" title="制定服务进行配置"></a>制定服务进行配置</h2><blockquote>
<p>当我们在使用@FeignClient(name = “user-service”)注解来生成一个名为user-service的feign客户端时，同时也生成了一个名为user-service的ribbon客户端，所以我们才能用注解@FeignClient里的name值（value也是一样的）来设置对应的ribbon参数，起到指定服务的效果，不再是全局配置了</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user-service:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">1000</span> <span class="comment">#服务请求连接超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">3000</span> <span class="comment">#服务请求处理超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span> <span class="comment">#对超时请求启用重试机制</span></span><br><span class="line">    <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换重试实例的最大个数</span></span><br><span class="line">    <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment"># 切换实例后重试最大次数</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#修改负载均衡算法</span></span><br></pre></td></tr></table></figure>

<h2 id="载均衡策略配置方法"><a href="#载均衡策略配置方法" class="headerlink" title="载均衡策略配置方法"></a>载均衡策略配置方法</h2><h3 id="配置类中选择"><a href="#配置类中选择" class="headerlink" title="配置类中选择"></a>配置类中选择</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">iRule</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RoundRobinRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="选择自定义负载均衡规则"><a href="#选择自定义负载均衡规则" class="headerlink" title="选择自定义负载均衡规则"></a>选择自定义负载均衡规则</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">iRule</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyRule()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRule</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBalancerRule</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRule</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWithNiwsConfig</span><span class="params">(IClientConfig iClientConfig)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//灰度发布 10%的流量在新的功能 ~ 90%的流量在旧的功能</span></span><br><span class="line">        <span class="comment">//自定义规则</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//无论传入什么，都返回null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class MyRule implements IRule &#123;</span><br><span class="line"></span><br><span class="line">    private ILoadBalancer lb;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Server choose(Object key) &#123;</span><br><span class="line">    &#x2F;&#x2F;自定义规则</span><br><span class="line">        List&lt;Server&gt; servers &#x3D; lb.getAllServers();</span><br><span class="line">        for (Server server : servers) &#123;</span><br><span class="line">            System.out.println(&quot;调用了第一个服务&quot;+server.getHostPort());</span><br><span class="line">        &#125;</span><br><span class="line">        return servers.get(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setLoadBalancer(ILoadBalancer lb) &#123;</span><br><span class="line">        this.lb &#x3D; lb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ILoadBalancer getLoadBalancer() &#123;</span><br><span class="line">        return lb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="yml中配置"><a href="#yml中配置" class="headerlink" title="yml中配置"></a>yml中配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#修改负载均衡算法</span></span><br></pre></td></tr></table></figure>

<h2 id="超时时间"><a href="#超时时间" class="headerlink" title="超时时间"></a>超时时间</h2><p>Ribbon 中有两种和时间相关的设置，分别是请求连接的超时时间和请求处理的超时时间，设置规则如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请求连接的超时时间</span></span><br><span class="line"><span class="meta">ribbon.ConnectTimeout</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"># 请求处理的超时时间</span></span><br><span class="line"><span class="meta">ribbon.ReadTimeout</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure>

<p>也可以为每个Ribbon客户端设置不同的超时时间, 通过服务名称进行指定：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">demo-service-provider.ribbon.ConnectTimeout</span>=<span class="string">2000</span></span><br><span class="line"><span class="meta">demo-service-provider.ribbon.ReadTimeout</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure>

<h2 id="并发参数"><a href="#并发参数" class="headerlink" title="并发参数"></a>并发参数</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line"><span class="meta">ribbon.MaxTotalConnections</span>=<span class="string">500</span></span><br><span class="line"><span class="comment"># 每个host最大连接数</span></span><br><span class="line"><span class="meta">ribbon.MaxConnectionsPerHost</span>=<span class="string">500</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/13/Spring-SpringCloud(Eureka)%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/13/Spring-SpringCloud(Eureka)%E7%BB%83%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Eureka)练习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-13T00:12:46+08:00">
                2021-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E7%BB%83%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud练习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring-Cloud-Eureka-服务注册与发现"><a href="#Spring-Cloud-Eureka-服务注册与发现" class="headerlink" title="Spring Cloud Eureka: 服务注册与发现"></a>Spring Cloud Eureka: 服务注册与发现</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在微服务架构中往往会有一个注册中心，每个微服务都会向注册中心去注册自己的地址及端口信息，注册中心维护着服务名称与服务实例的对应关系。每个微服务都会定时从注册中心获取服务列表，同时汇报自己的运行情况，这样当有的服务需要调用其他服务时，就可以从自己获取到的服务列表中获取实例地址进行调用，Eureka实现了这套服务注册与发现机制。</p>
<h2 id="搭建Eureka注册中心"><a href="#搭建Eureka注册中心" class="headerlink" title="搭建Eureka注册中心"></a>搭建Eureka注册中心</h2><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--给Eureka注册中心添加认证--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/开启作为Eureka Server的客户端的支持</span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="comment">//开启对EurekaServer的支持，即：作为Eureka服务端</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudEurekaNode1Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(CloudEurekaNode1Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="yml配置"><a href="#yml配置" class="headerlink" title="yml配置"></a>yml配置</h3><h4 id="单节点"><a href="#单节点" class="headerlink" title="单节点"></a>单节点</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pring:</span><br><span class="line">  security:</span><br><span class="line">    user:</span><br><span class="line">      name: liyuan</span><br><span class="line">      password: liyuan123</span><br><span class="line">      roles: SUPERUSER</span><br><span class="line">server:</span><br><span class="line">  port: <span class="number">8761</span></span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: localhost</span><br><span class="line">    prefer-ip-address: <span class="keyword">true</span></span><br><span class="line">  client:</span><br><span class="line">    register-with-eureka: <span class="keyword">false</span></span><br><span class="line">    fetch-registry: <span class="keyword">false</span></span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http:<span class="comment">//liyuan:liyuan123@localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>

<h4 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h4><p>配置host</p>
<ul>
<li>127.0.0.1 eureka-server1</li>
<li>127.0.0.1 eureka-server2</li>
</ul>
<h5 id="节点1"><a href="#节点1" class="headerlink" title="节点1"></a>节点1</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#配置SpringSecurity登录用户名和密码</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">liyuan</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">liyuan123</span></span><br><span class="line">      <span class="attr">roles:</span> <span class="string">SUPERUSER</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 在同一个局域网，可以通过hostname来互相访问，因为同一个局域网不允许出现相同的hostname</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka-server1</span></span><br><span class="line">    <span class="comment"># prefer-ip-address = true，hostname将失效</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#指示此实例是否应将其信息注册到eureka服务器以供其他服务发现，默认为false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#客户端是否获取eureka服务器注册表上的注册信息，默认为true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">    <span class="comment">#将自己注册到eureka-server2</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>

<h5 id="节点2"><a href="#节点2" class="headerlink" title="节点2"></a>节点2</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">liyuan</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">liyuan123</span></span><br><span class="line">      <span class="attr">roles:</span> <span class="string">SUPERUSER</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8762</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 在同一个局域网，可以通过hostname来互相访问，因为同一个局域网不允许出现相同的hostname</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka-server2</span></span><br><span class="line">    <span class="comment"># prefer-ip-address = true，hostname将失效</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#指示此实例是否应将其信息注册到eureka服务器以供其他服务发现，默认为false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#客户端是否获取eureka服务器注册表上的注册信息，默认为true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">    <span class="comment">#将自己注册到eureka-server1</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/</span></span><br></pre></td></tr></table></figure>

<h3 id="添加Java配置WebSecurityConfig"><a href="#添加Java配置WebSecurityConfig" class="headerlink" title="添加Java配置WebSecurityConfig"></a>添加Java配置WebSecurityConfig</h3><blockquote>
<p>默认情况下添加SpringSecurity依赖的应用每个请求都需要添加CSRF token才能访问，Eureka客户端注册时并不会添加，所以需要配置/eureka/**路径不需要CSRF token。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().ignoringAntMatchers(<span class="string">&quot;/eureka/**&quot;</span>);</span><br><span class="line">        <span class="keyword">super</span>.configure(http);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="搭建Eureka-客户端"><a href="#搭建Eureka-客户端" class="headerlink" title="搭建Eureka 客户端"></a>搭建Eureka 客户端</h2><h3 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="启动项"><a href="#启动项" class="headerlink" title="启动项"></a>启动项</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="搭建Eureka服务提供者"><a href="#搭建Eureka服务提供者" class="headerlink" title="搭建Eureka服务提供者"></a>搭建Eureka服务提供者</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>
<h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="搭建Eureka消费者"><a href="#搭建Eureka消费者" class="headerlink" title="搭建Eureka消费者"></a>搭建Eureka消费者</h3><h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#获取注册实例列表</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#配置注册中心地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://liyuan:liyuan123@eureka-server1:8761/eureka/,http://liyuan:liyuan123@eureka-server2:8762/eureka/</span></span><br></pre></td></tr></table></figure>

<h4 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h4><h5 id="直接调用接口"><a href="#直接调用接口" class="headerlink" title="直接调用接口"></a>直接调用接口</h5><p>RestTemplate是 <a target="_blank" rel="noopener" href="http://c.biancheng.net/spring/">Spring</a> 提供的用于访问 Rest 服务的客户端，RestTemplate 提供了多种便捷访问远程 Http 服务的方法，能够大大提高客户端的编写效率。我们通过配置 RestTemplate 来调用接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/article /callHello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">callHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8081/user/hello&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过-Eureka-来消费接口"><a href="#通过-Eureka-来消费接口" class="headerlink" title="通过 Eureka 来消费接口"></a>通过 Eureka 来消费接口</h5><p>上面提到的方法是直接通过服务接口的地址来调用的，和我们之前的做法一样，完全没有用到 Eureka 带给我们的便利。既然用了注册中心，那么客户端调用的时候肯定是不需要关心有多少个服务提供接口，下面我们来改造之前的调用代码。</p>
<p>首先改造 RestTemplate 的配置，添加一个 @LoadBalanced 注解，这个注解会自动构造 LoadBalancerClient 接口的实现类并注册到 Spring 容器中，代码如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/article/callHello2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">callHello2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://demo-service-provider/user/hello&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cloud-parent</span><br><span class="line">├── cloud_eureka_node1 <span class="comment">-- eureka注册中心节点1</span></span><br><span class="line">├── cloud_eureka_node2 <span class="comment">-- eureka注册中心节点2</span></span><br><span class="line">└── cloud-demo <span class="comment">-- SpringCloud测试项目</span></span><br><span class="line">	├── cloud_consumer <span class="comment">--服务消费端</span></span><br><span class="line">	├── cloud_provider <span class="comment">--服务提供端</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanyayuan.github.io/2021/05/12/Spring-SpringCloud(Eureka)%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hikari的Java之路">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/12/Spring-SpringCloud(Eureka)%E5%AD%A6%E4%B9%A0/" itemprop="url">Spring-SpringCloud(Eureka)学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-12T18:41:28+08:00">
                2021-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%B8%E7%94%A8%E6%A1%86%E6%9E%B6-SpringCloud%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">常用框架 - SpringCloud学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="微服务环境下面临的问题"><a href="#微服务环境下面临的问题" class="headerlink" title="微服务环境下面临的问题"></a>微服务环境下面临的问题</h1><p>1、服务治理与负载均衡</p>
<p>2、服务容错</p>
<p>3、配置管理</p>
<p>4、服务网关</p>
<p>5、调用链路追踪</p>
<p>6、消息驱动</p>
<p>7、限流</p>
<h1 id="什么是SpringCloud"><a href="#什么是SpringCloud" class="headerlink" title="什么是SpringCloud"></a>什么是SpringCloud</h1><p>是一套目前完整的微服务框架，它是是一系列框架的有序集合，将各服务组件组合起来，通过SpringBoot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终实现一套简单易懂、易部署和易维护的分布式系统开发工具包</p>
<p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.png"></p>
<h1 id="服务治理"><a href="#服务治理" class="headerlink" title="服务治理"></a>服务治理</h1><h3 id="服务治理目标"><a href="#服务治理目标" class="headerlink" title="服务治理目标"></a>服务治理目标</h3><ul>
<li><p>高可用性</p>
<p>服务不能轻易就不可用，即使只存活最后一个节点，服务治理框架也要保证服务的可用性</p>
</li>
<li><p>分布式调用</p>
<p>微服务的节点通常散落在不同的网络环境中，甚至会使用两地三机房或跨洲际机房做异地容灾，    这就要求服务治理框架具备在复杂网络环境下准确获知服务节点网络地址（IP，端口以及服务名称）的能力</p>
</li>
<li><p>生命周期管理</p>
<p>从服务上线、持续运行直到服务终止，服务治理始终贯穿整个微服务生命周期</p>
</li>
<li><p>健康度检查<br>如果一个节点因各种原因不可用，服务治理框架要精准识别这些节点，将其剔除</p>
<h3 id="服务治理面临的问题及解决方案"><a href="#服务治理面临的问题及解决方案" class="headerlink" title="服务治理面临的问题及解决方案"></a>服务治理面临的问题及解决方案</h3></li>
</ul>
<ol>
<li>服务治理框架如何识别服务（ip，端口，服务名，健康状况）——服务注册</li>
<li>服务调用方如何获取服务——服务发现</li>
<li>服务治理框如何管理服务——心跳检测，服务续约，服务剔除</li>
<li>服务治理框如何应对服务主动退出——服务下线</li>
</ol>
<h1 id="服务治理技术选型"><a href="#服务治理技术选型" class="headerlink" title="服务治理技术选型"></a>服务治理技术选型</h1><ul>
<li><p>Consul（AP）</p>
<ul>
<li>性能慢（RAFT协议Leader选举，过半数节点都写入成功才行）</li>
<li>HTTP&amp;DNS协议</li>
</ul>
</li>
<li><p>Eureka（AP），eureka就是注册中心而创建，节点都是相对独立，不需要考虑数据一致性的问题，为了保证高可用存在某一个瞬间可能导致某些ip节点被调用数多，某些ip节点调用数少的问题。也有可能存在一些本应该被删除而没被删除的脏数据，但是有服务容错来进行兜底。</p>
<p>Eureka还有自我保护机制（应对因网络故障导致部分节点失去联系的情况），如果在15分钟内超过85%的节点没有正常的心跳，那么Eureka就认为客户端与注册中心发生了网络故障（Eureka不在从注册列表中移除因为长时间没有收到心跳而应该过期的服务）（Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点上）（当网络稳定时，当前实例新的注册信息会被同步到其他节点）</p>
<ul>
<li>性能快</li>
<li>HTTP协议</li>
<li>2.0暂停开源计划</li>
</ul>
</li>
<li><p>Nacos（AP，CP）</p>
<ul>
<li>性能块</li>
<li>HTTP&amp;DNS&amp;UDP</li>
</ul>
</li>
<li><p>Zookeeper（CP），zk更多是作为分布式协调服务的存在，只不过因为它的特性被dubbo赋予了注册中心，它的职责更多是保证数据（配置数据，状态数据）在管辖下的所有服务之间保持一致。zk最核心的算法ZAB，就是为了解决分布式系统下数据在多个服务之间一致同步的问题。为了保证一致性存在选主期间，服务不可用的情况。</p>
<ul>
<li>性能慢（ZAB算法Leader选举）</li>
<li>Dubbo</li>
</ul>
</li>
</ul>
<h1 id="注册中心-Eureka"><a href="#注册中心-Eureka" class="headerlink" title="注册中心-Eureka"></a>注册中心-Eureka</h1><h2 id="注册中心核心工作流程"><a href="#注册中心核心工作流程" class="headerlink" title="注册中心核心工作流程"></a>注册中心核心工作流程</h2><p><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E6%A0%B8%E5%BF%83%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png"></p>
<h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><h3 id="两种服务注册解决方案"><a href="#两种服务注册解决方案" class="headerlink" title="两种服务注册解决方案"></a>两种服务注册解决方案</h3><p>1、由注册中心主动访问网络节点中的所有机器<br>2、注册中心等待服务节点自己注册</p>
<h3 id="Eureka的注册模式"><a href="#Eureka的注册模式" class="headerlink" title="Eureka的注册模式"></a>Eureka的注册模式</h3><p>选择等待服务节点自己注册</p>
<h4 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h4><p>1、对于网络中其他非服务节点不会产生任何无效请求<br>2、省去了广播环节，使注册效率大大提高<br>3、节省了大量网络请求的开销</p>
<h3 id="服务节点注册包含的主要内容"><a href="#服务节点注册包含的主要内容" class="headerlink" title="服务节点注册包含的主要内容"></a>服务节点注册包含的主要内容</h3><ul>
<li>服务节点所提供的微服务是什么</li>
<li>服务节点的IP+端口号</li>
<li>服务节点的状态</li>
</ul>
<h3 id="Eureka在等待服务节点注册期间还需要做什么"><a href="#Eureka在等待服务节点注册期间还需要做什么" class="headerlink" title="Eureka在等待服务节点注册期间还需要做什么"></a>Eureka在等待服务节点注册期间还需要做什么</h3><ul>
<li>心跳检测和服务剔除——对于已注册的节点进行心跳检测，如果节点没有回应则进行服务剔除</li>
<li>注册信息同步——注册中心集群状态下进行信息同步</li>
</ul>
<h3 id="服务注册基本流程"><a href="#服务注册基本流程" class="headerlink" title="服务注册基本流程"></a>服务注册基本流程</h3><ol>
<li><p><strong>扫描注解</strong>：</p>
<p><code>@EnableDiscoveryClient</code>开启作为Eureka Server的客户端的支持**(作为客户端)**</p>
<blockquote>
<p><code>@EnableEurekaServer</code>开启对EurekaServer服务端的支持**(作为服务端)**</p>
<p>搭建注册中心或集群时用到</p>
</blockquote>
</li>
<li><p><strong>发起注册</strong></p>
</li>
<li><p>使用<strong>装饰器+代理</strong>模式构建组件（装饰器模式实现失败重试功能）</p>
</li>
<li><p><strong>获取HttpClient</strong></p>
</li>
<li><p><strong>获取Server列表</strong></p>
<ul>
<li>有——发送注册请求<ul>
<li>注册成功或换另一台Server注册</li>
</ul>
</li>
<li>没有——抛出异常</li>
</ul>
</li>
</ol>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><h3 id="两种服务发现解决方案"><a href="#两种服务发现解决方案" class="headerlink" title="两种服务发现解决方案"></a>两种服务发现解决方案</h3><ul>
<li>基于客户端的服务发现</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E5%9F%BA%E4%BA%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" style="zoom:50%;" />

<p>网络服务节点将自己的服务信息以及IP地址发送给注册中心，调用方从注册中心后去所有的可用服务列表，然后从中选择一个访问。</p>
<p><strong>应用</strong>：Eureka定时拉取，Dubbo订阅模式</p>
<ul>
<li>基于服务端的服务发现</li>
</ul>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E5%9F%BA%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" style="zoom:50%;" />

<p>网络服务节点将自己的服务信息以及IP地址发送给注册中心，调用方访问的时服务端的代理Router，这个Router既是服务端负载均衡器，也可以是网关层，负载均衡策略在服务端执行。</p>
<p><strong>应用</strong>：K8s代理，LVS</p>
<h2 id="心跳检测"><a href="#心跳检测" class="headerlink" title="心跳检测"></a>心跳检测</h2><h3 id="服务心跳特点"><a href="#服务心跳特点" class="headerlink" title="服务心跳特点"></a>服务心跳特点</h3><ul>
<li>客户端发起：心跳服务是由一个个服务节点根据配置的时间主动发起的</li>
<li>同步状态 ：心跳服务中还要通知客户端状态，out_of_service还是up</li>
<li>服务剔除 ： 对于一段时间无响应的服务，注册中心从注册列表剔除</li>
<li>服务续约 ：底层也是心跳服务</li>
</ul>
<h3 id="心跳传输的信息"><a href="#心跳传输的信息" class="headerlink" title="心跳传输的信息"></a>心跳传输的信息</h3><ul>
<li><p>访问地址：Eureka注册中心的地址</p>
</li>
<li><p>访问地址：节点的个人信息——<code>instance-id: $&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</code></p>
</li>
<li><p>服务状态：反应节点状态<code>UP</code>,<code>DOWN</code>,<code>STARTING</code>,<code>out_of_service</code>,<code>UNKNOWN</code></p>
</li>
<li><p>最后一次同步注册的时间(<code>lastdirtytimestamp</code>)：当前服务节点最后一次与服务中心失去同步时的时间</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">配置心跳指标</span></span><br><span class="line"><span class="comment">#每隔多久向服务器发送一次心跳包</span></span><br><span class="line"><span class="meta">eureka.instance.lease-renewal-intercal-in-seconds</span>=<span class="string">10</span></span><br><span class="line"><span class="comment">#如果在x秒内都没心跳，代表挂掉了</span></span><br><span class="line"><span class="meta">eureka.instance.lease-expiration-duration-in-seconds</span>=<span class="string">20</span></span><br></pre></td></tr></table></figure>

<h2 id="服务剔除"><a href="#服务剔除" class="headerlink" title="服务剔除"></a>服务剔除</h2><img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E6%9C%8D%E5%8A%A1%E5%89%94%E9%99%A4.png" style="zoom:50%;" />

<ol>
<li>启动定时任务：注册中心在启动时会开启一个后台任务，默认每隔60s触发服务剔除任务，可使用<code>eureka.server.eviction-interval-timer-in-ms=30000</code>配置。</li>
<li>调用服务提出方法<ul>
<li>自保开启（Eureka不在从注册列表中移除因为长时间没有收到心跳而应该过期的服务）</li>
</ul>
</li>
<li>遍历过期服务，满足条件的当作过期<ul>
<li>已被标记为过期（evictionTimestamp&gt;0）</li>
<li>最后一次心跳时间+服务端配置的心跳间隔时间&lt;当前时间</li>
</ul>
</li>
<li>计算可提出的服务总个数：注册中心设置一个系数（默认0.85），可剔除的服务个数，不能大于已注册服务的总数量*系数，超过则进入自保模式</li>
<li>乱序提出服务：随机剔除过期服务</li>
</ol>
<h2 id="服务续约"><a href="#服务续约" class="headerlink" title="服务续约"></a>服务续约</h2><p>第一步：服务节点的状态同步至注册中心，告知注册中心该服务节点还存活，这一步由客户端的心跳完成</p>
<p>第二步：当心跳包到达注册中心的时候，那就要看注册中心的判别机制来判定当前的续约心跳是否合理，并根据结果修改当前节点在注册中心记录的同步时间</p>
<h3 id="服务节点向注册中心发送续约请求"><a href="#服务节点向注册中心发送续约请求" class="headerlink" title="服务节点向注册中心发送续约请求"></a>服务节点向注册中心发送续约请求</h3><ul>
<li><p>服务节点向注册中心发送心跳，返回200就续约成功，如果续约不成功返回404（<strong>返回404不是注册中心挂了而是注册中心认为服务节点不存在</strong>，这时客户端就要触发一次重新注册操作，就要将服务节点重新注册到服务中心）</p>
</li>
<li><p>在重新注册之前，客户端先进行两个操作</p>
<ul>
<li><p><code>isInstanceinfoDirty=true</code>,标记自己为脏节点。</p>
</li>
<li><p>重新设置<code>lastdirtytimestamp</code>(当前服务节点最后一次与服务中心失去同步时的时间)为系统时间</p>
</li>
</ul>
</li>
<li><p>重新注册成功清楚脏节点标记，但是不清除<code>lastDirtytimestamp</code>这个参数，将会在后面的服务续约中作为参数发送给注册中心，以便注册中心判断节点的同步状态</p>
</li>
</ul>
<h3 id="注册中心续约校验"><a href="#注册中心续约校验" class="headerlink" title="注册中心续约校验"></a>注册中心续约校验</h3><ul>
<li>接受请求</li>
<li>尝试续约，没有注册和UnKnown状态，续约失败，需要重新注册</li>
<li>脏数据校验 ，如果注册中心的<code>lastDirtytimestamp</code>大于节点的<code>lastDirtytimestamp</code>，说明从服务节点上次注册到这次注册之间，发生了数据不同步，续约不通过，返回404</li>
</ul>
<h2 id="服务自保"><a href="#服务自保" class="headerlink" title="服务自保"></a>服务自保</h2><p>Eureka还有自我保护机制（应对因网络故障导致部分节点失去联系的情况），如果在15分钟内超过85%的节点没有正常的心跳，那么Eureka就认为客户端与注册中心发生了网络故障，自我保护期间：</p>
<ul>
<li><p>Eureka不在从注册列表中移除因为长时间没有收到心跳而应该过期的服务</p>
</li>
<li><p>Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点上</p>
</li>
<li><p>当网络稳定时，当前实例新的注册信息会被同步到其他节点</p>
</li>
</ul>
<p><strong>手动开关</strong>：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<h2 id="服务下线"><a href="#服务下线" class="headerlink" title="服务下线"></a>服务下线</h2><p>1、标记服务状态DOWN<br>2、获取系统锁（<strong>CAS机制防止服务下线被重复调用</strong>）   </p>
<blockquote>
<p>Java线程安全的方法：synchronize，concurrent包下的一些线程安全类，Thread的wait和notify方法</p>
<p>还有CAS（Compare and swap）机制——比较和替换，使用一个期望值和一个变量的当前值进行比较，如果当前变量的值与我们期望的值相等，就使用一个新值替换当前变量的值<br>操作系统的CAS操作会将内存值和期望值进行比较，如果相等就将参数更新到内存并返回成功，如果不相等就返回失败。操作系统层面这个比较-替换操作是原子性的，所以线程安全。类似乐观锁</p>
<p>CAS的ABA问题，内存值从A变到B，然后再变回A，假设期望值是A，尽管中途发生了A-&gt;B的变化，但是最终还是变回A，因此CAS操作依然认为没有变化</p>
<p>解决方法：添加版本号，使用前查询版本号，比对时同时验证版本号，修改后版本号+1</p>
</blockquote>
<p>3、释放自身资源<br>4、关闭状态监听器、状态同步任务、心跳任务<br>5、发送下线指令，delete请求到注册中心</p>
<h1 id="注册中心集群"><a href="#注册中心集群" class="headerlink" title="注册中心集群"></a>注册中心集群</h1><h2 id="Eureka-的数据同步方式"><a href="#Eureka-的数据同步方式" class="headerlink" title="Eureka 的数据同步方式"></a>Eureka 的数据同步方式</h2><p>对等复制——副本间不分主从，任何副本都可以接收写操作，然后每个副本间互相进行数据更新</p>
<h2 id="同步过程"><a href="#同步过程" class="headerlink" title="同步过程"></a>同步过程</h2><p>Eureka Server 每当自己的信息变更后，例如 Client 向自己发起<em>注册、续约、注销</em>请求， 就会把自己的最新信息通知给其他 Eureka Server，保持数据同步。</p>
<h3 id="数据同步死循环"><a href="#数据同步死循环" class="headerlink" title="数据同步死循环"></a>数据同步死循环</h3><p>如果自己的信息变更是另一个Eureka Server同步过来</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E5%90%8C%E6%AD%A5%E6%AD%BB%E5%BE%AA%E7%8E%AF.png" style="zoom: 50%;" />

<p><strong>解决方式</strong>：Eureka Server 在执行复制操作的时候，使用 <code>HEADER_REPLICATION</code> 这个 http header 来区分普通应用实例的正常请求，说明这是一个复制请求，这样其他 peer 节点收到请求时，就不会再对其进行复制操作，从而避免死循环</p>
<h3 id="数据冲突"><a href="#数据冲突" class="headerlink" title="数据冲突"></a>数据冲突</h3><p>server A 向 server B 发起同步请求，如果 A 的数据比 B 的还旧，B 不可能接受 A 的数据</p>
<p><strong>解决方式</strong>：数据的新旧一般是通过<em>版本号</em>来定义的，Eureka 是通过 <code>lastDirtyTimestamp</code> （当前服务节点最后一次与服务中心失去同步时的时间）这个类似版本号的属性来实现的</p>
<p> Eureka Server A 向 Eureka Server B 复制数据，数据冲突有2种情况：</p>
<p>（1）A 的数据比 B 的新，B 返回 404，A 重新把这个应用实例注册到 B。</p>
<p>（2）A 的数据比 B 的旧，B 返回 409，要求 A 同步 B 的数据。</p>
<img src="https://nexus-oss-blog.oss-cn-beijing.aliyuncs.com/SpringCloud/%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5.png" style="zoom:50%;" />

<h1 id="Eureka集群挂掉后消费者和提供者之间关系"><a href="#Eureka集群挂掉后消费者和提供者之间关系" class="headerlink" title="Eureka集群挂掉后消费者和提供者之间关系"></a>Eureka集群挂掉后消费者和提供者之间关系</h1><h2 id="如果eureka集群突然宕机的情况下，会出现什么情况呢，服务之间还能不能正常访问"><a href="#如果eureka集群突然宕机的情况下，会出现什么情况呢，服务之间还能不能正常访问" class="headerlink" title="如果eureka集群突然宕机的情况下，会出现什么情况呢，服务之间还能不能正常访问"></a>如果eureka集群突然宕机的情况下，会出现什么情况呢，服务之间还能不能正常访问</h2><p><strong>可以</strong></p>
<p>在启动消费者和提供者的时候，eureka注册中心是正常运行的，因此可以将各个消费者和提供者可以正常订阅。当eureka突然宕机的时候，<strong>各个提供者和消费者都已经保存有相互间的服务名称与ip映射</strong>，所以相互访问没有问题</p>
<h2 id="在eureka集群宕机的情况下，消费者或者提供者服务重启后，消费者是否可以继续访问提供者"><a href="#在eureka集群宕机的情况下，消费者或者提供者服务重启后，消费者是否可以继续访问提供者" class="headerlink" title="在eureka集群宕机的情况下，消费者或者提供者服务重启后，消费者是否可以继续访问提供者"></a>在eureka集群宕机的情况下，消费者或者提供者服务重启后，消费者是否可以继续访问提供者</h2><p> 在eureka宕机未启动的情况下，</p>
<ul>
<li>当消费者重新启动后，<strong>无法从eureka中拉取其他服务的映射信息</strong>，因此消费者是<strong>无法再访问</strong>提供者的</li>
<li>当提供者重新启动后，由于<strong>消费者还继续保存着与提供者之间的映射信息，而且提供者的信息并未发生改变</strong>，因此消费者<strong>还是可以继续访问提供者</strong>的。</li>
</ul>
<h2 id="在eureka集群宕机的情况下，服务之间在何种情况下无法继续进行相互访问"><a href="#在eureka集群宕机的情况下，服务之间在何种情况下无法继续进行相互访问" class="headerlink" title="在eureka集群宕机的情况下，服务之间在何种情况下无法继续进行相互访问"></a>在eureka集群宕机的情况下，服务之间在何种情况下无法继续进行相互访问</h2><ul>
<li>所有服务全部停止，再重新启动除eureka之外的服务</li>
<li>修改消费者或提供者IP，端口，服务名称等映射信息的情况下</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <!--<a href="/archives/%7C%7Carchive">-->
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">68</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yuanyayuan" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:liyuan0707@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiYuan</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
